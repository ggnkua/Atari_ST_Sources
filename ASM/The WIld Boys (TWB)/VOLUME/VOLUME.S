;Yo, this is POWER MAN here with the source
;for my volume indicator article. See ya
;next time, so chill out....



	CLR.L -(A7)
	MOVE.W #32,-(A7)
	TRAP #1
	ADDQ.L #6,A7
	MOVE.L D0,STACK
	LEA $78000,A0		;SET UP COLOUR BARS
	MOVE.W #(66*20)-1,D0
COL1	MOVE.W #-1,(A0)+
	MOVE.L #0,(A0)+
	MOVE.W #0,(A0)+
	DBF D0,COL1
	MOVE.W #(66*20)-1,D0
COL2	MOVE.W #0,(A0)+
	MOVE.W #-1,(A0)+
	MOVE.L #0,(A0)+
	DBF D0,COL2
	MOVE.W #(68*20)-1,D0
COL3	MOVE.L #0,(A0)+
	MOVE.W #-1,(A0)+
	MOVE.W #0,(A0)+
	DBF D0,COL3
	JSR SETMUS
	MOVE.L #CHANGE,$4D2+4.W
WAIT	CMPI.B #57,$FFFFFC02.W	;SPACE BAR
	BNE WAIT
	BSR ENDMUS
	MOVE.L STACK,-(A7)
	MOVE.W #32,-(A7)
	TRAP #1
	ADDQ.L #6,A7
	CLR.L -(A7)
	TRAP #1

CHANGE	MOVEQ.W #0,D0
	MOVEQ.W #0,D1
	MOVEQ.W #0,D2
	MOVE.B #8,$FFFF8800.W  	;CHANNEL A
	MOVE.B $FFFF8800.W,D0
	MOVE.B #9,$FFFF8800.W   ;CHANNEL B
	MOVE.B $FFFF8800.W,D1
	MOVE.B #10,$FFFF8800.W  ;CHANNEL C
	MOVE.B $FFFF8800.W,D2
	BTST #4,D0              ;IS CHANNEL A AN ENVELOPE?
	BEQ .L1
	MOVE.B #10,D0           ;SET VOLUME IF IT IS
.L1	BTST #4,D1    		;IS CHANNEL B AN ENVELOPE?
       	BEQ .L2
	MOVE.B #10,D1
.L2	BTST #4,D2		;IS CHANNEL C AN ENVELOPE?
	BEQ .L3
	MOVE.B #10,D2
.L3	ADD.B D0,D0		;WORD ALIGNMENT
	ADD.B D1,D1
	ADD.B D2,D2
	LEA COLS1,A0
	LEA COLS2,A1
	LEA COLS3,A2
	LEA (A0,D0),A0
	LEA (A1,D1),A1
	LEA (A2,D2),A2
	MOVE.W (A0),$FFFF8242.W ;CHANGE COLOURS
	MOVE.W (A1),$FFFF8244.W
	MOVE.W (A2),$FFFF8248.W
	RTS

COLS1	DC.W $001,$001,$002,$002,$003,$003,$004,$004
	DC.W $005,$005,$006,$006,$007,$007,$007
COLS2	DC.W $010,$010,$020,$020,$030,$030,$040,$040
	DC.W $050,$050,$060,$060,$070,$070,$070
COLS3	DC.W $101,$101,$202,$202,$303,$303,$404,$404
	DC.W $505,$505,$606,$606,$707,$707,$707

SETMUS	BCLR #0,$484.W
	BSR MINIT
	BSR M+($46D60-$45A28)
	MOVE.L #MUSIC,$4D2.W
	RTS
ENDMUS	CLR.L $4D2.W
	CLR.L $4D2+4.W
	MOVE.L #$700FF00,$FFFF8800.W
	MOVE.L #$8000000,$FFFF8800.W
	MOVE.L #$9000000,$FFFF8800.W
	MOVE.L #$A000000,$FFFF8800.W
	RTS
MINIT	INCBIN INIT.DAT
	RTS
MUSIC	BRA M+($46E68-$45A28)
M	INCBIN MUSIC2.DAT

STACK	DS.L 1							;sample address,length,rate,space