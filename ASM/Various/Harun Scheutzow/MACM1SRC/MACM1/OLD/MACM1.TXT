MACM1.PRG
=========

Dies ist ein SERSOFST.TXT-konformer Treiber fÅr den Atari-"Emulator" 
MagiCMac auf Macintosh-Computern. MACM1.PRG stellt GEMDOS- und 
BIOS-Schnittstellen auf Atari-Seite bereit und benutzt dazu Schnittstellen 
des Macintosh.

Momentan wird keine RÅcksicht darauf genommen, ob bereits ein 
Macintosh-Programm auf der Mac-Schnittstelle arbeitet.


Voraussetzungen
---------------
Es ist eine MagiCMac-Version ab 1.0.2 aufwÑrts erforderlich. Ablesbar ist 
die Version im Infofenster das der Finder anzeigt, wenn man das 
MagiCMac-Ikon selektiert und im MenÅ Ablage/Information auswÑhlt.

Da es die Behnes immer noch nicht geschafft haben, im MagiC (leider auch 
nicht in Version 4) die erweiterten XBIOS-Bconmap-Funktionen einzubauen, 
ich endlich mehr als einen Treiber bereitstellen und mir dabei nicht mit 
Sonderbehandlungen die Zeit stehlen will, muû ab 1995-02-14 
(MACM1-Version) das Programm DRVIN.PRG vor diesem Treiber gestartet 
werden.

Es handelt sich bei diesem DRVIN.PRG um eine reduzierte Variante, die nur 
unter MagiCMac und anderen MagiC3-Versionen lÑuft. Das normale DRVIN.PRG 
aus den HSMODA-Paketen lÑuft auch unter MagiCMac, enthÑlt aber zusÑtzliche 
Teile fÅr TOS und MagiC2, die hier nicht erforderlich und deshalb im hier 
beiliegenden DRVIN nicht enthalten sind.


Installation
------------
Vor den Treibern (z.B. MACM1.PRG) muû DRVIN.PRG gestartet werden. Am 
Besten ist es im AUTO-Ordner aufgehoben. Die Reihenfolge der 
ProgrammausfÅhrung im AUTO-Ordner ist in den MagiCMac-Versionen 
unterschiedlich! Vor 1.2 wurden die Programme in alphabetischer 
Reihenfolge ausgefÅhrt, ab 1.2 werden sie in der Reihenfolge ausgefÅhrt, 
die in der Datei AUTOEXEC.BAT angegeben ist. Bei Fehlen dieser Datei ist 
die Reihenfolge umgekehrt-alphabetisch. Siehe dazu die jeweiligen 
MagiCMac-Dokumentationen. Gegebenenfalls mÅssen also die Programme 
umbenannt werden.

MACM1.PRG gehîrt in den AUTO-Ordner. Es lÑût sich aber auch als 
Autostart-Applikation oder vom Desktop aus starten.

MACM1 in diesem Archiv ist mîglichst kompatibel konfiguriert, da nicht 
alle Mîglichkeiten auf allen Mac existieren. Dies betrifft u.a. Baudraten 
Åber 57600 und die DCD-Erkennung. Siehe dazu den Abschnitt 
"Konfiguration".


Einfachste Installation
-----------------------
DRVIN.PRG und MACM1.PRG in den AUTO-Ordner kopieren, so daû DRVIN.PRG vor 
MACM1.PRG ausgefÅhrt wird (siehe "Installation").

Im MagiCMac-MenÅ unter Einstellungen/Systemparameter/AUX: die zu 
benutzende Mac-Schnittstelle einstellen.

MagiCMac beenden und erneut starten. Jetzt steht ein SERSOFST-konformer 
Treiber mit dem GEMDOS-Namen MODEM1 und der BIOS-Nummer 6 bereit, der auf 
der im MagiCMac-MenÅ eingestellten Mac-Schnittstelle arbeitet. So sollte 
der "genÅgsame" Nutzer erstmal arbeiten kînnen.


KompatibilitÑt
--------------
Auf Atari-Seite wird SERSOFST.TXT realisiert, so daû alle sauberen 
Programme (diesbezÅglich) laufen. ZusÑtzlich werden die BIOS-Funktionen 
sowie XBIOS-Rsconf und Iorec realisiert. Es handelt sich bei MACM1 nicht 
um einen MODEM1-Emulator, d.h. Programme, die direkt oder Åber einige 
XBIOS-Funktionen auf den MFP oder den Soundchip zugreifen wollen, laufen 
nicht.

Auf Macintosh-Seite sind alle unsauberen Sachen abschaltbar, so daû in der 
sichersten, aber funktionsÑrmsten, Konfiguration nur die 
Devicedriver-Aufrufe fÅr den seriellen Treiber (.AIn, .AOut, .BIn, .BOut) 
benutzt werden.


Laufende Software
-----------------
Connect 2.46 funktioniert. Es nutzt leider neben den GEMDOS-Funktionen 
auch BIOS-Funktionen, ist also nicht besonders sauber.

MIDI_COM (Netzwerksoft) lÑuft mit dem universellen MCTR-U:\DEV\-Treiber von 
Harun Scheutzow.

GSZRZ lÑuft und benutzt ganz sauber nur GEMDOS-Funktionen.

Die eben benannten Programme habe ich selbst getestet. Die folgenden 
Programme mÅûten laufen, was ich aber nicht selbst getestet habe. Ich 
mîchte die Nutzer mit Email-Mîglichkeit bitten, mir eine solche zukommen 
zu lassen, wenn sie eines der folgenden Programme oder nicht genannte 
Programme mit Nutzung serieller Schnittstellen unter MagiCMac zu 
laufen haben. Ich werde das Programm in die Liste aufnehmen, mîglichst mit 
Hinweis zu eventuellen Besonderheiten und mit Nennung des Testers.

CoMa
Teleoffice ab Version 3 (BIOS-Nummer 6 muû unbedingt belegt sein!)

Generell sollten alle Programme laufen, die nur die in SERSOFST.TXT 
definierten GEMDOS-Schnittstellen oder die alten BIOS-Schnittstellen 
benutzen.


Schnittstellenauswahl
---------------------
Viele Mac besitzen zwei serielle Schnittstellen, auf der ComputerrÅckseite 
beschriftet mit einem Telefonhîrersymbol (Modem) und einem 
Drucker-mit-Papier-Symbol (Drucker). MacOS-intern wird nur die 
Modem-Schnittstelle bei langen Interruptsperren abgefragt, so daû Modem 
beim Empfang nicht so anfÑllig fÅr Zeichenverluste ist wie Drucker. Beim 
Senden verhalten sich beide Schnittstellen gleich.

MACM1 benutzt die im MagiCMac unter Einstellungen/Systemparameter/AUX: 
eingestellte Schnittstelle, wenn im MACM1 USEAUX=Ja konfiguriert ist. Die 
MagiCMac-AUX-Einstellung wird beim Start von MACM1 in einen eigenen Puffer 
Åbernommen so daû nachtrÑgliche énderungen im MenÅ nach dem Starten von 
MACM1 wirkungslos sind. Es ist nicht sehr sinnvoll, MACM1 so konfiguriert 
zu starten, wenn im MenÅ "nicht verwendet" eingetragen ist.

Modem heiût im Mac intern ".AOut" / ".AIn" und Drucker ".BOut" / ".BIn". 
Nur wenn eine dieser beiden Schnittstellen eingestellt ist, wird MACM1 den 
SCC-Direktzugriff versuchen, wenn es entsprechend konfiguriert wurde, 
siehe "Konfiguration".

Wenn normal (nicht Åber einen gewissen Router) LocalTalk aktiviert ist, 
dann ist Drucker gesperrt, selbst wenn man LocalTalk Åber Modem betreibt 
(das ist eben MacOS). MACM1 kann die Schnittstelle nicht îffnen und gibt 
deshalb eine GEMDOS-Fehlermeldung zurÅck, worauf z.B. Connect 2.46 leider 
einen direkten Hardwarezugriff probiert -> rums.


Standard-Konfiguration
----------------------
Die Grundeinstellungen des MACM1.PRG, so wie ich es als Archiv einpacke, 
sind kompatibel aber funktionsarm.
- GPi-Eingang nicht verwendet
- hîchste Baudrate ist 57600
- GEMDOS-Name MODEM1
- BIOS-Nummer 6 (altes GerÑt 6 wird Åberschrieben)
- Mac-Schnittstelle wird im MagiCMac-MenÅ unter
  Einstellungen/Systemparameter/AUX: eingestellt
- Schnittstellenfreigabe im MagiCMac-MenÅ mîglich


Konfiguration
-------------
MACM1.PRG wird wie die Treiber des HSMODA-Paketes auf dem Atari mit 
einem extra Programm, dem einfachen SETTER.TTP oder dem GEM-konformen 
SETTER.PRG konfiguriert. Die Funktion der SETTER.*-Programme ist in ihren 
Dokumentationen beschrieben.

Jeder Konfigurationspunkt hat eine AbkÅrzung, die hier mit nÑheren 
ErklÑrungen aufgefÅhrt ist.

NR6
- -
Mit der Grundeinstellung "Ja" belegt der Treiber die BIOS-Nummer 6 auf 
Atari-Seite. Dies darf nur in einem _aller_ seriellen Treiber passieren. 
Der Treiber MFP.PRG fÅr die STout-Hardware belegt automatisch die Nr.6, so 
daû bei seiner Nutzung alle MACM1.PRG(-Kopien) auf "Nein" stehen mÅssen.

Bei "Nein" nutzt MACM1 die jeweils nÑchste freie BIOS-Nummer ab 7 aufwÑrts 
und belegt diese. (Nr.6 ist immer belegt, aber ohne einen Treiber nicht 
sinnvoll belegt, so daû man mit dem ausschlieûlichen Einsatz zweier auf 
"Nein" gesetzter MACM1.PRG eine Situation Ñhnlich der im Falcon erzeugt, 
die nicht ganz saubere Programme wie Connect 2.46 zum Absturz bringen 
kann.)

USEAUX
- - - -
Die Grundeinstellung ist "Ja" und bewirkt die Nutzung der im MagiCMac-MenÅ 
Einstellungen/Systemparameter/AUX: eingestellten Mac-Schnittstelle auf 
Atari-Seite. Die INDRV/OUTDRV-Konfigurationen werden ignoriert. Diese 
Schnittstelle lÑût sich im MagiCMac-MenÅ "freigeben".

Die alternative Einstellung "Nein" nutzt die bei INDRV/OUTDRV 
eingestellten Mac-Schnittstellennamen.

INDRV
- - -
Wenn USEAUX=Ja, dann wird der hier eingetragende Name des Eingabetreibers 
einer Mac-Schnittstelle benutzt. FÅr die Modem-Schnittstelle ist das 
".AIn", fÅr Drucker ".BIn". Bitte auf exakte Schreibung achten. Wer auf 
seinem Mac weitere Schnittstellen hat und deren Treibernamen kennt (also 
nicht das, was dem User vorgesetzt wird (z.B. "Druckeranschluû"), sondern 
der Name, der dem MacOS bei PBOpen Åbergeben wird), kann je einen 
MACM1-Treiber dafÅr konfigurieren. Es stehen 31 Zeichen zur VerfÅgung.

OUTDRV
- - - -
Siehe INDRV, aber der MacOS-Name des Ausgabetreibers. ".AOut" fÅr Modem 
und ".BOut" fÅr Drucker.

GNAME
- - -
Hier wird der GEMDOS-Name des Schnittstellentreibers eingetragen. Standard 
ist MODEM1. Jeder Treiber muû natÅrlich seinen eigenen Namen haben. Dieser 
Name wird immer ausgewertet und ist nach dem Treiberstart im Verzeichnis 
U:\DEV\ zu finden.

DTR
- -
Dies ist momentan noch bedeutungslos.

MACBUF
- - - -
gibt die Grîûe des seriellen Empfangspuffers auf MacOS-Seite vor. 
Empfehlung: 8192. In diesem Puffer legen die MacOS-Empfangsroutinen die 
Daten ab. MACM1 holt sie von dort. Die Grîûe kann von Atari-Programmen 
_nicht_ verÑndert werden. Sinnvoll sind Werte von 1024 bis 8192, wie man 
sie bei Atari-HSMODA-Treibern fÅr RBL (Empfangspuffergrîûe) einstellen 
wÅrde oder wie sie auf einem Atari von den Programmen selbst eingestellt 
wÅrden. Maximal mîglich sind 32000 Byte.

RBL
- -
ist momentan bedeutungslos. Empfehlung: auf 256 einstellen. Es wird nur 
einfach Speicher (16 bis 65534 Byte) belegt, der im Empfangs-IOREC 
eingetragen wird. Dieser Speicher wird jedoch ebenso wie die Zeiger des 
Empfangs-IOREC nicht benutzt. Sinnigerweise kînnen Atari-Programme die 
Grîûe dieses Speichers Ñndern.

TBL
- -
legt die Grîûe des Atari-kompatiblen Sendepuffers fest. Dieser Wert kann 
von Atari-Programmen geÑndert werden. Minimum ist 16, Maximum ist 65534 
Byte. Sinnvoll sind Werte von etwa 2048 bis zu 8192. Wenn das DFö-Programm 
(z.B. Terminalprogramm) diesen Puffer selbst vergrîûern kann, wie z.B. 
Connect oder GSZRZ, sollte man 256 einstellen. So wird nur dann mehr 
Speicher belegt, wenn das DFö-Programm lÑuft. Dieser Treiber Åbergibt dem 
MacOS immer StÅcke dieses Puffers zum Senden.

EOP
- -
Dies ist ein komplizierter MenÅpunkt, mit dem gescheiterten Versuch einer 
einfachen ErklÑrung. Das Atari-TOS und das MacOS unterscheiden sich 
nÑmlich wesentlich in der Behandlung unbenutzter, d.h. auf 
Betriebssystem-Ebene (beim Atari GEMDOS) geschlossener, Schnittstellen. 
Der Atari empfÑngt auch bei geschlossener Schnittstelle in den 
Empfangspuffer, und kann ebenfalls noch im Sendepuffer befindliche Zeichen 
senden. Beim MacOS ist die Schnittstelle quasi abgeschaltet, wenn man den 
Treiber schlieût, d.h. es wird nicht gesendet oder empfangen.

Wird die Schnittstelle von Atari-Seite auch nur einmal Åber das BIOS 
angesprochen, dann bleibt sie auf MacOS-Seite ohnehin immer offen 
(unabhÑngig von GEMDOS-Fopen/Fclose), denn dieser Treiber kann nicht 
feststellen, wann sie geschlossen werden dÅrfte. Eine auf MacOS-Seite 
offene Schnittstelle verhÑlt sich auf Atari-Seite so, wie eine 
Atari-Schnittstelle generell.

"Ja" legt fest, daû die Schnittstelle auf MacOS-Seite auch nach einem 
GEMDOS-Fopen stÑndig offen bleibt, d.h. bei GEMDOS-Fclose nicht 
geschlossen wird. Diese Einstellung sollte man wÑhlen, wenn man ein 
Programm benutzt, das wÑhrend seiner Laufzeit die Schnittstelle 
zwischenzeitlich schlieût, aber sie nicht "abschalten" mîchte. Diese 
Einstellung ist immer gut, wenn man _kein_ Mac-(DFö)-Programm auf dieser 
Schnittstelle nutzt. SPéTER wird eine offene Schnittstelle eventuell 
Mac-seitige Programme davon abhalten, diese Schnittstelle zu benutzen. 
Momentan ist das nicht der Fall, was durchaus beim ZurÅckschalten auf 
MagicMac zu einigen Fehlfunktionen fÅhren kann, da Puffergrîûen verstellt 
sein kînnten oder die Schnittstelle MacOS-seitig sogar geschlossen wurde.

"Nein" legt fest, daû die Schnittstelle bei GEMDOS-Fclose geschlossen 
wird, wenn sie nur durch Fopen geîffnet wurde. Ist nutzbar, wenn ein 
DFö-Programm die Schnittstelle stÑndig offen hÑlt, solange es irgendwas 
von der Schnittstelle will. Mit dieser Einstellung und Atari-seitig 
ausschlieûlich DFö-Programmen, die nur das GEMDOS zum Ansprechen der 
Schnittstelle nutzen, kann man die Schnittstelle problemlos abwechselnd 
Atari- und Mac-seitig benutzen.

???<Notiz> Eventuell sollte man vor Fclose, falls GEMDOS auf/zu gewÑhlt 
wurde, nicht einfach Ausgabe-KillIO machen, sondern erst noch etwas 
warten, bis Daten gesendet wurden - schlieûlich wÅrde ein Atari auch noch 
alles senden, wenn die Puffer nicht verÑndert werden.???

DIR
- -
erlaubt ("Ja") oder verbietet ("Nein") den Direktzugriff auf den SCC des 
Mac. Der Direktzugriff ist bei Mac mit IOP nicht mîglich, z.B. IIfx, 
Quadra900, Quadra950. Eigentlich sollte der Treiber automatisch 
feststellen, wenn der Zugriff unmîglich ist, aber mit "Nein" kann man ihm 
diesen Versuch ersparen, der in extrem ungÅnstigen FÑllen zum Absturz 
fÅhren kann. Ich bin mir nicht sicher, was bei Mac mit Geoport passiert. 
Eigentlich sollten diese SCC-kompatibel sein.

FÅr die Mac mit IOP gibt es ein Kontrollfeld "serial switch", mit dem der 
Direktzugriff auf den SCC freigeschaltet werden kann. Die entsprechende 
Einstellung mÅûte "compatibility mode" heiûen.

DCD
- -
Leider besitzen nicht alle Mac auf der MODEM-Schnittstelle den 
Åblicherweise als DCD (data carrier detect) benutzten GPi-Eingang. Zu 
allem öberfluû lÑût sich GPi nicht Åber das MacOS abfragen, so daû ein 
direkter SCC-Zugriff erforderlich ist, siehe Konfigurationspunkt "DIR". 
"Ja" = GPi-Eingang ist vorhanden, "Nein" = Eingang nicht vorhanden. "Nein" 
wird automatisch angenommen, wenn "DIR" auf "Nein" steht. NatÅrlich muû 
das Kabel die entsprechende Verdrahtung aufweisen, was bei gekauften 
Kabeln nicht immer der Fall ist. Zur Verdrahtung siehe 
"Schnittstellenbelegung und Kabel".

HBD
- -
erlaubt oder verbietet die Einstellung der vom MacOS nicht (/immer) 
unterstÅtzten hohen Baudraten 115200 und 230400. "Ja" erlaubt die 
Einstellung, die IN DIESER TREIBERVERSION AUSSCHLIESSLICH durch 
SCC-Direktzugriff erfolgt, und deshalb bei Mac mit IOP nicht 
mîglich ist. "Nein" verbietet die hohen Baudraten, so daû maximal 57600 
mîglich sind, die auf allen Mac sauber Åber das MacOS eingestellt werden 
kînnen. "Nein" ist die sichere Variante.

MIDI
- - -
Wenn direkter SCC-Zugriff erlaubt ist, wird mit "Ja" die Baudrate 28800 
durch "externer Takt / 32" ersetzt. Wenn eines der Åblichen 
Mac-MIDI-Interfaces einen externen 1-MHz-Takt anlegt, so ergibt sich die 
MIDI-Datenrate 31250. MACM1 realisiert ABER NOCH KEINE 
Atari-MIDI-Schnittstelle, es fehlen die speziellen BIOS/XBIOS-Funktionen!


Benutzung mehrerer Schnittstellen (Weitere Treiber)
---------------------------------------------------
MACM1.PRG ist ein universeller, einstellbarer Treiber, der fÅr 
verschiedene Schnittstellen nutzbar ist. Ein MACM1 bedient dabei immer nur 
eine Schnittstelle. Wenn man mehrere Mac-seitige Schnittstellen bedienen 
will, legt man zuerst eine entsprechende Anzahl von MACM1.PRG-Kopien unter 
verschiedenen Namen an. Die Namen kînnen ziemlich frei gewÑhlt werden.

Ein MACM1 sollte man auf USEAUX=Ja konfigurieren. Ebenfalls nur ein MACM1 
sollte man auf NR6=Ja konfigurieren, falls man keinen anderen 
Schnittstellentreiber benutzt, der die BIOS-Nummer 6 belegt, wie z.B. 
MFP.PRG fÅr die McSTout-Hardware. Alle anderen MACM1-Kopien werden auf 
USEAUX=Nein und bzw oder NR6=Nein eingestellt und bekommen ihre 
Mac-Schnittstellen in INDRV/OUTDRV mitgeteilt.

NatÅrlich muû man ebenfalls einmalige GEMDOS-Namen bei GNAME fÅr jeden 
Treiber einstellen. Diese GNAME sind ebenfalls frei wÑhlbar innerhalb
der TOS/DOS-BeschrÑnkungen fÅr Filenamen. Mit 
Fantasienamen (andere als MODEM1, MODEM2, SERIAL1, SERIAL2, LAN, MIDI) 
werden aber nur Programme klarkommen, die sich des RSVF-Cookies zur 
Schnittstellenfindung bedienen, was z.B. Connect und CoMa tun.

Nach dem DRVIN.PRG werden alle diese vorbereiteten MACM1-Kopien in den 
AUTO-Ordner kopiert. Dabei bestimmt die Reihenfolge des Starts die 
BIOS-Nummern der Schnittstellen, deren Treiber mit NR6=Nein konfiguriert 
sind. Diese erhalten aufsteigende Nummern ab 7.


MacOS-seitiges Schlieûen und das Beenden von MagiCMac-Ende
----------------------------------------------------------
Wenn MagiCMac beendet wird, wird eine eventuell MacOS-seitig offene 
Schnittstelle auf jeden Fall automatisch geschlossen. Dies machen 
alle MACM1-Treiber und -kopien.

!!! Folgendes gilt _nur_ bei der Konfiguration USEAUX=Ja !!!
Der MagiCMac-MenÅpunkt Aktionen/Ser.Port freigeben schlieût die 
Schnittstelle ebenfalls MacOS-seitig. Der Nutzer ist fÅr seine Handlungen 
selbst verantwortlich, da auf diese Weise eine eventuell Åber die 
Schnittstelle bestehende Verbindung abgebrochen wird. Wenn man zurÅck in 
die MagiCMac-Umgebung wechselt, wird die Schnittstelle MacOS-seitig wieder 
geîffnet, falls sie vor der Auswahl des MenÅpunktes "... freigeben" offen 
war. Auch hier ist der Nutzer fÅr alles selbst verantwortlich. Es sind 
Fehlfunktionen zu erwarten, wenn z.B. ein Mac-seitiges Programm die 
Schnittstelle blockiert oder die Schnittstelle auf Mac-Seite nicht mehr 
existiert.


Lîschen?
--------
Dies dÅrfte fÅr den normalen Nutzer nur interessant sein, wenn er 
USEAUX=Nein konfiguriert hat und die Schnittstelle trotzdem MacOS-seitig 
schlieûen mîchte.

### wer unbedingt sein PowerBook einschlafen lassen muûte, sollte nach dem 
Aufwachen ebenfalls die Schnittstellen in den MÅlleimer befîrdern ###
(ErfahrungsgemÑû verhindert das einige AbstÅrze oder Fehlfunktionen. Eine 
Lîsung gibt es wahrscheinlich spÑter mal.)

Dieser Treiber lÑût sich momentan nicht lîschen. Bei einem Lîschversuch 
wird jedoch die Schnittstelle MacOS-seitig geschlossen, auch wenn sie Åber 
BIOS-Funktionen benutzt wurde oder der Konfigurationspunkt EOP auf "Ja" 
eingestellt ist. Der Treiber bleibt voll funktionsfÑhig.

Den Lîschversuch kann man vom Desktop aus durchfÅhren. Laufwerk U: wird 
geîffnet, eine eventuelle "Daten auf Disk A defekt" Meldung wird mit 
"Abbruch" beantwortet. Im Laufwerk U: wird der Ordner "DEV" geîffnet. Das 
darin gefindliche File mit dem bei der Konfiguration unter GNAME 
eingestellten Namen, z.B. MODEM1, versucht man ganz normal zu lîschen, 
also ab in den MÅlleimer. Das ist alles. Das File ist jedoch weiterhin 
vorhanden, da der Treiber nicht gelîscht wurde, was einige Desktops mit 
einer Fehlermeldung quittieren.


Fehlermeldungen wÑhrend des Betriebs
------------------------------------
Normalerweise gibt MACM1.PRG nur wÑhrend des Startens lesbare Meldungen 
und Fehlermeldungen aus. In einigen "unmîglichen" Situationen gibt es aber 
auch danach Meldungen. Wenn man so etwas Unerfreuliches wie "************ 
MACM1 Error: " auf den Desktop bekommt, sollte man die Meldung notieren 
und sich Åberlegen und mîglichst notieren, was der Computer davor getan 
hat.

So eine Meldung fÅhrt nicht zwangsweise zum Absturz, ist aber eine ernste 
Warnung, auf die der Nutzer mit einer Sicherung noch nicht gespeicherter 
Daten und einem baldigen Neustart von MagiCMac reagieren sollte.


SCC - Serial Communication Controller
-------------------------------------
Der SCC realisiert zwei bidirektionale serielle Schnittstellen mit einigen 
Steuerleitungen. Er oder eine kompatible Weiterentwicklung kommen in allen 
Mac-Modellen zum Einsatz, entweder direkt als einzelner Schaltkreis oder 
integriert in einen Custom-Chip. Der originale SCC Z8530 oder Am85C30 hat 
nur 1 Zeichen Sende"FIFO" und 3 Zeichen EmpfangsFIFO. Weiterentwicklungen 
haben 4 oder 8 Zeichen SendeFIFO und 8 Zeichen EmpfangsFIFO.


IOP und das "Serial Switch"-Kontrollfeld
----------------------------------------
Bei einigen Ñlteren Mac-Modellen, es handelt sich wohl ausschlieûlich um 
IIfx, Quadra 900, Quadra 950 und davon abgeleitete Workgroupserver, kann 
der Datentranfer vom und zum SCC durch einen IOP (Input Output Processor) 
Åbernommen werden. Dies soll die CPU wesentlich entlasten. Leider ist der 
SCC in dieser Betriebsart nicht direkt durch die CPU erreichbar, so daû 
direkte SCC-Zugriffe und damit die GPi/DCD-Abfrage nicht mîglich sind.

Die Benutzung des IOP und damit auch die Zugriffsmîglichkeit der CPU auf 
den SCC lassen sich mit dem Kontrollfeld "Serial Switch" einstellen. Die 
Einstellung "Compatible" bedeutet IOP nicht benutzen und direkte 
SCC-Zugriffe ermîglichen. Die Einstellung "Faster" bedeutet IOP benutzen 
und direkte SCC-Zugriffe sind unmîglich. Die Einstellung wird im PRAM des 
Mac gespeichert und beim Neustart des Mac wirksam.


DMA, SerialDMA Systemerweiterung
--------------------------------
Bei den im Folgenden aufgelisteten Mac-Modellen wird der SCC durch einen 
DMA-Controller unterstÅtzt. Dabei sind direkte Zugriffe der CPU auf den 
SCC weiterhin mîglich. Der DMA-Controller soll die Daten zwischen SCC und 
Hauptspeicher transportieren und so die CPU entlasten.

Mac-Modelle mit DMA fÅr die seriellen Schnittstellen
Centris 660av, Quadra 840av. Dies sind wohl die einzigen 68k-Macs mit DMA. 
UnterstÅtzt DMA hier nur Modem-Port oder auch Printer???
alle PowerMac mit Nubus (wirklich alle???)
alle PowerMac mit PCI-Bus

Es gibt eine Systemerweiterung mit dem Namen SerialDMA. Es handelt sich 
dabei einfach um ein Update fÅr die seriellen Treiber des MacOS fÅr Macs 
mit DMA. Es soll in der Version 2.0.2 wesentliche Vorteile haben, auch 
gegenÅber der Version 2.0.1, insbesondere auf PCI-Mac. Es ist u.a. im 
Printing Fix (oder hieû er Printing Update ...) 1.1 fÅr MacOS 7.5.2 zu 
finden. Es soll im System 7.5.3 bereits mit integriert sein.


Besonderheiten und Hinweise fÅr Programmierer
---------------------------------------------
Der Ausgang DTR ist nur beeinfluûbar und als I/O-Line vorhanden, wenn der 
Hardwarehandshake nicht eingeschaltet ist.

Hardwarehandshake ist der Mac-bekannte DTR/CTS-Handshake.

Empfangsfehler und Break lassen sich erfragen.

Im IOREC wird nur der Ausgabepuffer benutzt, der auch von Programmen in 
der Grîûe geÑndert werden kann. Die Eingabepufferwerte im IOREC sind 
bedeutungslos.

Die Eingabepuffergrîûe ist momentan unverÑnderlich fest auf dem 
konfigurierten Wert.

Der Treiber belÑût das ursprÅngliche RSVF-Ende-Objekt am Ende der Kette, 
damit man spÑter auch eine Lîschbarkeit realisieren kann. Momentan ist der 
Treiber _nicht_ lîschbar.

Siehe unbedingt "MagiC Version 3, Fopen-Behandlung".


MagiC Version 3, Fopen-Behandlung
---------------------------------
Die auf dem Atari unter TOS und MagiC vor Version 3 zur 
GEMDOS-GerÑteverwaltung benutzte Hilfseinrichtung DRVIN kÅmmerte sich 
Åberhaupt nicht um den Fopen-Modus und darum, wie oft ein GerÑt geîffnet 
wurde. MagiC3 erlaubt im von vielen Programmen benutzten Modus 2 (Lesen 
und Schreiben) jedoch nur das einmalige ôffnen eines GerÑtes. Startet z.B. 
ein Terminalprogramm ein Protokoll als externes Programm und hat ein GerÑt 
mit Modus 2 offen, so kann das Protokoll das GerÑt nicht nochmal îffnen. 
Deshalb lÑût sich unter MagiC3 z.B. GSZRZ nicht vernÅnftig unter 
Connect2.46 starten. Connect2.46 selbst hat auch noch einige Probleme wegen 
Programmierfehlern beim Schnittstellenîffnen und -schlieûen.

Es gibt mehrere Lîsungsmîglichkeiten:

a) Das Terminalprogramm Åbergibt an das externe Protokoll das Filehandle 
der offenen Schnittstelle. Das externe Protokoll arbeitet nur mit diesem 
Handle, das automatisch vererbt werden mÅûte, und benutzt kein 
Fopen/Fclose auf diesem GerÑt. Sauberste Variante.

b) Das Terminalprogramm schlieût die Schnittstelle vor dem Start des 
Protokolls. Das Protokoll îffnet, arbeitet, schlieût, beendet sich. 
Terminalprogramm îffnet wieder. (MACM1-Konfigurationspunkt EOP sollte bei 
dieser Verfahrensweise auf "Ja" stehen.)

c) Das Terminalprogramm îffnet mit "mode OR $40", also "Filesharing - alles 
erlaubt". Das Protokoll muû ebenfalls mit "mode OR $40" îffnen. Solange 
das Protokoll lÑuft, darf das Terminalprogramm natÅrlich nicht auf der 
Schnittstelle fummeln.

d) Ein Patch sorgt dafÅr, daû Lîsung c) ohne Wissen und Mitwirkung der 
Programme benutzt wird. Dies ist eine schweinische Lîsung. Siehe "Das 
Schwein"


Das Schwein (SCHWEIN.PRG)
-------------------------
Da einige Terminalprogramm- und Protokollprogrammierer wohl keine Lust 
haben oder langsam sind, habe ich das Programm SCHWEIN.PRG geschrieben. Es 
sollte zusammen mit einer Dokumentation beiliegen oder irgendwo als Archiv 
SCHWEIN.LZH o.Ñ. aufzutreiben sein.

#### Das separate Schwein dÅrfte hier durch den Konfig-Punkt HOG 
ÅberflÅssig werden.

Es/er lîst Probleme wie "GSZRZ lÑuft nicht unter Connect2.46".


Baudraten
---------
Mit GEMDOS Fcntl TIOCIBAUD/TIOCOBAUD lassen sich die Baudraten erfragen, 
so daû sie durch saubere Programme automatisch bestimmt und angezeigt 
werden. Es wurden einige Baudraten durch andere ersetzt. Diese Info 
braucht man aber nur fÅr XBIOS Rsconf.
Original-Atari  MagicMac
    200          230400 (nur wenn SCC-Direktzugriff erlaubt)
    150          115200 (nur wenn SCC-Direktzugriff erlaubt)
    134           57600
    110           38400
     75           28800 (da 75 beim Mac nicht "sauber" einstellbar)
     50           14400 (da 50 beim Mac nicht "sauber" einstellbar)


Leistungen
----------
Ich habe mit einer MagiCMac-Betaversion auf einem Performa475 getestet. 
Benutzt wurde der MODEM-Port und das Connect-interne Zmodem empfing direkt 
auf Platte. Bei 115200Bd war fehlerfreier Empfang mîglich, bei 230400 gab 
es jedoch alle paar Sekunden Fehler durch Zeichenverluste. Zterm auf 
Macintosh-Seite kann jedoch auch bei 230400Bd fehlerfrei auf Platte 
empfangen. Hier bremst also der Emulator. Ebenfalls wird das Senden 
gebremst, wo bei jedem Interrupt fÅr jedes einzelne Zeichen umgeschaltet 
wird. Connect kommt nur auf 10200cps bei 230400Bd, soviel schafft es auch 
auf einem ST mit 8MHz, wobei auf TTs mehr als 19000cps erreicht werden. 
Wenn die Umschalterei sich irgendwie optimieren lÑût, mÅûten hier 
ebenfalls wesentlich hîhere Datenraten erreichbar sein.

Die Umschalterei wurde optimiert, so daû Connect inzwischen mit etwa 
20000cps auf meinem P475 sendet und dabei das Mac-seitige ZTerm1.03beta 
Åbertrifft!


Probleme
--------
Fehler- und Problemmeldungen bitte mit mîglichst genauer Schilderung des 
Sachverhaltes (Mac-Typbezeichnung, MACM1 wie konfiguriert, wie gestartet, 
welches DFö-Programm, wann tritt welches Problem auf, ...)

Ein mîgliches Problem fÅr viele Programme ist die bei MagiC Version 3, 
MagiCMac ist ein MagiC Version 3, gegenÅber DRVIN strenger gehandhabte 
Verwaltung des ôffnens von GerÑten. Siehe unter "Besonderheiten und 
Programmierhinweise".

Es wÑre nett, wenn ich auch ein paar Mitteilungen bekommen wÅrde, wenn 
MACM1 problemlos funktioniert, mit Angabe des Mac-Typs und der 
Konfiguration.


Autor und Rechtliches
---------------------
Dieser Treiber und die Anleitung wurde von mir, Harun Scheutzow, fÅr den 
Atari-Emulator MagiCMac geschrieben. Ich Åbernehme keinerlei Garantien und 
Haftungen. Die (Nicht-)Benutzung erfolgt auf eigenes Risiko. Bei 
Treiberproblemen sollte man sich direkt an mich wenden, am besten per 
Email, oder per Post, bitte mit RÅckporto, wenn man eine Antwort erwartet. 
Allgemeine MagiCMac-Probleme bitte dem MagiCMac-Autor Thomas Tempelmann 
oder dem Vertrieb ASH mitteilen.

Dieses Treiberpaket ist "frei" fÅr alle legalen MagiCMac-Benutzer.

Die öbersetzung dieser Dokumentation in andere Sprachen ist ausdrÅcklich 
erwÅnscht. Der öbersetzer muû darauf hinweisen, daû es sich um eine 
öbersetzung handelt und die Sprache angeben, aus der Åbersetzt wurde.

Email-Internet: Harun_Scheutzow@h.maus.de
Email-Mausnetz: Harun Scheutzow @H
Post:
Harun Scheutzow
Dresdener Straûe 83
10179 Berlin (, Deutschland)


Bemerkungen, die ich mir nicht verkneifen kann
----------------------------------------------
Der SCC wurde in den 68k-Macs nicht optimal eingebunden. Seine und die 
FÑhigkeit der 68k-CPU vektorisierte Interrupts zu verwenden wird nicht 
genutzt.

Die Interruptroutinen sehen suboptimal aus.

Hoffen wir mal, daû irgendwann die Interruptroutinen der PowerMacs 
komplett in PowerPC-Code vorliegen und nicht mehr in emuliertem 68K-Code. 
Ich denke da besonders an die Performa 5200, 5300, 6200, 6300 Reihe, die 
ohne DMA auskommen (mÅssen).

Auch ohne DMA sind spÑtestens bei einer CPU ab 68040 25 MHz aufwÑrts 
230400 bps im Interruptbetrieb problemlos mîglich, wenn die Software 
(nicht nur die seriellen Routinen, sondern das komplette Betriebssystem) 
entsprechend "gut" gemacht sind. Leider ist das beim MacOS (bisher) nicht 
der Fall.


Schnittstellenbelegung und Kabel
--------------------------------
Anschluûbelegung der 8poligen Mini-DIN-Buchse des Mac
(im Folgenden "LAN")
  --***--
/ 8  7  6 \
|5    4  3|
\  2   1  /
  -------
Pin Name  Beschreibung
 1  HSKo  Output Handshake, DTR-Signal vom SCC
 2  HSKi  Input Handshake or External Clock, CTS-Signal zum SCC
 3  TXD-  Transmit Data -, Sendedaten negiert
 4  GND   Signal Ground
 5  RXD-  Receive Data -, Empfangsdaten negiert
 6  TxD+  Transmit Data +, Sendedaten nicht negiert
 7  GPi   General Purpose Input, DCD-Signal zum SCC
 8  RxD+  Receive Data +, Empfangsdaten nicht negiert
Bei neueren Mac ist zwischen 5 und 4 noch ein "Loch" fÅr +5V.

Nullmodem
- - - - -
Wenn man die LAN(RS422/423)-Schnittstelle mit einer RS232 verbinden will 
als Nullmodem mit Benutzung von Hardwarehandshake, sollte man verbinden:
LAN            RS232 (Buchse)
HSKo           CTS
HSKi           RTS
TXD-           RXD
TXD+   offen
RXD-           TXD
RXD+   GND
GND            GND

Modem
- - -
Ein Modemkabel sollte folgende Verbindungen enthalten:
LAN            RS232 (Stecker)
HSKo           RTS und DTR verbunden
HSKi           CTS
TXD-           TXD
TXD+   offen
RXD-           RXD
RXD+   GND
GND            GND
GPi            DCD

Anschluûbelegungen der 9 und 25 poligen RS232-Stecker und Buchsen:
Name   9polig-Pinnr.   25polig-Pinnr.
DCD        1              8
RXD        2              3
TXD        3              2
DTR        4             20
GND        5              7
DSR        6              6
RTS        7              4
CTS        8              5
RING       9             22

Man konfiguriert sein Modem und den Computer entweder auf 
Softwarehandshake (Modem soll RTS ignorieren) und kann das DTR-Signal zum 
Auflegen benutzen, oder man konfiguriert Modem und Computer auf 
Hardwarehandshake (Modem soll DTR ignorieren, wichtig!).

Eventuell kann es bei Modem-Kabel sinnvoll sein, GPi nicht als DCD-, 
sondern als RING-Eingang zu benutzen. Eine zukÅnftige Version von MACM1 
wird das eventuell alternativ unterstÅtzen - momentan wird es _NICHT_ 
unterstÅtzt.


Versionen
---------
Ich vergebe keine Versionsnummern. Die AktualitÑt lÑût sich anhand des 
Datums in der Startmeldung feststellen. Dieses Datum ist in der Form 
Jahr-Monat-Tag notiert mit vierstelliger Jahreszahl.

Harun Scheutzow, 1994-11-22 und spÑter

1994-11-25  sollte mit write back cache gehen, 115200 und 230400Bd drin
1994-12-18  automatische IOP-Erkennung, MacOS-Schlieûen beim Lîschversuch
1994-12-25  Cacheflush nochmal geÑndert
1995-01-11  "harmlosere" Grundeinstellung
1995-02-01  erfordert MagiCMac mit MgMc-Cookie, Beenden schlieût 
Mac-Schnittstelle, Einstellung des AUX im MagiCMac wird ausgewertet
1995-02-14  freie Wahl der Mac- und GEMDOS-Treiber-Namen, benîtigt ab 
sofort DRVIN.PRG, mehrere Treiber mîglich
1995-02-20  XBIOS Rsconf setzt andere Raten als nur 19200 (Fehler raus)
1995-03-29  extra Konfig NR6 - getrennt von USEAUX
1995-07-13  Konfig MIDI eingebaut fÅr die Mac-MIDI-Interfaces
1995-12-06  Problem mit PCI-Mac gelîst (typische Erscheinungen: 
MagiCMac-Ende, seltsame AbstÅrze beim ôffnen der Schnittstelle)
1995-12-16  illegal-Befehle durch Meldungen ersetzt
1996-02-17  alle _Control von normal auf immediate umgestellt, dÅrfte 
einige "AufhÑngungspunkte" beseitigen
1996-03-17  Konfig HOG eingebaut
1996-04-13  Anzeige des MacOS-Treibernamens auch bei USEAUX=Ja
1996-04-16  unbeabsichtigten Absturz nach Laufzeit-Fehlermeldungen 
beseitigt
