; Byte Strangler Decrunch
;
; a0 = source
; a1 = destination
;

DECRUNCH
	MOVE.W	$FF8240,D7
	ADDQ.L	#4,A0
	MOVEM.L	(A0)+,D0-D1/D5
	MOVEA.L	A1,A2
	ADDA.L	D0,A0
	ADDA.L	D1,A2
	MOVE.L	-(A0),D0
	EOR.L	D0,D5
L4E3D8
	EOR	#$777,$FF8240
	LSR.L	#1,D0
	BNE.S	L4E3E0
	BSR	L4E46C
L4E3E0	BCS.S	L4E418
	MOVEQ	#8,D1
	MOVEQ	#1,D3
	LSR.L	#1,D0
	BNE.S	L4E3EE
	BSR.S	L4E46C
L4E3EE	BCS.S	L4E43E
	MOVEQ	#3,D1
	CLR.W	D4
L4E3F4	BSR.S	L4E478
	MOVE.W	D2,D3
	ADD.W	D4,D3
L4E3FC	MOVEQ	#7,D1
L4E3FE	LSR.L	#1,D0
	BNE.S	L4E404
	BSR.S	L4E46C
L4E404	ROXL.L	#1,D2
	DBF	D1,L4E3FE
	MOVE.B	D2,-(A2)
	DBF	D3,L4E3FC
	BRA.S	L4E44A
L4E412	MOVEQ	#8,D1
	MOVEQ	#8,D4
	BRA.S	L4E3F4
L4E418	MOVEQ	#2,D1
	BSR.S	L4E478
	CMPI.B	#2,D2
	BLT.S	L4E434
	CMPI.B	#3,D2
	BEQ.S	L4E412
	MOVEQ	#8,D1
	BSR.S	L4E478
	MOVE.W	D2,D3
	MOVE.W	#$C,D1
	BRA.S	L4E43E
L4E434	MOVE.W	#9,D1
	ADD.W	D2,D1
	ADDQ.W	#2,D2
	MOVE.W	D2,D3
L4E43E	BSR.S	L4E478
L4E440	SUBQ.W	#1,A2
	MOVE.B	0(A2,D2.W),(A2)
	DBF	D3,L4E440
L4E44A	
	CMPA.L	A2,A1
	BLT.S	L4E3D8
	TST.L	D5
	BNE.S	L4E45A
	MOVE.W	D7,$FF8240
	RTS
L4E45A	
	MOVE.W	#$700,$FF8240
	MOVEQ	#-1,D0
	RTS

L4E46C	MOVE.L	-(A0),D0
	EOR.L	D0,D5
	MOVE.B	#$10,CCR
	ROXR.L	#1,D0
	RTS
L4E478	SUBQ.W	#1,D1
	CLR.W	D2
L4E47C	LSR.L	#1,D0
	BNE.S	L4E48A
	MOVE.L	-(A0),D0
	EOR.L	D0,D5
	MOVE.B	#$10,CCR
	ROXR.L	#1,D0
L4E48A	ROXL.L	#1,D2
	DBF	D1,L4E47C
	RTS
