;
; Rob Northern Depack routine
;
; A0.L  holds start of packed data !!

start	MOVEM.L	D1-D4/A0-A4,-(A7)
	MOVEA.L	A0,A3
	ADDA.L	(A3)+,A0
	ADDQ.W	#4,A0
	MOVE.L	(A0)+,D1
	MOVE.L	(A0)+,D0
	MOVE.L	D0,-(A7)
	LEA	0(A0,D0.L),A2
	ADDA.L	#$100,A2
	ADDA.L	D1,A0
	MOVE.B	-(A0),D1
	MOVEQ	#0,D2
	MOVEQ	#7,D3
L30022	MOVEA.L	A3,A4
L30024	ADD.B	D1,D1
	BCC.S	L3002A
	ADDQ.W	#2,A4
L3002A	DBF	D3,L30032
	MOVEQ	#7,D3
	MOVE.B	-(A0),D1
L30032	MOVE.W	(A4),D4
	BMI.S	L3003A
	ADDA.W	D4,A4
	BRA.S	L30024
L3003A	TST.B	D2
	BMI.S	L30048
	CMP.W	#$F100,D4
	BNE.S	L3004E
	SUBQ.B	#1,D2
	BRA.S	L30022
L30048	ADD.B	D4,D2
	SUB.L	D2,D0
	MOVE.B	(A2),D4
L3004E	MOVE.B	D4,-(A2)
	DBF	D2,L3004E
	ADDQ.W	#1,D2
	SUBQ.L	#1,D0
	BNE.S	L30022
	LEA	-4(A3),A0
	MOVE.L	(A7)+,D0
	MOVEA.L	A0,A1
	ADDA.L	(A0),A0
	ADDA.L	#$10C,A0
	MOVE.L	A0,D2
	SUB.L	A1,D2
	MOVE.L	D0,D1
L30070	MOVE.B	(A0)+,(A1)+
	MOVE.B	(A1),$ffff8240.w	; Insert colour flash here
	SUBQ.L	#1,D1
	BNE.S	L30070
L30076	CLR.B	(A1)+
	SUBQ.L	#1,D2
	BNE.S	L30076
	MOVEM.L	(A7)+,D1-D4/A0-A4
	RTS
