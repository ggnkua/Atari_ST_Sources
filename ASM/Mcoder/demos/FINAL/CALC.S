;
; CALCUL DE LA MATRICE CONSTANTE DE PROJECTION
;
; CHANGE L'ANGLE DE ROTATION ET CALCULE LES SINUS ET COSINUS ASSOCIES
;
; SX=SIN/COS ANGLE X,SY=SIN/COS ANGLE Y,SZ=SIN/COS ANGLE Z
; L14=ANGLE ROT X,L16=ANGLE ROT Y,L3C=ANGLE ROT Z
; ROTX,ROTY,ROTZ=ANGLES COURANTS
;
SX	EQUR	D2
CX	EQUR	D3
SY	EQUR	D4
CY	EQUR	D5
SZ	EQUR	D6
CZ	EQUR	D7

;
; CHANGEMENT D'ANGLE DE ROTATION
;   (CONSTANTES POUR L'INSTANT)
;
	LEA	SINCOS(PC),A0
	NXTANG	ROTATEX,ROTX,SX/CX	;SX
	NXTANG	ROTATEY,ROTY,SY/CY	;SY
	NXTANG	ROTATEZ,ROTZ,SZ/CZ	;SZ
;
; CALCULE LA MATRICE DE PROJECTION
;
	LEA	NEW\W,A0

	MOVE	CY,D0
	MULS	CZ,D0
	ADD.L	D0,D0
	SWAP	D0
	MOVE	D0,(A0)+

	MOVE	SY,(A0)+

	MOVE	CY,D0
	MULS	SZ,D0
	ADD.L	D0,D0
	SWAP	D0
	NEG	D0
	MOVE	D0,(A0)+

	MOVE	SX,D1
	MULS	SZ,D1
	MOVE	CX,D0
	MULS	SY,D0
	ADD.L	D0,D0
	SWAP	D0
	MULS	CZ,D0
	SUB.L	D0,D1
	ADD.L	D1,D1
	SWAP	D1
	MOVE	D1,(A0)+

	MOVE	CX,D0
	MULS	CY,D0
	ADD.L	D0,D0
	SWAP	D0
	MOVE	D0,(A0)+	;$10

	MOVE	SX,D1
	MULS	CZ,D1
	MOVE	CX,D0
	MULS	SY,D0
	ADD.L	D0,D0
	SWAP	D0
	MULS	SZ,D0
	ADD.L	D1,D0
	ADD.L	D0,D0
	SWAP	D0
	MOVE	D0,(A0)+	;$14

	MOVE	CX,D1
	MULS	SZ,D1
	MOVE	SX,D0
	MULS	SY,D0
	ADD.L	D0,D0
	SWAP	D0
	MULS	CZ,D0
	ADD.L	D1,D0
	ADD.L	D0,D0
	SWAP	D0
	MOVE	D0,(A0)+	;$18

	MOVE	SX,D0
	MULS	CY,D0
	ADD.L	D0,D0
	SWAP	D0
	NEG	D0
	MOVE	D0,(A0)+	;$1C

	MOVE	CX,D1
	MULS	CZ,D1
	MOVE	SX,D0
	MULS	SY,D0
	ADD.L	D0,D0
	SWAP	D0
	MULS	SZ,D0
	SUB.L	D0,D1
	ADD.L	D1,D1
	SWAP	D1
	MOVE	D1,(A0)+	;$20

	LEA	INFINI,A1
	MOVE.L	CUROBJ\W,A2
	MOVE	(A2)+,D4
	LEA	NEW\W,A6
;
; REGISTRES UTILISES :
;	A0-A6 SAUF A1
;	A2 PEUT ETRE LIBERE
;
; 	D1-D7 SAUF D4
;
; registres libres :
;
;	A1,D0,D4
;
; REGISTRES UTILISES
;
; A6,A4,A2,A1
; D1,D2,D3,D6,D0,D7,D4
;
; D5/A0/A3/A5
;
RXMIN	EQUR	D5
RXMAX	EQUR	A0
RYMIN	EQUR	A3
RYMAX	EQUR	A5

	MOVE	#LARGEUR-1,RXMIN
	MOVE	#0,RXMAX
	MOVE	#HAUTEUR-1,RYMIN
	MOVE	#0,RYMAX
BCPTS:
	MOVE.L	A6,A4
	MOVEM	(A2)+,D1/D2/D3

	MOVE	D1,D6		;X
	MULS	(A4)+,D6
	MOVE	D2,D0
	MULS	(A4)+,D0
	ADD.L	D0,D6
	MOVE	D3,D0
	MULS	(A4)+,D0
	ADD.L	D0,D6

	MOVE	D1,D7		;Y
	MULS	(A4)+,D7
	MOVE	D2,D0
	MULS	(A4)+,D0
	ADD.L	D0,D7
	MOVE	D3,D0
	MULS	(A4)+,D0
	ADD.L	D0,D7

	MULS	(A4)+,D1	;Z
	MULS	(A4)+,D2
	ADD.L	D2,D1
	MULS	(A4)+,D3
	ADD.L	D3,D1

	SWAP	D1
	SUB	DIST\W,D1

	ASR.L	#8,D6
	ASR.L	#8,D7
	DIVS	D1,D6
	DIVS	D1,D7

	ADD	#LARGEUR/2,D6
	ADD	#HAUTEUR/2,D7

	IFNE	FINAL
	CMP	#LARGEUR,D6
	BLO.S	.1
	SGE	D6
	EXT	D6
	AND	#LARGEUR-1,D6
	ADDQ	#7,$FFFF8240.W
.1
	ENDC

	MOVE	D6,(A1)+
	MOVE	D7,(A1)+

	CMP	RXMIN,D6
	BGE.S	.NOX1
	MOVE	D6,RXMIN
.NOX1
	CMP	RXMAX,D6
	BLE.S	.NOX2
	MOVE	D6,RXMAX
.NOX2
	CMP	RYMIN,D7
	BGE.S	.NOX3
	MOVE	D7,RYMIN
.NOX3
	CMP	RYMAX,D7
	BLE.S	.NOX4
	MOVE	D7,RYMAX
.NOX4
	DBRA	D4,BCPTS
;	MOVE	RXMIN,XMIN.W
;	MOVE	RXMAX,XMAX.W
;	MOVE	RYMIN,YMIN.W
;	MOVE	RYMAX,YMAX.W
	MOVEM	RXMIN/RXMAX/RYMIN/RYMAX,XMIN.W
	RTS

;
; ETOILES
;
PROF=	32767

STARS_EF_X:	DC.W	4
STARS_EF_Y:	DC.W	4

; X (140 - 396)
; Y (40 -  220)


INITSTAR
	MOVE.L	#BUFFER1,BUFFER\W
	MOVE.L	#BUFFER2,SWAPBUF\W

	BSR	INIT_STARS
	LEA	ETOILES,A3
	LEA	PTRS,A6
	MOVE.W	#NBSTAR-1,D7
E:
	MOVE.L	A3,NBSTAR*4(A6)
	move.l	a3,(a6)+
REF:	CLR	CPTS
DE:
	ADDQ	#1,CPTS
	BSR.S	F
	BEQ.S	DE
	cmp	#minimum,CPTS
	bhs.s	.ok
	move.l	-4(a6),a3
	bra.s	REF
.ok
	MOVE.W	#-1,(A3)+
	DBRA	D7,E
	IFNE	FINAL
	CMP.L	#FINETOILES,A3
	BLS.S	.OK
	ILLEGAL
.OK
	ENDC
	RTS
CPTS:	DC.W	0

F:
	MOVEM.W	STARS_EF_X(PC),D0/D1
	ADD.W	D0,DEGX
	ADD.W	D1,DEGY
	BGE.S	DXOK0
	ADD.W	#720,DEGX
	BRA.S	DXOK1
DXOK0:
	CMP.W	#720,DEGX
	BLT.S	DXOK1
	SUB.W	#720,DEGX
DXOK1:
	TST.W	DEGY
	BGE.S	T2_Y
	ADD.W	#720,DEGY
T2_Y:	CMP.W	#360*2,DEGY
	BLT.S	AAA
	SUB.W	#720,DEGY
AAA:
	LEA	TABLE_3D_STARS,A0
	LEA	SIN(PC),A4
STARS_LOOP2:	
	MOVE.W	(A0)+,D0
	MOVE.W	(A0)+,D1
	MOVE.W	(A0),D2
	BMI	NO_STARS
	SUB.W	#SPEED,(A0)

	EXT.L	D0
	EXT.L	D1

	SWAP	D0
	ASR.L	#4,D0
	DIVS	D2,D0

	SWAP	D1
	ASR.L	#4,D1
	DIVS	D2,D1	;---- Y

;-----------------------------------------;
;             R O T A T I O N             ;
;-----------------------------------------;

	MOVE.W	DEGX(PC),D6
	MOVE.W	COS(PC,D6.W),D5
	MOVE.W	DEGY(PC),D6
	MOVE.W	0(A4,D6.W),D6

	MOVE.W	D0,D3
	MOVE.W	D1,D4

	MULS	D5,D3	;X COS
	MULS	D6,D4	;Y SIN
	MULS	D5,D1	;Y COS
	MULS	D6,D0	;X SIN

	SUB.L	D4,D3
	ADD.L	D0,D1

	MOVE.L	D3,D0

	ASR.L	#8,D0
	ASR.L	#8,D1

	ADD.W	#320/2,D0
	ADD.W	#200/2,D1

	BRA	DEK_POINT
;------------------- TABLE COS/SIN ----------------------;

COS:
 dc.w 256,256,256,256,255,255,255,254,254,253,252,251,250
 dc.w 249,248,247,246,245,243,242,241,239,237,236,234,232
 dc.w 230,228,226,224,222,219,217,215,212,210,207,204,202
 dc.w 199,196,193,190,187,184,181,178,175,171,168,165,161
 dc.w 158,154,150,147,143,139,136,132,128,124,120,116,112
 dc.w 108,104,100,96,92,88,83,79,75,71,66,62,58
 dc.w 53,49,44,40,36,31,27,22,18,13,9,4
SIN:
 dc.w 0,-4,-9,-13,-18,-22,-27,-31,-36,-40,-44,-49,-53,-58
 dc.w -62,-66,-71,-75,-79,-83,-88,-92,-96,-100,-104,-108,-112
 dc.w -116,-120,-124,-128,-132,-136,-139,-143,-147,-150,-154,-158,-161
 dc.w -165,-168,-171,-175,-178,-181,-184,-187,-190,-193,-196,-199,-202
 dc.w -204,-207,-210,-212,-215,-217,-219,-222,-224,-226,-228,-230,-232
 dc.w -234,-236,-237,-239,-241,-242,-243,-245,-246,-247,-248,-249,-250
 dc.w -251,-252,-253,-254,-254,-255,-255,-255,-256,-256,-256,-256,-256
 dc.w -256,-256,-255,-255,-255,-254,-254,-253,-252,-251,-250,-249,-248
 dc.w -247,-246,-245,-243,-242,-241,-239,-237,-236,-234,-232,-230,-228
 dc.w -226,-224,-222,-219,-217,-215,-212,-210,-207,-204,-202,-199,-196
 dc.w -193,-190,-187,-184,-181,-178,-175,-171,-168,-165,-161,-158,-154
 dc.w -150,-147,-143,-139,-136,-132,-128,-124,-120,-116,-112,-108,-104
 dc.w -100,-96,-92,-88,-83,-79,-75,-71,-66,-62,-58,-53,-49
 dc.w -44,-40,-36,-31,-27,-22,-18,-13,-9,-4,0,4,9
 dc.w 13,18,22,27,31,36,40,44,49,53,58,62,66
 dc.w 71,75,79,83,88,92,96,100,104,108,112,116,120
 dc.w 124,128,132,136,139,143,147,150,154,158,161,165,168
 dc.w 171,175,178,181,184,187,190,193,196,199,202,204,207
 dc.w 210,212,215,217,219,222,224,226,228,230,232,234,236
 dc.w 237,239,241,242,243,245,246,247,248,249,250,251,252
 dc.w 253,254,254,255,255,255,256,256,256
 dc.w 256,256,256,256,255,255,255,254,254,253,252,251,250
 dc.w 249,248,247,246,245,243,242,241,239,237,236,234,232
 dc.w 230,228,226,224,222,219,217,215,212,210,207,204,202
 dc.w 199,196,193,190,187,184,181,178,175,171,168,165,161
 dc.w 158,154,150,147,143,139,136,132,128,124,120,116,112
 dc.w 108,104,100,96,92,88,83,79,75,71,66,62,58
 dc.w 53,49,44,40,36,31,27,22,18,13,9,4

DEK_POINT:
	CMP	#320,D0
	BHS.S	NO_STARS
	CMP	#200,D1
	BHS.S	NO_STARS

	MOVEQ	#$F,D3
	EOR	D3,D0
	AND	D0,D3
	EOR	D3,D0
	MOVEQ	#0,D4
	BSET	D3,D4
	CMP	#PROF1,D2
	BLT.S	.SOMB
	SWAP	D4
	CMP	#PROF2,D2
	BLT.S	.SOMB
	BSET	D3,D4
.SOMB
	LSR	#1,D0
	MULU	#160,D1
	ADD	D0,D1
	MOVE.W	D1,(A3)+	;offset ecran
	MOVE.L	D4,(A3)+	;couleur
	ADDQ.W	#2,A0
	MOVEQ	#0,D0
	RTS

NO_STARS:
	BSR.S	RND_VAL
	MOVE.W	D1,-4(A0)
	BSR.S	RND_VAL
	MOVE.W	D1,-2(A0)
	MOVE.W	#PROF,(A0)+
	MOVEQ	#-1,D0
	RTS

DEGX:	DC.W	0
DEGY:	DC.W	0


INIT_STARS:
	LEA	TABLE_3D_STARS,A0
	MOVE.W	#NBSTAR-1,D0
	MOVEQ	#0,D6
	LEA	COS(PC),A1
	LEA	SIN(PC),A2
	MOVEQ	#0,D2
INIT_STARS_3D:
	MOVE.W	D2,D1
	ADD.W	D1,D1
	MOVE.W	0(A1,D1.W),D1
	ASR.W	#1,D1
	MOVE.W	D1,(A0)+

	MOVE.W	D2,D1
	ADD.W	D1,D1
	MOVE.W	0(A2,D1.W),D1
	MOVE.W	D1,(A0)+

	ADDQ.W	#1,D2

	BSR.S	RND_VAL
	MOVE.W	D1,D7
	ADD.W	#2000,D7
	ADD.W	D6,D7
	ADD.W	#1232,D6
	LSL.W	#8,D7
	BGT.S	Z_800	
	SUB.W	#PROF,D7
Z_800:
	MOVE.W	D7,(A0)+
	DBRA	D0,INIT_STARS_3D
	RTS


;---------- RND VAL renvoye dans D1 ----------;

RND2:	DC.W	$6789
RND_VAL:
	ADD	#$1234,RND2
	EOR	#$4567,RND2
	MOVE	RND2,D1
	ADD.W	D1,RND
	ADD.W	RND(PC),D1
	ADD.W	D1,RND
	AND.W	#$3FF,D1
	CMP.W	#720,D1
	BLT.S	RND_VAL2
	SUB.W	#720,D1
RND_VAL2:
	RTS

RND:	DC.W	0
