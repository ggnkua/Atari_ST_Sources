LOAD=$80000
ADR=$5000
;
; RELOGEUR DE PROGRAMME
;
	BRA.S	SKIPFILE
FILE:	DC.B	'HIDDEN2.PRG',0
	EVEN
SKIPFILE:
	CLR	-(SP)
	PEA	FILE(PC)
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D7
	BMI.S	ERREUR

	PEA	LOAD
	PEA	400000
	MOVE	D7,-(SP)
	MOVE	#$3F,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	MOVE.L	D0,D6
	BMI.S	ERREUR
;
; D6=NB OCTETS
;
	MOVE	D7,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP

	LEA	LOAD,A0
	BSR	RELOGEUR
	LEA	LOAD+$1C,A0
	MOVE.L	FIN,A1

	MOVEQ	#0,D0
ERREUR:
	ILLEGAL
FIN:	DC.L	0

RELOGEUR:
	MOVE.L	A0,A3

	CMP	#$601A,(A3)
	BNE	ERREUR

	MOVE.L	2(A3),A0	;LONGUEUR TEXT
	ADD.L	6(A3),A0	;+LONGUEUR DATA
	LEA	$1C(A3),A1	;SKIP ENTETE
	add.l	a1,a0
	MOVE.L	A0,FIN

	TST	$1A(A3)
	BNE.S	NORELOC

	ADD.L	$E(A3),A0	;SKIP LABELS

	MOVE.L	(A0)+,D0
	BEQ.S	NORELOC
	ADD.L	D0,A1
;	MOVEQ	#$1C,D0
;	ADD.L	A3,D0
	MOVE.L	#ADR,D0		;ADRESSE DE RELOCATION

	MOVEQ	#0,D1
L9DE:	ADD	D1,A1
	SUBQ.B	#1,D1
	BNE.S	L9DF
	LEA	$FE-1(A1),A1
	BRA.S	L9E0
L9DF:	ADD.L	D0,(A1)
L9E0:	MOVE.B	(A0)+,D1
	BNE.S	L9DE
NORELOC:
	RTS
