;
; NETTOYEUR DE MUSIQUES
;
LOAD=$80000
LONG=32000

PRINT:	MACRO
	PEA	?1
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	ENDM

	MOVE	#$2F,-(SP)
	TRAP	#1
	ADDQ	#2,SP
	MOVE.L	D0,DTA

	LEA	DIRECTORY,A6

	CLR	-(SP)
	PEA	FILE(PC)
	MOVE	#$4E,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	TST	D0
	BNE	ERREUR
PUSHDIR:
	MOVE.L	DTA,A0
	LEA	30(A0),A0
COPYDIR:MOVE.B	(A0)+,(A6)+
	BNE.S	COPYDIR

	MOVE	#$4F,-(SP)
	TRAP	#1
	ADDQ	#2,SP
	TST	D0
	BEQ.S	PUSHDIR
	ST	(A6)

	LEA	DIR,A6
LOADER:
	MOVEQ	#0,D0
	TST.B	(A6)
	BMI	ERREUR

	PRINT	CR0(PC)
	PRINT	(A6)
	PRINT	CR1(PC)

	LEA	LOAD,A0
	MOVE	#LONG/4-1,D0
	MOVEQ	#0,D1
CLEARE:	MOVE.L	D1,(A0)+
	DBRA	D0,CLEARE

	CLR	-(SP)
	PEA	(A6)
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D7
	BMI	ERREUR

	PEA	LOAD
	PEA	LONG
	MOVE	D7,-(SP)
	MOVE	#$3F,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	TST.L	D0
	BMI.L	ERREUR
	MOVE.L	D0,NBBYTES

	MOVE	D7,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP

	LEA	LOAD,A5

	MOVEQ	#0,D7
	MOVE.L	A5,A0
	ADD.L	$14(A5),A0
CNTMUS:
	ADDQ	#1,D7
	MOVE	(A0)+,D0
	OR	(A0)+,D0
	OR	(A0)+,D0
	BNE.S	CNTMUS

	SUBQ	#1,D7

	MOVE.L	A5,A0
	ADD.L	$14(A5),A0
	MOVE	4(A0),D6

	CMP	$30(A5),D7		;NB MUS
	BNE	ERR1
	CMP	$2E(A5),D6		;VITESSE
	BNE	ERR1

	MOVE.L	$18(A5),D0
	CMP.L	#'DIGI',(A5)
	BEQ	DIGI1
	OR.L	$1C(A5),D0
DIGI1:
	TST.L	D0
	BNE	ERR1

;	CMP	#$40,$2C(A5)		;SAUF TERA62 -> $30 !!!
;	BNE	ERR1

	TST.L	$32(A5)
	BNE	ERR1

	TST	$36(A5)
	BNE	ERR1
	TST.L	$38(A5)
	BNE	ERR1
	TST.L	$3C(A5)
	BNE	ERR1
	BRA	LOOP
ERR1:
;	MOVEQ	#1,D0
;	ILLEGAL

	CLR.L	$18(A5)
	CMP.L	#'DIGI',(A5)
	BEQ	DIGI2
	CLR.L	$1C(A5)
DIGI2:
;	MOVE	#$40,$2C(A5)
	MOVE	D6,$2E(A5)
	MOVE	D7,$30(A5)

	CLR	$32(A5)
	CLR.L	$34(A5)
	CLR.L	$38(A5)
	CLR.L	$3C(A5)
	BSR	SAUVE

O:
LOOP:	TST.B	(A6)+
	BNE.S	LOOP
	BRA	LOADER
ERREUR:
	MOVEQ	#-1,D1
	illegal

SAUVE:
	PRINT	CR(PC)
;	RTS
;	ILLEGAL

	CLR	-(SP)
	PEA	(A6)
	MOVE	#$3C,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D7
	BMI	ERREUR

	PEA	LOAD
	MOVE.L	NBBYTES,-(SP)
	MOVE	D7,-(SP)
	MOVE	#$40,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	CMP.L	NBBYTES,D0
	BNE	ERREUR

	MOVE	D7,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP
	RTS

NBBYTES:DC.L	0
DTA:	DC.L	0
CR:	DC.B	13,10,0
CR0:	DC.B	13,0
CR1:	DC.B	27,'K',0
FILE:
;	DC.B	'*.MUS',0
;	DC.B	'*.MME',0
	DC.B	'*.PAK',0

	EVEN
DIRECTORY:
DIR:
	BLK.B	1000
