LOAD=$80000
LONG=32000

PRINT:	MACRO
	PEA	?1
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	ENDM

	MOVE	#$2F,-(SP)
	TRAP	#1
	ADDQ	#2,SP
	MOVE.L	D0,DTA

	LEA	DIRECTORY,A6

	CLR	-(SP)
	PEA	FILE(PC)
	MOVE	#$4E,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	TST	D0
	BNE	ERREUR
PUSHDIR:
	MOVE.L	DTA,A0
	LEA	30(A0),A0
COPYDIR:MOVE.B	(A0)+,(A6)+
	BNE.S	COPYDIR

	MOVE	#$4F,-(SP)
	TRAP	#1
	ADDQ	#2,SP
	TST	D0
	BEQ.S	PUSHDIR
	ST	(A6)

	LEA	DIR,A6
LOADER:
	MOVEQ	#0,D0
	TST.B	(A6)
	BMI	ERREUR

	PRINT	CR0(PC)
	PRINT	(A6)
	PRINT	CR1(PC)

	LEA	LOAD,A0
	MOVE	#LONG/4-1,D0
	MOVEQ	#0,D1
CLEARE:	MOVE.L	D1,(A0)+
	DBRA	D0,CLEARE

	CLR	-(SP)
	PEA	(A6)
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D7
	BMI	ERREUR

	PEA	LOAD
	PEA	LONG
	MOVE	D7,-(SP)
	MOVE	#$3F,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	TST.L	D0
	BMI.L	ERREUR
	MOVE.L	D0,NBBYTES
	MOVE.L	D0,D6

	MOVE	D7,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP

	LEA	LOAD,A5

TEST:	MACRO
	MOVE.L	A5,A0
	ADD.L	?1(A5),A0
	MOVEQ	#0,D0
L?0:	MOVE	(A0)+,D0
	BEQ	L?0
	SUBQ	#2,A0
	ADD.L	A5,D0
	SUB.L	A0,D0
	LSR.L	#1,D0
	SUBQ	#1,D0
	CMP	?2(A5),D0
	BNE	ERREUR?3
	ENDM

	TEST	4,$24,1
	TEST	8,$26,2
	TEST	$C,$28,3

	MOVE.L	$14(A5),D0
	SUB.L	$10(A5),D0
	DIVU	#12,D0
	SWAP	D0
	TST	D0
	BNE	ERREUR
	SWAP	D0
	SUBQ	#1,D0
	CMP	$2A(A5),D0
	BNE	ERREUR4

	MOVE.L	A5,A0
	ADD.L	$14(A5),A0
	MOVEQ	#0,D7
COUNT:
	MOVE	(A0),D0
	OR	2(A0),D0
	OR	4(A0),D0
	BEQ.S	FINCNT

	CMP	(A0),D7
	BNE	ERREUR5
	MOVE	2(A0),D7
	ADDQ	#1,D7
	ADDQ	#6,A0
	BRA.S	COUNT
FINCNT:
	MOVE.L	A0,D0
	SUB.L	A5,D0
	CMP.L	NBBYTES,D0
	BNE	ERREUR6

	SUBQ	#1,D7
	CMP	$2A(A5),D7
	BNE	ERREUR7

;	MOVEQ	#0,D1
;	ILLEGAL

LOOP:	TST.B	(A6)+
	BNE.S	LOOP
	BRA	LOADER

ERREUR1:
;	ILLEGAL
	PRINT	MESS1(PC)
	BRA	LOOP
ERREUR2:
;	ILLEGAL
	PRINT	MESS2(PC)
	BRA	LOOP
ERREUR3:
;	ILLEGAL
	PRINT	MESS3(PC)
	BRA	LOOP
ERREUR4:
	LEA	LOAD,A0
	MOVE.L	A0,A1
	ADD.L	D6,A1
;	ILLEGAL
	PRINT	MESS4(PC)
	BRA	LOOP
ERREUR5:
	LEA	LOAD,A0
	MOVE.L	A0,A1
	ADD.L	D6,A1

;	ILLEGAL
	BRA	OK1
	BRA	MUS
;
; PAK
;
	CMP.L	#$1E1B,D6
	BEQ	OK1
	CMP.L	#$1EE1,D6
	BEQ	OK1
	CMP.L	#$1C6A,D6
	BEQ	OK1
	CMP.L	#$29F4,D6
	BEQ	OK1
	CMP.L	#$1282,D6
	BEQ	OK1
	CMP.L	#$1511,D6
	BEQ	OK1
	CMP.L	#$20BC,D6
	BEQ	OK1
	CMP.L	#$D9A,D6
	BEQ	OK1
	ILLEGAL
;
; MUS
;
MUS:
	CMP.L	#$7A8,D6
	BEQ.S	OK1
	CMP.L	#$48A,D6
	BEQ.S	OK1
	CMP.L	#$191C,D6
	BEQ.S	OK1
	CMP.L	#$1830,D6
	BEQ.S	OK1
	CMP.L	#$127A,D6
	BEQ.S	OK1
	CMP.L	#$163A,D6
	BEQ.S	OK1
	CMP.L	#$D80,D6
	BEQ.S	OK1
	CMP.L	#$A8A,D6
	BEQ.S	OK1
	ILLEGAL
;
; MMME
;
MMME:
	CMP.L	#$2B0,D6
	BEQ	OK1
	CMP.L	#$1510,D6
	BEQ	OK1

	ILLEGAL
MOVE:
	MOVE	6(A0),(A0)+
	MOVE	6(A0),(A0)+
	MOVE	6(A0),(A0)+
	MOVE	-6(A0),D0
	OR	-4(A0),D0
	OR	-2(A0),D0
	BNE.S	MOVE
	ILLEGAL

OK1:
	PRINT	MESS5(PC)
	BRA	LOOP
ERREUR6:
	PRINT	MESS6(PC)
	BRA	LOOP
ERREUR7:
	PRINT	MESS7(PC)
	BRA	LOOP

ERREUR:
	MOVEQ	#-1,D1
	illegal

NBBYTES:DC.L	0
DTA:	DC.L	0
CR:	DC.B	13,10,0
CR0:	DC.B	13,0
CR1:	DC.B	27,'K',0
FILE:	DC.B	'*.MUS',0

MESS1:	DC.B	9,'NB MOD FREQ',13,10,0
MESS2:	DC.B	9,'NB MOD VOL',13,10,0
MESS3:	DC.B	9,'NB PATTERNS',13,10,0
MESS4:	DC.B	9,'NB SEQUENCES',13,10,0
MESS5:	DC.B	9,'MUSIQUES',13,10,0
MESS6:	DC.B	9,"TROP D'OCTETS",13,10,0
MESS7:	DC.B	9,"TROP DE PATTERNS",13,10,0

	EVEN
DIRECTORY:
DIR:
	BLK.B	1000
