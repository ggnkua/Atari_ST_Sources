LOAD=$40000
SAVE=$50000
;
; MOULINETTE POUR ENLEVER LES MODULATIONS EN TROP
;
	BRA	SKIPMOD
MODFREQ:
	DC.B	0,1,2,3,4,5,7,8,9
;	DC.B	0,2,3,4,5,8
;	DC.B	0,1,2,5,6,7,8,9,10,11,12,13,14,15
	DC.B	-1
MODVOL:
	DC.B	0,1,2,3,4,5,7,8,9,10,11,25
;	DC.B	0,4,6,11,15,20,22,25
;	DC.B	1,2,3,4,5
;	DC.B	0,2,3,4
;	DC.B	0,1,2,6,9,10,11,12,13,14,15,16,17,18,19,20,21
	DC.B	-1
	EVEN
SKIPMOD:
	LEA	LOAD,A5
	LEA	SAVE,A6

	MOVE.L	A5,A0
	ADD.L	4(A5),A0

	MOVE.L	A5,A1
COPY1:	MOVE	(A1)+,(A6)+
	CMP.L	A0,A1
	BLO.S	COPY1

	MOVE.L	A6,A1
	LEA	SAVE,A6
	ADD	(A0),A6

	MOVE.L	A5,A2
	MOVE.L	A0,A4
	ADD	(A0),A2
	LEA	MODFREQ,A3
KILLFREQ:
	MOVE.L	A0,D0
	SUB.L	A4,D0
	LSR.L	#1,D0

	CMP.B	(A3),D0
	BNE.S	ENLEVE
;
; ON GARDE LE MEME
;
	ADDQ	#1,A3
	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE	D0,(A1)+

	LEA	LOAD,A5
	ADD	(A0),A5

COPY2:
	MOVE.B	(A5)+,D0
	MOVE.B	D0,(A6)+
	CMP.B	#$E1,D0
	BEQ.S	OTE
	CMP.B	#$E0,D0
	BNE.S	COPY2
	MOVE.B	(A5)+,(A6)+
	BRA.S	OTE
ENLEVE:
;
; NON, ON LE DEGAGE
;
	CLR	(A1)+
OTE:

	ADDQ	#2,A0
	CMP.L	A2,A0
	BLO.S	KILLFREQ

	TST.B	(A3)
	BPL	ERREUR

	MOVE	A6,D0
	LSR	#1,D0
	BCC.S	PAIR1
	CLR.B	(A6)+
PAIR1:

	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE.L	D0,SAVE+8

	LEA	MODVOL(PC),A0

	LEA	LOAD,A1
	MOVE.L	A1,A2
	ADD.L	8(A1),A1
	ADD	(A1),A2
	MOVE.L	A1,A4

	MOVE.L	A6,A3
	ADD	(A1),A6
	SUB.L	LOAD+8,A6
LOOP2:
	MOVE.L	A1,D0
	SUB.L	A4,D0
	LSR.L	#1,D0
	CMP.B	(A0),D0
	BNE.S	ENLEVE2

	ADDQ	#1,A0

	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE	D0,(A3)+

	LEA	LOAD,A5
	ADD	(A1),A5
COPY3:
	MOVE.B	(A5)+,D0
	MOVE.B	D0,(A6)+
	CMP.B	#$E1,D0
	BEQ.S	OTE2
	CMP.B	#$E0,D0
	BNE.S	COPY3
	MOVE.B	(A5)+,(A6)+
	BRA.S	OTE2
ENLEVE2:
	CLR	(A3)+
OTE2:
	ADDQ	#2,A1
	CMP.L	A2,A1
	BLO.S	LOOP2

	TST.B	(A0)
	BPL	ERREUR

	MOVE	A6,D0
	LSR	#1,D0
	BCC.S	PAIR2
	CLR.B	(A6)+
PAIR2:
	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE.L	D0,SAVE+$C

	LEA	LOAD,A0
	ADD.L	$C(A0),A0
	LEA	LOAD,A1
	ADD	(A0),A1
	MOVE.L	A0,A2
RENUM1:
	MOVEQ	#0,D0
	MOVE	(A0)+,D0
	ADD.L	#LOAD,D0
	SUB.L	A2,D0
	ADD.L	SAVE+$C,D0
	MOVE	D0,(A6)+
	CMP.L	A1,A0
	BLO.S	RENUM1

	LEA	LOAD,A1
	ADD.L	$10(A1),A1
COPY4:
	MOVE	(A0)+,(A6)+
	CMP.L	A1,A0
	BLO.S	COPY4

	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE.L	D0,SAVE+$10

	LEA	LOAD,A0
	MOVE.L	A0,A1
	ADD.L	$10(A0),A0
	ADD.L	$14(A1),A1
COPY5:
	MOVE	(A0)+,(A6)+
	CMP.L	A1,A0
	BLO.S	COPY5

	MOVE.L	A6,D0
	SUB.L	#SAVE,D0
	MOVE.L	D0,SAVE+$14

COPY6:
	MOVE	(A0),D0
	OR	2(A0),D0
	OR	4(A0),D0
	BEQ.S	FINI1
	MOVE	(A0)+,(A6)+
	MOVE	(A0)+,(A6)+
	MOVE	(A0)+,(A6)+
	BRA.S	COPY6
FINI1:
	LEA	SAVE,A0
	MOVE.L	A6,A1

	MOVEQ	#0,D0
	ILLEGAL
ERREUR:
	MOVEQ	#-1,D0
	ILLEGAL
