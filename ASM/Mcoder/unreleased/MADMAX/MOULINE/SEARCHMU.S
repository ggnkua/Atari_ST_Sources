LOADMUS=$80000
PLAYMUS=$90000
MUSIC=$A0000
PUSHMUS=$B0000

PRINT:	MACRO
	PEA	?1
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	ENDM

	LEA	LOADMUS,A5
	LEA	FILELOAD(PC),A6
	MOVEQ	#-1,D0
	BSR	LOAD
	LEA	PLAYMUS,A5
	LEA	FILEPLAY(PC),A6
	MOVEQ	#-1,D0
	BSR	LOAD

	LEA	PUSHMUS,A3
	LEA	LOADMUS,A4
	MOVEQ	#0,D5
LOOP:
	TST.B	(A4)
	BLE	FINI

	MOVE.L	A4,A6
	LEA	MUSIC,A5
	MOVEQ	#0,D0
	BSR	LOAD
	LEA	MUSIC,A0
	ADD.L	$14(A0),A0
	MOVEQ	#1,D7
CNTMUS:
	MOVE	(A0),D0
	OR	2(A0),D0
	OR	4(A0),D0
	BEQ	NEXT

	ADDQ	#6,A0
	MOVE.B	D5,(A3)+
	MOVE.B	D7,(A3)+
	ADDQ	#1,D7
	BRA.S	CNTMUS
NEXT:
	ADDQ	#1,D5
SKIP:	TST.B	(A4)+
	BNE.S	SKIP
	BRA	LOOP
FINI:
	LEA	PLAYMUS,A0
	LEA	BUG,A2
SEARCH:
	MOVE	(A0)+,D7	;MUSIQUE A CHERCHER
	CMP	#-1,D7
	BEQ	FIN
	LEA	PUSHMUS,A1
FND:
	CMP	(A1)+,D7
	BEQ.S	TROUVE
	CMP.L	A3,A1
	BLO.S	FND
;	CMP	#$1002,D7
;	BEQ	SEARCH
;	CMP	#$3203,D7
;	BEQ	SEARCH
;	CMP	#$1402,D7
;	BEQ	SEARCH
	MOVE	D7,(A2)+
	MOVEM.L	D0-D7/A0-A6,-(SP)
	PRINT	ERREUR1(PC)
	MOVEM.L	(SP)+,D0-D7/A0-A6
	BRA	SEARCH
;	ILLEGAL
TROUVE:
	MOVE	#-1,-(A1)
	BRA	SEARCH
FIN:
	PRINT	LISTE(PC)
	LEA	PUSHMUS,A4
LOWER:
	MOVE	(A4)+,D0
	CMP	#-1,D0
	BEQ	NONE

	MOVEQ	#0,D7
	MOVE.B	-2(A4),D7
	BSR	PRINTC
	PRINT	VIRG(PC)
	MOVEQ	#0,D7
	MOVE.B	-1(A4),D7
	BSR	PRINTC
	PRINT	CR(PC)

NONE:
	CMP.L	A3,A4
	BLO.S	LOWER
	ILLEGAL

PRINTC:
	CMP	#100,D7
	BLO.S	LOW100
	SUB	#100,D7
	PRINT	CHIF1(PC)
LOW100:
	DIVU	#10,D7
	ADD.L	#$300030,D7
	MOVE.B	D7,CHIF2
	SWAP	D7
	MOVE.B	D7,CHIF2+1
	PRINT	CHIF2(PC)
	RTS

LOAD:
	MOVE.L	A5,A0
	MOVE	#32000/4-1,D1
CLEARE:	MOVE.L	D0,(A0)+
	DBRA	D1,CLEARE

	PRINT	(A6)
	PRINT	CR2(PC)
	CLR	-(SP)
	PEA	(A6)
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D6
	BMI	ERREUR

	PEA	(A5)
	PEA	32000
	MOVE	D6,-(SP)
	MOVE	#$3F,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	MOVE.L	D0,D7
	BMI	ERREUR

	MOVE	D6,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP
	RTS
ERREUR:	ILLEGAL
VIRG:	DC.B	',',0
CR:	DC.B	13,10,0
CR2:	DC.B	27,'K',13,0
FILELOAD:DC.B	'D:\MAD\LOADMUS.BIN',0
FILEPLAY:DC.B	'D:\MAD\PLAYMUS.BIN',0
ERREUR1:DC.B	'MUSIQUE NON TROUVEE',0
LISTE:	DC.B	'LISTE DES MUSIQUES NON UTILISEES',13,10,10,0
CHIF1:	DC.B	'1',0
CHIF2:	DC.B	0,0,0
	EVEN
BUG:	BLK.B	1000
