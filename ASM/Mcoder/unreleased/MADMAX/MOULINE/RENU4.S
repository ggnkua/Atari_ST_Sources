LOAD=$80000
DEST=$90000

	BRA	SKIPFILE
FILE:
	IF	0=1
	ENDIF

	DC.B	"MADMUS2.MUS",0
	DC.B	"SYNTER2.MUS",0
	DC.B	"WARP2.MUS",0
	DC.B	"ASTAR2.MUS",0
	DC.B	"PREHIS6.MUS",0
	DC.B	'MASTER2.MME',0
	DC.B	"CHAMBER5.MUS",0
	DC.B	"TERA71.MUS",0
	DC.B	"MEDUSA.MUS",0
	DC.B	"STORM1.MUS",0
	DC.B	"LANDS9.MUS",0
	DC.B	"PREHIS12.MME",0

	DC.B	'COSO37.PAK',0
;
; MODIFIES :
;	DC.B	'TUR2.PAK',0
;	DC.B	'TUR3.PAK',0
;	DC.B	'COSO49.PAK',0
;	DC.B	'COSO58.PAK',0
;
;	DC.B	'PREHIS9.MME',0
;	DC.B	'WEIRD.MUS',0
;	DC.B	'THAL7.MUS',0
;	DC.B	'DRAGON2.MUS',0
;	DC.B	'TUR1.PAK',0
;	DC.B	'TUR4.PAK',0
;	DC.B	'COSO19.PAK',0
	EVEN
SKIPFILE:

PRINT:	MACRO
	PEA	?1
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	ENDM

	LEA	LOAD,A0
	MOVE	#32000/4-1,D0
CLEAR:	CLR.L	(A0)+
	DBRA	D0,CLEAR

	PRINT	FILE(PC)
	PRINT	CR(PC)

	CLR	-(SP)
	PEA	FILE(PC)
	MOVE	#$3D,-(SP)
	TRAP	#1
	ADDQ	#8,SP
	MOVE.L	D0,D7
	BMI	ERREUR

	PEA	LOAD
	PEA	32000
	MOVE	D7,-(SP)
	MOVE	#$3F,-(SP)
	TRAP	#1
	LEA	12(SP),SP
	MOVE.L	D0,D6		;NB BYTES
	BMI	ERREUR

	MOVE	D7,-(SP)
	MOVE	#$3E,-(SP)
	TRAP	#1
	ADDQ	#4,SP

	MOVEQ	#0,D7		;NUMERO DE PATTERN COURANT
	LEA	DEST,A6
	CLR	NBPAT
MAIN:
	LEA	LOAD,A5
	MOVE.L	A5,A0
	ADD.L	$14(A5),A0

	SUBQ	#6,A0
	CLR	D2
	MOVEQ	#-1,D5
	SUB.L	A1,A1
TSTFIN:
	ADDQ	#6,A0
	MOVE	(A0),D0
	OR	2(A0),D0
	OR	4(A0),D0
	BEQ.S	FINI
	BMI	TSTFIN

	ST	D2
	CMP	(A0),D5
	BLS	TSTFIN
	MOVE.L	A0,A1
	MOVE	(A0),D5
	BRA	TSTFIN
FINI:
	MOVE.L	A1,D0
	BEQ	FINI2

	CMP	D7,D5
	BEQ.S	OK

	SUB	D5,D7
	NEG	D7
	BMI	OK4

	ADD	D7,NBPAT

	MOVEM.L	D0-D7/A0-A6,-(SP)
	PRINT	WARN1(PC)
	MOVEM.L	(SP)+,D0-D7/A0-A6
	BRA	OK
OK4:
	MOVEM.L	D0-D7/A0-A6,-(SP)
	PRINT	WARN4(PC)
	MOVEM.L	(SP)+,D0-D7/A0-A6
OK:

	MOVEM.L	D0-D7/A0-A6,-(SP)

	MOVE.L	A5,A0
	ADD.L	$14(A5),A0
	MOVE.L	A1,D0
	SUB.L	A0,D0
	DIVU	#6,D0
	ADD	#'1',D0
	MOVE.B	D0,AFF1

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	DIVU	#6,D0
	ADD	#'1',D0
	MOVE.B	D0,AFF2
	CMP.B	AFF1,D0
	BEQ.S	NOAFF
	PRINT	AFF(PC)
NOAFF:
	MOVEM.L	(SP)+,D0-D7/A0-A6

	MOVE	(A1)+,(A6)+
	MOVE	(A1)+,D7
	MOVE	D7,(A6)+
	ADDQ	#1,D7
	MOVE	(A1)+,(A6)+

	MOVE	#-1,-6(A1)
	BRA	MAIN

FINI2:
	TST	D2
	BNE	NOEND

	SUBQ	#1,D7
	CMP	LOAD+$2A,D7
	BEQ	OK2

	SUB	LOAD+$2A,D7
	NEG	D7

	BMI	ERREUR
	ADD	D7,NBPAT

	MOVEM.L	D0-D7/A0-A6,-(SP)
	PRINT	WARN2(PC)
	MOVEM.L	(SP)+,D0-D7/A0-A6

OK2:
	TST	NBPAT
	BEQ	OK3
	MOVEM.L	D0-D7/A0-A6,-(SP)
	MOVE	NBPAT,D0
	ADD	#'0',D0
	MOVE.B	D0,WARN3
	PRINT	WARN3(PC)
	MOVEM.L	(SP)+,D0-D7/A0-A6
OK3:
	LEA	DEST,A0
	MOVE.L	A5,A1
	ADD.L	$14(A5),A1
MEMO:
	MOVE	(A0)+,(A1)+
	CMP.L	A6,A0
	BLO.S	MEMO

	LEA	LOAD,A0
	MOVE.L	A0,A1
	ADD.L	D6,A1
	MOVE.L	A0,A2
	ADD.L	$14(A0),A2
	MOVEQ	#-1,D0
	MOVE.L	A2,A3
CNT:	ADDQ.L	#1,D0
	MOVE	(A3)+,D1
	OR	(A3)+,D1
	OR	(A3)+,D1
	BNE.S	CNT
	ILLEGAL
NOEND:	PRINT	ERREUR1(PC)
ERREUR:
	ILLEGAL
NBPAT:	DC.W	0
CR:	DC.B	13,10,0
WARN1:	DC.B	"PATTERN EN TROP AU MILIEU",13,10,0
WARN2:	DC.B	"PATTERN EN TROP A LA FIN",13,10,0
WARN3:	DC.B	"0 PATTERNS EN TROP",13,10,0
WARN4:	DC.B	"PATTERN REUTILISE",13,10,0
ERREUR1:DC.B	"INTERNAL ERROR",0

AFF:
AFF1:	DC.B	0
	DC.B	'->'
AFF2:	DC.B	0
	DC.B	13,10,0
	EVEN
