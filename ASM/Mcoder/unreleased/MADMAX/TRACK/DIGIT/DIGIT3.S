;
; TRANSFORMEUR DE FICHIER DIGIT MADMAX EN FICHIER NORMAL
;
SOURCE=$4001C
DEST=$50000
O=DEST

	LEA	SOURCE,A5
	LEA	DEST,A6
	CMP.L	#'COSO',(A5)
	BNE	ERREUR
	MOVE.L	#'DIGI',(A6)+
;
; 7 POINTEURS EN LONG A AJUSTER AU FUR ET A MESURE
;
	MOVEQ	#-1,D0
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+
	MOVE.L	D0,(A6)+

	MOVE.L	#'TFMX',(A6)+

	LEA	$24(A5),A5
	MOVEQ	#28-1,D0
COP1:	MOVE.B	(A5)+,(A6)+
	DBRA	D0,COP1

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE.L	D0,DEST+4

	MOVE	DEST+36,D7	;NB INS-1
	MOVE.L	A5,A3
	MOVE.L	A6,A4
	MOVE	D7,D0
	ADDQ	#1,D0
	ADD	D0,D0
	ADD	D0,A6
	ADD	D0,A5
	ADD	D0,A5
COP2:
	MOVE.L	(A3)+,D0
	ADD.L	#SOURCE,D0
	CMP.L	A5,D0
	BNE.L	ERREUR

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE	D0,(A4)+

COP3:
	MOVE.B	(A5)+,D0
	CMP.B	#$E7,D0
	BNE.S	NOTE7
	MOVE.B	#$EB,D0
NOTE7:
	CMP.B	#$EA,D0
	BNE.S	NOTEA
	MOVE.B	#$EC,D0
NOTEA:
	MOVE.B	D0,(A6)+

	CMP.B	#$E1,D0
	BEQ.S	E1
	CMP.B	#$E0,D0
	BNE.S	COP3
	MOVE.B	(A5)+,(A6)+
E1:
	DBRA	D7,COP2

	BSR	PARITE

	MOVE.L	A5,D0
	SUB.L	#SOURCE,D0
	CMP.L	SOURCE+8,D0
	BNE	ERREUR

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE.L	D0,DEST+8


	MOVE	DEST+38,D7	;NB INS-1
	MOVE.L	A5,A3
	MOVE.L	A6,A4
	MOVE	D7,D0
	ADDQ	#1,D0
	ADD	D0,D0
	ADD	D0,A6
	ADD	D0,A5
	ADD	D0,A5
LCOP2:
	MOVE.L	(A3)+,D0
	ADD.L	#SOURCE,D0
	CMP.L	A5,D0
	BNE.L	ERREUR

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE	D0,(A4)+

LCOP3:
	MOVE.B	(A5)+,D0
	MOVE.B	D0,(A6)+

	CMP.B	#$E1,D0
	BEQ.S	LE1
	CMP.B	#$E0,D0
	BNE.S	LCOP3
	MOVE.B	(A5)+,(A6)+
LE1:
	DBRA	D7,LCOP2

	BSR	PARITE

	MOVE.L	A5,D0
	SUB.L	#SOURCE,D0
	CMP.L	SOURCE+12,D0
	BNE	ERREUR

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE.L	D0,DEST+12

	MOVE	DEST+40,D7	;NB INS-1
	MOVE.L	A5,A3
	MOVE.L	A6,A4
	MOVE	D7,D0
	ADDQ	#1,D0
	ADD	D0,D0
	ADD	D0,A6
	ADD	D0,A5
	ADD	D0,A5

MCOP2:
	MOVE.L	(A3)+,D0
	ADD.L	#SOURCE,D0
	CMP.L	A5,D0
	BNE.S	ERREUR

	MOVE.L	A6,D0
	SUB.L	#DEST,D0
	MOVE	D0,(A4)+

MCOP3:
	MOVE.B	(A5)+,D0
	MOVE.B	D0,(A6)+

	CMP.B	#$FF,D0
	BNE.S	MCOP3
	DBRA	D7,MCOP2

	BSR	PARITE

	ILLEGAL

ERREUR:	MOVEQ	#-1,D0
	ILLEGAL

PARITE:
	MOVE	A6,D0
	LSR	#1,D0
	BCC.S	PAIR1
	CLR.B	(A6)+
PAIR1:

	MOVE	A5,D0
	LSR	#1,D0
	BCC.S	PAIR2
	ADDQ	#1,A5
PAIR2:
	RTS
