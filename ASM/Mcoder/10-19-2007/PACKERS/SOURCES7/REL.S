OPENFILE
	RTS
READ
	RTS
CLOSEFILE
	RTS
CLRMEM
	RTS
LFC7D46

;
; STRUCTURE DE A6
;
;	8.L=NOM DU PRG
;
;	-6.W=HANDLE
;	-8.W

	LINK	A6,#-$42
	MOVEM.L	D4-D7/A5,-(A7)
	MOVE.L	8(A6),(A7)
	BSR	OPENFILE
	EXT.L	D0
	BMI	LFC88D8
	MOVE	D0,-6(A6)
;
; LOAD 2 OCTETS EN A6-8
;
	PEA	-8(A6)
	PEA	2.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	CMP	#$601A,-8(A6)
	BEQ.S	LFC86AC

	MOVEQ	#-66,D0		;ERREUR PAS RELOGEABLE
	BRA	LFC88D8

LFC86AC
	PEA	-$42(A6)
	PEA	$10.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	PEA	-$1E(A6)
	PEA	4.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	PEA	-$1E(A6)
	PEA	4.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	PEA	-$A(A6)
	PEA	2.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	MOVE.L	-$3E(A6),D0
	ADD.L	-$42(A6),D0
	MOVE.L	D0,-$1A(A6)
	MOVE.L	$C(A6),D0
	ADDQ.L	#8,D0
	MOVE.L	D0,-$E(A6)
	MOVE.L	$C(A6),A0
	MOVE.L	4(A0),D0
	MOVE.L	$C(A6),A1
	MOVE.L	(A1),D1
	SUB.L	D1,D0
	ADD.L	#-$100,D0
	MOVE.L	D0,-$32(A6)
	ADD.L	#$100,$C(A6)
	MOVE.L	$C(A6),D0
	MOVE.L	D0,-$16(A6)
	MOVE.L	D0,-$12(A6)
	MOVE.L	-$12(A6),-$22(A6)
	MOVE.L	-$12(A6),D0
	ADD.L	-$1A(A6),D0
	MOVE.L	D0,-4(A6)
	MOVE.L	-$32(A6),D0
	SUB.L	-$1A(A6),D0
	MOVE.L	D0,-$2E(A6)
	MOVE.L	-$3A(A6),D0
	CMP.L	-$2E(A6),D0
	BLE.S	LFC8786
	MOVEQ	#-39,D0		;MEMOIRE INSUFFISANTE
	BRA	LFC88D8
LFC8786	CLR.L	D5
LFC878A	MOVE.L	-$E(A6),A0
	MOVE.L	-$16(A6),(A0)
	ADDQ.L	#4,-$E(A6)
	MOVE.L	-$E(A6),A0
	MOVE.L	A6,A1
	MOVE.L	D5,A2
	ADD.L	A2,A2
	ADD.L	A2,A2
	ADD.L	A2,A1
	MOVE.L	-$42(A1),(A0)
	ADDQ.L	#4,-$E(A6)
	MOVE.L	A6,A0
	MOVE.L	D5,A1
	ADD.L	A1,A1
	ADD.L	A1,A1
	ADD.L	A1,A0
	MOVE.L	-$42(A0),D0
	ADD.L	D0,-$16(A6)
	ADDQ.L	#1,D5
LFC87C0	CMP.L	#3,D5
	BLT.S	LFC878A
	MOVE.L	-$12(A6),(A7)
	MOVE.L	-$1A(A6),-(A7)
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7
	TST	-$A(A6)
	BEQ.S	LFC87E8		;PROGRAMME RELOGEABLE ???
	MOVEQ	#0,D0
	BRA	LFC88D8
LFC87E8	CLR	(A7)
	MOVE	-6(A6),-(A7)
	MOVE.L	-$36(A6),D0
	ADD.L	-$1A(A6),D0
	MOVE.L	D0,-(A7)
	ADD.L	#$1C,(A7)
	BSR	LFC7D46
	ADDQ.L	#6,A7
	PEA	-$26(A6)
	PEA	4.W
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7
	TST.L	-$26(A6)
	BEQ	LFC88B6
	MOVE.L	-$22(A6),D6
	ADD.L	-$26(A6),D6
	CMP.L	-$22(A6),D6
	BLT.S	LFC883C
	CMP.L	-4(A6),D6
	BCS.S	LFC8842
LFC883C	MOVEQ	#-$42,D0
	BRA	LFC88D8
LFC8842	MOVE.L	-$22(A6),D0
	MOVE.L	D6,A1
	ADD.L	D0,(A1)
LFC884A	CMP.L	-$22(A6),D6
	BLT.S	LFC8856
	CMP.L	-4(A6),D6
	BCS.S	LFC885C
LFC8856	MOVEQ	#-$42,D0
	BRA	LFC88D8
LFC885C
	MOVE.L	-4(A6),(A7)
	MOVE.L	-$2E(A6),-(A7)
	MOVE	-6(A6),-(A7)
	BSR	READ
	ADDQ.L	#6,A7

	EXT.L	D0
	MOVE.L	D0,-$2A(A6)
	MOVE.L	-$2A(A6),D5
	MOVE.L	-4(A6),A5
	BRA.S	LFC88A8
LFC8880	MOVE.B	(A5)+,D7
	EXT	D7
	BEQ.S	LFC88B6
	AND	#$FF,D7
	CMP	#1,D7
	BNE.S	LFC8898
	ADD.L	#$FE,D6
	BRA.S	LFC88A6
LFC8898	MOVE	D7,D0
	EXT.L	D0
	ADD.L	D0,D6
	MOVE.L	-$22(A6),D0
	MOVE.L	D6,A1
	ADD.L	D0,(A1)
LFC88A6	SUBQ.L	#1,D5
LFC88A8	TST.L	D5
	BNE.S	LFC8880
	MOVE.L	-$2A(A6),D0
	CMP.L	-$2E(A6),D0
	BEQ.S	LFC884A
LFC88B6	MOVE.L	-4(A6),D0
	ADD.L	-$2E(A6),D0
	MOVE.L	D0,(A7)
	MOVE.L	-4(A6),-(A7)
	BSR	CLRMEM
	ADDQ.L	#4,A7
	MOVE	-6(A6),(A7)
	BSR	CLOSEFILE
	MOVEQ	#0,D0
LFC88D8	ADDQ	#4,SP
	MOVEM.L	(A7)+,D5-D7/A5
	UNLK	A6
	RTS
