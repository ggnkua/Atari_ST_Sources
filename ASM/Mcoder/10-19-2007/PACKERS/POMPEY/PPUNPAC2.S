; Position independent unpacking routine for Pompey Pack v.1.5.
; usage: A0 beginning of packed data 
;        D0 is the lenght of packed data.
; After unpacking this will return original lenght in D0. 
; This routine is especially to use with normal fileloading files

unpack
	movem.l       d0-d7/a0-a6,-(a7)
	add.l	d0,a0
	CMPI.L	#$504F5049,-(A0)
	BNE.S	L21104
	move.l	-(a0),(a7)       ; unpacked lenght of data
	BSR.S	L21116
L21104         
               movem.l	(a7)+,d0-d7/a0-a6
               RTS          
L21116	add.l	#8,a0
	MOVEA.L	A0,A3
	SUBA.L	#$C,A0
	SUBA.L	(A0),A3
	MOVEA.L	A3,A2
	ADDA.L	4(A0),A2
L21132	MOVE.B	-(A0),D0
	BEQ.S	L21132
L21136	MOVEQ	#0,D2
	BSR.S	L211B8
	BCS.S	L21150
	MOVE.B	-(A0),D2
L21140	MOVE.B	D2,-(A2)
	BRA.S	L2117A
L21144	MOVEQ	#$F,D4
	MOVEQ	#2,D3
	BSR.S	L211C4
	BNE.S	L211AC
	MOVE.W	D4,D2
	BRA.S	L21140
L21150	BSR.S	L211B8
	BCC.S	L21188
	BSR.S	L211B8
	BCC.S	L21144
	BSR.S	L211B8
	BCS.S	L2116A
	MOVEQ	#2,D1
	BSR	L211E6
	EXG	D1,D2
	ADDQ.W	#1,D2
	BSET	D1,D2
	BRA.S	L21140
L2116A	BSR.S	L211B8
	BCS.S	L21184
	MOVEQ	#$F,D4
	MOVE.W	#3,D3
	BSR.S	L211C4
	BNE.S	L211AC
	MOVE.B	(A2),-(A2)
L2117A	
	CMPA.L	A2,A3
	BLT.S	L21136
	RTS
L21184	MOVEQ	#4,D3
	BRA.S	L211AA
L21188	BSR.S	L211B8
	BCS.S	L21200
	MOVEQ	#1,D1
L2118E	LSR.B	#1,D0
	BNE.S	L21196
	MOVE.B	-(A0),D0
	ROXR.B	#1,D0
L21196	ADDX.W	D2,D2
	DBF	D1,L2118E
	MOVE.W	D2,D1
	BEQ.S	L211F8
	ADDQ.W	#1,D1
	ADD.W	D1,D1
	SUBQ.W	#1,D1
	BSR.S	L211E6
	MOVE.W	D2,D3
L211AA	BSR.S	L211C2
L211AC	MOVEA.L	A2,A1
	ADDA.L	D2,A1
L211B0	MOVE.B	-(A1),-(A2)
	DBF	D3,L211B0
	BRA.S	L2117A
L211B8	LSR.B	#1,D0
	BNE.S	L211C0
	MOVE.B	-(A0),D0
	ROXR.B	#1,D0
L211C0	RTS
L211C2	MOVEQ	#0,D4
L211C4	MOVEQ	#1,D1
	MOVEQ	#0,D2
L211C8	LSR.B	#1,D0
	BNE.S	L211D0
	MOVE.B	-(A0),D0
	ROXR.B	#1,D0
L211D0	ADDX.W	D2,D2
	DBF	D1,L211C8
	MOVE.W	D2,D1
	ADDQ.W	#1,D1
	LSL.W	#2,D1
	SUBQ.W	#1,D1
	EOR.B	D1,D4
	BNE.S	L211E6
	RTS
	MOVEQ	#7,D1
L211E6	MOVEQ	#0,D2
L211E8	LSR.B	#1,D0
	BNE.S	L211F0
	MOVE.B	-(A0),D0
	ROXR.B	#1,D0
L211F0	ADDX.W	D2,D2
	DBF	D1,L211E8
	RTS
L211F8	BSR.S	L211C2
	MOVE.W	D2,D3
	MOVEQ	#1,D2
	BRA.S	L211AC
L21200	MOVEQ	#1,D3
	MOVE.B	-(A0),D2
	BRA.S	L211AC
