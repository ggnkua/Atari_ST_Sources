;
; BUG DANS DEVPAC ST :
;
;  SI ON DEFINIT UN LABEL A LA FIN D'UN FICHIER INCLUDE,
;   IL N'EST PAS PRIS EN COMPTE !!!
;
	MOVE.L	#LONGCODE,D0
	BSR	L1E5F0

	LEA	FREQS(PC),A0
	MOVEQ	#0,D2
	MOVEQ	#1,D3
	MOVE.L	(A0)+,D1
L1E63A	CMP.L	(A0)+,D1
	BHS.S	L1E644
	MOVE.L	-4(A0),D1
	MOVE	D3,D2
L1E644	ADDQ.B	#1,D3
	BNE.S	L1E63A
	LEA	OCTET4+1(PC),A0
	MOVE.B	D2,(A0)

	BSR	L1E654
	LEA	OCTET1+1(PC),A0
	MOVE.B	D2,(A0)
	BSR	L1E654
	LEA	OCTET2+1(PC),A0
	MOVE.B	D2,(A0)
	BSR	L1E654
	LEA	OCTET3+1(PC),A0
	MOVE.B	D2,(A0)

	BSR	PASSE1
;
; SAUVEGARDE DU CODE COMPRESSE
;
	PEA	FILEOUT(PC)
	MOVE	#$41,-(SP)	;DELETE FILE !!!!
	TRAP	#1		;(EVITE BUG)
	ADDQ	#6,SP

	CLR	-(A7)
	PEA	FILEOUT(PC)
	MOVE	#$3C,-(A7)	;CREATE FILE
	TRAP	#1
	ADDQ	#8,A7
	TST.L	D0
	BMI.S	ERREUR
	LEA	HANDLE(PC),A0
	MOVE	D0,(A0)

	BSR	ENCRYPT

	MOVE.L	L200A0(PC),A0
	LEA	L1EE32(PC),A1
	SUB.L	A1,A0
	PEA	L1EE32(PC)
	PEA	(A0)
	LEA	-$1C(A0),A0
	LEA	L1EE34(PC),A1
	MOVE.L	A0,(A1)			;SET CODE LENGTH
	MOVE	HANDLE(PC),-(A7)
	MOVE	#$40,-(A7)
	TRAP	#1
	LEA	$C(A7),A7
	TST.L	D0
	BMI.S	ERREUR

	MOVE	HANDLE(PC),-(A7)
	MOVE	#$3E,-(A7)
	TRAP	#1
	ADDQ	#4,A7

ERREUR
	CLR	-(A7)		;RETOUR AU BUREAU
	TRAP	#1

;
; RECHERCHE DE LA FREQUENCE LA MOINS UTILISEE
;
L1E654	LEA	FREQS(PC),A0
	MOVEQ	#0,D2
	MOVEQ	#1,D3
	MOVE.L	(A0)+,D1
L1E668	CMP.L	(A0)+,D1
	BLS.S	L1E672
	MOVE.L	-4(A0),D1
	MOVE.B	D3,D2
L1E672	ADDQ.B	#1,D3
	BNE.S	L1E668

	LEA	FREQS(PC),A0
	MOVE	D2,D3
	ADD	D3,D3
	ADD	D3,D3
	MOVE.L	#$FFFFFFFF,0(A0,D3.W)
	RTS
;
; CALCUL DES FREQUENCES
;
; D0=LONGUEUR
;
L1E5F0	MOVE	#$FF,D1
	LEA	FREQS(PC),A1
L1E5FC	CLR.L	(A1)+
	DBRA	D1,L1E5FC
	LEA	DEBUTCODE(PC),A0
	LEA	FREQS(PC),A1
L1E610	MOVEQ	#0,D1
	MOVE.B	(A0)+,D1
	ADD	D1,D1
	ADD	D1,D1
	ADDQ.L	#1,0(A1,D1.W)
	SUBQ.L	#1,D0
	BNE.S	L1E610
	RTS
;
; PREMIERE PASSE DU COMPACTEUR
;
PASSE1
	LEA	DEBUTCODE(PC),A0
	ADD.L	#LONGCODE+1,A0
	LEA	$1000(A0),A1
	MOVE.L	#LONGCODE+1,D0
L1E37C	MOVE.B	-(A0),-(A1)
	SUBQ.L	#1,D0
	BNE.S	L1E37C

	LEA	DEBUTCODE(PC),A1
	LEA	$1000(A1),A0
	MOVE.L	A0,D7
	ADD.L	#LONGCODE,D7
L1E122	CMP.L	A0,D7
	BLO	L1E29C
	MOVE.B	(A0),D0
	CMP.B	1(A0),D0
	BNE.S	L1E196
	CMP.B	2(A0),D0
	BNE.S	L1E196
	CMP.B	OCTET4+1(PC),D0
	BEQ.S	L1E172
	CMP.B	3(A0),D0
	BNE.S	L1E196
	MOVEQ	#0,D1
L1E14E	CMP.B	(A0),D0
	BNE.S	L1E162
	ADDQ	#1,A0
	ADDQ	#1,D1
	CMP.B	#$FE,D1
	BNE.S	L1E14E
L1E162	MOVE.B	OCTET1+1(PC),(A1)+
	MOVE.B	D0,(A1)+

	SUBQ.B	#1,D1		;COMPTEUR-1 POUR GAGNER DES CYCLES !!!

	MOVE.B	D1,(A1)+
	BRA.S	L1E122
L1E172	MOVEQ	#0,D1
L1E174	CMP.B	(A0),D0
	BNE.S	L1E188
	ADDQ	#1,A0
	ADDQ	#1,D1
	CMP.B	#$FE,D1
	BEQ.S	L1E188
	BRA.S	L1E174
L1E188	MOVE.B	OCTET2+1(PC),(A1)+

	SUBQ.B	#1,D1		;COMPTEUR-1 POUR GAGNER DES CYCLES !!!

	MOVE.B	D1,(A1)+
	BRA.S	L1E122
L1E196	MOVEQ	#2,D1
L1E198	CMP.B	0(A0,D1.W),D0
	BEQ.S	L1E1AC
L1E1A0	ADDQ	#1,D1
	CMP.B	#$30,D1
	BNE.S	L1E198
	BRA.S	L1E22A
L1E1AC	MOVE.L	A0,A2
	MOVEQ	#1,D3
	ADD.L	D1,A2
L1E1B2	MOVE.L	A0,A3
	MOVE.L	D1,D2
	ADDQ.L	#1,D2
L1E1B8	SUBQ.L	#1,D2
	BEQ.S	L1E1C6
	CMP.B	(A2)+,(A3)+
	BEQ.S	L1E1B8
	BRA.S	L1E1E2
;
; ICI UTILISER DBNE !!!
;
L1E1C6	ADDQ.L	#1,D3
	CMP.B	#$FF,D3
	BEQ.S	L1E1E2
	MOVE.L	A0,A3
	MOVE.L	D1,D4
	MULU	D3,D4
	ADD.L	D4,A3
	ADD.L	D1,A3
	CMP.L	A3,D7
	BHI.S	L1E1B2
L1E1E2
	CMP.L	#2,D3
	BHI.S	L1E1FE
	CMP.L	#1,D3
	BLS.S	L1E1A0
	CMP.B	#2,D1
	BLS.S	L1E1A0
L1E1FE
	MOVE.B	OCTET3+1(PC),(A1)+

	SUBQ.B	#1,D1		;COMPTEUR-1 POUR GAGNER DES CYCLES !!!
	MOVE.B	D1,(A1)+
	ADDQ.B	#1,D1

	SUBQ.B	#1,D3		;COMPTEUR-1 POUR GAGNER DES CYCLES !!!
	MOVE.B	D3,(A1)+
	ADDQ.B	#1,D3

	MOVE.L	D1,D2
	MOVE.L	A0,A2
L1E20C	MOVE.B	(A2)+,(A1)+
	SUBQ.L	#1,D2
	BNE.S	L1E20C
	AND.L	#$FF,D1
	AND.L	#$FF,D3
	MULU	D1,D3
	ADD.L	D3,A0
	BRA	L1E122
L1E22A	CMP.B	OCTET1+1(PC),D0
	BEQ.S	L1E26A
	CMP.B	OCTET2+1(PC),D0
	BEQ.S	L1E26A
	CMP.B	OCTET3+1(PC),D0
	BEQ.S	L1E26A
	MOVE.B	(A0)+,(A1)+
	BRA	L1E122
L1E26A	MOVEQ	#0,D1
	CMP.B	1(A0),D0
	BNE.S	L1E28A
	ADDQ.L	#1,D1
	CMP.B	2(A0),D0
	BNE.S	L1E28A
	ADDQ	#1,D1
	CMP.B	3(A0),D0
	BNE.S	L1E28A
	ADDQ	#1,D1
L1E28A	ADDQ	#1,D1
	MOVE.B	OCTET1+1(PC),(A1)+
	MOVE.B	D0,(A1)+

	SUBQ.B	#1,D1		;COMPTEUR-1 POUR GAGNER DES CYCLES !!!

	MOVE.B	D1,(A1)+
	ADDQ.B	#1,D1

	ADD.L	D1,A0
	BRA	L1E122
L1E29C	MOVE.L	A1,D0
	BTST	#0,D0
	BEQ.S	L1E2A8
	ADDQ	#1,A1
L1E2A8
	LEA	DEBUTCODE(PC),A0
	SUB.L	A0,A1
	LEA	LONGUEUR(PC),A0
	MOVE.L	A1,(A0)
;
; DEUXIEME PASSE DU COMPACTEUR
;
	MOVE.L	A1,D0
	BSR	L1E5F0
	LEA	FREQS(PC),A0
	LEA	L200B0(PC),A1
	MOVEQ	#0,D0
L1E6D0	CLR.L	(A1)+		;2 WORDS !!
	MOVE.L	D0,(A1)+	;2 WORDS !!!
	MOVE.L	(A0)+,(A1)+
	ADDQ.B	#1,D0
	BNE.S	L1E6D0

	MOVE	#$100,D0
	LEA	L200B0(PC),A0
	BSR	L1EA92		;TRI DES FREQUENCES

	LEA	L200B0(PC),A0
	MOVEQ	#0,D0
L1E6FA	TST.L	8(A0)
	BEQ.S	L1E710
	LEA	$C(A0),A0
	ADDQ	#1,D0
	BRA.S	L1E6FA
L1E710
	LEA	L200A8(PC),A0
	MOVE	D0,(A0)
L1E71C	CMP	#1,D0
	BEQ.S	L1E734
	LEA	L200B0(PC),A0
	BSR	L1EA92
	LEA	L200A8(PC),A1
	ADDQ	#1,(A1)
	LEA	L200B0(PC),A1
	MOVE	L200A8(PC),D2
	SUBQ	#1,D2
	MULU	#$C,D2
	ADD.L	D2,A1
	MOVE	D0,D1
	SUBQ	#2,D1
	MULU	#$C,D1
	LEA	L200B0(PC),A2
	ADD.L	D1,A2
	MOVE.L	(A2),(A1)
	MOVE.L	4(A2),4(A1)
	MOVE.L	8(A2),8(A1)
	MOVE	L200A8(PC),2(A2)
	MOVE	D0,4(A2)
	LEA	$C(A2),A1
	MOVE.L	8(A1),D2
	ADD.L	D2,8(A2)
	MOVE	#$FFFF,(A2)
	SUBQ	#1,D0
	BRA.S	L1E71C

L1E734
	LEA	L23170(PC),A0
	MOVEQ	#$17,D0
L1E748	CLR.B	(A0)+
	DBRA	D0,L1E748

	MOVEQ	#1,D7
	LEA	L200B0(PC),A0
	LEA	L1F0F6(PC),A6
	MOVEQ	#1,D0
	BSR.S	L1E784		;SAUVE L'ARBRE DE HUFFMANN CODE
;CARRY2	ADD.B	D7,D7
;	BCC.S	CARRY2
;	MOVE.B	D7,(A6)+

	BRA.S	L1E802
;
; SAUVEGARDE DE L'ARBRE DE HUFFMANN
;
; POINT D'ENTREE EN 1E784 !!
;
L1E7B9
	ADD.B	D7,D7
	BSET	#0,D7
	BCC.S	L1E8001
	MOVE.B	D7,(A6)+
	MOVEQ	#1,D7
L1E8001	PEA	(A2)
	MOVE	2(A2),D0
	BSR.S	L1E784
	MOVE.L	(A7)+,A2
	MOVE	4(A2),D0

L1E784	SUBQ	#1,D0
	MULU	#$C,D0
	LEA	0(A0,D0.L),A2
	TST	(A2)
	BNE.S	L1E7B9
L1E7B8	ADD.B	D7,D7
	BCC.S	L1E8002
	MOVE.B	D7,(A6)+
	MOVEQ	#1,D7
L1E8002	MOVE.B	7(A2),D2
	ADD.B	D2,D2
	BSET	#0,D2
L1E7C6	ADDX.B	D7,D7
	BCC.S	L1E8003
	MOVE.B	D7,(A6)+
	MOVEQ	#1,D7
L1E8003	ADD.B	D2,D2
	BNE.S	L1E7C6
	RTS
;
; GENERE LES CODES DE HUFFMANN
;
L1E802	MOVEQ	#1,D0
	LEA	L23170(PC),A0
	BSR	L1E940

	LEA	DEBUTCODE+1(PC),A0
	LEA	$1000(A0),A1
	ADD.L	LONGUEUR(PC),A0
	ADD.L	LONGUEUR(PC),A1
	MOVE.L	LONGUEUR(PC),D0
	ADDQ.L	#4,D0
L1E8DC	MOVE.B	-(A0),-(A1)
	SUBQ.L	#1,D0
	BNE.S	L1E8DC

	LEA	DEBUTCODE+$1000(PC),A0
	MOVE.L	LONGUEUR(PC),D0
L1E822	MOVEQ	#0,D2
	MOVE.B	(A0)+,D2
	MULU	#$18,D2
	LEA	L21910(PC),A2
	ADD	D2,A2
L1E834	MOVE.B	(A2)+,D2
	BEQ.S	L1E85E
	ADD.B	D2,D2
	ADDX.B	D7,D7
	BCC.S	L1E834
	MOVE.B	D7,(A6)+
	MOVEQ	#1,D7
	BRA.S	L1E834
L1E85E	SUBQ.L	#1,D0
	BNE.S	L1E822

CARRY3	ADD.B	D7,D7
	BCC.S	CARRY3
	MOVE.B	D7,(A6)+
	MOVE.L	A6,D0
	BTST	#0,D0
	BEQ.S	CESTPAIR
	CLR.B	(A6)+
CESTPAIR
	LEA	L200A0(PC),A0
	MOVE.L	A6,(A0)
	RTS

L1E940	SUBQ	#1,D0
	MULU	#$C,D0
	LEA	L200B0(PC),A1
	ADD.L	D0,A1
	TST	(A1)
	BEQ.S	L1E97C
	PEA	(A1)
	MOVE.B	#$01,(A0)+	;<>0 ET BIT 7=0
	MOVE	2(A1),D0
	BSR.S	L1E940
	MOVE.L	(A7)+,A1
	CLR.B	-(A0)
	MOVE.B	#$80,(A0)+	;<>0 ET BIT 7=1
	MOVE	4(A1),D0
	BSR.S	L1E940
	CLR.B	-(A0)
	RTS
L1E97C	LEA	L21910(PC),A2
	MOVE	6(A1),D0
	MULU	#$18,D0
	ADD.L	D0,A2
	MOVE	6(A1),$16(A2)
	LEA	L23170(PC),A3
L1E998	MOVE.B	(A3)+,(A2)+
	BNE.S	L1E998
	RTS

;
; TRI DES FREQUENCES SHELL-METZNER
;
L1EA92	MOVEM.L	D0-D7/A0-A6,-(A7)
	MOVE	D0,D1
L1EAA0	LSR	#1,D1
	BEQ.S	L1EB06
	MOVE	D1,D2
L1EAAA	CMP	D2,D0
	BLS.S	L1EAA0
	MOVE.L	D2,D3
	SUB	D1,D3
L1EAB4	BLO.S	L1EAFE
	MOVE	D3,D4
	MULU	#$C,D4
	MOVE.L	A0,A1
	ADD.L	D4,A1
	MOVE.L	A1,A2
	MOVE	D1,D4
	MULU	#$C,D4
	ADD.L	D4,A2
	MOVE.L	8(A1),D5
	CMP.L	8(A2),D5
	BHS.S	L1EAFE
	MOVE.L	(A1),D5
	MOVE.L	(A2),(A1)
	MOVE.L	D5,(A2)
	MOVE.L	4(A1),D5
	MOVE.L	4(A2),4(A1)
	MOVE.L	D5,4(A2)
	MOVE.L	8(A1),D5
	MOVE.L	8(A2),8(A1)
	MOVE.L	D5,8(A2)
	SUB	D1,D3
	BRA.S	L1EAB4
L1EAFE	ADDQ	#1,D2
	BRA.S	L1EAAA
L1EB06	MOVEM.L	(A7)+,D0-D7/A0-A6
	RTS
;
; DATAS
;
FILEOUT		DC.B	"DEMO.TOS",0
		EVEN
HANDLE		DS.W	1
LONGUEUR	DS.L	1		;LONGUEUR DU FICHIER
FREQS		DS.L	$100		;TABLES DE FREQUENCE
L200A0	DS.L	1		;0
L200A8	DS.W	1		;0
L200B0	DS.B	$1860		;0
L21910	DS.B	$1860		;0
L23170	DS.B	$18		;0
;
; PROTECTION DU CODE !!!
;
ENCRYPT
	LEA	L200A0(PC),A3
	MOVE.L	(A3),A6
	CLR.L	(A6)+
	CLR.L	(A6)+
	CLR.L	(A6)+
;
; deuxiäme protection
;
; protection du code du decompacteur
;
	LEA	DEBPREF+2(PC),A2
	MOVE.L	A2,A1
TSTF1	TST.L	(A1)+
	BNE.S	TSTF1
	CMP.L	(A3),A1
	BLO.S	LOW1
	MOVE.L	A1,(A3)
LOW1
	LEA	-4(A1),A0
CODPREF
	MOVE.L	-(A0),D0
	SUB.L	D0,-(A1)
	CMP.L	A2,A1
	BNE.S	CODPREF
;	LEA	AUTOPREF+12(PC),A2
;	CMP.L	A2,A0
;	BEQ.S	PABUG
;	ILLEGAL
;PABUG
	MOVE.L	AUTOPREF+2(PC),D0
	SUB.L	D0,-(A1)		;D0.HW=4 !!
;
; premiäre protection
;
	LEA	L1EE4E(PC),A2
	MOVE.L	A2,A0
TSTF2	TST.L	(A0)+
	BNE.S	TSTF2
	CMP.L	(A3),A0
	BLO.S	LOW2
	MOVE.L	A0,(A3)
LOW2
	SUB.L	#DEBCRY-L1EE4E,A0
CRYPT
	MOVE.L	-(A0),D0
	SUB.L	D0,DEBCRY-L1EE4E(A0)
	CMP.L	A2,A0
	BNE.S	CRYPT
	RTS

RDBYTE	MACRO
	MOVE.L	A4,A7
	MOVE	D1,\1
\@1	ADD.L	D2,D2
	BNE.S	\@2
	MOVE.L	(A2)+,D2
	ADDX.L	D2,D2
\@2	BCS.S	\@3
	MOVEQ	#2,\1
\@3	ADD	\1,A7
	MOVE	(A7)+,\1
	BNE.S	\@1
	ADDQ	#1,(A0)
	MOVE.B	(A7),\1
	ENDM
;
; ENTETE DU PROGRAMME
;
L1EE32	BRA.S	L1EE4E		;$601A
L1EE34	DC.L	0		;TAILLE CODE
	DC.L	0
	DC.L	0
	DC.L	0,0,0
	DC.W	$FFFF
L1EE4E
;
; PREMIER DECODAGE
;
; DECODAGE DU TEXTE (POUR LES GOGOS)
;
	LEA	L1EE4E(PC),A0
DECRYPT
	MOVE.L	(A0)+,D0
	ADD.L	D0,DEBCRY-L1EE4E-4(A0)
	BNE.S	DECRYPT
DEBCRY
	MOVE	#4,-(SP)
	TRAP	#14
	ADDQ	#2,SP
	SUBQ	#1,D0
	BLS	LOWRES
	PEA	MESBUG(PC)
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP
	MOVE	#7,-(SP)
	TRAP	#1
	CLR	(SP)
	TRAP	#1

MESSAGE
	DC.B	$1B,"f",$1B,"E"
	DC.B	"MAGNUM FORCE UNPACKER IN ACTION..."
	DC.B	13,10
	DC.B	"THE FASTEST IN THE WORLD !!!!"
	DC.B	0
MESBUG
	DC.B	"SORRY BUT THE MAGNUM FORCE DEMO CAN'T RUN IN HIGH-RES"
	DC.B	13,10,0
	EVEN
LOWRES
	PEA	MESSAGE(PC)
	MOVE	#9,-(SP)
	TRAP	#1
	ADDQ	#6,SP

;	MOVE.L	4(A7),A4
;	MOVE.L	$18(A4),A4		;ADRESSE DEBUT BSS
	LEA	-2500(A7),A4

	MOVE	SR,D0
	AND	#$2000,D0
	BNE.S	SUPER
	CLR.L	-(SP)
	MOVE	#$20,-(SP)
	TRAP	#1
	ADDQ	#6,SP
SUPER
	MOVE	#$2700,SR
;
; DEUXIEME DECODAGE
;
; DECODAGE DU DECOMPACTEUR (POUR LES PROS)
;
	LEA	AUTOPREF+2-4(PC),A0
	LEA	DEBPREF-2(PC),A1
	MOVEQ	#-1,D1
AUTOPREF
	LEA	4(A0),A0	;ASTUCE !!!
	MOVE.L	(A0)+,D0
	ADD.L	D0,(A1)+
	DBEQ	D1,AUTOPREF+4
DEBPREF
	LEA	$FFFF8260.W,A0
	MOVEQ	#0,D2
	MOVEQ	#0,D6
	MOVEQ	#0,D7
	MOVEM.L	D2/D6/D7,-(A0)
	MOVEM.L	D6/D7,-(A0)
	MOVEM.L	D2/D6/D7,-(A0)
;
; X=1 ICI ????
;
;	BSET	#31,D2
	ROXR.L	#1,D2

	LEA	L1F0F6(PC),A2
;	LEA	BUFFER(PC),A1
	MOVE.L	A2,A1
	BSR	DECODE		;COLLECTE LES CODES DE HUFFMANN
				;A PARTIR DE A4
	MOVE	(A4)+,D1
;
; ATTENTION !!!
;
; LE DECOMPRESSEUR S'ARRETE QUAND IL RECOIT DES OCTETS DIFFERENTS !!!
;
	LEA	DEBUT\W,A5

	OPT	P-
	LEA	FINCODE,A6
	OPT	P+

OCTET3	MOVEQ	#0,D6
OCTET4	MOVEQ	#0,D7
L1F05F
OCTET1	MOVEQ	#0,D4
OCTET2	MOVEQ	#0,D5
L1EE82
	RDBYTE	D0

	CMP.B	D4,D0
	BEQ.S	L1EEA6
	CMP.B	D5,D0
	BEQ.S	L1EEBA
	CMP.B	D6,D0
	BEQ.S	L1EECE
	MOVE.B	D0,(A5)+
	CMP.L	A6,A5
	BLO.S	L1EE82
	JMP	startup-FINCODE(A6)	;ILLISIBLE !!!

L1EEA6	RDBYTE	D3
	RDBYTE	D0
L1EEB2	MOVE.B	D3,(A5)+
	DBRA	D0,L1EEB2
	BRA.S	L1EE82

L1EEBA	RDBYTE	D0
L1EEC6	MOVE.B	D7,(A5)+
	DBRA	D0,L1EEC6
	BRA	L1EE82

L1EECE	RDBYTE	D3
	MOVE	D3,D4
	RDBYTE	D5
	MOVE.L	A1,A3
NXTBYT
	MOVE.L	A4,A7
	MOVE	D1,D0
RD1	ADD.L	D2,D2
	BNE.S	RD2
	MOVE.L	(A2)+,D2
	ADDX.L	D2,D2
RD2	BCS.S	RD3
	MOVEQ	#2,D0
RD3	ADD	D0,A7
	MOVE	(A7)+,D0
	BNE.S	RD1
	ADDQ	#1,(A0)
	MOVE.B	(A7),(A3)+
	DBRA	D4,NXTBYT

L1EEDA	MOVE	D3,D0
	MOVE.L	A1,A3
L1EEE4	MOVE.B	(A3)+,(A5)+
	DBRA	D0,L1EEE4
	DBRA	D5,L1EEDA
	BRA	L1F05F

;
; LECTURE D'UN OCTET CODE PAR HUFFMANN
;
;
; ROUTINE RECURSIVE
;
; UTILISE A6,A2
;
DECODE3
;	ADDQ	#4,D6		;MARQUAGE D'UNE BRANCHE
	PEA	(A6)		;A6 POINTE SUR LA FEUILLE DE DROITE
	BSR.S	DECODE2
;	ADDQ	#4,D6
	MOVE.L	(A7)+,A6
	MOVE.L	A4,D0
	SUB.L	A6,D0		;A4-A6+D6
	ADD	D6,D0
	ADDQ	#2,D0
;	SUBQ	#2,D0
	MOVE	D0,(A6)		;POINTE SUR LA FEUILLE DE GAUCHE
DECODE2	ADDQ	#4,D6
DECODE
	LEA	0(A4,D6.W),A6

	ADD.L	D2,D2
	BNE.S	TSTCARY2
	MOVE.L	(A2)+,D2
	ADDX.L	D2,D2
TSTCARY2
	BCS.S	DECODE3

	CLR	(A6)+		;MARQUE UN NOEUD TERMINAL
	MOVEQ	#1,D1
L1F2EE	ADD.L	D2,D2
	BNE.S	TSTCARY3
	MOVE.L	(A2)+,D2
	ADDX.L	D2,D2
TSTCARY3
	ADDX.B	D1,D1
	BCC.S	L1F2EE
	MOVE.B	D1,(A6)		;ET STOCKE SA VALEUR
	RTS
;BUFFER
L1F0F6	DS.B	$200		;AVEC $00

; FIN DU TRANSFERT
; DEBUTCODE
