NBOCT:	EQU	512

	LEA	$FC0000,A6
	MOVE	#$FF0000-$FC0000/NBOCT,CPT
SUITE:
	MOVE.L	A6,A0
	LEA	$40000,A1
	MOVE	#NBOCT,D0
	BSR	COMPACTE
	LEA	$40000,A0
	LEA	$60000,A1
	MOVE	#NBOCT,D0
	BSR	DECOMP
	MOVE.L	A6,A0
	LEA	$60000,A1
	MOVE	#NBOCT-1,D0
	BSR	COMPARE
	BNE.S	O
OL:
	ADD.L	#NBOCT,A6
	SUBQ	#1,CPT
	BNE.S	SUITE
O:
	ILLEGAL
CPT:	DC.W	0
MAX1:	DC.B	0
MIN1:	DC.B	$FF
MAX3:	DC.B	0
MIN3:	DC.B	$FF

MAX4:	DC.B	0
MIN4:	DC.B	$FF
MAX5:	DC.B	0
MIN5:	DC.B	$FF

;
; ENTREE :
;
;	A0=SOURCE
;	A1=DESTINATION
;	D0=NB OCTETS
;
; SORTIE :
;	A0=FIN SOURCE
;	A1=FIN DESTINATION
;
; REGISTRES :
;	D0.W=COMPTEUR
;	D1=SCRATCH
;	D3.B=FLAG
;	D4.B=OCTET
;	D5.B=OCTET
;	D6=COMPTEUR.B
;	D7=COMPTEUR.B
;
;	A0=SOURCE
;	A1=DESTINATION
;
COMPACTE:
	CLR.B	D3		;NO REPEAT
	MOVEQ	#0,D7
	MOVEQ	#0,D6
	MOVE.B	(A0)+,D5
	MOVE.B	D5,1(A1)
L6A:
	SUBQ	#1,D0
	BEQ.L	L70
L5C:
	MOVE.B	(A0)+,D4
	MOVE.B	D4,2(A1,D6.W)
	ADDQ	#1,D6
	TST.B	D3
	BEQ.S	LC6		;REPEAT ?
	CMP.B	D5,D4		;OUI
	BNE.S	L96
	MOVE	D6,D1
	SUB.B	D7,D1
	CMP.B	#$80,D1
	BLS.S	L6A
L96:	SUB	D6,D7

	ADDQ	#1,D7

	CMP.B	MAX1,D7
	BLS.S	PAMX1
	MOVE.B	D7,MAX1
PAMX1:
	CMP.B	MIN1,D7
	BHS.S	PAMX2
	MOVE.B	D7,MIN1
PAMX2:
	MOVE.B	D7,(A1)+
	MOVE.B	D5,(A1)+
	MOVE.B	D4,1(A1)
	MOVEQ	#0,D6
	MOVEQ	#0,D7
	CLR.B	D3
	BRA.L	L68
LC6:
	TST.B	D6
	BPL.S	LEE
	MOVE.B	#$7F,(A1)+
	LEA	$80(A1),A1
	MOVE.B	D4,1(A1)
	MOVEQ	#0,D6
	MOVEQ	#0,D7
	BRA.S	L68
LEE:
	CMP.B	D5,D4
	BNE.S	L60
	MOVE	D6,D1
	SUB	D7,D1
	CMP	#2,D1
	BLO.S	L52
	ST	D3
	MOVE	D7,D1
	BEQ.L	L6A
	SUBQ	#1,D1
	CMP.B	MAX4,D1
	BLS.S	PAMX5
	MOVE.B	D1,MAX4
PAMX5:
	CMP.B	MIN4,D1
	BHS.S	PAMX6
	MOVE.B	D1,MIN4
PAMX6:
	MOVE.B	D1,(A1)+
	ADD	D7,A1
	SUB	D7,D6
	MOVEQ	#0,D7
	BRA.L	L6A
L52:	TST	D7
	SEQ	D3
	BRA.L	L6A
L60:	MOVE	D6,D7
L68:	MOVE.B	D4,D5
	SUBQ	#1,D0
	BNE.L	L5C
L70:
	TST.B	D3
	BEQ.S	L7E
	SUB	D6,D7

	CMP.B	MAX3,D7
	BLS.S	PAMX7
	MOVE.B	D7,MAX3
PAMX7:
	CMP.B	MIN3,D7
	BHS.S	PAMX8
	MOVE.B	D7,MIN3
PAMX8:
	MOVE.B	D7,(A1)+
	MOVE.B	D5,(A1)+
	RTS
L7E:
	CMP.B	MAX5,D6
	BLS.S	PAMX9
	MOVE.B	D6,MAX5
PAMX9:
	CMP.B	MIN5,D6
	BHS.S	PAMX10
	MOVE.B	D6,MIN5
PAMX10:
	MOVE.B	D6,(A1)+
	LEA	1(A1,D6.W),A1
	RTS
;
; ENTREE :
;
;	D0=NB OCTETS A DECOMPRESSER
;
DECOMP:
	LEA	0(A1,D0.W),A2
DECOMP1:
	CLR	D0
	MOVE.B	(A0)+,D0
	BMI.S	L41606
L415F6:	MOVE.B	(A0)+,(A1)+
	DBRA	D0,L415F6
	CMP.L	A2,A1
	BLO.S	DECOMP1
	BNE	O
	RTS
L41606:	NEG.B	D0
	MOVE.B	(A0)+,D1
L4160E:	MOVE.B	D1,(A1)+
	DBRA	D0,L4160E
	CMP.L	A2,A1
	BLO.S	DECOMP1
	BNE	O
	RTS

COMPARE:
	CMPM.B	(A0)+,(A1)+
	DBNE	D0,COMPARE
	RTS
