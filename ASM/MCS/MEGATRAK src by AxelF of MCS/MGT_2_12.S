  	*	Mega tracker
	*       By Axel Follet
	*   Started on the november,15th 1990
	*	Falcon Only

	*	32 stereo digitals channels at 50 khz
	*	About 70 % of 68030 time left
	
	*	Version DSP	(may, 13th 1994)
	*       With Tempo      (june, 4th 1994)
	
	*  Cool, no ?
	
	*NOP
	
	OPT	D+
	OPT	O-
	
	
	
DEMO		EQU	0		* 1 = DEMO (SAVE DISABLED)
FINSAMPLE	EQU	1200
FINSAMPLE_MOD	EQU	700

*--------------------------------------------------------------------------
		RSRESET				* SAMPLE
NAME_MGT	RS.B	32

DEB_MGT		RS.L	1
LEN_MGT		RS.L	1
LOOP_DEB_MGT	RS.L	1
LOOP_FIN_MGT	RS.L	1
LEN_BUF_MGT	RS.W	1
LEN_FIN_MGT	RS.L	1

BASE_MGT	RS.W	1
PANO_MGT	RS.W	1			* PANORAMIQUE
VOL_MGT		RS.W	1
BIT1_MGT	RS.W	1

VIDE_MGT	RS.B	1
F_TUNE_MGT	RS.B	1
NOTE_MGT	RS.B	1
COMMAND_MGT	RS.B	1
PARAM_MGT	RS.W	1
RESERVE_MGT	RS.L	2

FIN_MGT		RS.L	1

LEN_SAMPLE_MGT	RS.B	1
*--------------------------------------------------------------------------
		RSRESET				* SAUVEGARDE
S_ENTETE	RS.L	2
S_NBVOICE	RS.W	1
S_NBMUS		RS.W	1
S_NBSEQ		RS.W	1
S_NBPATT	RS.W	1
S_NBTRK		RS.W	1
S_NBSPL		RS.W	1
*S_VIDE		RS.W	1
S_DEBMUS	RS.L	1
S_DEBSPLDATA	RS.L	1
S_DEBSEQ	RS.L	1
S_DEBPATT	RS.L	1
S_DEBTABTRACK	RS.L	1
S_DEBSPL	RS.L	1
S_LENSPL	RS.L	1
S_LEN_BUF_SPL	RS.L	1
S_LEN_DEPACKED_TRACKS	RS.L	1

LEN_S		RS.L	1
*--------------------------------------------------------------------------

	JMP	BEGIN
BEGIN2	
				*Ici va se derouler tous ce qui n'est
				*pas en VBL (fileselect,input)
niet
	CMP.W	#1,fin
	BEQ	da
	TST	okp
	BEQ.S	niet
	MOVEQ	#0,D0
	MOVE.W	okp,D0
	JSR	([SAUT,D0.W*4])
	BRA.S	niet

SAUT	DC.L	0,FILESEL,INPT2,OFF_134,CLRSPL1,CLRPTN1,SPLTSPE,SCROL,TRI,LOADE
	DC.L	SAUVE,AFFPATTERN2,VOL_OK,VOL_OK,VOL_OK,VOL_OK
	DC.L	ADDMAXTRK,ADDMAXPAT,ADDMAXPOS,CLRTRK1,ADDMAXMUS,SUBMAXMUS
	DC.L	SUBMAXPOS,SUBMAXPAT,SUBMAXTRK,CLRPOS1,CLRMUS1
	DC.L	INSERT1,DELETE1,ADDLOOPDEB,ADDLOOPFIN,SUBLOOPFIN 
	DC.L	STATE_LOOP2	* LAST = 32
****************************** FIN ****************************************
da	JSR	RESTORE
	MOVE.B	#$80+$28/2,$FFFFA201.W	* Host User 1, vecteur $28 STOP
	MOVE.W  #0,$FFFF8900.W
	MOVE.B	#8,$FFFFFC02.W
	MOVE.W	#$666,$FFFF8246.W
	BSR.L	CLRKEYB
	MOVE.W	rezo,-(A7)
	MOVE.W	#3,-(A7)
	MOVE.L	ecran,-(A7)
	MOVE.L	ecran,-(A7)
	MOVE.W	#5,-(A7)
	TRAP 	#14
	ADD.W	#14,A7
	MOVE.L	pile,-(A7)
	MOVE.W	#$20,-(A7)
	TRAP #1
	ADDQ.L	#6,A7
	BSR.L	CLRKEYB
	CLR.L	-(A7)
	TRAP	 #1
	
	IFNE	DEMO
MOUSEABS	DC.B	9,02,$80-16,2,$1C-16,0,0,0,0
	ELSEIF
MOUSEABS	DC.B	9,02,$80-16,2,$1C-16,0,0,0,0
	ENDC
	EVEN
***************************************************************************
MY_70	MOVE.W	#$2700,SR
	MOVE.B	#$D,$FFFFFC02.W
	MOVEM.L	D0-A6,-(a7)
	MOVE.W	compt2,-(a7)
	MOVE.L	where,-(a7)
	MOVEQ	#0,D0
	MOVE.W	SCREENY,D0
	MULU	#640,D0
	ADD.L	#screen,D0
	MOVE.L	D0,-(A7)
	MOVE.B	2(A7),$ffff8203.W
	MOVE.B	1(A7),$ffff8201.W
	MOVE.B	3(A7),$ffff820D.W
	ADDQ.W	#4,A7
	MOVE.W	#$2300,SR

	CLR.W	waiting
	
	CMP.W	#0,SPRITING
	BNE.S	.PO
	MOVE.W	#1,SPRITING
	JSR	RESTITU
	JSR	FOND2
	JSR	AFFMOUSE
	MOVE.W	#0,SPRITING
	
.PO	JSR	TESTBORDS
	
	TST.W	okp
	BNE.S	.P1
	BSR	POSMOUSE
	BSR	FONCT
	BSR.L	KEYB
.POK2	
	
.P1	MOVE.L	(A7)+,where
	MOVE.W	(A7)+,compt2
	MOVEM.L	(A7)+,D0-A6
	RTE
SPRITING	DC.W	0	
***************************************************************************
OLD_134
	CMP.L	#0,COLOR
	BEQ.S	.AA
	MOVE.L	#$99000066,$FFFF9800.W
.AA	*MOVE.W	#$2700,SR
	MOVE.W	compt2,-(a7)
	MOVE.L	where,-(a7)
	
	CMP.B	#1,playpat
	BNE.S	.bl1
	JSR	VBLPAT
	
.bl1	CMP.B	#1,record
	BNE.S	.bl2
	JSR	VBLRECORD
	
.bl2	CMP.B	#1,playsong
	BNE.S	.bl3
	JSR	VBLPAT
	
.bl3	MOVE.L	(A7)+,where
	MOVE.W	(A7)+,compt2
	ADDQ.W	#1,TEMP
	CMP.B	#1,ASK_OFF
	BNE.S	.GH
	MOVE.B	#2,ASK_OFF
.GH	RTS

TEMP	DC.W	0
***************************************************************************
Code_Sample_Lenght	DC.W	0
Sample_Lenght		DC.W	0
Timer_Data		DC.B	0
Timer_Control		DC.B	0
***************************************************************************
POSMOUSE
	BTST.B	#3,km
	BNE.S	.UNCLICK
	BTST.B	#1,km
	BNE.S	.UNCLICK
	BTST.B	#2,km			*Bouton gauche
	BNE.S	.za1
	BTST.B	#0,km			*Bouton droit
	BNE.S	.za2
	BRA	retour

.UNCLICK
	MOVE.B	#0,km
	MOVE.B	#0,LASTKM
	RTS
	
.za1	LEA	pos,A0
	BRA.S	.za3
.za2	LEA	pos2,A0

.za3	MOVEQ	#0,D0
	MOVE.B	km,D0
	CMP.B	LASTKM,D0
	BEQ	KM1
	
	MOVE.B	km,LASTKM
	MOVE.B	#0,WAITKM3
	MOVE.B	#0,WAITKM2
KM6	MOVE.B	km,km2
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.W	X1,D0
	MOVE.W	Y1,D1
	LEA	jump,A1
.suite	MOVE.L	(a0)+,d2		*X min
	MOVE.L	(a0)+,d3		*Y min
	MOVE.L	(a0)+,d4		*X max
	MOVE.L	(a0)+,d5		*Y max
	MOVE.L	(a0)+,a1		*JUMP
	cmp.l	#-1,d2
	beq	retour
	cmp.W	D0,d2
	bgt.s	.suite
	cmp.W	D0,d4
	blt.s	.suite
	cmp.W	D1,d3
	bgt.s	.suite
	cmp.W	D1,d5
	blt.s	.suite
	jmp	(a1)
	
pos	
	DC.L 426,152,494,160,CLRALL,426,160,494,168,CLRMUS
	DC.L 426,168,494,176,CLRPOS,426,176,494,184,CLRPTN
	DC.L 426,184,494,192,CLRTRK,426,192,494,200,CLRSPL
	DC.L 2,49,64,71,LOADER,65,49,126,71,SAUVEUR,163,313,246,328,EDIT
	DC.L 338,291,406,350,OFF_134B,0,0,126,30,EXIT

	DC.L 0,80,64,104,MASKMODULE,64,80,128,104,MASKSAMPLE
	
	DC.L 1,313,239,319,INPUT,250,328,334,342,PLAYPATT,250,313,334,328,PLAYSONG
	DC.L 163,328,246,342,RECORD
	DC.L 464,312,472,320,ADDNUM100,472,312,480,320,ADDNUM10,480,312,488,320,ADDNUM1
	DC.L 456,320,464,328,ADDPOS1000,464,320,472,328,ADDPOS100,472,320,480,328,ADDPOS10,480,320,488,328,ADDPOS1
	DC.L 456,328,464,336,ADDPAT1000,464,328,472,336,ADDPAT100,472,328,480,336,ADDPAT10,480,328,488,336,ADDPAT1
	DC.L 456,344,464,352,ADDLOP1000,464,334,472,352,ADDLOP100,472,344,480,352,ADDLOP10,480,344,488,352,ADDLOP1
	
	DC.L 480,104,504,112,TYPE,470,112,504,120,INSERT,470,120,504,128,DELETE

	DC.L 64,256,72,264,ADDLOOPDEB1000000,72,256,80,264,ADDLOOPDEB100000
	DC.L 80,256,88,264,ADDLOOPDEB10000,88,256,96,264,ADDLOOPDEB1000
	DC.L 96,256,104,264,ADDLOOPDEB100,104,256,112,264,ADDLOOPDEB10
	DC.L 112,256,120,264,ADDLOOPDEB1
	
	DC.L 64,264,72,272,ADDLOOPFIN1000000,72,264,80,272,ADDLOOPFIN100000
	DC.L 80,264,88,272,ADDLOOPFIN10000,88,264,96,272,ADDLOOPFIN1000
	DC.L 96,264,104,272,ADDLOOPFIN100,104,264,112,272,ADDLOOPFIN10
	DC.L 112,264,120,272,ADDLOOPFIN1
	DC.L 14,280,40,288,STATE_LOOP

	DC.L 72,320,80,328,ADDBASE10000,80,320,88,328,ADDBASE1000,88,320,96,328,ADDBASE100
	DC.L 96,320,104,328,ADDBASE10,104,320,112,328,ADDBASE1
	
	DC.L 512,312,520,320,ADDMAXNUM10,520,312,528,320,ADDMAXNUM1
	DC.L 504,320,512,328,ADDMAXPOS100,512,320,520,328,ADDMAXPOS10,520,320,528,328,ADDMAXPOS1
	DC.L 504,328,512,336,ADDMAXPAT100,512,328,520,336,ADDMAXPAT10,520,328,528,336,ADDMAXPAT1
	DC.L 504,336,512,344,ADDMAXTRK100,512,336,520,344,ADDMAXTRK10,520,336,528,344,ADDMAXTRK1
	
	DC.L 153,27,327,196,TEST_FILE,138,24,153,32,EXIT_REP,343,9,399,103,SUB1FS
	DC.L 343,113,399,205,ADD1FS,79,119,88,128,PLUSDRIVE,16,112,78,134,ACCEPT

	DC.L 32,362,146,502,V0,152,362,266,502,V1,272,362,386,502,V2,392,362,506,502,V3,512,362,626,502,V4

	DC.L 0,362,16,378,SCROLL_VOICE_RIGHT,16,362,32,378,SCROLL_VOICE_LEFT
	
	DC.L 200,232,208,240,ON0,224,232,232,240,ON1,248,232,256,240,ON2
	DC.L 272,232,280,240,ON3,296,232,304,240,ON4,320,232,328,240,ON5
	DC.L 344,232,352,240,ON6,368,232,376,240,ON7,392,232,400,240,ON8
	DC.L 416,232,424,240,ON9,440,232,448,240,ON10,464,232,472,240,ON11
	DC.L 488,232,496,240,ON12,512,232,520,240,ON13,536,232,544,240,ON14,560,232,568,240,ON15
	DC.L 200,264,208,272,ON16,224,264,232,272,ON17,248,264,256,272,ON18
	DC.L 272,264,280,272,ON19,296,264,304,272,ON20,320,264,328,272,ON21
	DC.L 344,264,352,272,ON22,368,264,376,272,ON23,392,264,400,272,ON24
	DC.L 416,264,424,272,ON25,440,264,448,272,ON26,464,264,472,272,ON27
	DC.L 488,264,496,272,ON28,512,264,520,272,ON29,536,264,544,272,ON30,560,264,568,272,ON31

	*DC.L 200+8,232,208+8,240,BR0,224+8,232,232+8,240,BR1,248+8,232,256+8,240,BR2
	*DC.L 272+8,232,280+8,240,BR3,296+8,232,304+8,240,BR4,320+8,232,328+8,240,BR5
	*DC.L 344+8,232,352+8,240,BR6,368+8,232,376+8,240,BR7,392+8,232,400+8,240,BR8
	*DC.L 416+8,232,424+8,240,BR9,440+8,232,448+8,240,BR10,464+8,232,472+8,240,BR11
	*DC.L 488+8,232,496+8,240,BR12,512+8,232,520+8,240,BR13,536+8,232,544+8,240,BR14,560+8,232,568+8,240,BR15
	*DC.L 200+8,264,208+8,272,BR16,224+8,264,232+8,272,BR17,248+8,264,256+8,272,BR18
	*DC.L 272+8,264,280+8,272,BR19,296+8,264,304+8,272,BR20,320+8,264,328+8,272,BR21
	*DC.L 344+8,264,352+8,272,BR22,368+8,264,376+8,272,BR23,392+8,264,400+8,272,BR24
	*DC.L 416+8,264,424+8,272,BR25,440+8,264,448+8,272,BR26,464+8,264,472+8,272,BR27
	*DC.L 488+8,264,496+8,272,BR28,512+8,264,520+8,272,BR29,536+8,264,544+8,272,BR30,560+8,264,568+8,272,BR31
	
	*DC.L 200,240,208,248,BLK0,224,240,232,248,BLK1,248,240,256,248,BLK2
	*DC.L 272,240,280,248,BLK3,296,240,304,248,BLK4,320,240,328,248,BLK5
	*DC.L 344,240,352,248,BLK6,368,240,376,248,BLK7,392,240,400,248,BLK8
	*DC.L 416,240,424,248,BLK9,440,240,448,248,BLK10,464,240,472,248,BLK11
	*DC.L 488,240,496,248,BLK12,512,240,520,248,BLK13,536,240,544,248,BLK14,560,240,568,248,BLK15
	*DC.L 200,272,208,280,BLK16,224,272,240,280,BLK17,248,272,256,280,BLK18
	*DC.L 272,272,280,280,BLK19,296,272,304,280,BLK20,320,272,328,280,BLK21
	*DC.L 344,272,352,280,BLK22,368,272,376,280,BLK23,392,272,400,280,BLK24
	*DC.L 416,272,424,280,BLK25,440,272,448,280,BLK26,464,272,472,280,BLK27
	*DC.L 488,272,496,280,BLK28,512,272,520,280,BLK29,536,272,544,280,BLK30,560,272,568,280,BLK31
	
	*DC.L 8,328,55,335,MONOSTEREO
	DC.L 144,328,152,336,SPESPL
	DC.L 48,169,88,176,PIANO_DRUM
	DC.L 64,240,72,248,PLUS_100_VOLUME_SPL,72,240,80,248,PLUS_10_VOLUME_SPL,80,240,88,248,PLUS_1_VOLUME_SPL
	DC.L 40,297,63,304,PLUSFRQSPL,120,297,136,304,PLUSCOMSPL
	DC.L 80,304,88,311,PLUS1000PARAMSPL,88,304,96,311,PLUS100PARAMSPL
	DC.L 96,304,104,311,PLUS10PARAMSPL,104,304,112,311,PLUS1PARAMSPL
	DC.L 96,336,112,344,PLUSFTUNE,432,72,465,80,PLUS_1_NBVF
	DC.L 88,184,120,192,UPDIGIPL
	DC.L 96,192,104,200,PLUS100PL,104,192,112,200,PLUS10PL,112,192,120,200,PLUS1PL
	DC.L -1
	
pos2	DC.L 464,312,472,320,SUBNUM100,472,312,480,320,SUBNUM10,480,312,488,320,SUBNUM1
	DC.L 456,320,464,328,SUBPOS1000,466,320,472,328,SUBPOS100,472,320,480,328,SUBPOS10,480,320,488,328,SUBPOS1
	DC.L 456,328,464,336,SUBPAT1000,464,328,472,336,SUBPAT100,472,328,480,336,SUBPAT10,480,328,488,336,SUBPAT1
	DC.L 456,336,464,344,SUBLEN1000,464,336,472,344,SUBLEN100,472,336,480,344,SUBLEN10,480,336,488,344,SUBLEN1
	DC.L 456,344,464,352,SUBLOP1000,464,334,472,352,SUBLOP100,472,344,480,352,SUBLOP10,480,344,488,352,SUBLOP1
	
	DC.L 512,312,520,320,SUBMAXNUM10,520,312,528,320,SUBMAXNUM1
	DC.L 504,320,512,328,SUBMAXPOS100,512,320,520,328,SUBMAXPOS10,520,320,528,328,SUBMAXPOS1
	DC.L 504,328,512,336,SUBMAXPAT100,512,328,520,336,SUBMAXPAT10,520,328,528,336,SUBMAXPAT1
	DC.L 504,336,512,344,SUBMAXTRK100,512,336,520,344,SUBMAXTRK10,520,336,528,344,SUBMAXTRK1
	
	DC.L 64,256,72,264,SUBLOOPDEB1000000,72,256,80,264,SUBLOOPDEB100000
	DC.L 80,256,88,264,SUBLOOPDEB10000,88,256,96,264,SUBLOOPDEB1000
	DC.L 96,256,104,264,SUBLOOPDEB100,104,256,112,264,SUBLOOPDEB10
	DC.L 112,256,120,264,SUBLOOPDEB1
	
	DC.L 64,264,72,272,SUBLOOPFIN1000000,72,264,80,272,SUBLOOPFIN100000
	DC.L 80,264,88,272,SUBLOOPFIN10000,88,264,96,272,SUBLOOPFIN1000
	DC.L 96,264,104,272,SUBLOOPFIN100,104,264,112,272,SUBLOOPFIN10
	DC.L 112,264,120,272,SUBLOOPFIN1 
	DC.L 14,280,40,288,STATE_LOOP
	
	DC.L 72,320,80,328,SUBBASE10000,80,320,88,328,SUBBASE1000,88,320,96,328,SUBBASE100
	DC.L 96,320,104,328,SUBBASE10,104,320,112,328,SUBBASE1
	
	DC.L 343,9,399,103,SUB18FS,343,113,399,205,ADD18FS,79,119,88,128,MOINSDRIVE,16,112,78,134,ACCEPT
	*DC.L 8,328,55,335,MONOSTEREO
	DC.L 144,328,152,336,SPESPL
	DC.L 40,297,63,304,MOINSFRQSPL
	DC.L 80,304,88,311,MOINS1000PARAMSPL,88,304,96,311,MOINS100PARAMSPL
	DC.L 120,297,136,304,MOINSCOMSPL,96,304,104,311,MOINS10PARAMSPL
	DC.L 104,304,112,311,MOINS1PARAMSPL,96,336,112,344,MOINSFTUNE
	DC.L 64,240,72,248,MOINS_100_VOLUME_SPL,72,240,80,248,MOINS_10_VOLUME_SPL,80,240,88,248,MOINS_1_VOLUME_SPL
	DC.L 432,72,465,80,MOINS_1_NBVF,88,184,120,192,DOWNDIGIPL
	DC.L 96,192,104,200,MOINS100PL,104,192,112,200,MOINS10PL,112,192,120,200,MOINS1PL
	
	DC.L 32,362,146,502,V0,152,362,266,502,V1,272,362,386,502,V2,392,362,506,502,V3,512,362,626,502,V4
	DC.L 0,362,16,378,SCROLL_VOICE_RIGHT,16,362,32,378,SCROLL_VOICE_LEFT
	DC.L -1
jump	dc.l	0
***************************************************************************
KM1	CMP.B	#1,WAITKM2
	BEQ.S	.KM4
	ADDQ.B	#1,WAITKM3
	CMP.B	#15,WAITKM3
	BEQ.S	.KM2
	RTS
.KM2	MOVE.B	#1,WAITKM2
	MOVE.B	#0,WAITKM3
	BRA	KM6
	
.KM4	ADDQ.B	#1,WAITKM3
	CMP.B	#4,WAITKM3
	BNE	retour
	MOVE.B	#0,WAITKM3
	BRA	KM6
WAITKM2		DC.B	0
WAITKM3		DC.B	0
LASTKM		DC.W	0
***************************************************************************
EXIT	MOVE.W	#1,fin
ITO	RTS

FONCT	CMP.W	#-1,touche
	BEQ.S	ITO
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	CMP.B	#1,DRUM
	BEQ	FONCT2
					* MODE DRUM
	LEA	FONCTION,A0		* D'ABORD VOIR SI C'EST UNE
	MOVE.W	touche,D1		* FONCTION
.ML1	MOVE.B	(A0)+,D2
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D0
	BEQ	ML2
	CMP.B	D2,D1
	BNE.S	.ML1
	LEA	FO1,A0
	CMP.B	#1,SHIFT_LEFT
	BNE.S	.ZZ
	LEA	FO1_SHIFTED,A0
.ZZ	MOVE.L	(A0,D0.W*4),A0
	JMP	(A0)

FO1	DC.L	ML2,PLAYSONG,CHNGCOLOR,OFF_134B,LEFTCURSOR,RIGHTCURSOR
	DC.L	DOWNCURSOR,UPCURSOR,UPLANCHE,DOWNPLANCHE,PLUSFRQSPL
	DC.L	SPESPL,VOL_OK,ERASE,LOOP,INPUT,CHG_REZ
	DC.L	ML2,ML2,DISPOSITION,SPACEBAR
	
FO1_SHIFTED
	DC.L	ML2,PLAYSONG,CHNGCOLOR,OFF_134B,LEFTCURSOR,RIGHTCURSOR
	DC.L	DOWNCURSOR,UPCURSOR,UPLANCHE,DOWNPLANCHE,PLUSFRQSPL
	DC.L	SPESPL,VOL_OK,ERASE,LOOP,INPUT,CHG_REZ
	DC.L	ML2,ML2,DISPOSITION,SPACEBAR
	
ML2	MOVEQ	#0,D1
	MOVE.B	whatvoice,d1
	LEA	.WH1,A0
	MOVE.L	(A0,D1.W*4),A0
	JMP	(A0)
.WH1	DC.L	.DINST,.DINST,.DINST,MCOM,MCOM,MEFF,MEFF,MEFF,MEFF,MVOL,MVOL

.DINST	LEA	AZERTY,A0
	MOVE.W	touche,D2
.ML5	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ	ML13
	CMP.B	D1,D2
	BNE.S	.ML5
		
	MOVE.B	#0,recnote
	ADD.W	planche,D0
	MOVE.W	D0,D1
	MOVE.B	D0,recinst
	ADDQ.B	#1,recinst
	MULU	#LEN_SAMPLE_MGT,D0
	LEA	SAMPLE,A0
	ADD.L	D0,A0
	MOVE.L	#0,current
	CMP.L	#0,LEN_MGT(A0)
	BEQ.S	ML13
	MOVE.L	A0,ADDCURSPL
	MOVE.L	A0,current
	MOVE.B	D1,curentnb2
	MOVE.B	D1,sampledata
	MOVE.B	D1,dernier
	MOVE.W	#0,zerotou
arb	BSR.L	CHECKPATT
	JSR     DRUM_PREPA
	MOVE.L	ADDCURSPL,A0
	JSR	SUM
retour	RTS	
ML13	MOVE.B	#-1,recinst
	RTS

planche		dc.W	0
digiplanche	dc.W	36
recnote		dc.b	0
recinst		dc.b	0
reccom		dc.b	0
receff		dc.b	0
recvol		dc.b	0
		even

FONCT2					* MODE FRQ
	CMP.B	#1,CONTRO
	BEQ	FRQ_CTRL
	CMP.B	#1,ALTERN
	BEQ	FRQ_ALTERNATE
	
	LEA	FONCTION,A0		* D'ABORD VOIR SI C'EST UNE
	MOVE.W	touche,D1		* FONCTION
.ML3	MOVE.B	(A0)+,D2
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D0
	BEQ	.ML4
	CMP.B	D2,D1
	BNE.S	.ML3
	LEA	.FO2,A0
	CMP.B	#1,SHIFT_LEFT
	BNE.S	.AA
	LEA	.FO2_SHIFTED,A0
.AA	MOVE.L	(A0,D0.W*4),A0
	JMP	(A0)

.FO2	DC.L	.ML4,PLAYSONG,CHNGCOLOR,OFF_134B,LEFTCURSOR,RIGHTCURSOR
	DC.L	DOWNCURSOR,UPCURSOR,UPLANCHE,DOWNPLANCHE,UPDIGIPL
	DC.L	DOWNDIGIPL,VOL_OK,LOOP,PLUS_1_NBVF,CHG_REZ,.ML4
	DC.L	.ML4,MOINSSPL,PLUSSPL,DISPOSITION,SPACEBAR
.FO2_SHIFTED
	DC.L	.ML4,PLAYSONG,CHNGCOLOR,OFF_134B,LEFTCURSOR13,RIGHTCURSOR13
	DC.L	DOWNCURSOR7,UPCURSOR7,UPLANCHE,DOWNPLANCHE,UPDIGIPL
	DC.L	DOWNDIGIPL,.ML4,LOOP,.ML4,CHG_REZ,.ML4
	DC.L	.ML4,INSERT_LINE_TRK,DEL_LINE_TRK,DISPOSITION,SPACEBAR

.ML4	MOVEQ	#0,D1
	MOVE.B	whatvoice,d1
	LEA	.WH,A0
	MOVE.L	(A0,D1.W*4),A0
	JMP	(A0)
.WH	DC.L	.MNOTE,MINST,MINST,MCOM,MCOM,MEFF,MEFF,MEFF,MEFF,MVOL,MVOL 
	
.MNOTE	LEA	NOTE1,A0
	MOVEQ	#0,D0
	MOVE.W	touche,D2
.ML5	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ.S	ML6
	CMP.B	D1,D2
	BNE.S	.ML5
		
	ADD.W	digiplanche,D0
	ADDQ.W	#1,D0
	MOVE.B	D0,recnote
	
	MOVE.B	curentnb2,recinst		* rectou = recinst
	ADDQ.B	#1,recinst
	MOVE.W	#0,zerotou
ARB2	BSR.L	CHECKPATT
	CMP.B	#1,edit
	BEQ.S	.retor
	CMP.B	#1,record
	BEQ.S	.retor
	JSR     FRQ_PREPA
.retor	MOVE.W	#-1,touche	
	RTS
ML6	MOVE.B	#-1,recinst
	RTS
	
MINST	LEA	DATA,A0
	MOVE.W	touche,D2
.ML7	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ.S	.ML8
	CMP.B	D1,D2
	BNE.S	.ML7
	MOVE.B	D0,recinst
	MOVE.W	#0,zerotou
	BRA.S	ARB2
.ML8	MOVE.B	#-1,recinst
	RTS
	
MCOM	LEA	DATA,A0
	MOVE.W	touche,D2
.ML9	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ.S	.ML10
	CMP.B	D1,D2
	BNE.S	.ML9
	MOVE.B	D0,reccom
	MOVE.W	#0,zerotou
	BRA	ARB2
.ML10	MOVE.B	#-1,reccom
	RTS
	
MEFF	LEA	DATA,A0
	MOVE.W	touche,D2
.ML11	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ.S	.ML12
	CMP.B	D1,D2
	BNE.S	.ML11
	MOVE.B	D0,receff
	MOVE.W	#0,zerotou
	BRA	ARB2
.ML12	MOVE.B	#-1,receff
	RTS
	
MVOL	LEA	DATA,A0
	MOVE.W	touche,D2
.ML15	MOVE.B	(A0)+,D1
	MOVE.B	(A0)+,D0
	CMP.B	#-1,D1
	BEQ.S	.ML14
	CMP.B	D1,D2
	BNE.S	.ML15
	MOVE.B	D0,recvol
	MOVE.W	#0,zerotou
	BRA	ARB2
.ML14	MOVE.B	#-1,recvol
	RTS	
***************************************************************************
SPACEBAR2
	MOVE.B	#0,KEY
	MOVE.W	#0,touche
	MOVE.B	#0,recnote
	MOVE.B	#0,recinst
	MOVE.W	#1,zerotou
	MOVE.L	#0,current
	BRA	ARB2
***************************************************************************
SPACEBAR
	MOVE.B	#0,KEY
	MOVE.W	#0,touche
	MOVE.B	#0,recnote
	MOVE.B	#0,recinst
	MOVE.W	#1,zerotou
	MOVE.L	#0,current
	BRA	arb
***************************************************************************
FRQ_ALTERNATE
	CMP.B	#1,playsong
	BEQ.S	.OUT
	CMP.B	#1,playpat
	BEQ.S	.OUT
	
	MOVE.W	touche,D1
	MOVE.W	#-1,touche
	LEA	TAB_FRQ_ALT1,A1
	LEA	TAB_FRQ_ALT2,A2
.AA	MOVE.B	(A1)+,D2
	MOVE.L	(A2)+,A3
	CMP.B	#-1,D2
	BEQ.S	.OUT
	CMP.B	D1,D2
	BEQ.S	.GO
	BRA.S	.AA
.GO	JSR	(A3)
.OUT	RTS
	
TAB_FRQ_ALT1
	DC.B	$4E,$4A					* + -
	DC.B	$4D,$4B					* -> <-
	DC.B	$02,$03,$04,$05,$06,$07,$08,$09		* 1 ¶ 10
	DC.B	$0A,$0B
	DC.B	$1C,$0E					* RETURN  BACKSPACE
	DC.B	$3B,$3C,$3D,$3E,$3F,$40,$41,$42		* F1 ¶ F10
	DC.B	$43,$44
	DC.B	-1
	EVEN

TAB_FRQ_ALT2
	DC.L	NOTE_UP_CUR_SAMPLE,NOTE_DOWN_CUR_SAMPLE
	DC.L	ADDPOS1,SUBPOS1
	DC.L	PAST1,PAST2,PAST3,PAST4,PAST5,PAST6,PAST7,PAST8
	DC.L	PAST9,PAST0
	DC.L	INSERT_LINE_TRK,DEL_LINE_TRK
	DC.L	ES1,ES2,ES3,ES4,ES5,ES6,ES7,ES8
	DC.L	ES9,ES10
	DC.L	-1
***************************************************************************
ES1	MOVEQ	#1,D4
	BRA.S	EDIT_SKIP
ES2	MOVEQ	#2,D4
	BRA.S	EDIT_SKIP
ES3	MOVEQ	#3,D4
	BRA.S	EDIT_SKIP
ES4	MOVEQ	#4,D4
	BRA.S	EDIT_SKIP
ES5	MOVEQ	#5,D4
	BRA.S	EDIT_SKIP
ES6	MOVEQ	#6,D4
	BRA.S	EDIT_SKIP
ES7	MOVEQ	#7,D4
	BRA.S	EDIT_SKIP
ES8	MOVEQ	#8,D4
	BRA.S	EDIT_SKIP
ES9	MOVEQ	#9,D4
	BRA.S	EDIT_SKIP
ES10	MOVEQ	#10,D4

EDIT_SKIP
	MOVE.B	D4,EDITSKIP
	RTS
	
EDITSKIP	DC.B	1
		EVEN
***************************************************************************
PAST1	MOVEQ	#1,D4
	BRA.S	PAST_EFFECT
PAST2	MOVEQ	#2,D4
	BRA.S	PAST_EFFECT
PAST3	MOVEQ	#3,D4
	BRA.S	PAST_EFFECT
PAST4	MOVEQ	#4,D4
	BRA.S	PAST_EFFECT
PAST5	MOVEQ	#5,D4
	BRA.S	PAST_EFFECT
PAST6	MOVEQ	#6,D4
	BRA.S	PAST_EFFECT
PAST7	MOVEQ	#7,D4
	BRA.S	PAST_EFFECT
PAST8	MOVEQ	#8,D4
	BRA.S	PAST_EFFECT
PAST9	MOVEQ	#9,D4
	BRA.S	PAST_EFFECT
PAST0	MOVEQ	#0,D4

PAST_EFFECT
	BSR	GET_TRACK_BLOCK
	
	MOVE.W	inpatt2,D0
	LEA	(A0,D0.W),A0
	LEA	EFFECT_BUFFER,A1
	LEA	(A1,D4.W*4),A1
	MOVE.B	(A1),2(A0)
	MOVE.W	1(A1),3(A0)
	
	MOVE.B	inpatt,D3
	SUBQ.W	#1,D1
	CMP.W	D1,D3
	BEQ.S	.AA
	
	ADDQ.B	#1,inpatt
	ADDQ.W	#6,inpatt2
	
.AA	BSR.L	AFFPATTERN
	RTS
***************************************************************************
NOTE_DOWN_CUR_SAMPLE
	BSR	GET_TRACK_BLOCK
	BSR	COPY_INTO_UNDO_BUFFER
	
	MOVEQ	#0,D4
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	MOVE.B	sampledata,D4
	ADDQ.W	#1,D4
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.FF	CMP.B	#0,(A0)
	BEQ.S	.EE
	MOVE.B	1(A0),D5
	CMP.B	D4,D5
	BNE.S	.EE
	SUBQ.B	#1,(A0)
	CMP.B	#0,(A0)
	BNE.S	.EE
	MOVE.B	#1,(A0)
.EE	MOVE.L	(A0)+,(A1)+
	MOVE.W	(A0)+,(A1)+
	DBF	D3,.FF
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
NOTE_UP_CUR_SAMPLE
	BSR	GET_TRACK_BLOCK
	BSR	COPY_INTO_UNDO_BUFFER
	
	MOVEQ	#0,D4
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	MOVE.B	sampledata,D4
	ADDQ.W	#1,D4
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.FF	CMP.B	#0,(A0)
	BEQ.S	.EE
	MOVE.B	1(A0),D5
	CMP.B	D4,D5
	BNE.S	.EE
	ADDQ.B	#1,(A0)
	CMP.B	#96,(A0)
	BNE.S	.EE
	MOVE.B	#96,(A0)
.EE	MOVE.L	(A0)+,(A1)+
	MOVE.W	(A0)+,(A1)+
	DBF	D3,.FF
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
FRQ_CTRL
	CMP.B	#1,playsong
	BEQ.S	.OUT
	CMP.B	#1,playpat
	BEQ.S	.OUT
	
	MOVE.W	touche,D1
	MOVE.W	#-1,touche
	LEA	TAB_FRQ_CTRL1,A1
	LEA	TAB_FRQ_CTRL2,A2
.AA	MOVE.B	(A1)+,D2
	MOVE.L	(A2)+,A3
	CMP.B	#-1,D2
	BEQ.S	.OUT
	CMP.B	D1,D2
	BEQ.S	.GO
	BRA.S	.AA
.GO	JSR	(A3)
.OUT	RTS

TAB_FRQ_CTRL1
	DC.B	$2E,$30,$17				* B  C  I
	DC.B	$19,$61					* P  UNDO
	DC.B	$3D,$3E,$3F				* F3 F4 F5
	DC.B	$4E,$4A					* +  -
	DC.B	$4D,$4B					* -> <-
	DC.B	$02,$03,$04,$05,$06,$07,$08,$09		* 1 ¶ 10
	DC.B	$0A,$0B
	DC.B	-1
	EVEN
TAB_FRQ_CTRL2
	DC.L	START_BLOCK_ONE_TRACK,END_BLOCK_ONE_TRACK,INSERT_BLOCK
	DC.L	PASTE_BLOCK,UNDO_BLOCK
	DC.L	CLEAR_EFFECT_BLOCK,REMBER_EFFECT_BLOCK,PASTE_EFFECT_BLOCK
	DC.L	NOTE_UP_BLOCK,NOTE_DOWN_BLOCK
	DC.L	ADDPAT1,SUBPAT1
	DC.L	REM1,REM2,REM3,REM4,REM5,REM6,REM7,REM8
	DC.L	REM9,REM0
	DC.L	-1
	
START_BLOCK	DC.B	0
END_BLOCK	DC.B	$3F
NUMTRACK_BLOCK	DC.W	0
UNDO_ADDTRACK	DC.L	0
UNDO_LENTRACK	DC.W	0
			* REVOIR LE UNDO AVEC NOTE_UP(DOWN)_BLOCK
***************************************************************************
REM1	MOVEQ	#1,D4
	BRA.S	REMEMBER_EFFECT
REM2	MOVEQ	#2,D4
	BRA.S	REMEMBER_EFFECT
REM3	MOVEQ	#3,D4
	BRA.S	REMEMBER_EFFECT
REM4	MOVEQ	#4,D4
	BRA.S	REMEMBER_EFFECT
REM5	MOVEQ	#5,D4
	BRA.S	REMEMBER_EFFECT
REM6	MOVEQ	#6,D4
	BRA.S	REMEMBER_EFFECT
REM7	MOVEQ	#7,D4
	BRA.S	REMEMBER_EFFECT
REM8	MOVEQ	#8,D4
	BRA.S	REMEMBER_EFFECT
REM9	MOVEQ	#9,D4
	BRA.S	REMEMBER_EFFECT
REM0	MOVEQ	#0,D4

REMEMBER_EFFECT
	BSR	GET_TRACK_BLOCK
	
	MOVE.W	inpatt2,D0
	LEA	(A0,D0.W),A0
	LEA	EFFECT_BUFFER,A1
	LEA	(A1,D4.W*4),A1
	MOVE.B	2(A0),(A1)
	MOVE.W	3(A0),1(A1)
	
	RTS
***************************************************************************
GET_TRACK_BLOCK
	MOVEM.L	RIEN,D0-D3
	MOVE.B	curvoie,D2
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D2.W),D2
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D2.W*4),A0
	MOVE.W	NBCURTRACK(A0),D2
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	(A0,D2.L*4),A0
	MOVE.W	(A0)+,D1
	RTS
***************************************************************************
COPY_INTO_UNDO_BUFFER
	MOVE.L	A0,UNDO_ADDTRACK
	MOVE.W	D1,UNDO_LENTRACK
	MOVE.L	A0,A1
	LEA	UNDO_BUFFER,A2
.DD	MOVE.L	(A1)+,(A2)+
	MOVE.W	(A1)+,(A2)+
	SUBQ.W	#1,D1
	BNE.S	.DD
	RTS
***************************************************************************
NOTE_DOWN_BLOCK
	BSR	GET_TRACK_BLOCK
	BSR	COPY_INTO_UNDO_BUFFER
	
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.FF	CMP.B	#0,(A0)
	BEQ.S	.EE
	SUBQ.B	#1,(A0)
	CMP.B	#0,(A0)
	BNE.S	.EE
	MOVE.B	#1,(A0)
.EE	MOVE.L	(A0)+,(A1)+
	MOVE.W	(A0)+,(A1)+
	DBF	D3,.FF
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
NOTE_UP_BLOCK
	BSR	GET_TRACK_BLOCK
	BSR	COPY_INTO_UNDO_BUFFER
	
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.FF	CMP.B	#0,(A0)
	BEQ.S	.EE
	ADDQ.B	#1,(A0)
	CMP.B	#96,(A0)
	BNE.S	.EE
	MOVE.B	#96,(A0)
.EE	MOVE.L	(A0)+,(A1)+
	MOVE.W	(A0)+,(A1)+
	DBF	D3,.FF
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
PASTE_EFFECT_BLOCK
	BSR	GET_TRACK_BLOCK
	BSR	COPY_INTO_UNDO_BUFFER
	
	BSR.S	PEB
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
PEB	MOVE.B	START_BLOCK,D2			* EFFECT
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3				* D3 = LEN BLOCK
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.AA	MOVE.W	2(A1),2(A0)
	MOVE.B	4(A1),4(A0)
	ADDQ.W	#6,A0
	ADDQ.W	#6,A1
	DBF	D3,.AA
	
	RTS
***************************************************************************
PVB	MOVE.B	START_BLOCK,D2			* VOLUME
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.AA	MOVE.B	5(A1),5(A0)
	ADDQ.W	#6,A0
	ADDQ.W	#6,A1
	DBF	D3,.AA
	
	RTS
***************************************************************************
REMBER_EFFECT_BLOCK
	BSR	GET_TRACK_BLOCK
	
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.AA	MOVE.W	2(A0),2(A1)
	MOVE.B	4(A0),4(A1)
	ADDQ.W	#6,A0
	ADDQ.W	#6,A1
	DBF	D3,.AA
	
	LEA	char3,A0
	MOVE.W	NUMTRACK_BLOCK,D0
	BSR	CONVERT_WORD_TO_HEXA
	MOVE.L	#screen+640*305+561+2,where
	MOVE.W	#1,compt2
	MOVEQ	#4,D1
	BSR	PRINT
	RTS
***************************************************************************
CLEAR_EFFECT_BLOCK
	MOVEM.L	RIEN,D0-D3
	MOVE.W	NUMTRACK_BLOCK,D0
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	(A0,D0.L*4),A0
	MOVE.W	(A0)+,D1			* D1 = LEN TRACK
	
	BSR	COPY_INTO_UNDO_BUFFER
	
	MOVE.B	START_BLOCK,D2
	MOVE.B	END_BLOCK,D3
	SUB.W	D2,D3				* D3 = LEN BLOCK
	MULU	#6,D2
	
	LEA	(A0,D2.W),A0
	LEA	BLOCK_BUFFER,A1
.AA	MOVE.W	#0,2(A0)
	MOVE.B	#0,4(A0)
	MOVE.W	2(A0),2(A1)
	MOVE.B	4(A0),4(A1)
	ADDQ.W	#6,A0
	ADDQ.W	#6,A1
	DBF	D3,.AA
	
	BSR.L	AFFPATTERN
	RTS
***************************************************************************
INSERT_BLOCK				* BUFFER -> TRACK
	MOVEM.L	RIEN,D0-D7		* EN FONCTION DE INPATT
	MOVE.B	START_BLOCK,D0
	MOVE.B	END_BLOCK,D1
	MOVE.B	inpatt,D5		* D5 = INPATT
	MOVE.L	D0,D3
	MOVE.L	D1,D4			* D3 = START BLOCK
	MULU	#6,D0			* D0 = START BLOCK *6
	MULU	#6,D4			* D4 = END   BLOCK *6
	SUB.W	D3,D1			* D1 = LEN   BLOCK
	
	MOVE.B	curvoie,D2
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D2.W),D2
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D2.W*4),A0
	MOVE.W	NBCURTRACK(A0),D2
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	(A0,D2.L*4),A0
	MOVE.W	(A0)+,D7		* D7 = LEN TRACK
	
	MOVE.L	A0,UNDO_ADDTRACK	* COPY TRACK INTO UNDO BUFFER
	MOVE.W	D7,UNDO_LENTRACK
	MOVE.L	A0,A1
	LEA	UNDO_BUFFER,A2
	MOVE.W	D7,D6
.DD	MOVE.L	(A1)+,(A2)+
	MOVE.W	(A1)+,(A2)+
	SUBQ.W	#1,D6
	BNE.S	.DD
	

	MOVE.B	inpatt,D6
	ADD.W	D1,D6
	ADDQ.W	#1,D6
	CMP.W	D7,D6
	BGE.S	.FF
	
	MOVEQ	#0,D0	
	MOVE.B	inpatt,D0
	
	MOVE.W	D7,D6
	SUBQ.W	#1,D6
	SUB.W	D1,D6
	
	MOVE.W	D7,D2
	SUBQ.W	#1,D2
	MULU	#6,D2			* D2 = LEN TRACK * 6
	
	LEA	(A0,D2.W),A1
	LEA	(A0,D2.W),A2
	MOVE.W	D4,D2
	SUB.W	D3,D2			* D2 = LEN BLOCK * 6
	SUB.W	D2,A1
	SUBQ.W	#6,A1
.EE	MOVE.L	(A1),(A2)
	MOVE.W	4(A1),4(A2)
	SUBQ.W	#6,A1
	SUBQ.W	#6,A2
	SUBQ.W	#1,D6
	CMP.W	D0,D6
	BNE.S	.EE
	
.FF	SUB.W	D5,D7			* D7 = # OF ROWS LEFT IN TRACK
	MULU	#6,D5			* D5 = INPATT * 6
	LEA	(A0,D5.W),A1		* INSERT
	LEA	BLOCK_BUFFER,A2
.BB	MOVE.L	(A2)+,(A1)+
	MOVE.W	(A2)+,(A1)+
	SUBQ.W	#1,D7			* POUR NE PAS DEPASSER LA FIN
	BEQ.S	.CC			* DE LA TRACK
	DBF	D1,.BB
	
.CC	BSR.L	AFFPATTERN
	RTS
***************************************************************************
UNDO_BLOCK	
	MOVE.L	UNDO_ADDTRACK,A0
	CMP.L	#0,A0
	BEQ.S	.AA
	LEA	UNDO_BUFFER,A1
	MOVE.W	UNDO_LENTRACK,D0
	
.BB	MOVE.L	(A0),D6
	MOVE.W	4(A0),D7
	MOVE.L	(A1),(A0)+
	MOVE.W	4(A1),(A0)+
	MOVE.L	D6,(A1)+
	MOVE.W	D7,(A1)+
	SUBQ.W	#1,D0
	BNE.S	.BB
	
	BSR.L	AFFPATTERN
.AA	RTS
***************************************************************************
PASTE_BLOCK				* BUFFER -> TRACK
	MOVEQ	#0,D0			* EN FONCTION DE INPATT
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D5
	MOVE.B	START_BLOCK,D0
	MOVE.B	END_BLOCK,D1
	MOVE.B	inpatt,D5		* D5 = INPATT
	MOVE.L	D0,D3
	MOVE.L	D1,D4			* D3 = START BLOCK
	MULU	#6,D0			* D0 = START BLOCK *6
	MULU	#6,D4			* D4 = END   BLOCK *6
	SUB.W	D3,D1			* D1 = LEN   BLOCK
	
	MOVE.B	curvoie,D2
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D2.W),D2
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D2.W*4),A0
	MOVE.W	NBCURTRACK(A0),D2
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	(A0,D2.L*4),A0
	MOVE.W	(A0)+,D7		* D7 = LEN TRACK
	
	MOVE.L	A0,UNDO_ADDTRACK	* COPY TRACK INTO UNDO BUFFER
	MOVE.W	D7,UNDO_LENTRACK
	MOVE.L	A0,A1
	LEA	UNDO_BUFFER,A2
	MOVE.W	D7,D6
.DD	MOVE.L	(A1)+,(A2)+
	MOVE.W	(A1)+,(A2)+
	SUBQ.W	#1,D6
	BNE.S	.DD
	
	SUB.W	D5,D7			* D7 = # OF ROWS LEFT IN TRACK
	MULU	#6,D5			* D5 = INPATT * 6
	
.FF	LEA	(A0,D5.W),A1		* PASTE
	LEA	BLOCK_BUFFER,A2
.BB	MOVE.L	(A2)+,(A1)+
	MOVE.W	(A2)+,(A1)+
	SUBQ.W	#1,D7			* POUR NE PAS DEPASSER LA FIN
	BEQ.S	.CC			* DE LA TRACK
	DBF	D1,.BB
	
.CC	BSR.L	AFFPATTERN
	RTS
***************************************************************************
START_BLOCK_ONE_TRACK
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.B	inpatt,D0
	MOVE.B	END_BLOCK,D1
	CMP.W	D1,D0
	BLT.S	.CC
	MOVE.B	D1,D0
.CC	MOVE.B	D0,START_BLOCK
	LEA	char3,A0
	BSR	CONVERT_WORD_TO_HEXA
	LEA	char3+2,A0
	MOVE.L	#screen+640*313+545+2,where
	MOVE.W	#1,compt2
	MOVEQ	#2,D1
	BSR	PRINT
	
	
COPY_BLOCK				* TRACK -> BUFFER
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVE.B	START_BLOCK,D3
	MOVE.B	END_BLOCK,D1
	SUB.W	D3,D1
	MULU	#6,D3
	
	MOVE.B	curvoie,D2
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D2.W),D2
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D2.W*4),A0
	MOVE.W	NBCURTRACK(A0),D2
	MOVE.W	D2,NUMTRACK_BLOCK
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	(A0,D2.L*4),A0
	ADDQ.W	#2,A0
	
	LEA	(A0,D3.W),A0
	LEA	BLOCK_BUFFER,A2
.BB	MOVE.L	(A0)+,(A2)+
	MOVE.W	(A0)+,(A2)+
	DBF	D1,.BB
	
	LEA	char3,A0
	MOVE.W	NUMTRACK_BLOCK,D0
	BSR	CONVERT_WORD_TO_HEXA
	MOVE.L	#screen+640*305+561+2,where
	MOVE.W	#1,compt2
	MOVEQ	#4,D1
	BSR	PRINT
	RTS
***************************************************************************
END_BLOCK_ONE_TRACK
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.B	inpatt,D0
	MOVE.B	START_BLOCK,D1
	CMP.W	D0,D1
	BLT.S	.AA
	MOVE.B	D1,D0
.AA	MOVE.B	D0,END_BLOCK
	LEA	char3,A0
	BSR	CONVERT_WORD_TO_HEXA
	LEA	char3+2,A0
	MOVE.L	#screen+640*313+576+2,where
	MOVE.W	#0,compt2
	MOVEQ	#2,D1
	BSR	PRINT
	BRA	COPY_BLOCK
***************************************************************************
INSERT_LINE_TRK
	MOVE.B	#0,KEY
	MOVEQ	#0,D1
	MOVE.B	playpat,D1
	ADD.B	playsong,D1
	BNE	retour
	MOVEQ	#0,D2
	MOVEQ	#0,D7
	MOVE.B	curvoie,D7
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D7.W),D7
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D7.W*4),A0
	MOVE.W	LENCURTRACK(A0),D1
	SUBQ.W	#1,D1
	MOVE.L	ADDCURTRACK(A0),A1
	MOVE.L	ADDCURTRACK(A0),A2
	MOVE.B	inpatt,D2
	CMP.W	D1,D2
	BGE	retour
	ADD.W	inpatt2,A2
	MOVE.L	D1,D3
	MULU	#6,D3
	ADD.L	D3,A1
	ADD.W	#6,A1
.EE	MOVE.L	-10(A1),-4(A1)
	MOVE.W	-12(A1),-6(A1)
	SUBQ.W	#6,A1
	CMP.L	A1,A2
	BNE.S	.EE
	MOVE.L	#0,(A1)
	MOVE.W	#0,4(A1)
	BSR	AFF_ONE_TRACK
	RTS
***************************************************************************
DEL_LINE_TRK
	MOVE.B	#0,KEY
	MOVEQ	#0,D1
	MOVE.B	playpat,D1
	ADD.B	playsong,D1
	BNE.L	VOL_OK
	MOVEQ	#0,D2
	MOVEQ	#0,D7
	MOVE.B	curvoie,D7
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D7.W),D7
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D7.W*4),A0
	MOVE.W	LENCURTRACK(A0),D1
	SUBQ.W	#1,D1
	MOVE.L	ADDCURTRACK(A0),A1
	MOVE.L	ADDCURTRACK(A0),A2
	MOVE.B	inpatt,D2
	CMP.W	D1,D2
	BGE.L	VOL_OK
	ADD.W	inpatt2,A1
	MOVE.L	D1,D3
	MULU	#6,D3
	ADD.L	D3,A2
.FF	MOVE.L	6(A1),(A1)
	MOVE.W	10(A1),4(A1)
	ADDQ.W	#6,A1
	CMP.L	A1,A2
	BNE.S	.FF
	MOVE.L	#0,(A1)
	MOVE.W	#0,4(A1)
	BSR	AFF_ONE_TRACK
	RTS
***************************************************************************
ADDBASE10000
	MOVE.L	#10000,D0
	BRA.S	ADDBASE
ADDBASE1000
	MOVE.L	#1000,D0
	BRA.S	ADDBASE
ADDBASE100
	MOVEQ	#100,D0
	BRA.S	ADDBASE
ADDBASE10
	MOVEQ	#10,D0
	BRA.S	ADDBASE
ADDBASE1
	MOVEQ	#1,D0
	
ADDBASE	
	MOVEQ	#0,D1
	MOVE.L	ADDCURSPL,A1
	MOVE.W	BASE_MGT(A1),D1
	ADD.L	D0,D1
	CMP.L	#50033,D1
	BLE.S	.OK
	MOVE.L	#50033,D1
.OK	MOVE.W	D1,BASE_MGT(A1)
	BSR.L	AFF_BASE_SPL
	RTS
***************************************************************************
SUBBASE10000
	MOVE.L	#10000,D0
	BRA.S	SUBBASE
SUBBASE1000
	MOVE.L	#1000,D0
	BRA.S	SUBBASE
SUBBASE100
	MOVEQ	#100,D0
	BRA.S	SUBBASE
SUBBASE10
	MOVEQ	#10,D0
	BRA.S	SUBBASE
SUBBASE1
	MOVEQ	#1,D0
	
SUBBASE	
	MOVEQ	#0,D1
	MOVE.L	ADDCURSPL,A1
	MOVE.W	BASE_MGT(A1),D1
	SUB.L	D0,D1
	CMP.L	#1500,D1
	BGE.S	.BB
	MOVE.L	#1500,D1
.BB	MOVE.W	D1,BASE_MGT(A1)
	BSR.L	AFF_BASE_SPL
	RTS	
***************************************************************************
ADD_LOOP	DC.L	0
SUBLOOPDEB1000000
	MOVE.L	#-1000000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB100000
	MOVE.L	#-100000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB10000
	MOVE.L	#-10000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB1000
	MOVE.L	#-1000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB100
	MOVE.L	#-100,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB10
	MOVE.L	#-10,ADD_LOOP
	MOVE.W	#29,okp
	RTS
SUBLOOPDEB1
	MOVE.L	#-1,ADD_LOOP
	MOVE.W	#29,okp
	RTS

ADDLOOPDEB1000000
	MOVE.L	#1000000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB100000
	MOVE.L	#100000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB10000
	MOVE.L	#10000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB1000
	MOVE.L	#1000,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB100
	MOVE.L	#100,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB10
	MOVE.L	#10,ADD_LOOP
	MOVE.W	#29,okp
	RTS
ADDLOOPDEB1
	MOVE.L	#1,ADD_LOOP
	MOVE.W	#29,okp
	RTS
	
ADDLOOPDEB:
	MOVE.L	ADDCURSPL,A1
	MOVE.L	ADD_LOOP,D0
	ADD.L	D0,LOOP_DEB_MGT(A1)
	MOVE.L	LOOP_DEB_MGT(A1),D0
	MOVE.L	LOOP_FIN_MGT(A1),D1
	CMP.L	D0,D1
	BGT.S	.OK
	MOVE.L	LOOP_FIN_MGT(A1),LOOP_DEB_MGT(A1)
	SUB.L	#1,LOOP_DEB_MGT(A1)
	BRA.S	.OK1
	
.OK	MOVE.L	DEB_MGT(A1),D1
	CMP.L	D0,D1
	BLE.S	.OK1
	MOVE.L	DEB_MGT(A1),LOOP_DEB_MGT(A1)	
	
.OK1	MOVE.W	LEN_BUF_MGT(A1),D0
	MOVE.L	LOOP_DEB_MGT(A1),A2
	MOVE.L	LOOP_FIN_MGT(A1),A3
.CC	MOVE.B	(A2)+,(A3)+
	SUBQ.W	#1,D0
	BNE.S	.CC
	BSR.L	AFF_LOOP_DEB_SPL
	
	MOVE.W	#0,okp
	RTS
***************************************************************************
ADDLOOPFIN1000000
	MOVE.L	#1000000,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN100000
	MOVE.L	#100000,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN10000
	MOVE.L	#10000,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN1000
	MOVE.L	#1000,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN100
	MOVE.L	#100,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN10
	MOVE.L	#10,ADD_LOOP
	MOVE.W	#30,okp
	RTS
ADDLOOPFIN1
	MOVE.L	#1,ADD_LOOP
	MOVE.W	#30,okp
	RTS
	
ADDLOOPFIN:
	MOVE.L	ADDCURSPL,A1
	
	MOVE.L	ADD_LOOP,D0
	MOVE.L	LEN_FIN_MGT(A1),D2
	BEQ.S	.DD
	CMP.L	D0,D2
	BGT.S	.CC
	MOVE.L	D2,D0
	
.CC	BSR	OFF_LOOP
	ADD.L	D0,LOOP_FIN_MGT(A1)
	BSR	ON_LOOP
	
	BSR.L	AFF_LOOP_FIN_SPL
.DD	MOVE.W	#0,okp
	RTS
***************************************************************************
SUBLOOPFIN1000000
	MOVE.L	#1000000,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN100000
	MOVE.L	#100000,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN10000
	MOVE.L	#10000,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN1000
	MOVE.L	#1000,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN100
	MOVE.L	#100,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN10
	MOVE.L	#10,ADD_LOOP
	MOVE.W	#31,okp
	RTS
SUBLOOPFIN1
	MOVE.L	#1,ADD_LOOP
	MOVE.W	#31,okp
	RTS
	
SUBLOOPFIN:
	MOVE.L	ADDCURSPL,A1
	
	MOVE.L	ADD_LOOP,D0
	MOVE.L	LOOP_FIN_MGT(A1),D2
	SUB.L	LOOP_DEB_MGT(A1),D2
	CMP.L	D0,D2
	BGT.S	.CC
	MOVE.L	D2,D0
	SUBQ.L	#2,D0
	BEQ.S	.DD
	
.CC	BSR	OFF_LOOP
	SUB.L	D0,LOOP_FIN_MGT(A1)
	BSR	ON_LOOP
	
	BSR.L	AFF_LOOP_FIN_SPL
.DD	MOVE.W	#0,okp
	RTS
***************************************************************************
STATE_LOOP
	MOVE.W	#32,okp
	RTS
STATE_LOOP2
	MOVE.L	ADDCURSPL,A1
	BCHG.B	#2,BIT1_MGT+1(A1)
	BNE.S	.N_LOOP_OFF
	
	BSR	ON_LOOP
	BRA.S	.DS
.N_LOOP_OFF
	BSR	OFF_LOOP
.DS	BSR.L	AFF_LOOP_ON_OFF
	MOVE.W	#0,okp
	RTS
***************************************************************************
OFF_LOOP
	MOVE.L	LOOP_FIN_MGT(A1),A2
	ADD.W	LEN_BUF_MGT(A1),A2
	MOVE.L	LOOP_FIN_MGT(A1),A3
	MOVE.L	LEN_FIN_MGT(A1),D1
	BEQ.S	.CC
.AA	MOVE.B	(A2)+,(A3)+
	SUBQ.L	#1,D1
	BNE.S	.AA
.CC	MOVEQ	#0,D1
	MOVE.W	LEN_BUF_MGT(A1),D1
	MOVE.L	LOOP_FIN_MGT(A1),A3
	ADD.L	LEN_FIN_MGT(A1),A3
.BB	MOVE.B	#0,(A3)+
	SUBQ.W	#1,D1
	BNE.S	.BB
	MOVE.L	#0,LEN_FIN_MGT(A1)
	RTS
***************************************************************************
ON_LOOP
	MOVEQ	#0,D2
	MOVE.L	FIN_MGT(A1),D1
	SUB.L	LOOP_FIN_MGT(A1),D1
	MOVE.W	LEN_BUF_MGT(A1),D2
	SUB.L	D2,D1
	MOVE.L	D1,LEN_FIN_MGT(A1)
	CMP.L	#0,D1
	BEQ.S	.CC

	MOVE.L	FIN_MGT(A1),A2
	MOVE.L	A2,A3
	SUB.W	LEN_BUF_MGT(A1),A3
.AA	MOVE.B	-(A3),-(A2)
	SUBQ.L	#1,D1
	BNE.S	.AA

.CC	MOVEQ	#0,D1
	MOVE.W	LEN_BUF_MGT(A1),D1
	MOVE.L	LOOP_DEB_MGT(A1),A2
	MOVE.L	LOOP_FIN_MGT(A1),A3
.BB	MOVE.B	(A2)+,(A3)+
	SUBQ.W	#1,D1
	BNE.S	.BB
	RTS
***************************************************************************
PLUS_1_NBVF
	ADDQ.B	#1,NBVF
	CMP.B	#32,NBVF
	BLE.S	.WW
	MOVE.B	#32,NBVF
.WW	BSR	NB_VOICE_FRQ
	RTS	
***************************************************************************
MOINS_1_NBVF
	SUBQ.B	#1,NBVF
	BGE.S	.WW
	MOVE.B	#0,NBVF
.WW	BSR	NB_VOICE_FRQ
	RTS
***************************************************************************
MOINS_1_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	SUBQ.W	#1,VOL_MGT(A1)
	BGE.S	.RT
	MOVE.W	#0,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS

PLUS_1_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	ADDQ.W	#1,VOL_MGT(A1)
	CMP.W	#1024,VOL_MGT(A1)
	BNE.S	.RT
	MOVE.W	#1024,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS
	
MOINS_10_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	SUB.W	#$10,VOL_MGT(A1)
	BGE.S	.RT
	MOVE.W	#0,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS

PLUS_10_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	ADD.W	#$10,VOL_MGT(A1)
	CMP.W	#1025,VOL_MGT(A1)
	BLT.S	.RT
	MOVE.W	#1024,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS
	
MOINS_100_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	SUB.W	#$100,VOL_MGT(A1)
	BGE.S	.RT
	MOVE.W	#0,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS

PLUS_100_VOLUME_SPL
	MOVE.L	ADDCURSPL,A1
	ADD.W	#$100,VOL_MGT(A1)
	CMP.W	#1025,VOL_MGT(A1)
	BLT.S	.RT
	MOVE.W	#1024,VOL_MGT(A1)
.RT	BSR.L	AFF_VOLUME_SPL	
	RTS	
***************************************************************************
CHG_REZ
	BCHG	#0,$FFFF82C3.W
	BTST	#0,$FFFF82C3.W
	BEQ.S	.HI_REZ
	MOVE.W	#248-15,OFFSET
	RTS
.HI_REZ	MOVE.W	#496-15,OFFSET
	RTS
***************************************************************************
PIANO_DRUM
	BCHG.B	#0,DRUM
	MOVEQ	#0,D0
	MOVE.B	DRUM,D0
	MULU	#5,D0
	LEA	TEXT1,A0
	ADD.W	D0,A0
	MOVE.L	#screen+33+169*640,where
	MOVE.W	#1,compt2
	MOVEQ	#5,D1
	BSR.L	PRINT
	RTS
TEXT1	DC.B	'DRUM ','PIANO'
************************************************************************
ON0	MOVEQ	#0,D0
	BRA	T_ON
ON1	MOVEQ	#1,D0
	BRA	T_ON
ON2	MOVEQ	#2,D0 
	BRA	T_ON
ON3	MOVEQ	#3,D0 
	BRA	T_ON
ON4	MOVEQ	#4,D0 
	BRA	T_ON
ON5	MOVEQ	#5,D0 
	BRA	T_ON
ON6	MOVEQ	#6,D0 
	BRA	T_ON
ON7	MOVEQ	#7,D0 
	BRA	T_ON
ON8	MOVEQ	#8,D0 
	BRA	T_ON
ON9	MOVEQ	#9,D0 
	BRA	T_ON
ON10	MOVEQ	#10,D0 
	BRA	T_ON
ON11	MOVEQ	#11,D0 
	BRA	T_ON
ON12	MOVEQ	#12,D0 
	BRA	T_ON
ON13	MOVEQ	#13,D0 
	BRA	T_ON
ON14	MOVEQ	#14,D0 
	BRA	T_ON
ON15	MOVEQ	#15,D0 
	BRA	T_ON
ON16	MOVEQ	#16,D0 
	BRA	T_ON
ON17	MOVEQ	#17,D0 
	BRA	T_ON
ON18	MOVEQ	#18,D0 
	BRA	T_ON
ON19	MOVEQ	#19,D0 
	BRA	T_ON
ON20	MOVEQ	#20,D0 
	BRA	T_ON
ON21	MOVEQ	#21,D0 
	BRA	T_ON
ON22	MOVEQ	#22,D0 
	BRA	T_ON
ON23	MOVEQ	#23,D0 
	BRA	T_ON
ON24	MOVEQ	#24,D0 
	BRA	T_ON
ON25	MOVEQ	#25,D0 
	BRA	T_ON
ON26	MOVEQ	#26,D0 
	BRA	T_ON
ON27	MOVEQ	#27,D0 
	BRA	T_ON
ON28	MOVEQ	#28,D0 
	BRA	T_ON
ON29	MOVEQ	#29,D0 
	BRA	T_ON
ON30	MOVEQ	#30,D0 
	BRA	T_ON
ON31	MOVEQ	#31,D0

T_ON	

.ZZZ	LEA	PILEVOIE,A0
	MOVE.L	(A0,D0.W*4),A0
	
	MOVEQ	#0,D1
	MOVE.B	KIND_VOICE(A0),D1
	
	MOVE.L	A0,A5
	BSR	CLEAR2
	
	BTST	#0,D1
	BNE.S	.TR2
	
	BSET	#0,D1
	ADDQ.B	#1,digvoices
	MOVEQ	#1,D2
	BRA	.TR
	
.TR2	BCLR	#0,D1
	SUBQ.B	#1,digvoices
	MOVEQ	#0,D2

.TR	MOVE.B	D1,KIND_VOICE(A0)
	
.MM	LEA	ON_TABLE,A1
	MOVE.L	(A1,D0.W*4),where
	MOVE.W	#0,compt2
	LEA	VTABLE,A0
	LEA	(A0,D2.W),A0
	MOVEQ	#1,D1
	BSR.L	PRINT
	
	LEA	VOICE_TAB,A0
	LEA	VOICE_TAB1,A1
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	LEA	VOICE_TAB1,A1
	MOVE.B	D2,(A1,D0.W)
	BSR	SET_VS
	BSR	NB_VOICE_FRQ
	RTS

ON_TABLE	DC.L	screen+640*232+192,screen+640*232+223,screen+640*232+240,screen+640*232+271,screen+640*232+288,screen+640*232+319
		DC.L	screen+640*232+336,screen+640*232+367,screen+640*232+384,screen+640*232+415,screen+640*232+432,screen+640*232+463
		DC.L	screen+640*232+480,screen+640*232+511,screen+640*232+528,screen+640*232+559
		
		DC.L	screen+640*256+192,screen+640*256+223,screen+640*256+240,screen+640*256+271,screen+640*256+288,screen+640*256+319
		DC.L	screen+640*256+336,screen+640*256+367,screen+640*256+384,screen+640*256+415,screen+640*256+432,screen+640*256+463
		DC.L	screen+640*256+480,screen+640*256+511,screen+640*256+528,screen+640*256+559

VTABLE		DC.B	' X'		* VOIE ACTIVE
FXTABLE		DC.B	'  F'		* VOIE FX
BTABLE		DC.B	' B'		* BLOCK
		EVEN
***************************************************************************
SET_ON
	LEA	PILEVOIE,A1
	LEA	VTABLE,A2
	LEA	ON_TABLE,A3
	MOVEQ	#31,D0
	MOVEQ	#0,D1
	
.LIPO	MOVE.L	(A1)+,A4
	MOVE.B	KIND_VOICE(A4),D1
	LEA	(A2,D1.W),A0
	MOVE.L	(A3)+,where
	MOVE.W	#0,compt2
	MOVEQ	#1,D1
	BSR.L	PRINT
	DBF	D0,.LIPO

	RTS
***************************************************************************
V0	MOVEQ	#0,D7
	BRA	T_V
V1	MOVEQ	#1,D7
	BRA	T_V
V2	MOVEQ	#2,D7
	BRA	T_V
V3	MOVEQ	#3,D7
	BRA	T_V
V4	MOVEQ	#4,D7
	BRA	T_V

T_V	MOVEQ	#0,D6
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D7.W),D6
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D6.W*4),A0

	SUB.L	#32,D0
	SUB.L	#362,D1
.AA	CMP.L	#120,D0
	BLE.S	.OUI2
	SUB.L	#120,D0
	BMI.S	.EXIT
	BRA.S	.AA
.EXIT	RTS

.OUI2	LEA	TAB_V,A1
	BTST.B	#2,km2
	BNE.S	.OUI3
	LEA	TAB2_V,A1
.OUI3	MOVEM.L	(A1)+,D2-D5/A2
	CMP.L	#-1,D2
	BEQ.S	.EXIT
	CMP.L	D0,D2
	BGT.S	.OUI3
	CMP.L	D1,D3
	BGT.S	.OUI3
	CMP.L	D0,D4
	BLT.S	.OUI3
	CMP.L	D1,D5
	BLT.S	.OUI3
	JMP	(A2)
*--------------------------------------------------------------------------
VS	MOVE.L	D7,D0
	BRA	T_VS
*--------------------------------------------------------------------------
SUBVTRACK1000
	MOVE.L	#$1000,D0
	BRA.S	AS1
SUBVTRACK100
	MOVE.L	#$100,D0
	BRA.S	AS1
SUBVTRACK10
	MOVEQ	#$10,D0
	BRA.S	AS1
SUBVTRACK1
	MOVE.L	#1,D0
	
AS1	BTST.B	#0,KIND_VOICE(A0)
	BEQ.L	VOL_OK
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVE.L	ADDCURPATT,A1
	MOVE.W	2(A1,D7.W*2),D2		* D2 = CURRENT TRACK OF THIS VOICE
	SUB.L	D0,D2
	CMP.L	#0,D2
	BPL.S	AD
	MOVEQ	#0,D2
	BRA.S	AD
	
ADDVTRACK1000
	MOVE.L	#$1000,D0
	BRA.S	AS
ADDVTRACK100
	MOVE.L	#$100,D0
	BRA.S	AS
ADDVTRACK10
	MOVEQ	#$10,D0
	BRA.S	AS
ADDVTRACK1
	MOVE.L	#1,D0
	
AS	BTST.B	#0,KIND_VOICE(A0)
	BEQ.L	VOL_OK
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVE.L	ADDCURPATT,A1
	MOVE.W	2(A1,D7.W*2),D2		* D2 = CURRENT TRACK OF THIS VOICE
	ADD.L	D0,D2
	MOVE.W	maxtrack,D1
	SUBQ.W	#1,D1
	CMP.L	D2,D1
	BGT.S	AD
	MOVE.L	D1,D2
	
AD	MOVE.W	D2,2(A1,D7.W*2)
	MOVE.W	D2,NBCURTRACK(A0)
	MOVE.L	DEBTABTRACK,A1
	MOVE.L	(A1,D2.L*4),A1
	MOVE.W	(A1)+,LENCURTRACK(A0)
	MOVE.L	A1,ADDCURTRACK(A0)
	BSR	AFF_ONE_TRACK
	RTS
***************************************************************************
* D7 = # OF THE VOICE ON SCREEN
TEMPLEN	DC.W	0
AFF_ONE_TRACK:
	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVEQ	#0,D6
	MOVE.B	inpatt,D6
	SUBQ.W	#7,D6
	
        LEA	NUMERO_VOICE_TAB,A2
	MOVE.B	(A2,D7.W),D2
	LEA	PILEVOIE,A2
	MOVE.L	(A2,D2.W*4),A3
	
	MOVE.W	LENCURTRACK(A3),TEMPLEN
	
	LEA	AFFNBTRACK,A2
	MOVE.L	(A2,D7.W*4),where
	LEA	AFFNBCOMPT,A2
	MOVE.W	(A2,D7.W*2),compt2
	MOVE.W	NBCURTRACK(A3),D0
	LEA	char3,A0
	BSR	CONVERT_WORD_TO_HEXA
	MOVEQ	#4,D1
	BSR	PRINT
	
	MOVE.L	D2,D0
	ADDQ.B	#1,D0
	LEA	AFFNUMTRACK,A2
	MOVE.L	(A2,D7.W*4),where
	ADD.L	#16,where
	LEA	AFFNBCOMPT,A2
	MOVE.W	(A2,D7.W*2),compt2
	LEA	char3,A0
	BSR	CONVERT_BYTE_DECI
	LEA	char3+1,A0
	MOVEQ	#2,D1
	BSR	PRINT
	
	*LEA	VOICE_TAB,A2		* TABLE DES VOIES ACTIVES
	*TST.B	(A2,D4.W)
	*BEQ	.za
	
	MOVE.L	ADDCURTRACK(A3),A3
	CMP.L	DEBTRACK,A3
	BNE.S	.MM
	MOVEQ	#0,D6
.MM	MOVE.W	D6,D5
	MULS	#6,D5
	LEA	(A3,D5.L),A3
	
	LEA	patt,A2
	MOVE.L	(A2,D7.W*4),where
	LEA	ccompt2,A2
	MOVE.W	(A2,D7.W*2),bo
	MOVEQ	#16,D2
	
.ja	MOVE.W	bo,compt2
	CMP.W	#0,D6
	BMI.S	.crien
	CMP.W	TEMPLEN,D6
	BGE.S	.crien
	BRA.S	.cquel
	
.crien	LEA	vvide,A0
	BRA	.ssss
	
.cquel	LEA	pattt,A2		* Calcul ce que l'on va
	MOVE.B	(A3),D0			* Afficher
	BSR	CHECKNOTE
	LEA	hexa,A4
	
	MOVEQ	#0,D5	
	MOVE.B	1(A3),D5
	MOVE.L	D5,D4
	AND.B	#$F,D5
	MOVE.B  (A4,D5.W),4(A2)
	LSR.B	#4,D4
	MOVE.B	(A4,D4.W),3(A2)
	CMP.B	#'0',3(A2)
	BNE.S	.Q1
	MOVE.B	#' ',3(A2)
	CMP.B	#'0',4(A2)
	BNE.S	.Q1
	MOVE.B	#' ',4(A2)
	
.Q1	MOVEQ	#7,D1
	MOVEQ	#0,D4
	MOVE.L	2(A3),D5
.WW	MOVE.B	D5,D4
	AND.B	#$F,D4
	MOVE.B	(A4,D4.W),5(A2,D1.W)
	LSR.L	#4,D5
	DBF	D1,.WW
	
	LEA	pattt,A0

.ssss	SUBQ.B	#1,D2
	BEQ.S	.za
	
	MOVEQ	#13,D1
	
	MOVEQ	#0,D4				* PRINT
.again2	ADDQ.W	#1,compt2
	CMP.W	#2,compt2
	BEQ.S	.cco1
	ADDQ.L	#1,where
	BRA.S	.cco2
.cco1	ADD.L	#15,where
	MOVE.W	#0,compt2
.cco2	MOVE.B	(A0)+,D4
	BSR	AFFICHE
	SUBQ.W	#1,D1
	BNE.S	.again2	
	
	
	ADD.L	#640*7+561-32,where
	CMP.W	#1,bo
	BEQ.S	.PL
	ADD.L	#14,where
.PL	ADDQ.W	#6,A3
	ADDQ.W	#1,D6
	BRA	.ja
	
.za	RTS
***************************************************************************
VOL_L
VOL_R
	RTS

TAB_V	DC.L	0,12,16,20,VS
	DC.L	22,12,40,20,VOL_L
	DC.L	48,12,56,20,ADDVTRACK1000,56,12,62,20,ADDVTRACK100
	DC.L	62,12,70,20,ADDVTRACK10,70,12,78,20,ADDVTRACK1
	DC.L	88,12,104,20,VOL_R
	DC.L	-1
TAB2_V	DC.L	0,12,16,20,VS
	DC.L	22,12,40,20,VOL_L
	DC.L	48,12,56,20,SUBVTRACK1000,56,12,62,20,SUBVTRACK100
	DC.L	62,12,70,20,SUBVTRACK10,70,12,78,20,SUBVTRACK1
	DC.L	88,12,104,20,VOL_R
	DC.L	-1
***************************************************************************
BLK0	MOVEQ	#0,D0
	BRA	T_BLK
BLK1	MOVEQ	#1,D0
	BRA	T_BLK
BLK2	MOVEQ	#2,D0 
	BRA	T_BLK
BLK3	MOVEQ	#3,D0 
	BRA	T_BLK
BLK4	MOVEQ	#4,D0 
	BRA	T_BLK
BLK5	MOVEQ	#5,D0 
	BRA	T_BLK
BLK6	MOVEQ	#6,D0 
	BRA	T_BLK
BLK7	MOVEQ	#7,D0 
	BRA	T_BLK
BLK8	MOVEQ	#8,D0 
	BRA	T_BLK
BLK9	MOVEQ	#9,D0 
	BRA	T_BLK
BLK10	MOVEQ	#10,D0 
	BRA	T_BLK
BLK11	MOVEQ	#11,D0 
	BRA	T_BLK
BLK12	MOVEQ	#12,D0 
	BRA	T_BLK
BLK13	MOVEQ	#13,D0 
	BRA	T_BLK
BLK14	MOVEQ	#14,D0 
	BRA	T_BLK
BLK15	MOVEQ	#15,D0 
	BRA	T_BLK
BLK16	MOVEQ	#16,D0 
	BRA	T_BLK
BLK17	MOVEQ	#17,D0 
	BRA	T_BLK
BLK18	MOVEQ	#18,D0 
	BRA	T_BLK
BLK19	MOVEQ	#19,D0 
	BRA	T_BLK
BLK20	MOVEQ	#20,D0 
	BRA	T_BLK
BLK21	MOVEQ	#21,D0 
	BRA	T_BLK
BLK22	MOVEQ	#22,D0 
	BRA	T_BLK
BLK23	MOVEQ	#23,D0 
	BRA	T_BLK
BLK24	MOVEQ	#24,D0 
	BRA	T_BLK
BLK25	MOVEQ	#25,D0 
	BRA	T_BLK
BLK26	MOVEQ	#26,D0 
	BRA	T_BLK
BLK27	MOVEQ	#27,D0 
	BRA	T_BLK
BLK28	MOVEQ	#28,D0 
	BRA	T_BLK
BLK29	MOVEQ	#29,D0 
	BRA	T_BLK
BLK30	MOVEQ	#30,D0 
	BRA	T_BLK
BLK31	MOVEQ	#31,D0

T_BLK	LEA	BLK_TAB,A0
	LEA	(A0,D0.W),A0
	BCHG.B	#0,(A0)
	MOVEQ	#0,D1
	MOVE.B	(A0),D1
	LEA	BTABLE,A0
	LEA	(A0,D1.W),A0
	LEA	BLK_TABLE,A1
	MOVE.L	(A1,D0.W*4),where
	MOVE.W	#0,compt2
	MOVEQ	#1,D1
	BSR.L	PRINT
	RTS
	
	
BLK_TABLE	DC.L	screen+640*240+192,screen+640*240+223,screen+640*240+240,screen+640*240+271,screen+640*240+288,screen+640*240+319
		DC.L	screen+640*240+336,screen+640*240+367,screen+640*240+384,screen+640*240+415,screen+640*240+432,screen+640*240+463
		DC.L	screen+640*240+480,screen+640*240+511,screen+640*240+528,screen+640*240+559
		
		DC.L	screen+640*272+192,screen+640*272+223,screen+640*272+240,screen+640*272+271,screen+640*272+288,screen+640*272+319
		DC.L	screen+640*272+336,screen+640*272+367,screen+640*272+384,screen+640*272+415,screen+640*272+432,screen+640*272+463
		DC.L	screen+640*272+480,screen+640*272+511,screen+640*272+528,screen+640*272+559
***************************************************************************
BR0	MOVEQ	#0,D0
	BRA	T_BR
BR1	MOVEQ	#1,D0
	BRA	T_BR
BR2	MOVEQ	#2,D0 
	BRA	T_BR
BR3	MOVEQ	#3,D0 
	BRA	T_BR
BR4	MOVEQ	#4,D0 
	BRA	T_BR
BR5	MOVEQ	#5,D0 
	BRA	T_BR
BR6	MOVEQ	#6,D0 
	BRA	T_BR
BR7	MOVEQ	#7,D0 
	BRA	T_BR
BR8	MOVEQ	#8,D0 
	BRA	T_BR
BR9	MOVEQ	#9,D0 
	BRA	T_BR
BR10	MOVEQ	#10,D0 
	BRA	T_BR
BR11	MOVEQ	#11,D0 
	BRA	T_BR
BR12	MOVEQ	#12,D0 
	BRA	T_BR
BR13	MOVEQ	#13,D0 
	BRA	T_BR
BR14	MOVEQ	#14,D0 
	BRA	T_BR
BR15	MOVEQ	#15,D0 
	BRA	T_BR
BR16	MOVEQ	#16,D0 
	BRA	T_BR
BR17	MOVEQ	#17,D0 
	BRA	T_BR
BR18	MOVEQ	#18,D0 
	BRA	T_BR
BR19	MOVEQ	#19,D0 
	BRA	T_BR
BR20	MOVEQ	#20,D0 
	BRA	T_BR
BR21	MOVEQ	#21,D0 
	BRA	T_BR
BR22	MOVEQ	#22,D0 
	BRA	T_BR
BR23	MOVEQ	#23,D0 
	BRA	T_BR
BR24	MOVEQ	#24,D0 
	BRA	T_BR
BR25	MOVEQ	#25,D0 
	BRA	T_BR
BR26	MOVEQ	#26,D0 
	BRA	T_BR
BR27	MOVEQ	#27,D0 
	BRA	T_BR
BR28	MOVEQ	#28,D0 
	BRA	T_BR
BR29	MOVEQ	#29,D0 
	BRA	T_BR
BR30	MOVEQ	#30,D0 
	BRA	T_BR
BR31	MOVEQ	#31,D0

T_BR	LEA	PILEVOIE,A0
	MOVE.L	(A0,D0.W*4),A0
	BCHG.B	#1,KIND_VOICE(A0)
	MOVEQ	#0,D1
	MOVE.B	KIND_VOICE(A0),D1
	AND.W	#2,D1
	LEA	FXTABLE,A0
	LEA	(A0,D1.W),A0
	LEA	BR_TABLE,A1
	MOVE.L	(A1,D0.W*4),where
	MOVE.W	#0,compt2
	MOVEQ	#1,D1
	BSR.L	PRINT
	RTS

BR_TABLE	DC.L	screen+640*232+192+15,screen+640*232+223+1,screen+640*232+240+15,screen+640*232+271+1,screen+640*232+288+15,screen+640*232+319+1
		DC.L	screen+640*232+336+15,screen+640*232+367+1,screen+640*232+384+15,screen+640*232+415+1,screen+640*232+432+15,screen+640*232+463+1
		DC.L	screen+640*232+480+15,screen+640*232+511+1,screen+640*232+528+15,screen+640*232+559+1
		
		DC.L	screen+640*264+192+15,screen+640*264+223+1,screen+640*264+240+15,screen+640*264+271+1,screen+640*264+288+15,screen+640*264+319+1
		DC.L	screen+640*264+336+15,screen+640*264+367+1,screen+640*264+384+15,screen+640*264+415+1,screen+640*264+432+15,screen+640*264+463+1
		DC.L	screen+640*264+480+15,screen+640*264+511+1,screen+640*264+528+15,screen+640*264+559+1	
***************************************************************************
T_VS	LEA	VOICE_TAB,A0
	LEA	(A0,D0.W),A0
	BCHG.B	#0,(A0)
	
	LEA	V_TAB_SCR,A0
	MOVE.L	(A0,D0.W*4),A0
	LEA	ccompt2,A1
	MOVE.W	(A1,D0.W*2),D1
	BTST	#0,D1
	BNE.S	.M2
	MOVEQ	#7,D0
.LOPO	NOT.W	(A0)
	LEA	640(A0),A0
	DBF	D0,.LOPO
	RTS
.M2	MOVEQ	#7,D0
.LOP2	NOT.B	1(A0)
	NOT.B	16(A0)
	LEA	640(A0),A0
	DBF	D0,.LOP2
	RTS
	
V_TAB_SCR
	DC.L	screen+640*373+32+8,screen+640*373+144+8,screen+640*373+272+8,screen+640*373+384+8,screen+640*373+512+8
***************************************************************************
CHNGCOLOR
	MOVE.B	#0,KEY
	EOR.L	#$FF,COLOR
	MOVE.L	#0,$FFFF9800.W
	RTS
COLOR	DC.L	0
***************************************************************************
DISPOSITION
	MOVE.B	#0,KEY
	LEA	PILEVOIE,A0
	MOVEQ	#8-1,D0
	
.ZZ	MOVE.L	(A0)+,A1
	MOVE.L	(A0)+,A1
	MOVE.B	LEFT_VOL(A1),D1
	MOVE.B	RIGHT_VOL(A1),D2
	EXG	D1,D2
	MOVE.B	D1,LEFT_VOL(A1)
	MOVE.B	D2,RIGHT_VOL(A1)
	MOVE.L	(A0)+,A1
	MOVE.B	LEFT_VOL(A1),D1
	MOVE.B	RIGHT_VOL(A1),D2
	EXG	D1,D2
	MOVE.B	D1,LEFT_VOL(A1)
	MOVE.B	D2,RIGHT_VOL(A1)
	MOVE.L	(A0)+,A1
	DBF	D0,.ZZ
	RTS
***************************************************************************
PLUSSPL
	ADDQ.b	#1,sampledata
	CMP.B	#255,sampledata
	BNE.S	vtt
	MOVE.B  #254,sampledata
vtt	MOVEQ	#0,d0
	MOVE.B	sampledata,d0
	MOVE.B	d0,dernier
	MOVE.B	d0,curentnb2
	LEA	SAMPLE,A0
	MULU	#LEN_SAMPLE_MGT,D0
	ADD.L	D0,A0
	MOVE.L	A0,ADDCURSPL
	JSR	SUM
	RTS
***************************************************************************
MOINSSPL
	subQ.b	#1,sampledata
	cmp.b	#255,sampledata
	bne	vtt
	MOVE.B	#0,sampledata
	bra	vtt
***************************************************************************
UPDIGIPL
	MOVE.B	#0,KEY
	ADD.W	#12,digiplanche
	CMP.W	#72,digiplanche
	BNE.S	.DD
	MOVE.W	#0,digiplanche
.DD	BSR	AFF_DIGIPL	
	RTS
***************************************************************************
DOWNDIGIPL
	MOVE.B	#0,KEY
	SUB.W	#12,digiplanche
	CMP.W	#-12,digiplanche
	BNE.S	.DD
	MOVE.W	#60,digiplanche
.DD	BSR	AFF_DIGIPL	
	RTS
***************************************************************************
AFF_DIGIPL
	MOVE.W	digiplanche,D0
	CMP.W	#0,D0
	BNE.S	.KK
	LEA	PL1,A0
	BRA.S	.KK2
.KK	CMP.W	#12,D0
	BNE.S	.KK1
	LEA	PL2,A0
	BRA.S	.KK2
.KK1	CMP.W	#24,D0
	BNE.S	.KK3
	LEA	PL3,A0
	BRA.S	.KK2
.KK3	CMP.W	#36,D0
	BNE.S	.KK4
	LEA	PL4,A0
	BRA.S	.KK2
.KK4	CMP.W	#$48,D0
	BNE.S	.KK5
	LEA	PL5,A0
	BRA.S	.KK2
.KK5	LEA	PL6,A0
.KK2	MOVE.L	#screen+640*184+80,where
	MOVE.W	#0,compt2
	MOVEQ	#4,D1
	BSR.L	PRINT
	RTS

PL1		DC.B ' 012'
PL2		DC.B ' 123'
PL3		DC.B ' 234'
PL4		DC.B ' 345'
PL5		DC.B ' 456'
PL6		DC.B ' 567'
***************************************************************************
PLUS100PL
	ADD.W	#$100,planche
	BRA.S	FF
PLUS10PL
	ADD.W	#$10,planche
	BRA.S	FF
PLUS1PL
UPLANCHE
	ADDQ.W	#1,planche
FF	CMP.W	#255-64,planche
	BLT.S	.outt
	MOVE.W	#255-64,planche
.outt	BSR	AFF_PL
	RTS
************************************************************************
MOINS100PL
	SUB.W	#$100,planche
	BRA.S	GG
MOINS10PL
	SUB.W	#$10,planche
	BRA.S	GG
MOINS1PL
DOWNPLANCHE
	SUBQ.W	#1,planche
GG	CMP.W	#0,planche
	BGE.S	.outt
	MOVE.W	#0,planche
.outt	BSR	AFF_PL
	RTS
***************************************************************************
AFF_PL
	LEA	PPL,A0
	LEA	hexa,A1
	MOVE.W	planche,D0
	ADDQ.W	#1,D0
	MOVE.B	D0,D1
	AND.W	#$F,D1
	MOVE.B	(A1,D1.W),3(A0)
	MOVE.B	D0,D1
	LSR.B	#4,D1
	MOVE.B	(A1,D1.W),2(A0)
	LSR.B	#8,D0
	MOVE.B	(A1,D0.W),1(A0)
	
	CMP.B	#'0',1(A0)
	BNE.S	.KK2
	MOVE.B	#' ',1(A0)
	CMP.B	#'0',2(A0)
	BNE.S	.KK2
	MOVE.B	#' ',2(A0)
	
.KK2	MOVE.L	#screen+640*192+80,where
	MOVE.W	#0,compt2
	MOVEQ	#4,D1
	BSR.L	PRINT
	RTS
PPL	DC.B	'    '	
************************************************************************
PLUSDRIVE
	ADDQ.B	#1,DRV
	CMP.B	#'P',DRV
	BLE.S	AFF_DRV
	MOVE.B	#'P',DRV
	BRA.S	AFF_DRV
************************************************************************
MOINSDRIVE
	SUBQ.B	#1,DRV
	CMP.B	#'A',DRV
	BGE.S	AFF_DRV
	MOVE.B	#'A',DRV
AFF_DRV
	LEA	DRV,A0
	MOVEQ	#1,D1
	MOVE.L	#screen+119*640+64+1,where
	MOVE.W	#1,compt2
	BSR.L	PRINT
	RTS
DRV	DC.B	'A'
	EVEN
************************************************************************
ACCEPT
	MOVE.B	DRV,PATH
	MOVE.L	#'\*.*',PATH+2
	MOVE.L	#0,PATH+6
	MOVE.B	DRV,AFFICHAGE
	*MOVE.W	#0,EH_NON
	MOVE.W	#0,IN_MOD
	MOVE.W	#0,P_MOD
	MOVE.W	#1,okp
	RTS
***************************************************************************
RECORD	
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.B	D1,D0
	BGE	retour
	MOVE.B	#0,KEY
	MOVE.W	#-1,touche
	MOVE.B	#-1,lastkey
	BSR	INVERT_RECORD
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata
	bchg.b	#0,record
	MOVE.B	#0,recinst
	MOVE.B	#0,recnote
	MOVE.W	#1,sync
	MOVE.W	#0,TICK
	cmp.b	#1,edit
	BNE.S	.rt1
	BSR	INVERT_EDIT
	MOVE.B	#0,edit
.rt1	cmp.b	#1,playpat
	BNE.S	.rt8
	MOVE.B	#0,playpat
	BSR	INVERT_PLAYPATT
.rt8	cmp.b	#1,playsong
	BNE.S	.rt12
	MOVE.B	#0,playsong
	BSR	INVERT_PLAYSONG
.rt12	RTS
record	dc.b	0
	even
************************************************************************
EDIT	BCHG.B	#0,edit
	BSR.S	INVERT_EDIT
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata
	CMP.B	#1,record
	BNE.S	.rt3
	BSR.S	INVERT_RECORD
	MOVE.B	#0,record
.rt3	CMP.B	#1,playpat
	BNE.S	.rt11
	MOVE.B	#0,playpat
	BSR	INVERT_PLAYPATT
.rt11	CMP.B	#1,playsong
	BNE.S	.rt13
	MOVE.B	#0,playsong
	BSR.S	INVERT_PLAYSONG
.rt13	RTS
************************************************************************
INVERT_EDIT
	LEA	screen+640*313+160+8,A0
	MOVEQ	#14,d0
	BSR	INVERT_2
	RTS
***************************************************************************
INVERT_RECORD
	LEA	screen+640*328+160+8,A0
	MOVEQ	#14,d0
	BSR	INVERT_2
	RTS
***************************************************************************
INVERT_CLRALL
	LEA	screen+640*152+416+8,A0
	MOVEQ	#7,D0
	BSR	INVERT2
	RTS
***************************************************************************
INVERT_CLRMUS
	LEA	screen+640*160+416+8,A0
	MOVEQ	#7,d0
	BSR	INVERT2
	RTS
***************************************************************************
INVERT_CLRPOS
	LEA	screen+640*168+416+8,A0
	MOVEQ	#7,d0
	BSR	INVERT2
	RTS
***************************************************************************
INVERT_CLRPTN
	LEA	screen+640*176+416+8,A0
	MOVEQ	#7,d0
	BSR.S	INVERT2
	RTS
***************************************************************************
INVERT_CLRTRK
	LEA	screen+640*184+416+8,A0
	MOVEQ	#7,d0
	BSR.S	INVERT2
	RTS
***************************************************************************
INVERT_CLRSPL
	LEA	screen+640*192+416+8,A0
	MOVEQ	#7,d0
	BSR.S	INVERT2
	RTS
***************************************************************************
INVERT_PLAYPATT
	LEA	screen+640*328+240+8,A0
	MOVEQ	#14,d0
	BSR.S	INVERT
	RTS
***************************************************************************
INVERT_PLAYSONG
	LEA	screen+640*313+240+8,A0
	MOVEQ	#14,D0
	BSR.S	INVERT
	RTS
***************************************************************************
INVERT
.i1	NOT.B	1(a0)
	NOT.W	16(a0)
	NOT.W	32(a0)
	NOT.W	48(a0)
	NOT.W	64(a0)
	NOT.W	80(a0)
	LEA	640(A0),A0
	DBF	D0,.i1
	RTS
***************************************************************************
INVERT_2
.i3	NOT.W	(a0)
	NOT.W	16(a0)
	NOT.W	32(a0)
	NOT.W	48(a0)
	NOT.W	64(a0)
	NOT.B	80(a0)
	LEA	640(A0),A0
	DBF	D0,.i3
	RTS
***************************************************************************
INVERT2
.i2	NOT.B	1(a0)
	NOT.W	16(a0)
	NOT.W	32(a0)
	NOT.W	48(a0)
	NOT.W	64(a0)
	LEA	640(A0),A0
	DBF	D0,.i2
	RTS
***************************************************************************
PLUSFTUNE
	MOVE.L	ADDCURSPL,A1
	ADDQ.B	#1,F_TUNE_MGT(A1)
	CMP.B	#16,F_TUNE_MGT(A1)
	BNE.S	.ZERT
	MOVE.B	#15,F_TUNE_MGT(A1)
.ZERT	JSR	AFF_F_TUNE_SPL
	RTS
***************************************************************************
MOINSFTUNE
	MOVE.L	ADDCURSPL,A1
	SUBQ.B	#1,F_TUNE_MGT(A1)
	CMP.B	#-1,F_TUNE_MGT(A1)
	BNE.S	.ZERT
	MOVE.B	#0,F_TUNE_MGT(A1)
.ZERT	JSR	AFF_F_TUNE_SPL
	RTS
***************************************************************************
PLUS1000PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.L	D0,D1
	AND.L	#$F000,D1
	CMP.L	#$F000,D1
	BEQ.S	.AA
	ADD.L	#$1000,D0
	BRA.S	RETO
.AA	AND.W	#$0FFF,D0
	BRA.S	RETO
***************************************************************************
PLUS100PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.W	D0,D1
	AND.W	#$F00,D1
	CMP.W	#$F00,D1
	BEQ.S	.AA
	ADD.W	#$100,D0
	BRA.S	RETO
.AA	AND.W	#$F0FF,D0
	BRA	RETO
***************************************************************************
PLUS10PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.W	D0,D1
	AND.W	#$F0,D1
	CMP.W	#$F0,D1
	BEQ.S	.AA
	ADD.W	#$10,D0
	BRA.S	RETO
.AA	AND.W	#$FF0F,D0
RETO	MOVE.W	D0,PARAM_MGT(A1)
	JSR	AFF_PARAM_SPL
	RTS
***************************************************************************
PLUS1PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.W	D0,D1
	AND.W	#$F,D1
	CMP.W	#$F,D1
	BEQ.S	.AA
	ADD.W	#$1,D0
	BRA.S	RETO
.AA	AND.W	#$F0,D0	
	BRA.S	RETO
***************************************************************************
MOINS1000PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.L	D0,D1
	AND.L	#$F000,D1
	BEQ.S	.AA
	SUB.L	#$1000,D0
	BRA.S	RETO
.AA	OR.L	#$F000,D0
	BRA.S	RETO
***************************************************************************
MOINS100PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.L	D0,D1
	AND.W	#$F00,D1
	BEQ.S	.AA
	SUB.W	#$100,D0
	BRA.S	RETO
.AA	OR.W	#$F00,D0
	BRA.S	RETO
***************************************************************************
MOINS10PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.L	D0,D1
	AND.W	#$F0,D1
	BEQ.S	.AA
	SUB.W	#$10,D0
	BRA	RETO
.AA	OR.W	#$F0,D0
	BRA	RETO
***************************************************************************
MOINS1PARAMSPL
	MOVEQ	#0,D0
	MOVE.L	ADDCURSPL,A1
	MOVE.W	PARAM_MGT(A1),D0
	MOVE.W	D0,D1
	AND.W	#$F,D1
	BEQ.S	.BB
	SUB.W	#$1,D0
	BRA	RETO
.BB	OR.W	#$F,D0
	BRA	RETO
***************************************************************************
PLUSCOMSPL
	MOVE.L	ADDCURSPL,A1
	ADDQ.B	#1,COMMAND_MGT(A1)
	JSR	AFF_COM_SPL
	RTS
***************************************************************************
MOINSCOMSPL
	MOVE.L	ADDCURSPL,A1
	SUBQ.B	#1,COMMAND_MGT(A1)
	JSR	AFF_COM_SPL
	RTS
***************************************************************************
PLUSFRQSPL
	MOVE.L	ADDCURSPL,A1
	ADDQ.B	#1,NOTE_MGT(A1)
	CMP.B	#96,NOTE_MGT(A1)
	BNE.S	.ZZ
	MOVE.B	#95,NOTE_MGT(A1)
	
.ZZ	JSR	AFF_FRQ_SPL
	RTS

*************************************************************************
MOINSFRQSPL
	MOVE.L	ADDCURSPL,A1
	SUBQ.B	#1,NOTE_MGT(A1)
	CMP.B	#0,NOTE_MGT(A1)
	BNE.S	.ZZ
	MOVE.B	#1,NOTE_MGT(A1)
.ZZ	JSR	AFF_FRQ_SPL
	RTS
	
setloadfrq	dc.W	129
*************************************************************************
MONOSTEREO
	MOVE.B	#0,KEY
	MOVE.L	ADDCURSPL,A1
	CMP.L	#0,LEN_MGT(A1)
	BEQ.S	.rt7
	BCHG	#1,BIT1_MGT+1(A1)
	JSR	AFF_MONO_SPL
.rt7	RTS
***************************************************************************
LOOP	MOVEQ	#0,d0
	MOVE.B	#0,KEY
	MOVE.L	ADDCURSPL,A0
	BCHG.B	#2,BIT1_MGT+1(A1)
	RTS
***************************************************************************
CLRMUS	TST.B	CONTRO
	BEQ	VOL_OK
	MOVE.W	#26,okp
	RTS
CLRMUS1	BSR	INVERT_CLRMUS
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D7
	CMP.B	#1,all
	BEQ	.CLR_ALLMUS
	
	MOVE.L	DEBMUS,A0
	MOVE.B	curmus,D0
	MULU	#TOTAL_MUS,D0
	LEA	(A0,D0.W),A0
	
	MOVE.W	#0,RESTART_MUS(A0)
	MOVE.B	#6,I_SPEED_MUS(A0)
	MOVE.B	#$7D,I_TEMPO_MUS(A0)
	MOVE.W	#$2020,I_MASTERVOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A0)
	MOVE.L	#0,NAME_MUS(A0)
	MOVE.L	#0,NAME_MUS+4(A0)
	MOVE.L	#0,NAME_MUS+8(A0)
	MOVE.L	#0,NAME_MUS+12(A0)
	MOVE.L	#0,NAME_MUS+16(A0)
	MOVE.L	#0,NAME_MUS+20(A0)
	MOVE.L	#0,NAME_MUS+24(A0)
	MOVE.L	#0,NAME_MUS+28(A0)
	
	MOVE.L	ADDDEB_MUS(A0),A1
	MOVE.W	LEN_MUS(A0),D0
.BB	MOVE.W	D1,(A1)+
	SUBQ.L	#1,D0
	BNE.S	.BB
	
.EC1	BSR	INVERT_CLRMUS
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVE.B	#0,all
	BSR.L	AFFPATTERN3
	CMP.W	#26,okp
	BNE.S	.SS
	MOVE.W	#0,okp
.SS	RTS
	
.CLR_ALLMUS
	MOVE.L	DEBMUS,A0
	MOVE.B	maxmus,D7
	
.CC	MOVE.W	#0,RESTART_MUS(A0)
	MOVE.B	#6,I_SPEED_MUS(A0)
	MOVE.B	#$7D,I_TEMPO_MUS(A0)
	MOVE.W	#$2020,I_MASTERVOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A0)
	MOVE.L	#0,NAME_MUS(A0)
	MOVE.L	#0,NAME_MUS+4(A0)
	MOVE.L	#0,NAME_MUS+8(A0)
	MOVE.L	#0,NAME_MUS+12(A0)
	MOVE.L	#0,NAME_MUS+16(A0)
	MOVE.L	#0,NAME_MUS+20(A0)
	MOVE.L	#0,NAME_MUS+24(A0)
	MOVE.L	#0,NAME_MUS+28(A0)
	
	MOVE.L	ADDDEB_MUS(A0),A1
	MOVE.W	LEN_MUS(A0),D0
.DD	MOVE.W	D1,(A1)+
	SUBQ.L	#1,D0
	BNE.S	.DD
	ADD.W	#TOTAL_MUS,A0
	SUBQ.W	#1,D7
	BNE	.CC
	
	MOVE.B	#0,all
	BSR	INVERT_CLRALL
	BRA	.EC1
***************************************************************************
CLRPOS	TST.B	CONTRO
	BEQ	VOL_OK
	MOVE.W	#25,okp
	RTS
	
CLRPOS1	BSR	INVERT_CLRPOS
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	CMP.B	#1,all
	BEQ.S	.CLR_ALLPOS
	MOVE.L	ADDCURSEQ,A0
	MOVE.W	curpos,D0
	MOVE.W	#0,(A0,D0.W*2)
.EC3	BSR	INVERT_CLRPOS
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVE.B	#0,all
	BSR.L	AFFPATTERN3
	CMP.W	#25,okp
	BNE.S	.SS
	MOVE.W	#0,okp
.SS	RTS
	
.CLR_ALLPOS
	MOVE.L	ADDCURSEQ,A0
	MOVE.L	DEBMUS,A1
	MOVE.W	LEN_MUS(A1),D0
.AA	MOVE.W	#0,(A0)+
	SUBQ.L	#1,D0
	BNE.S	.AA
	MOVE.B	#0,all
	BSR	INVERT_CLRALL
	BRA.S	.EC3
***************************************************************************
CLRPTN	TST.B	CONTRO
	BEQ	VOL_OK
	MOVE.W	#5,okp
	RTS
CLRPTN1	BSR	INVERT_CLRPTN
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	CMP.B	#1,all
	BEQ.S	.CLR_ALLPAT
	
	MOVE.L	ADDCURPATT,A0
	MOVE.W	#64,(A0)+
	MOVE.L	#31,D0
.clrp	MOVE.W	D1,(A0)+
	DBF	D0,.clrp
	
.EC2	BSR	INVERT_CLRPTN
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	BSR.L	AFFPATTERN3
	CMP.W	#5,okp
	BNE.S	.SS
	MOVE.W	#0,okp
.SS	RTS
	
.CLR_ALLPAT
	MOVE.L	DEBPATT,A0
	MOVE.W	maxpatt,D0

.AA	MOVE.W	#64,(A0)+
	MOVEQ	#31,D1
.clralp	MOVE.W	D2,(A0)+
	DBF	D1,.clralp
	SUBQ.W	#1,D0
	BNE.S	.AA
	
	BSR	INVERT_CLRALL
	BRA	.EC2
***************************************************************************
CLRTRK	TST.B	CONTRO
	BEQ	VOL_OK
	MOVE.W	#19,okp
	RTS
CLRTRK1	BSR	INVERT_CLRTRK
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	CMP.B	#1,all
	BEQ.S	.CLR_ALLTRK
	MOVE.B	curvoie,D1
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D1.W),D1
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D1.W*4),A0
	MOVE.L	ADDCURTRACK(A0),A1
	MOVE.W	LENCURTRACK(A0),D0
.AA	MOVE.L	D2,(A1)+
	MOVE.W	D2,(A1)+
	SUBQ.W	#1,D0
	BNE.S	.AA
.EC4	BSR	INVERT_CLRTRK
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	BSR.L	AFFPATTERN3
	CMP.W	#19,okp
	BNE.S	.SS
	MOVE.W	#0,okp
.SS	RTS

.CLR_ALLTRK
	MOVE.L	DEBTRACK,A0
	MOVE.W	maxtrack,D0
	
.CC	MOVE.W	(A0)+,D1
.BB	MOVE.L	D2,(A0)+
	MOVE.W	D2,(A0)+
	SUBQ.W	#1,D1
	BNE.S	.BB
	SUBQ.W	#1,D0
	BNE.S	.CC
	MOVE.B	#0,all
	BSR	INVERT_CLRALL
	BRA.S	.EC4
***************************************************************************
CLRALL	TST.B	CONTRO
	BEQ	VOL_OK
	BSR	INVERT_CLRALL
	BCHG	#0,all
	RTS
all	DC.B	0
	even
***************************************************************************
CLRSPL	TST.B	CONTRO
	BEQ	VOL_OK
	MOVE.W	#4,okp
	RTS
CLRSPL1
	BSR	INVERT_CLRSPL
	CMP.B	#0,all
	BEQ	CLR_ONE
	LEA	SAMPLE,a0
	MOVE.L	#254*LEN_SAMPLE_MGT-1,d0
.clrsa	MOVE.B	#0,(a0)+
	DBF	D0,.clrsa
	MOVE.L	DEBSPL,ENDADDR
	BSR	FRE
	BSR	INVERT_CLRALL
	BSR	INVERT_CLRSPL
	MOVE.L	ADDCURSPL,A1
	BSR.L	SUM
	MOVE.B	#0,all
	CMP.W	#4,okp
	BNE.S	.SS
	MOVE.W	#0,okp
.SS	RTS

CLR_ONE	BSR.L	ERASE
	BSR	INVERT_CLRSPL
	MOVE.L	ADDCURSPL,A1
	BSR.L	SUM
	MOVE.W	#0,okp
	RTS
***************************************************************************
CONVERT_WORD_TO_HEXA
	MOVEM.L	D0-D2/A0/A2/A4,-(A7)
	LEA	hexa,a4
	MOVEQ	#0,D1
	MOVEQ	#3,D2
	
.FF	MOVE.B	D0,D1
	AND.B	#$F,D1
	MOVE.B	(A4,D1.W),(A0,D2.W)
	LSR.W	#4,D0
	DBF	D2,.FF
	
	MOVEQ	#3,D0
.stll	CMP.B	#'0',(A0)
	BNE.S	.srt
	MOVE.B  #0,(A0)+
	SUB.W	#1,D0
	BNE.S	.stll
.srt	MOVEM.L	(A7)+,D0-D2/A0/A2/A4
	RTS
***************************************************************************
*	IN : D0 = Nombre a convertir
*	     A0 = Adresse ou convertir
CONVERT_BYTE_DECI
	divu	#100,d0			* converti les centaines
	ADD.W	#'0',d0
	MOVE.B	d0,(a0)
	MOVE.W	#0,d0
	swap	d0
	divu	#10,d0			* converti les dizaines
	ADD.W	#'0',d0
	MOVE.B	d0,1(a0)
	swap	d0			* puis les unites
	ADD.W	#'0',d0
	MOVE.B	d0,2(a0)
	MOVEQ	#2,d0			* vire les '0' en trop
.stll	cmp.b	#'0',(a0)
	BNE.S	.srt
	MOVE.B  #0,(a0)+
	subq	#1,d0
	BNE.S	.stll
.srt	RTS
***************************************************************************
SUBPAT1000
	MOVE.L	#-$1000,D0
	BRA.S	dog
SUBPAT100
	MOVE.L	#-$100,D0
	BRA.S	dog
SUBPAT10
	MOVE.L	#-$10,D0
	BRA.S	dog
SUBPAT1
	MOVE.L	#-1,D0
	BRA.S	dog
ADDPAT1000
	MOVE.L	#$1000,D0
	BRA.S	dog
ADDPAT100
	MOVE.L	#$100,D0
	BRA.S	dog
ADDPAT10
	MOVEQ	#$10,D0
	BRA.S	dog
ADDPAT1
	MOVEQ	#1,D0
	
dog	MOVEQ	#0,D1
	MOVE.W	curpatt,D1
	ADD.L	D0,D1
	BGE.S	.FISH2
	MOVEQ	#0,D1
.FISH2	MOVE.W	maxpatt,D2
	SUBQ.W	#1,D2
	CMP.W	D2,D1
	BLT.S	.FISH4
	MOVE.W	D2,D1
.FISH4	MOVE.W	D1,curpatt

	MOVE.W	D1,D0
	MOVE.L  #screen+640*328+448,where
	BSR	pouet
	
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.W	curpos,D1
	MOVE.W	curpatt,D0		* Place la pattern courante
	MOVE.L	ADDCURSEQ,A0		* dans la sequence
	MOVE.W	D0,(A0,D1.W*2)
yep	
	MOVE.B	playsong,D1
	ADD.B	playpat,D1
	BNE.S	.DD
	MOVE.W	#0,inpatt2
	MOVE.B	#0,inpatt
	BRA.S	.FF
	
.DD	MOVE.W	#-6,inpatt2
	MOVE.B	#-1,inpatt
	
.FF	MOVE.W	D0,D3
	BSR.L	PATT_TRACK
	BSR.L	AFFPATTERN
re	RTS
***************************************************************************
SUBPOS1000
	MOVE.L	#-$1000,D0
	BRA.S	monkey
SUBPOS100
	MOVE.L	#-$100,D0
	BRA.S	monkey
SUBPOS10
	MOVE.L	#-$10,D0
	BRA.S	monkey
SUBPOS1
	MOVE.L	#-1,D0
	BRA.S	monkey
ADDPOS1000
	MOVE.L	#$1000,D0
	BRA.S	monkey
ADDPOS100
	MOVE.L	#$100,D0
	BRA.S	monkey
ADDPOS10
	MOVEQ	#$10,D0
	BRA.S	monkey
ADDPOS1
	MOVEQ	#1,D0
	
monkey	MOVEQ	#0,D1
	MOVE.W	curpos,D1
	ADD.L	D0,D1
	BGE.S	.FISH2
	MOVEQ	#0,D1
.FISH2	MOVE.W	curlen,D2
	SUBQ.W	#1,D2
	CMP.W	D2,D1
	BLT.S	.FISH4
	MOVE.W	D2,D1
.FISH4	MOVE.W	D1,curpos
	
	
frigo	MOVEQ	#0,D0				*puisque la postion dans
	MOVE.W	curpos,D0			*la sequence a ete modifie
	MOVE.L  #screen+640*320+448,where
	BSR	pouet
	
	MOVE.W	curpos,D0		* SI POS = 0
	BNE.S	.ZZ			* ALORS INITIAL SPEED
	MOVEQ	#0,D0
	MOVE.B	curmus,D0
	MOVE.L	DEBMUS,A0
	MULU	#TOTAL_MUS,D0
	LEA	(A0,D0.L),A0
	MOVEQ	#0,D0
	MOVE.B	I_SPEED_MUS(A0),D0
	MOVE.W	D0,SPEED
	MOVE.B	I_TEMPO_MUS(A0),D0
	BSR	SET_T2
	LEA	I_VOL_MUS(A0),A0
	LEA	PILEVOIE,A1
	MOVEQ	#31,D0
.EE	MOVE.L	(A1)+,A2
	MOVE.W	(A0)+,LEFT_VOL(A2)
	DBF	D0,.EE
	
.ZZ	MOVE.W	curpos,D0
	MOVE.L	ADDCURSEQ,A0			*on affiche la pattern
	MOVE.W	(A0,D0.W*2),D0			*correspondante.
						*la pattern devient donc
	MOVE.W	D0,curpatt			*courante
	MOVE.L  #screen+640*328+448,where
	BSR	pouet
	MOVEQ	#0,D0
	MOVE.W	curpatt,D0
	bra	yep
re1	RTS
***************************************************************************
SUBNUM100
	MOVE.L	#-$100,D0
	BRA.S	fish
SUBNUM10
	MOVE.L	#-$10,D0
	BRA.S	fish
SUBNUM1
	MOVE.L	#-1,D0
	BRA.S	fish
ADDNUM100
	MOVE.L	#$100,D0
	BRA.S	fish
ADDNUM10
	MOVEQ	#$10,D0
	BRA.S	fish
ADDNUM1
	MOVEQ	#1,D0
	
fish	MOVEQ	#0,D1
	MOVE.B	curmus,D1
	ADD.L	D0,D1
	BGE.S	.FISH2
	MOVEQ	#0,D1
.FISH2	MOVE.B	maxmus,D2
	SUBQ.B	#1,D2
	CMP.B	D2,D1
	BLT.S	.FISH4
	MOVE.B	D2,D1
.FISH4	MOVE.B	D1,curmus
					*puisqu'on change de zik
	MOVE.W	#0,curpos		*on remet a zero les compteurs 
					*de position (sequence)
	MOVE.L	DEBMUS,A0
	MULU	#TOTAL_MUS,D1
	LEA	(A0,D1.L),A0
	MOVE.L	ADDDEB_MUS(A0),ADDCURSEQ
	MOVE.W	LEN_MUS(A0),curlen
	MOVE.W	RESTART_MUS(A0),curlop
	MOVEQ	#0,D0
	MOVE.B	I_SPEED_MUS(A0),D0
	MOVE.W	D0,SPEED
	MOVE.B	I_TEMPO_MUS(A0),D0
	BSR	SET_T2
	LEA	I_VOL_MUS(A0),A0
	LEA	PILEVOIE,A1
	MOVEQ	#31,D0
.AA	MOVE.L	(A1)+,A2
	MOVE.W	(A0)+,LEFT_VOL(A2)
	DBF	D0,.AA
	
	MOVE.L	ADDCURSEQ,A0
	MOVE.W	2(A0),curpatt

	MOVEQ	#0,D0
	MOVE.B	curmus,D0
	MOVE.L  #screen+640*312+448,where
	BSR	pouet
	MOVE.W	curlen,D0
	MOVE.L  #screen+640*320+481,where
	BSR	pouet2
	MOVE.W	curlop,D0
	MOVE.L  #screen+640*344+448,where
	BSR	pouet
	bra	frigo			*puis on va afficher le tout
re2	RTS
char3:	dc.b 	'   0'
***************************************************************************
SUBLEN1000
	MOVE.L	#-$1000,D0
	BRA.S	rabbit
SUBLEN100
	MOVE.L	#-$100,D0
	BRA.S	rabbit
SUBLEN10
	MOVE.L	#-$10,D0
	BRA.S	rabbit
SUBLEN1
	MOVE.L	#-1,D0
	BRA.S	rabbit
ADDLEN1000
	MOVE.L	#$1000,D0
	BRA.S	rabbit
ADDLEN100
	MOVE.L	#$100,D0
	BRA.S	rabbit
ADDLEN10
	MOVEQ	#$10,D0
	BRA.S	rabbit
ADDLEN1
	MOVEQ	#1,D0
	
rabbit	MOVEQ	#0,D1
	MOVE.W	curlen,D1
	ADD.L	D0,D1
	BGE.S	.FISH2
	MOVEQ	#1,D1
.FISH2	MOVE.W	maxpos,D2
	SUBQ.W	#1,D2
	CMP.W	D2,D1
	BLT.S	.FISH4
	MOVE.W	D2,D1
.FISH4	MOVE.W	D1,curlen
	
	MOVEQ	#0,D0
	MOVE.B	curmus,D0
	MOVE.L	MUSIQUE,A0
	LEA	(A0,D0.W*4),A0
	MOVE.W	D1,4(A0)
	MOVE.W	D1,D0
	MOVE.L  #screen+640*336+448,where
	BSR	pouet
	RTS
***************************************************************************
SUBLOP1000
	MOVE.L	#-$1000,D0
	BRA.S	cow
SUBLOP100
	MOVE.L	#-$100,D0
	BRA.S	cow
SUBLOP10
	MOVE.L	#-$10,D0
	BRA.S	cow
SUBLOP1
	MOVE.L	#-1,D0
	BRA.S	cow
ADDLOP1000
	MOVE.L	#$1000,D0
	BRA.S	cow
ADDLOP100
	MOVE.L	#$100,D0
	BRA.S	cow
ADDLOP10
	MOVEQ	#$10,D0
	BRA.S	cow
ADDLOP1
	MOVEQ	#1,D0
	
cow	MOVEQ	#0,D1
	MOVE.W	curlop,D1
	ADD.L	D0,D1
	BGE.S	.FISH2
	MOVEQ	#0,D1
.FISH2	MOVE.W	maxpos,D2
	SUBQ.W	#1,D2
	CMP.W	D2,D1
	BLT.S	.FISH4
	MOVE.W	D2,D1
.FISH4	MOVE.W	D1,curlop
	
	MOVEQ	#0,D0
	MOVE.B	curmus,D0
	MOVE.L	MUSIQUE,A0
	LEA	(A0,D0.W*4),A0
	MOVE.W	D1,6(A0)
	MOVE.W	D1,D0
	MOVE.L  #screen+640*344+448,where
	BSR	pouet
	RTS
****************************************************************************
TYPE	BCHG.B	#0,BTYPE
	MOVEQ	#0,D0
	MOVE.B	BTYPE,D0
	MULU	#3,D0
	LEA	ATYPE,A0
	LEA	(A0,D0),A0
	MOVE.L  #screen+640*104+480-15,where
	MOVE.W	#1,compt2
	MOVEQ	#3,D1
	BSR 	PRINT
	RTS
BTYPE 	DC.W 	0
ATYPE	DC.B 	'POS','PTN'
****************************************************************************
INSERT	MOVE.W	#27,okp
	RTS
	
INSERT1
	*BTST.B	#0,BTYPE
	*BNE	INS_PTN
	
	MOVEQ	#0,D0
	MOVEQ	#1*2,D1			* LEN OF POS ADDED
	MOVEQ	#0,D2
	MOVEQ	#1,D7			* #   OF POS ADDED
	MOVE.B	curmus,D0
	MOVE.B	maxmus,D3
	SUB.B	D0,D3
	MULU	#TOTAL_MUS,D0
	MOVE.L	DEBMUS,A0
	LEA	(A0,D0.W),A0
	MOVE.L	ADDDEB_MUS(A0),A1
	ADD.W	D7,LEN_MUS(A0)
	ADD.W	D7,curlen
	
.AA	ADD.L	#TOTAL_MUS,A0
	SUBQ.W	#1,D3
	BEQ.S	.BB
	ADD.W	D7,LEN_MUS(A0)
	BRA.S	.AA
	
.BB	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	ADD.L	D1,DEB_MGT(A4)
	ADD.L	D1,FIN_MGT(A4)
	ADD.L	D1,LOOP_DEB_MGT(A4)
	ADD.L	D1,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER
	
	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.IO	ADD.L	D1,(A0)+
	DBF	D3,.IO
	
	MOVEQ	#0,D2
	MOVE.W	curpos,D2
	ADD.L	D2,D2
	LEA	(A1,D2.L),A1
	MOVE.L	ENDADDR,A3
	ADD.L	D1,DEBPATT
	ADD.L	D1,DEBTABTRACK
	ADD.L	D1,DEBTRACK
	ADD.L	D1,DEBSPL
	ADD.L	D1,ENDADDR
	ADD.L	D1,ADDCURPATT
	*ADD.L	D1,ADDCURSPL
	
	MOVE.L	A3,A4
	MOVE.L	A3,D3
	SUB.L	A1,D3
	ADD.L	D1,A4
.TY	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.TY
	
	MOVE.L	D1,D0
.YU	MOVE.B	#0,-(A4)
	SUBQ.L	#1,D0
	BNE.S	.YU
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.UI	MOVE.L	(A0)+,A1
	ADD.L	D1,ADDCURTRACK(A1)
	DBF	D0,.UI
	
	MOVE.W	curlen,D0
	MOVE.L	#screen+640*320+481,where
	BSR	pouet2
	BSR 	FRE	
	CMP.W	#27,okp
	BNE.S	.DD
	MOVE.W	#0,okp
.DD	RTS			* OKP
****************************************************************************
DELETE	MOVE.W	#28,okp
	RTS
	
DELETE1
	MOVEQ	#0,D0
	MOVEQ	#1*2,D1
	MOVEQ	#0,D2
	MOVEQ	#1,D7
	MOVE.B	curmus,D0
	MOVE.B	maxmus,D3
	SUB.B	D0,D3
	MULU	#TOTAL_MUS,D0
	MOVE.L	DEBMUS,A0
	LEA	(A0,D0.W),A0
	MOVE.L	ADDDEB_MUS(A0),A1
	SUB.W	D7,LEN_MUS(A0)
	SUB.W	D7,curlen
	
.AA	ADD.L	#TOTAL_MUS,A0
	SUBQ.W	#1,D3
	BEQ.S	.BB
	SUB.W	D7,LEN_MUS(A0)
	BRA.S	.AA
	
.BB	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	SUB.L	D1,DEB_MGT(A4)
	SUB.L	D1,FIN_MGT(A4)
	SUB.L	D1,LOOP_DEB_MGT(A4)
	SUB.L	D1,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER
	
	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.IO	SUB.L	D1,(A0)+
	DBF	D3,.IO
	
	MOVEQ	#0,D2
	MOVE.W	curpos,D2
	ADD.L	D2,D2
	LEA	(A1,D2.L),A1
	MOVE.L	A1,A2
	ADD.W	D1,A2
	MOVE.L	ENDADDR,D3
	SUB.L	A2,D3
	SUB.L	D1,DEBPATT
	SUB.L	D1,DEBTABTRACK
	SUB.L	D1,DEBTRACK
	SUB.L	D1,DEBSPL
	SUB.L	D1,ENDADDR
	SUB.L	D1,ADDCURPATT
	*SUB.L	D1,ADDCURSPL


.ZZ	MOVE.B	(A2)+,(A1)+
	SUBQ.L	#1,D3
	BNE.S	.ZZ

	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.UI	MOVE.L	(A0)+,A1
	SUB.L	D1,ADDCURTRACK(A1)
	DBF	D0,.UI
	
	MOVE.W	curlen,D0
	MOVE.L	#screen+640*320+481,where
	BSR	pouet2
	BSR	FRE
	CMP.W 	#28,okp
	BNE.S	.DD
	MOVE.W	#0,okp
.DD	RTS
****************************************************************************
SUBMAXNUM10
	MOVEQ	#$10,D0
	BRA.S	FG
SUBMAXNUM1
	MOVEQ	#1,D0

FG	TST.B	CONTRO
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.B	maxmus,D1
	CMP.W	D1,D0
	BLT.S	.GH
	MOVE.B	D1,D0
	SUBQ.B	#1,D0
.GH	MOVE.L	D0,MAXTEMP
	MOVE.W	#21,okp
	RTS
	
SUBMAXMUS
	MOVE.L	MAXTEMP,D0
	BEQ	.AB
	SUB.B	D0,maxmus
	MOVE.L	D0,D1
	MOVE.L	D0,D2
	MULU	#TOTAL_MUS,D1		* D1 = LEN OF DATAMUS
	LSL.W	#5,D2			* D2 = LEN OF DATASEQ
	MOVE.L	D1,D6
	ADD.L	D2,D6			* D6 = TOTAL LEN

	MOVE.L	DEBMUS,A4
	MOVEQ	#0,D3
	MOVE.B	maxmus,D3
	SUBQ.W	#1,D3
.HH	SUB.L	D1,ADDDEB_MUS(A4)
	ADD.W	#TOTAL_MUS,A4
	DBF	D3,.HH
	
	LEA	SAMPLE,A4
	MOVE.L	#255,D3
.DD	CMP.L	#0,LEN_MGT(a4)
	BEQ.S	.SS
	SUB.L	D6,DEB_MGT(A4)
	SUB.L	D6,FIN_MGT(A4)
	SUB.L	D6,LOOP_DEB_MGT(A4)
	SUB.L	D6,LOOP_FIN_MGT(A4)
.SS	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.DD
	
	MOVE.L	DEBTABTRACK,A4
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.FF	SUB.L	D6,(A4)+
	DBF	D3,.FF
	
	MOVE.L	DEBSEQ,A0
	MOVE.L	DEBSEQ,A2
	MOVE.L	DEBPATT,D3
	SUB.L	A0,D3
	SUB.L	D1,A0
.ML	MOVE.B	(A2)+,(A0)+
	SUBQ.L	#1,D3
	BNE.S	.ML
	
	MOVE.L	DEBPATT,A0
	MOVE.L	DEBPATT,A2
	MOVE.L	ENDADDR,D3
	SUB.L	A0,D3
	SUB.L	D6,A0
.LK	MOVE.B	(A2)+,(A0)+
	SUBQ.L	#1,D3
	BNE.S	.LK
	
	SUB.L	D1,DEBSEQ
	SUB.L	D6,DEBPATT
	SUB.L	D6,DEBTABTRACK
	SUB.L	D6,DEBTRACK
	SUB.L	D6,DEBSPL
	SUB.L	D1,ADDCURSEQ
	SUB.L	D6,ADDCURPATT
	SUB.L	D6,ADDCURSPL
	SUB.L	D6,ENDADDR
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.KJ	MOVE.L	(A0)+,A1
	SUB.L	D6,ADDCURTRACK(A1)
	DBF	D0,.KJ
	
	MOVE.L	#0,MAXTEMP
	MOVEQ	#0,D0
	MOVE.B	maxmus,D0
	MOVE.L	#screen+640*312+481,where
	BSR	pouet2
	BSR	FRE
	
.AB	CMP.W	#21,okp
	BNE.S	.BA
	MOVE.W	#0,okp
.BA	RTS
****************************************************************************
SUBMAXPOS100
	MOVE.L	#$100,D0
	BRA.S	GH
SUBMAXPOS10
	MOVEQ	#$10,D0
	BRA.S	GH
SUBMAXPOS1
	MOVEQ	#1,D0

GH	CMP.W	#22,okp
	BNE	VOL_OK
	TST.B	CONTRO
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.W	curlen,D1
	CMP.L	D1,D0
	BLT.S	.HI
	MOVE.W	D1,D0
	SUBQ.W	#1,D0
.HI	MOVE.L	D0,MAXTEMP
	MOVE.W	#22,okp
	RTS
	
SUBMAXPOS
	MOVE.L	MAXTEMP,D0
	BEQ	.BC
	SUB.W	D0,curlen
	MOVE.L	D0,D6
	LSL.W	#1,D6			* D6 = TOTAL LEN

	LEA	SAMPLE,A4
	MOVE.L	#255,D3
.FF	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.GG
	SUB.L	D6,DEB_MGT(A4)
	SUB.L	D6,FIN_MGT(A4)
	SUB.L	D6,LOOP_DEB_MGT(A4)
	SUB.L	D6,LOOP_FIN_MGT(A4)
.GG	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.FF
	
	MOVE.L	DEBTABTRACK,A4
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.HH	SUB.L	D6,(A4)+
	DBF	D3,.HH
	
	MOVE.L	DEBMUS,A0
	MOVEQ	#0,D1
	MOVE.B	curmus,D1
	MULU	#TOTAL_MUS,D1
	ADD.L	D1,A0
	MOVE.L	ADDDEB_MUS(A0),A1
	MOVE.L	ADDDEB_MUS(A0),A2
	MOVEQ	#0,D3
	MOVE.W	LEN_MUS(A0),D3
	LSL.W	#1,D3
	ADD.L	D3,A1
	ADD.L	D3,A2
	ADD.L	D6,A2
	MOVE.L	ENDADDR,D3
	SUB.L	A2,D3
.ML	MOVE.B	(A2)+,(A1)+
	SUBQ.L	#1,D3
	BNE.S	.ML
	MOVE.W	curlen,LEN_MUS(A0)
	
	SUB.L	D6,DEBPATT
	SUB.L	D6,DEBTABTRACK
	SUB.L	D6,DEBTRACK
	SUB.L	D6,DEBSPL
	SUB.L	D6,ADDCURPATT
	SUB.L	D6,ADDCURSPL
	SUB.L	D6,ENDADDR
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.KJ	MOVE.L	(A0)+,A1
	SUB.L	D6,ADDCURTRACK(A1)
	DBF	D0,.KJ
	
	MOVE.L	#0,MAXTEMP
	MOVEQ	#0,D0
	MOVE.W	curlen,D0
	MOVE.L	#screen+640*320+481,where
	BSR	pouet2
	BSR	FRE
	
.BC	CMP.W	#22,okp
	BNE.S	.CB
	MOVE.W	#0,okp
.CB	RTS
****************************************************************************
SUBMAXPAT100
	MOVE.L	#$100,D0
	BRA.S	HI
SUBMAXPAT10
	MOVEQ	#$10,D0
	BRA.S	HI
SUBMAXPAT1
	MOVEQ	#1,D0

HI	TST.B	CONTRO
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.W	maxpatt,D1
	CMP.L	D1,D0
	BLT.S	.IJ
	MOVE.W	D1,D0
	SUBQ.W	#1,D0
.IJ	MOVE.L	D0,MAXTEMP
	MOVE.W	#23,okp
	RTS
	
SUBMAXPAT
	MOVE.L	MAXTEMP,D0
	BEQ	.CD
	SUB.W	D0,maxpatt
	MOVE.L	D0,D6
	MULU.W	#32*2+2,D6			* D6 = TOTAL LEN

	LEA	SAMPLE,A4
	MOVE.L	#255,D3
.II	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.JJ
	SUB.L	D6,DEB_MGT(A4)
	SUB.L	D6,FIN_MGT(A4)
	SUB.L	D6,LOOP_DEB_MGT(A4)
	SUB.L	D6,LOOP_FIN_MGT(A4)
.JJ	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.II
	
	MOVE.L	DEBTABTRACK,A4
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.ZZ	SUB.L	D6,(A4)+
	DBF	D3,.ZZ
	
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	ENDADDR,D1
	SUB.L	A0,D1
	MOVE.L	A0,A1
	SUB.L	D6,A0
.KK	MOVE.B	(A1)+,(A0)+
	SUBQ.L	#1,D1
	BNE.S	.KK
	
	SUB.L	D6,DEBTABTRACK
	SUB.L	D6,DEBTRACK
	SUB.L	D6,DEBSPL
	SUB.L	D6,ENDADDR
	SUB.L	D6,ADDCURSPL
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.KJ	MOVE.L	(A0)+,A1
	SUB.L	D6,ADDCURTRACK(A1)
	DBF	D0,.KJ
	
	MOVE.L	DEBSEQ,A0
	MOVE.L	DEBPATT,D0
	SUB.L	A0,D0
	LSR.L	#1,D0
	SUBQ.L	#1,D0
	MOVE.W	maxpatt,D7
.JN	MOVE.W	(A0),D2
	CMP.W	D7,D2
	BLT.S	.UJ
	MOVE.W	#0,(A0)
.UJ	ADDQ.W	#2,A0
	DBF	D0,.JN
	
	MOVE.L	#0,MAXTEMP
	MOVEQ	#0,D0
	MOVE.W	maxpatt,D0
	MOVE.L	#screen+640*328+481,where
	BSR	pouet2
	BSR	FRE
	
.CD	CMP.W	#23,okp
	BNE.S	.DC
	MOVE.W	#0,okp
.DC	RTS
****************************************************************************
SUBMAXTRK100
	MOVE.L	#$100,D0
	BRA.S	IJ
SUBMAXTRK10
	MOVEQ	#$10,D0
	BRA.S	IJ
SUBMAXTRK1
	MOVEQ	#1,D0

IJ	TST.B	CONTRO
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.W	maxtrack,D1
	CMP.L	D1,D0
	BLT.S	.Jk
	MOVE.W	D1,D0
	SUBQ.W	#1,D0
.Jk	MOVE.L	D0,MAXTEMP
	MOVE.W	#24,okp
	RTS
	
SUBMAXTRK
	MOVE.L	MAXTEMP,D0
	BEQ	.CD
	SUB.W	D0,maxtrack
	MOVEQ	#0,D1
	MOVEQ	#0,D3
	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D1
	SUBQ.W	#1,D1
	
	MOVE.L	DEBSPL,D2
	MOVE.L	(A0,D1.L*4),A0
	MOVE.W	(A0),D3
	MULU	#6,D3
	ADDQ.L	#2,D3
	
	SUB.L	A0,D2
	SUB.L	D3,D2
	
	LSL.L	#2,D0			* D0 = LEN TAB TRACK
	MOVE.L	D2,D6			* D2 = LEN TRACK
	ADD.L	D0,D6			* D6 = TOTAL LEN

	LEA	SAMPLE,A4
	MOVE.L	#255,D3
.LL	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.MM
	SUB.L	D6,DEB_MGT(A4)
	SUB.L	D6,FIN_MGT(A4)
	SUB.L	D6,LOOP_DEB_MGT(A4)
	SUB.L	D6,LOOP_FIN_MGT(A4)
.MM	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.LL
	
	MOVE.L	DEBTABTRACK,A4
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.OO	SUB.L	D0,(A4)+
	DBF	D3,.OO
	
	MOVE.L	DEBTRACK,A0
	MOVE.L	DEBSPL,D3
	SUB.L	A0,D3
	MOVE.L	A0,A1
	SUB.L	D0,A0
.PP	MOVE.B	(A1)+,(A0)+
	SUBQ.L	#1,D3
	BNE.S	.PP
	
	MOVE.L	DEBSPL,A0
	MOVE.L	ENDADDR,D1
	SUB.L	A0,D1
	BEQ.S	.WW
	MOVE.L	A0,A1
	SUB.L	D6,A0
.QQ	MOVE.B	(A1)+,(A0)+
	SUBQ.L	#1,D1
	BNE.S	.QQ
	
.WW	SUB.L	D0,DEBTRACK
	SUB.L	D6,DEBSPL
	SUB.L	D6,ENDADDR
	SUB.L	D6,ADDCURSPL
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.KJ	MOVE.L	(A0)+,A1
	SUB.L	D6,ADDCURTRACK(A1)
	DBF	D0,.KJ
	
	MOVE.L	DEBPATT,A0
	MOVEQ	#0,D0
	MOVEQ	#0,D3
	MOVE.W	maxpatt,D0
	SUBQ.W	#1,D0
	MOVE.W	maxtrack,D1
.GB	MOVEQ	#31,D2
	ADDQ.W	#2,A0
.FR	MOVE.W	(A0),D3
	CMP.L	D1,D3
	BLT.S	.SX
	MOVE.W	#0,(A0)
.SX	ADDQ.W	#2,A0
	DBF	D2,.FR
	DBF	D0,.GB
	
	MOVE.L	#0,MAXTEMP
	MOVEQ	#0,D0
	MOVE.W	maxtrack,D0
	MOVE.L	#screen+640*336+481,where
	BSR	pouet2
	BSR	FRE
	
.CD	CMP.W	#24,okp
	BNE.S	.DC
	MOVE.W	#0,okp
.DC	RTS
****************************************************************************
ADDMAXNUM10
	MOVEQ	#$10,D0
	BRA.S	DF
ADDMAXNUM1
	MOVEQ	#1,D0
	
DF	TST.B	CONTRO
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.B	maxmus,D1
	ADD.L	D0,D1
	CMP.L	#255,D1
	BLE.S	.ZE
	MOVE.L	#255,D1
.ZE	MOVE.L	D1,MAXTEMP
	MOVE.W	#20,okp
	RTS

ADDMAXMUS
	MOVEQ	#0,D0
	MOVE.B	maxmus,D0
	MOVE.L	D0,D4
	MOVE.L	MAXTEMP,D1
	BEQ	.AA

	SUB.L	D0,D1
	ADD.B	D1,maxmus
	MOVE.L	D1,MAXTEMP
	MOVE.L	D1,D0
	MULU	#TOTAL_MUS,D1		* D1 = LEN OF DATAMUS
	LSL.W	#5,D0			* D2 = LEN OF DATASEQ GENERATED
	MOVE.L	D1,D6
	ADD.L	D0,D6			* D6 = TOTAL LEN
	
	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	ADD.L	D6,DEB_MGT(A4)
	ADD.L	D6,FIN_MGT(A4)
	ADD.L	D6,LOOP_DEB_MGT(A4)
	ADD.L	D6,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER

	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.IO	ADD.L	D6,(A0)+
	DBF	D3,.IO
	
	MOVE.L	DEBPATT,A1
	MOVE.L	A1,D5
	SUB.L	DEBSEQ,D5
	MOVE.L	ENDADDR,A3
	ADD.L	D6,DEBPATT
	ADD.L	D6,DEBTABTRACK
	ADD.L	D6,DEBTRACK
	ADD.L	D6,DEBSPL
	ADD.L	D6,ENDADDR
	ADD.L	D1,ADDCURSEQ
	ADD.L	D6,ADDCURPATT
	ADD.L	D6,ADDCURSPL
	
	MOVE.L	A3,A4
	MOVE.L	A3,D3
	SUB.L	A1,D3
	ADD.L	D6,A4
.TY	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.TY
	
	MOVE.L	D0,D3
.YU	MOVE.B	#0,-(A4)
	SUBQ.L	#1,D3
	BNE.S	.YU
	
	MOVE.L	DEBSEQ,A3
	ADD.L	D1,DEBSEQ
	ADD.L	D5,A3
.QS	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D5
	BNE.S	.QS
	
	MOVE.L	DEBMUS,A0
.OP	ADD.L	D1,ADDDEB_MUS(A0)
	ADD.W	#TOTAL_MUS,A0
	SUBQ.L	#1,D4
	BNE.S	.OP
	MOVE.L	MAXTEMP,D4
	LEA	-TOTAL_MUS(A0),A1
	MOVEQ	#0,D5
	MOVE.W	LEN_MUS(A1),D5		* A VOIR
	ADDQ.L	#1,D5
	ADD.L	D5,D5
	ADD.L	ADDDEB_MUS(A1),D5
.PQ	MOVE.L	D5,ADDDEB_MUS(A0)
	MOVE.W	#32,LEN_MUS(A0)
	MOVE.W	#0,RESTART_MUS(A0)
	MOVE.B	#6,I_SPEED_MUS(A0)
	MOVE.B	#$7D,I_TEMPO_MUS(A0)
	MOVE.W	#$2020,I_MASTERVOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+32(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+36(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+30(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+44(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+48(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+52(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+56(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+60(A0)
	MOVEQ	#31,D3
.KL	MOVE.B	#0,(NAME_MUS)(A0,D3.W)
	DBF	D3,.KL
	ADD.W	#TOTAL_MUS,A0
	ADD.L	#32*2,D5
	SUBQ.L	#1,D4
	BNE	.PQ	

	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.UI	MOVE.L	(A0)+,A1
	ADD.L	D6,ADDCURTRACK(A1)
	DBF	D0,.UI

	MOVE.L	#0,MAXTEMP
	
	MOVEQ	#0,D0
	MOVE.B	maxmus,D0
	MOVE.L  #screen+640*312+481,where
	BSR	pouet2
	
	BSR	FRE
	
.AA	CMP.W	#20,okp
	BNE.S	.BB
	MOVE.W	#0,okp
.BB	RTS
****************************************************************************
ADDMAXPOS100
	MOVE.L	#$100,D0
	BRA.S	SD
ADDMAXPOS10
	MOVEQ	#$10,D0
	BRA.S	SD
ADDMAXPOS1
	MOVEQ	#1,D0
	
SD	CMP.W	#18,okp
	BEQ.S	.ER
	MOVEQ	#0,D1
	MOVE.W	curlen,D1
	ADD.L	D0,D1
	CMP.L	#65535,D1
	BLE.S	.ZE
	MOVE.L	#65535,D1
.ZE	MOVE.L	D1,MAXTEMP
	MOVE.W	#18,okp
.ER	RTS

ADDMAXPOS
	MOVEQ	#0,D0
	MOVE.W	curlen,D0
	MOVE.L	MAXTEMP,D1
	BEQ	.AA

	SUB.L	D0,D1
	ADD.W	D1,curlen
	LSL.W	#1,D1
	
	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	ADD.L	D1,DEB_MGT(A4)
	ADD.L	D1,FIN_MGT(A4)
	ADD.L	D1,LOOP_DEB_MGT(A4)
	ADD.L	D1,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER

	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.IO	ADD.L	D1,(A0)+
	DBF	D3,.IO
	
	MOVE.L	DEBPATT,A1
	MOVE.L	ENDADDR,A3
	ADD.L	D1,DEBPATT
	ADD.L	D1,DEBTABTRACK
	ADD.L	D1,DEBTRACK
	ADD.L	D1,DEBSPL
	ADD.L	D1,ENDADDR
	ADD.L	D1,ADDCURPATT
	ADD.L	D1,ADDCURSPL
	
	MOVE.L	A3,A4
	MOVE.L	A3,D3
	SUB.L	A1,D3
	ADD.L	D1,A4
.TY	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.TY
	
	MOVE.L	D1,D0
	SUBQ.L	#1,D0
.YU	MOVE.B	#0,-(A4)
	SUBQ.L	#1,D0
	BNE.S	.YU

	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.UI	MOVE.L	(A0)+,A1
	ADD.L	D1,ADDCURTRACK(A1)
	DBF	D0,.UI

	MOVE.L	#0,MAXTEMP
	
	MOVE.W	curlen,D0
	MOVE.L  #screen+640*320+481,where
	BSR	pouet2
	
	BSR	FRE
	
.AA	CMP.W	#18,okp
	BNE.S	.BB
	MOVE.W	#0,okp
.BB	RTS
***************************************************************************
ADDMAXPAT100
	MOVE.L	#$100,D0
	BRA.S	QS
ADDMAXPAT10
	MOVEQ	#$10,D0
	BRA.S	QS
ADDMAXPAT1
	MOVEQ	#1,D0
	
QS	MOVEQ	#0,D1
	MOVE.W	maxpatt,D1
	ADD.L	D0,D1
	CMP.L	#65535,D1
	BLE.S	.ZE
	MOVE.L	#65535,D1
.ZE	MOVE.L	D1,MAXTEMP
	MOVE.W	#17,okp
	RTS
	
ADDMAXPAT
	MOVEQ	#0,D0
	MOVE.W	maxpatt,D0
	MOVE.L	MAXTEMP,D1
	BEQ	.AA

	SUB.L	D0,D1
	ADD.W	D1,maxpatt
	MULU	#32*2+2,D1		* D1 = LEN OF PAT ADDED
	
	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	ADD.L	D1,DEB_MGT(A4)
	ADD.L	D1,FIN_MGT(A4)
	ADD.L	D1,LOOP_DEB_MGT(A4)
	ADD.L	D1,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER

	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	SUBQ.W	#1,D3
.IO	ADD.L	D1,(A0)+
	DBF	D3,.IO
	
	MOVE.L	DEBTABTRACK,A1
	MOVE.L	ENDADDR,A3
	ADD.L	D1,DEBTABTRACK
	ADD.L	D1,DEBTRACK
	ADD.L	D1,DEBSPL
	ADD.L	D1,ENDADDR
	ADD.L	D1,ADDCURSPL
	
	MOVE.L	A3,A4
	MOVE.L	A3,D3
	SUB.L	A1,D3
	ADD.L	D1,A4
.TY	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.TY
	
	MOVE.L	D1,D0
	SUBQ.L	#1,D0
.YU	MOVE.B	#0,-(A4)
	SUBQ.L	#1,D0
	BNE.S	.YU

	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.UI	MOVE.L	(A0)+,A1
	ADD.L	D1,ADDCURTRACK(A1)
	DBF	D0,.UI
	
	MOVE.L	#0,MAXTEMP
	
	MOVE.W	maxpatt,D0
	MOVE.L  #screen+640*328+481,where
	BSR	pouet2
	
	BSR	FRE
	
.AA	CMP.W	#17,okp
	BNE.S	.BB
	MOVE.W	#0,okp
.BB	RTS
***************************************************************************
ADDMAXTRK100
	MOVE.L	#$100,D0
	BRA.S	AZ
ADDMAXTRK10
	MOVEQ	#$10,D0
	BRA.S	AZ
ADDMAXTRK1
	MOVEQ	#1,D0
	
AZ	MOVEQ	#0,D1
	MOVE.W	maxtrack,D1
	ADD.L	D0,D1
	CMP.L	#65535,D1
	BLE.S	.ZE
	MOVE.L	#65535,D1
.ZE	MOVE.L	D1,MAXTEMP
	MOVE.W	#16,okp
	RTS

ADDMAXTRK
	MOVEQ	#0,D0
	MOVE.W	maxtrack,D0
	MOVE.L	MAXTEMP,D1
	BEQ	.AA
	
	SUB.L	D0,D1
	MOVE.L	D1,D0
	MOVE.L	D1,D6
	MULU	#64*6+2,D1		* D1 = LEN OF TRACK ADDED
	MULU	#4,D6			* D6 = LEN OF TAB TRACK ADDED
	MOVE.L	D6,D2
	ADD.L	D1,D2			* D2 = TOTAL LEN (FOR MOVING SAMPLE)
	
	LEA	SAMPLE,A4
	MOVE.L	#254,D3
.ER	CMP.L	#0,LEN_MGT(A4)
	BEQ.S	.RT
	ADD.L	D2,DEB_MGT(A4)
	ADD.L	D2,FIN_MGT(A4)
	ADD.L	D2,LOOP_DEB_MGT(A4)
	ADD.L	D2,LOOP_FIN_MGT(A4)
.RT	ADD.W	#LEN_SAMPLE_MGT,A4
	DBF	D3,.ER
	
	MOVE.L	DEBTRACK,A1
	MOVE.L	DEBSPL,A2
	MOVE.L	ENDADDR,A3
	ADD.L	D6,DEBTRACK
	ADD.L	D2,DEBSPL
	ADD.L	D2,ENDADDR
	ADD.L	D2,ADDCURSPL
	
	MOVE.L	A3,A4
	MOVE.L	A3,D3
	SUB.L	A2,D3
	ADD.L	D2,A4
.TY	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.TY
	
	MOVE.L	A2,A4
	MOVE.L	A2,D3
	SUB.L	A1,D3
	ADD.L	D6,A4
.QS	MOVE.B	-(A3),-(A4)
	SUBQ.L	#1,D3
	BNE.S	.QS
	
	MOVE.L	DEBSPL,A2
	SUB.L	D1,A2
	MOVEQ	#0,D4
	MOVE.L	D0,D5
	SUBQ.L	#1,D5
.UI	MOVEQ	#63,D3
	MOVE.W	#64,(A2)+
.YU	MOVE.L	D4,(A2)+
	MOVE.W	D4,(A2)+
	DBF	D3,.YU
	DBF	D5,.UI
	
	MOVE.L	DEBTABTRACK,A0
	MOVE.W	maxtrack,D3
	ADD.W	D0,maxtrack
	SUBQ.W	#1,D3
.IO	ADD.L	D6,(A0)+
	DBF	D3,.IO
	MOVE.L	-(A0),A1
.OP	MOVE.L	A1,(A0)+
	ADD.W	#64*6+2,A1
	DBF	D0,.OP
	
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.PQ	MOVE.L	(A0)+,A1
	ADD.L	D6,ADDCURTRACK(A1)
	DBF	D0,.PQ
	
	MOVE.L	#0,MAXTEMP
	
	MOVE.W	maxtrack,D0
	MOVE.L  #screen+640*336+481,where
	BSR	pouet2
	
	BSR	FRE
	
.AA	CMP.W	#16,okp
	BNE.S	.BB
	MOVE.W	#0,okp
.BB	RTS
MAXTEMP	DC.L	0
***************************************************************************
SCROLL_VOICE_RIGHT
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.L	(A0),1(A0)
	SUBQ.B	#1,(A0)
	CMP.B	#-1,(A0)
	BNE.S	.AA
	MOVE.B	#31,(A0)
.AA	BSR	AFFPATTERN
	RTS
	
SCROLL_VOICE_LEFT
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.L	1(A0),(A0)
	ADDQ.B	#1,4(A0)
	CMP.B	#32,4(A0)
	BNE.S	.AA
	MOVE.B	#0,4(A0)
.AA	BSR	AFFPATTERN
	RTS
***************************************************************************
FIND_CORRECT_BASE
	MOVE.L	ENDADDR,A0
	LEA	SAMPLE,A1
	MOVE.L	DEBTABTRACK,A3
	LEA	DIGINOTE1,A5
	ADDQ.W	#4,A3
	
	MOVE.L	#255,D0
.AA	MOVE.W	#0,(A0)+
	DBF	D0,.AA
	MOVE.L	ENDADDR,A0
	
	MOVEQ	#0,D0
	MOVE.L	DEBMUS,A5
	MOVE.B	I_TEMPO_MUS(A5),D0
	MOVE.W	(A2,D0.W*4),CUR_LEN_TEMPO
	
	MOVE.L	(A3)+,A4		* A4 = TRACK
	MOVE.W	(A4)+,D0		* D0 = LEN TRACK
	
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	MOVEQ	#0,D4
	MOVEQ	#0,D7
	MOVE.B	(A4),D1			* D1 = NOTE
	MOVE.B	1(A4),D2		* D2 = INSTR
	MULU	#LEN_SAMPLE_MGT,D2
	LEA	(A4,D2.W),A6
	MOVE.B	F_TUNE_MGT(A6),D3
	LEA	TABLE_DIGINOTE,A2
	MOVE.L	(A2,D3.W*4),A2
	MOVE.W	(A2,D1.W*2),D1		* D1 = PERIODE
	MOVE.W	BASE_SPL(A6),D4
	MULU.L	D4,D7:D6
	MOVE.L	#49169,D4
	DIVU.L	D4,D7:D6		* D6 = D1 = PERIODE
	
	
	
CUR_LEN_TEMPO	DC.W	0	
***************************************************************************
SILENT:
	MOVEM.L	D0-A0,-(A7)
	MOVE.B	#0,KEY
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata

	LEA	VOICE0,a0
	BSR	CLEAR1
	LEA	VOICE1,a0
	BSR	CLEAR1
	LEA	VOICE2,a0
	BSR	CLEAR1
	LEA	VOICE3,a0
	BSR	CLEAR1
	LEA	VOICE4,a0
	BSR	CLEAR1
	LEA	VOICE5,a0
	BSR	CLEAR1
	LEA	VOICE6,a0
	BSR	CLEAR1
	LEA	VOICE7,a0
	BSR	CLEAR1
	LEA	VOICE8,a0
	BSR	CLEAR1
	LEA	VOICE9,a0
	BSR	CLEAR1
	LEA	VOICE10,a0
	BSR	CLEAR1
	LEA	VOICE11,a0
	BSR	CLEAR1
	LEA	VOICE12,a0
	BSR	CLEAR1
	LEA	VOICE13,a0
	BSR	CLEAR1
	LEA	VOICE14,a0
	BSR	CLEAR1
	LEA	VOICE15,a0
	BSR	CLEAR1
	LEA	VOICE16,a0
	BSR	CLEAR1
	LEA	VOICE17,a0
	BSR	CLEAR1
	LEA	VOICE18,a0
	BSR	CLEAR1
	LEA	VOICE19,a0
	BSR	CLEAR1
	LEA	VOICE20,a0
	BSR	CLEAR1
	LEA	VOICE21,a0
	BSR	CLEAR1
	LEA	VOICE22,a0
	BSR	CLEAR1
	LEA	VOICE23,a0
	BSR	CLEAR1
	LEA	VOICE24,a0
	BSR	CLEAR1
	LEA	VOICE25,a0
	BSR	CLEAR1
	LEA	VOICE26,a0
	BSR	CLEAR1
	LEA	VOICE27,a0
	BSR	CLEAR1
	LEA	VOICE28,a0
	BSR	CLEAR1
	LEA	VOICE29,a0
	BSR	CLEAR1
	LEA	VOICE30,a0
	BSR	CLEAR1
	LEA	VOICE31,a0
	BSR	CLEAR1

	cmp.b	#1,playpat
	BNE.S	.rt6
	MOVE.B	#0,playpat
	BSR	INVERT_PLAYPATT
.rt6	cmp.b	#1,record
	BNE.S	.rt4
	MOVE.B	#0,record
	BSR	INVERT_RECORD
.rt4	cmp.b	#1,edit
	BNE.S	.rt2
	BSR	INVERT_EDIT
	MOVE.B	#0,edit
.rt2	cmp.b	#1,playsong
	BNE.S	.rt14
	MOVE.B	#0,playsong
	BSR	INVERT_PLAYSONG
.rt14	CMP.B	#-1,inpatt
	BNE.S	.RT15
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
.RT15	BSR.L	AFFPATTERN
	MOVEM.L	(A7)+,D0-A0
	RTS
dernier	dc.b	0
	even
CLEAR1	
	MOVE.W	#0,FREQUENCY(a0)
	MOVE.L	#0,SPL_POINTER(a0)
	MOVE.L	#0,LOOP_BEGIN(a0)
	MOVE.L	#0,LOOP_END(a0)
	MOVE.L	#0,WAVE_START(a0)
	MOVE.L	#0,SPL_BEGIN(a0)
	MOVE.B	#0,VOL1(a0)
	MOVE.W	#$400,PATT_VOL(a0)
	MOVE.B	#8,BITS(A0)
	RTS
************************************************************************
SPESPL	MOVE.B	#0,KEY
	MOVEQ	#0,d0
	MOVE.B	sampledata,d0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a1
	ADD.L	d0,a1
	CMP.L	#0,LEN_MGT(a1)
	beq.s	.pasdutout
	MOVE.L	a1,heretoconvert
	MOVE.W	#6,okp
.pasdutout
	RTS
heretoconvert
	dc.l	0
***************************************************************************
INVERT_4
	LEA	screen+640*80+8,A0
	MOVEQ	#23,D0
.AA	NOT.W	(A0)
	NOT.W	16(A0)
	NOT.W	32(A0)
	NOT.W	48(A0)
	NOT.W	64(A0)
	NOT.W	80(A0)
	NOT.W	96(A0)
	NOT.W	112(A0)
	LEA	640(A0),A0
	DBF	D0,.AA
	RTS
***************************************************************************
MASKMODULE
	CMP.L	#maskmod+2,MASKPOINTER
	BEQ	VOL_OK
	BSR	INVERT_4
	MOVE.L	#maskmod+2,MASKPOINTER	
	MOVE.W	#1,EH_NON			* PAS MULTIFILE
	BRA	PAS
	
MASKSAMPLE
	CMP.L	#maskspl+2,MASKPOINTER
	BEQ	VOL_OK
	BSR	INVERT_4
	MOVE.L	#maskspl+2,MASKPOINTER	
	MOVE.W	#0,EH_NON			* MULTIFILE
	
PAS	MOVE.W	#0,IN_MOD
	MOVE.W	#0,P_MOD
	*MOVE.W	#1,CHANGREP
	MOVE.W	#8,okp
	RTS

maskmod	dc.b 	'*.MOD',0
	dc.b 	'*.S3M',0
	dc.b	'*.MAD',0
	dc.b	'*.669',0
	dc.b	'*.MGT',0
	dc.b 	'*.MTM',-2

maskspl	dc.b 	'*.SPL',0
	dc.b	'*.AVR',0
	dc.b	'*.SAM',0
	dc.b	'*.MGS',0
	dc.b 	'*.SPE',-2
	dc.l	-1
**************************************************************************
SAUVEUR:				* oh! mon sauveur
	MOVE.W	#10,okp
	RTS
SAUVE
	LEA	DEFAULT,A0
	MOVE.L	A0,string
	MOVE.B	#8,maxlet
	MOVE.L	#0,(A0)
	MOVE.L	#0,4(A0)
	MOVE.L	#0,8(A0)
	MOVE.L	#0,12(A0)
	
sel	MOVEQ	#22,D1
	LEA	rrien,A0
	MOVE.L	#screen+640*17+145,where
	MOVE.W	#1,compt2
	BSR	PRINT

	MOVE.W	#1,compt
	MOVE.L	#screen+640*17+145,where2
	MOVE.B	#0,lastouche
	BSR	INPT

	CMP.W	#5,erreur
	BEQ	.je_veux_pas
	LEA	DEFAULT,A2
	MOVEQ	#7,D0
.AA	CMP.B	#".",(A2)
	BEQ.S	.POINT
	CMP.B	#0,(A2)
	BEQ.S	.POINT
	CMP.B	#" ",(A2)
	BEQ.S	.POINT
	ADDQ.W	#1,A2
	DBF	D0,.AA

.POINT	MOVE.L	MASKPOINTER,A0
	LEA	maskmod+2,a1
	CMP.L	A0,A1
	BEQ.S	.MOD
	MOVE.L	#".MGS",(A2)		* SAMPLE
	BRA.S	.BB	
.MOD	MOVE.L	#".MGT",(A2)		* MODULE
	
.BB	LEA	PATH,A0
	LEA	AFFICHAGE,A1
	LEA	DEFAULT,A2
.tt2	CMP.B	#0,(A0)
	BEQ.S	.tt1
	MOVE.B	(A0)+,(A1)+
	BRA.S	.tt2
.tt1	CMP.B	#'\',-(A1)
	BNE.S	.tt1
	ADDQ.W	#1,A1
	
	MOVE.L	(a2)+,(a1)+
	MOVE.L	(a2)+,(a1)+
	MOVE.L	(a2)+,(a1)+
	MOVE.L	(a2)+,(a1)+
	MOVE.B	#0,(a1)+
	
	MOVE.L	MASKPOINTER,A0
	LEA	maskmod+2,a1
	CMP.L	A0,A1
	BEQ	.L1
	BSR	SAVE_SAMPLE
	BRA	.je_veux_pas
.L1	BSR	SAVE_MODULE

.je_veux_pas
	MOVE.W	#0,okp
	MOVE.W	#0,erreur
	RTS
rrien	dc.b	'                      '
***************************************************************************	
LOADER:	MOVE.W	#9,okp
	RTS
LOADE
	LEA	AFFICHAGE,A0
	MOVEQ	#1,D1
	MOVE.L	#screen+119*640+64+1,where
	MOVE.W	#1,compt2
	BSR	PRINT

	
	LEA	DIR_FILES,A0
.OUI	CMP.B	#'*',(A0)
	BEQ	.NON
	CMP.B	#0,(A0)
	BEQ	ALL_FOLKS	
	CMP.B	#$21,(A0)
	BNE	.NON
	
	MOVE.B	#$20,(A0)
	LEA	PATH+3,A1
	
	LEA	AFFICHAGE+3,A2
	MOVEQ	#64+8,D0
.CLEAN5	MOVE.B	#0,(A2)+
	DBF	D0,.CLEAN5
	LEA	AFFICHAGE+3,A2
.OUPS	TST.B	(A1)
	BEQ.S	.FOLL
	MOVE.B	(A1)+,(A2)+
	BRA.S	.OUPS
.FOLL	LEA	-3(A2),A2
	MOVE.B	2(A0),(A2)+
	MOVE.B	3(A0),(A2)+
	MOVE.B	4(A0),(A2)+
	MOVE.B	5(A0),(A2)+
	MOVE.B	6(A0),(A2)+
	MOVE.B	7(A0),(A2)+
	MOVE.B	8(A0),(A2)+
	MOVE.B	9(A0),(A2)+
	MOVE.B	10(A0),(A2)+
	MOVE.B	11(A0),(A2)+
	MOVE.B	12(A0),(A2)+
	MOVE.B	13(A0),(A2)+
	MOVE.B	14(A0),(A2)+
	LEA	FILE_LOADED,A3
.ML	CMP.B	#'\',(A2)
	BEQ.S	.NO_EXT
	CMP.B	#'.',(A2)
	BEQ.S	.RIGHT
	LEA	-1(A2),A2
	BRA.S	.ML
.RIGHT	MOVE.B	#'*',(A3)+
	MOVE.B	(A2)+,(A3)+
	MOVE.B	(A2)+,(A3)+
	MOVE.B	(A2)+,(A3)+
	MOVE.B	(A2)+,(A3)+
	BRA.S	.ON_CHARGE
.NO_EXT	MOVE.B	#'*',(A3)+
	MOVE.B	#'.',(A3)+
	MOVE.B	#'B',(A3)+
	MOVE.B	#'O',(A3)+
	MOVE.B	#'F',(A3)+
.ON_CHARGE
	MOVEM.L	D0-D7/A0-A6,-(A7)
	LEA	AFFICHAGE+3,A0
	MOVEQ	#22,D1
	MOVE.L	#screen+640*17+144,where
	MOVE.W	#0,compt
	MOVE.W	#0,compt2
	BSR	PRINT
	BSR.S	CHARGE
	MOVEM.L	(A7)+,D0-D7/A0-A6
	CMP.W	#2,erreur
	BEQ.S	ALL_FOLKS
	CMP.B	#3,curentmask
	BEQ.S	ALL_FOLKS
.NON	LEA	18(A0),A0
	BRA	.OUI

CHARGE	MOVE.L	MASKPOINTER,A0
	LEA	maskmod+2,a1
	CMP.L	A0,A1
	BEQ	.L1
	BSR	LOAD_SAMPLE
	BRA	.L2
.L1	BSR	LOAD_MODULE

.L2	CMP.W	#0,erreur
	BNE.S	.pascharge
	MOVEQ	#0,D0
	MOVE.B	D0,sampledata
	LEA	SAMPLE,a0
        BSR.L	SUM
        BSR	FRE
.pascharge
	MOVE.B	sampledata,dernier
	RTS
	
ALL_FOLKS
	LEA	FILES_TO_SORT,A0
	MOVEQ	#18,D0
.CLEAN6	BCLR.B	#0,(A0)
	LEA	18(A0),A0
	DBF	D0,.CLEAN6
	JSR	AFF_FS
	
	MOVE.L	#screen+640*32+432,where
	MOVE.W	#0,compt2
	MOVE.L	DEBMUS,A0
	LEA	NAME_MUS(A0),A0
	MOVEQ	#20,D1
	BSR	PRINT
	
	MOVE.W	#0,erreur
	MOVE.B	#0,touche
	MOVE.W	#0,okp
	RTS				* Fin
***************************************************************************
LOAD_SAMPLE:
l_spl:	ADDQ.B	#1,totalsample
	cmp.b	#254,totalsample
	beq	toomuch
	LEA	AFFICHAGE,a0
	BSR	LOAD
	BSR	SEARCHFREESPL
	MOVE.L	a1,a2
	MOVE.W	#$400,VOL_MGT(a1)
	MOVE.L	ENDADDR,DEB_MGT(a1)
	MOVE.L	ENDADDR,LOOP_DEB_MGT(a1)
	MOVE.L	long,d0
	subq.l	#8,d0
	bclr	#0,d0			* Adresse paire
	MOVE.L	d0,LEN_MGT(a1)		* LENGHT
	ADD.l	d0,ENDADDR		* END in memory
	MOVE.L	ENDADDR,FIN_MGT(a1)	* END
	ADD.l	#FINSAMPLE,d0
	ADD.l	#FINSAMPLE,ENDADDR
	MOVE.L	d0,long			* pour la fin du sample
	ADD.l	d0,lensamples
*	MOVE.B	setloadfrq,MONO_MGT(a1)	* Set Default Frequency
	BCLR.B	#1,BIT1_MGT+1(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	BSR	SPLTOSPE		* Convertit le spl au ste
	BSR	ZEROFINSPL		* Rajoute 1024 octets nuls
	RTS

l_sam:	ADDQ.b	#1,totalsample
	cmp.b	#254,totalsample
	beq	toomuch
	LEA	AFFICHAGE,a0
	BSR	LOAD
	BSR	SEARCHFREESPL
	MOVE.L	a1,a2
	BCLR.B	#1,BIT1_MGT+1(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	MOVE.W	#$400,VOL_MGT(a1)
	MOVE.L	ENDADDR,DEB_MGT(a1)
	MOVE.L	ENDADDR,LOOP_DEB_MGT(a1)
	MOVE.L	long,d0
	SUB.L	#12,d0
	MOVE.L	ENDADDR,a0
	LEA	12(a0),a2
	MOVE.L	d0,d1
.ccc1	MOVE.B	(a2)+,(a0)+
	subq.l	#1,d1
	BNE.S	.ccc1
	MOVE.L	d0,LEN_MGT(a1)
	ADD.l	#FINSAMPLE,d0
	MOVE.L	d0,long
	ADD.l	d0,ENDADDR
	MOVE.L	ENDADDR,FIN_MGT(a1)
	SUB.L	#FINSAMPLE,FIN_MGT(a1)
	BSR	ZEROFINSPL
	RTS
	
l_spe	ADDQ.b	#1,totalsample
	cmp.b	#254,totalsample
	beq	toomuch
	LEA	AFFICHAGE,a0
	BSR	LOAD
	MOVE.L	ENDADDR,a0
	BSR	SEARCHFREESPL
	ADDQ.l	#4,a0
	MOVE.L	a1,a2
	MOVE.L	a1,a4
	
	MOVE.L	#LEN_SAMPLE_MGT-1,D0
.ICI	MOVE.B	(a0)+,(a2)+
	DBF	D0,.ICI
	
	MOVE.L	ENDADDR,d0
	MOVE.L	d0,a0
	MOVE.L	d0,a3
	ADD.l	d0,DEB_MGT(a1)
	ADD.l   d0,FIN_MGT(a1)
	ADD.l	d0,LOOP_DEB_MGT(a1)
	ADD.l	d0,LOOP_FIN_MGT(a1)
	MOVE.L	LEN_MGT(a1),d0
	ADD.l	#FINSAMPLE,d0
	MOVE.L	d0,long
	ADD.l	d0,ENDADDR		*Ou se chargera le prochain sample
	ADD.l	d0,lensamples
	MOVE.L	LEN_MGT(a1),a1		*a1 = longeur
	LEA	LEN_SAMPLE_MGT(a3),a2	*a2 = debut du sample
					*a0 = debut memoire
.conti	MOVE.B	(a2)+,(a0)+		
	subq.l	#1,a1			* et on recopie le sample 40 octets
	BNE.S	.conti			* en arriere
	MOVE.L	a4,a1
	BSR	ZEROFINSPL
	RTS
	
l_bnk	RTS
toomuch	MOVE.W	#2,erreur
	RTS
***************************************************************************
l_avr:	ADDQ.B	#1,totalsample
	CMP.B	#254,totalsample
	BEQ	toomuch
	
	LEA	AFFICHAGE,a0
	BSR	LOAD
	
	MOVE.L	ENDADDR,a0
	BSR	SEARCHFREESPL
	
	MOVE.L	a1,a2
	MOVE.L	a1,a4
	MOVE.W	#$400,VOL_MGT(a1)
	MOVE.L	4(a0),(a1)		* ecrit le nom de 8 lettres
	MOVE.L	8(a0),4(a1)
	MOVE.L	#0,8(A1)
	MOVE.L	#0,12(A1)
	MOVE.L	#0,16(A1)
	MOVE.W	#0,20(A1)
	
	CMP.W	#0,12(a0)
	BNE.S	stereo
	BCLR.B	#1,BIT1_MGT+1(A1)
	BRA.S	mono
stereo	BSET.B	#1,BIT1_MGT+1(A1)
mono	CMP.W	#8,14(a0)		* sample  8 bits ?
	BEQ.S	bit8
	CMP.W	#16,14(a0)		* sample 16 bits ?
	BEQ.S	bit16
	
	LEA	128(a0),a2		* sinon  12 bits
	MOVE.L	long,d0			
	SUB.L	#128,d0
cvert1	MOVE.B	(a2),d1
	LSR.B	#2,d1			* convertit 12 bits to 8 bits
	MOVE.B d1,(a2)+
	SUBQ.L	#1,d0
	BNE.S	cvert1
	BRA.S	bit8
	BRA	signe
*--------------------------------------------------------------------------	
bit16	BSET.B	#0,BIT1_MGT+1(A1)
	
	CMP.W	#-1,16(A0)
	BEQ.S	signe
	
	LEA	128(A0),A2		
	MOVE.L	long,D0
	SUB.L	#128,D0
	MOVE.W	#$8000,D1
	
cvert2	ADD.W	D1,(A2)+
	SUBQ.L	#1,D0
	BNE.S	cvert2
	BRA	signe
*--------------------------------------------------------------------------	
bit8	BCLR.B	#0,BIT1_MGT+1(A1)
	
	CMP.W	#-1,16(A0)
	BEQ.S	signe
	
	LEA	128(A0),A2
	MOVE.L	long,D0
	SUB.L	#128,D0
	MOVE.B	#$80,D1
	
cvert3	ADD.B	D1,(A2)+		* convertit non signe to signe
	SUBQ.L	#1,D0
	BNE.S	cvert3
	
*--------------------------------------------------------------------------	
signe	BCLR.B	#2,BIT1_MGT+1(a1)
	CMP.W	#0,18(A0)
	BEQ.S	noloop
	BSET.B	#2,BIT1_MGT+1(a1)
	MOVE.L	30(a0),d1
	CMP.W	#-1,12(a0)		* loop point
	BNE.S	c_stereo
	ADD.L	D1,D1
c_stereo
	MOVE.L	d1,LOOP_DEB_MGT(a1)	
	MOVE.L	ENDADDR,d1
	ADD.L	d1,LOOP_DEB_MGT(a1)
	MOVE.L	ENDADDR,36(a0)
noloop	MOVE.L	ENDADDR,DEB_MGT(a1)
	MOVE.L	long,LEN_MGT(a1)
	SUB.L	#128,LEN_MGT(a1)
	MOVE.L	LEN_MGT(a1),d1
	ADD.L	DEB_MGT(a1),d1
	MOVE.L	d1,FIN_MGT(a1)
	
	MOVE.L	ENDADDR,a0		* Et on deplace le tout
	MOVE.L	LEN_MGT(a1),d0		* 128 octets en arriere
	LEA	128(A0),A1
	
copii	MOVE.B	(a1)+,(a0)+
	SUBQ.L	#1,D0
	BNE.S	copii
	
	MOVE.L	a4,a1
	BSR	ZEROFINSPL
	MOVE.L	long,d1
	ADD.L	#FINSAMPLE-128,d1
	ADD.L	d1,ENDADDR
	ADD.L	d1,lensamples
	BCLR.B	#0,ENDADDR+3
	BCLR.B	#0,lensamples+3
	RTS
***************************************************************************
LOAD_MODULE:
l_s3m	LEA	AFFICHAGE,A0
	BSR	LOAD
	BSR	OFF_134
	BSR	INITMEG

	MOVE.L	A0,A1
	MOVEQ	#64,D0
.AA	CMP.L	#"SCRM",(A1)
	BEQ.S	.S3M
	ADDQ.W	#1,A1
	DBF	D0,.AA
	BRA	l_mod
	

.S3M	BSR	DEPLACE_MOD
	BSR	INIT_S3M
	BSR	DATAPATT_S3M
	BSR	DATASAMPLE_S3M
	BSR	REINIT_MTM
	RTS

*--------------------------------------------------------------------------
INIT_S3M
	MOVE.B	#1,maxmus
	MOVE.B	#0,curmus
	MOVEQ	#0,D0
	MOVE.B	$21(A0),D0		* ORDNUM
	LSL.L	#8,D0
	MOVE.B	$20(A0),D0
	SUBQ.W	#1,D0
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	LEA	$60(A0),A1
	MOVE.L	DEBMUS,DEBSEQ
	ADD.L	#TOTAL_MUS,DEBSEQ
	MOVE.L	DEBSEQ,A2
.LL	MOVE.B	(A1)+,D1
	CMP.B	#255,D1
	BEQ.S	.SKIP2
	CMP.B	#254,D1
	BEQ.S	.SKIP
	MOVE.W	D1,(A2)+		* sequence des patterns
	CMP.B	D3,D1
	BLE.S	.AA
	MOVE.W	D1,D3
	BRA.S	.AA
.SKIP	MOVE.W	#0,(A2)+
	BRA.S	.AA
.SKIP2	MOVE.W	#-1,(A2)+
.AA	ADDQ.W	#1,D2
	DBF	D0,.LL
.END	MOVE.L	DEBMUS,A1
	MOVE.L	DEBSEQ,ADDDEB_MUS(A1)
	MOVE.W	D2,LEN_MUS(A1)
	MOVE.W	D2,curlen
	MOVE.W	D2,maxpos
	MOVE.W	#0,curlop
	MOVE.W	#0,curpos
	MOVE.W	#0,RESTART_MUS(A1)
	MOVE.B	$31(A0),I_SPEED_MUS(A1)
	MOVE.B	$32(A0),I_TEMPO_MUS(A1)
	
	LEA	I_VOL_MUS(A1),A6
	MOVE.L	A0,A2
	LEA	NAME_MUS(A1),A5
	MOVEQ	#27,D0
.COPO	MOVE.B	(A2)+,(A5)+
	DBF	D0,.COPO
	MOVE.L	#0,(A5)+
	
	ADD.W	#TOTAL_MUS,A1
	MOVE.L	A1,ADDCURSEQ
	LEA	(A1,D2.W*2),A1
	MOVE.L	A1,DEBPATT
	
	ADDQ.W	#1,D3
	MOVE.W	D3,maxpatt
	MULU.L	#32*2+2,D3
	MOVE.L	DEBPATT,A1
	ADD.L	D3,A1
	MOVE.L	A1,DEBTABTRACK

	LEA	$40(A0),A5		* CHANNELS SETTING
	LEA	PILEVOIE,A2
	LEA	VOICE_TAB1,A4
	MOVEQ	#31,D0
	MOVEQ	#0,D6
S3M_CHANNEL_LOOP
	MOVE.L	(A2)+,A3
	MOVEQ	#0,D1
	MOVE.B	(A5)+,D1
	BTST	#8,D1
	BNE.S	CHANNEL_DISABLED
	AND.B	#$7F,D1
	CMP.B	#16,D1
	BHI.S	CHANNEL_DISABLED
	MOVE.W	D6,D2
	ADDQ.W	#1,D6
	MOVE.W	#$FF00,D3
	CMP.B	#8,D1
	BLT.S	S3M_OK
	MOVE.W	#$00FF,D3
S3M_OK	MOVE.W	D3,(A6)+
	MOVE.W	D3,LEFT_VOL(A3)
	MOVE.B	#1,KIND_VOICE(A3)
	MOVE.B	#1,(A4)+
	BRA.S	FINCH
CHANNEL_DISABLED
	MOVE.W	#0,(A6)+
	MOVE.W	#0,LEFT_VOL(A3)
	MOVE.B	#0,KIND_VOICE(A3)
	MOVE.B	#0,(A4)+
FINCH	DBF	D0,S3M_CHANNEL_LOOP
	
	MOVE.B	D6,digvoices
	CMP.B	#8,D6
	BLE.S	.HH
	MOVE.B	#8,D6
.HH	MOVE.B	D6,NBVF

	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVE.B	digvoices,D0
	MOVE.W	maxpatt,D2
	MULU	D0,D2
	ADDQ.W	#1,D2
	MOVE.W	D2,maxtrack
	LEA	(A1,D2.L*4),A1
	MOVE.L	A1,DEBTRACK
	
	MOVE.L	A1,A2
	MOVE.W	#64,(A2)+
	MOVEQ	#63,D3
.WW	MOVE.L	#0,(A2)+
	MOVE.W	#0,(A2)+
	DBF	D3,.WW
	
	MULU	#6*64+2,D2
	ADD.L	D2,A1
	MOVE.L	A1,DEBSPL
	MOVE.L	A1,ENDADDR
	
	MOVE.L	ADDCURSEQ,A2
	MOVEQ	#0,D3
	MOVE.B	(A2),D3
	MULU	#6*64+2,D3
	MOVE.L	DEBPATT,A2
	ADD.L	D3,A2
	MOVE.L	A2,ADDCURPATT
	
	MOVEQ	#0,D0
	MOVE.B	$31(A0),D0
	MOVE.W	D0,SPEED	
	MOVE.B	$32(A0),D0
	BSR	SET_T2
	
	RTS
*--------------------------------------------------------------------------
DATAPATT_S3M
	BSR	REINIT_TAB_TRACK
	MOVEM.L	RIEN,D1-D3
	MOVE.L	DEBPATT,A1
	MOVEQ	#1,D0
	MOVE.W	maxpatt,D1
	SUBQ.W	#1,D1
	MOVE.B	digvoices,D2
	MOVEQ	#32,D4
	SUB.W	D2,D4
	
.RR	MOVE.W	#64,(A1)+
	
.ZZ	MOVE.W	D0,(A1)+
	ADDQ.W	#1,D0
	ADDQ.W	#1,D3
	CMP.W	D2,D3
	BNE.S	.ZZ
	MOVEQ	#0,D3
.EE	MOVE.W	#0,(A1)+
	ADDQ.W	#1,D3
	CMP.W	D4,D3
	BNE.S	.EE
	MOVEQ	#0,D3
	DBF	D1,.RR

	MOVE.W	maxtrack,D1
	SUBQ.W	#1,D1
	MOVE.L	DEBTRACK,A1
.CC	MOVE.W	#64,(A1)+
	MOVEQ	#64-1,D0
	MOVEQ	#0,D2
.XX	MOVE.L	#0,(A1)+
	MOVE.W	#0,(A1)+
	DBF	D0,.XX
	DBF	D1,.CC


	MOVE.W	#0,ROW
	MOVE.W	#0,J
	
	LEA	BUFMOD,A5
	LEA	$60(A5),A1
	MOVEQ	#0,D0
	MOVE.B	$21(A5),D0
	LSL.L	#8,D0
	MOVE.B	$20(A5),D0		* D0 = ORDNUM
	ADD.W	D0,A1
	MOVE.B	$23(A5),D0
	LSL.L	#8,D0
	MOVE.B	$22(A5),D0		* D0 = INSNUM * 2
	LEA	(A1,D0.L*2),A1		* A1 = PARAPOINTER TO PATTERNS
	
	MOVE.L	DEBTRACK,A4
	LEA	64*6+2+2(A4),A4
	
L6	MOVEQ	#0,D1
	MOVE.B	1(A1),D1
	LSL.L	#8,D1
	MOVE.B	(A1),D1
	MULU	#16,D1	
	LEA	2(A0,D1.L),A3		* A3 = PATTERN S3M
	
	MOVE.L	A4,A2

L4	MOVEM.L	RIEN,D2-D7
	
	MOVE.B	(A3)+,D2
	BEQ	NEW_ROW
	MOVE.B	D2,D3
	AND.B	#$1F,D3			* D3 = # OF VOICE
	MULU	#64*6+2,D3

	BTST	#5,D2			* NOTE ?
	BEQ	L1
	
	MOVE.B	(A3)+,D5
	BMI.S	NO_NOTE
	MOVE.B	D5,D6
	AND.B	#$F,D5
	LSR.B	#4,D6
	MULU	#12,D6
	ADD.B	D6,D5
	ADDQ.B	#1,D5
	MOVE.B	D5,(A2,D3.W)		* NOTE
NO_NOTE	MOVE.B	(A3)+,1(A2,D3.W)	* INSTR
	
	
L1	BTST	#6,D2
	BEQ.S	.L2
	MOVE.B	(A3)+,5(A2,D3.W)	* VOLUME
	ADD.B	#$10,5(A2,D3.W)
	
.L2	BTST	#7,D2
	BEQ.S	L4
	MOVEQ	#0,D5
	MOVE.B	(A3)+,D5		* COMMAND + PARAMETER
	AND.B	#$1F,D5
	BEQ.S	.NO_EFF
	SUBQ.B	#1,D5
	JSR	([TABLE_S3M_EFFECT,D5.W*4])
	BRA.S	L4
.NO_EFF	MOVE.B	(A3)+,D5
	BRA.S	L4

NEW_ROW ADDQ.W	#6,A2
	ADDQ.W	#1,ROW
	CMP.W	#64,ROW
	BEQ.S	NEW_PATT
	BRA	L4
	
NEW_PATT
	MOVE.W	#0,ROW
	ADDQ.W	#2,A1
	MOVEQ	#0,D0
	MOVE.B	digvoices,D0
	MULU	#64*6+2,D0
	ADD.W	D0,A4
	ADDQ.W	#1,J
	MOVE.W	J,D0
	CMP.W	maxpatt,D0
	BNE	L6

	MOVE.L	A3,RAW_SAMPLE_DATA
	RTS
*--------------------------------------------------------------------------
DATASAMPLE_S3M
	LEA	BUFMOD,A3
	LEA	$60(A3),A2
	MOVEQ	#0,D0
	MOVE.B	$21(A3),D0
	LSL.L	#8,D0
	MOVE.B	$20(A3),D0
	ADD.W	D0,A2			* A2 = PARAPOINTER SAMPLE
	
	MOVEQ	#0,D0
	MOVE.B	$23(A3),D0		* D0 = # OF SAMPLE
	LSL.L	#8,D0
	MOVE.B	$22(A3),D0
	SUBQ.W	#1,D0
	LEA	SAMPLE,A1
	MOVE.L	#0,lensamples
	MOVE.B	#0,totalsample
	MOVEQ	#0,D7
	MOVE.L	DEBSPL,D5
	
.PP	MOVEQ	#0,D1
	MOVE.B	1(A2),D1
	LSL.L	#8,D1
	MOVE.B	(A2),D1
	MULU	#16,D1
	CMP.L	#8000-128,D1
	BGT.S	.SDF
	LEA	(A3,D1.L),A6		* A6 = INSTRUMENT S3M
	BRA.S	.FDS
	
.SDF	LEA	(A0,D1.L),A6
.FDS	MOVE.L	$30(A6),(A1)
	MOVE.L	$34(A6),4(A1)
	MOVE.L	$38(A6),8(A1)
	MOVE.L	$3C(A6),12(A1)
	MOVE.L	$40(A6),16(A1)
	MOVE.L	$44(A6),20(A1)
	MOVE.L	$48(A6),24(A1)
	MOVE.L	#0,28(A1)
	CMP.B	#1,(A6)
	BNE	.FINT
	
	MOVEQ	#0,D1
	MOVE.B	$13(A6),D1
	LSL.L	#8,D1
	MOVE.B	$12(A6),D1
	LSL.L	#8,D1
	MOVE.B	$11(A6),D1
	LSL.L	#8,D1
	MOVE.B	$10(A6),D1
	CMP.L	#0,D1				* D1 = LEN SAMPLE
	BEQ	.FINT
	ADDQ.B	#1,totalsample
	
	MOVEQ	#0,D2
	MOVE.B	$17(A6),D2
	LSL.L	#8,D2
	MOVE.B	$16(A6),D2
	LSL.L	#8,D2
	MOVE.B	$15(A6),D2
	LSL.L	#8,D2
	MOVE.B	$14(A6),D2			* D2 = LOOP BEG
	
	MOVEQ	#0,D3
	MOVE.B	$1B(A6),D3
	LSL.L	#8,D3
	MOVE.B	$1A(A6),D3
	LSL.L	#8,D3
	MOVE.B	$19(A6),D3
	LSL.L	#8,D3
	MOVE.B	$18(A6),D3			* D3 = LOOP END
	
	MOVE.L	D3,D4
	CMP.L	#2,D4
	BGT.S	.WW
	MOVE.L	D1,D4
	
.WW	CMP.L	D2,D3
	BNE.S	.XX
	MOVE.L	#0,D2
	
.XX	MOVE.L	D7,DEB_MGT(A1)	
	MOVE.L	D7,FIN_MGT(A1)	
	MOVE.L	D7,LOOP_DEB_MGT(A1)
	MOVE.L	D7,LOOP_FIN_MGT(A1)
	
	ADD.L	D5,DEB_MGT(A1)
	ADD.L	D5,FIN_MGT(A1)
	ADD.L	D5,LOOP_DEB_MGT(A1)
	ADD.L	D5,LOOP_FIN_MGT(A1)
	
	ADD.L	D1,FIN_MGT(A1)
	MOVE.L  D1,LEN_MGT(A1)
	
	ADD.L	D2,LOOP_DEB_MGT(A1)
	ADD.L	D4,LOOP_FIN_MGT(A1)
	
	BTST.B	#0,$1F(A6)
	BNE.S	.NOLOP1
	MOVE.L	DEB_MGT(A1),LOOP_DEB_MGT(A1)
	MOVE.L	FIN_MGT(A1),LOOP_FIN_MGT(A1)

.NOLOP1	MOVE.L	FIN_MGT(A1),D4
	SUB.L	LOOP_FIN_MGT(A1),D4
	MOVE.L	D4,LEN_FIN_MGT(A1)
	
	MOVE.L	DEB_MGT(A1),A4
	MOVEQ	#0,D6
	MOVE.B	$D(A6),D6
	LSL.L	#8,D6
	MOVE.B	$F(A6),D6
	LSL.L	#8,D6
	MOVE.B	$E(A6),D6
	LSL.L	#4,D6
	LEA	(A0,D6.L),A5
	MOVE.L	D1,D4
	
.UU	CMP.L	$42E.W,A5
	BGE.S	.VV
	MOVE.B	(A5)+,D6
	ADD.B	#$80,D6
	MOVE.B	D6,(A4)+
	SUBQ.L	#1,D4
	BNE.S	.UU
	
.VV	MOVE.W	#FINSAMPLE,LEN_BUF_MGT(A1)
	
	BTST.B	#0,$1F(A6)
	BNE.S	.LLOOPP
	BCLR.B	#2,BIT1_MGT+1(A1)
	BSR	ZEROFINSPL
	BRA.S	.MLML
	
.LLOOPP	BSET.B	#2,BIT1_MGT+1(A1)
	BSR	BCLFINSPL
	
.MLML	ADD.L	#FINSAMPLE,D1
	ADD.L	#FINSAMPLE,FIN_MGT(A1)
	ADD.L	D1,lensamples
	ADD.L	D1,D7
	
	MOVE.B	#0,F_TUNE_MGT(A1)
	MOVEQ	#0,D6
	MOVE.B	$1C(A6),D6
	LSL.W	#4,D6
	MOVE.W	D6,VOL_MGT(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	
	MOVE.B	$21(A6),BASE_MGT(A1)
	MOVE.B	$20(A6),BASE_MGT+1(A1)
	
	MOVE.B	#0,COMMAND_MGT(A1)
	MOVE.W	#0,PARAM_MGT(A1)
	
	BTST.B	#2,$1F(A6)
	BEQ.S	.MTM_8
	
	BSET.B	#0,BIT1_MGT+1(A1)
	BRA.S	.FINT
	
.MTM_8	BCLR.B	#0,BIT1_MGT+1(A1)
	
.FINT	ADDQ.W	#2,A2
	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,.PP
	
	MOVE.L	A4,ENDADDR
	ADD.L	#FINSAMPLE,ENDADDR
	RTS
*--------------------------------------------------------------------------
TABLE_S3M_EFFECT
	DC.L	S3M_SET_SPEED,S3M_POS_JUMP,S3M_PATT_BREAK,S3M_VOL_SLIDE
	DC.L	S3M_PORT_DOWN,S3M_PORT_UP,S3M_TONE_PORT,S3M_VIBRATO
	DC.L	S3M_TREMOR,S3M_ARPEGGIO,S3M_VIB_VOL_SLID,S3M_TONE_VOL_SLID
	DC.L	S3M_RTS,S3M_RTS,S3M_SAMPLE_OFFSET,S3M_RTS,S3M_RETRIG_VOL_SLID
	DC.L	S3M_TREMOLO,S3M_E_COMMAND,S3M_SET_TEMPO
	DC.L	S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS
	DC.L	S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS
	DC.L	S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS,S3M_RTS
	
S3M_SET_SPEED
	MOVE.B	#$F,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_POS_JUMP	
	MOVE.B	#$B,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_PATT_BREAK
	MOVE.B	#$D,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	MOVE.B	D5,D6
	LSR.B	#4,D6
	MULU	#10,D6
	AND.W	#$F,D5
	ADD.B	D6,D5
	MOVE.B	D5,4(A2,D3.W)
	RTS

S3M_VOL_SLIDE
	MOVE.B	(A3),D5
	AND.B	#$F0,D5
	CMP.B	#$F0,D5
	BEQ.S	S3M_FINE_VOL_DOWN
	MOVE.B	(A3),D5
	AND.B	#$F,D5
	CMP.B	#$F,D5
	BEQ.S	S3M_FINE_VOL_UP
	MOVE.B	#$A,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	LSR.B	#4,D5
	BEQ.S	S3M_VOL_DOWN
	AND.W	#$F,D5
	LSL.W	#8,D5
	MOVE.W	D5,3(A2,D3.W)
	RTS
S3M_VOL_DOWN
	MOVE.B	-1(A3),D5
	AND.W	#$F,D5	
	MOVE.W	D5,3(A2,D3.W)
	RTS
S3M_FINE_VOL_DOWN
	MOVE.B	#$1B,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	AND.B	#$F,D5
	MOVE.B	D5,4(A2,D3.W)
	RTS
S3M_FINE_VOL_UP
	MOVE.B	#$1A,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	LSR.B	#4,D5
	MOVE.B	D5,4(A2,D3.W)
	RTS
	
S3M_PORT_DOWN
	MOVE.B	(A3),D5
	AND.B	#$F0,D5
	CMP.B	#$F0,D5
	BEQ.S	S3M_FINE_PORT_DOWN
	CMP.B	#$E0,D5
	BEQ.S	S3M_EXTRA_FINE_PORT_DOWN
	MOVE.B	#2,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
S3M_FINE_PORT_DOWN
	MOVE.B	#$12,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	AND.B	#$F,D5
	MOVE.B	D5,4(A2,D3.W)
	RTS
S3M_EXTRA_FINE_PORT_DOWN
	MOVE.B	(A3)+,D5
	RTS
	
S3M_PORT_UP
	MOVE.B	(A3),D5
	AND.B	#$F0,D5
	CMP.B	#$F0,D5
	BEQ.S	S3M_FINE_PORT_UP
	CMP.B	#$E0,D5
	BEQ.S	S3M_EXTRA_FINE_PORT_UP
	MOVE.B	#2,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
S3M_FINE_PORT_UP
	MOVE.B	#$12,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,D5
	AND.B	#$F,D5
	MOVE.B	D5,4(A2,D3.W)
	RTS
S3M_EXTRA_FINE_PORT_UP
	MOVE.B	(A3)+,D5
	RTS
	
S3M_TONE_PORT
	MOVE.B	#$3,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_VIBRATO
	MOVE.B	#$4,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_TREMOR
	MOVE.B	(A3)+,D5
	RTS
	
S3M_ARPEGGIO
	MOVE.B	#0,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS

S3M_VIB_VOL_SLID
	MOVE.B	#6,2(A2,D3.W)
	MOVE.B	(A3)+,D5
	LSR.B	#4,D5
	BEQ.S	S3M_VOL_DOWN1
	AND.W	#$F,D5
	LSL.W	#8,D5
	MOVE.W	D5,3(A2,D3.W)
	RTS
S3M_VOL_DOWN1
	MOVE.B	-1(A3),D5
	AND.W	#$F,D5	
	MOVE.W	D5,3(A2,D3.W)
	RTS

S3M_TONE_VOL_SLID
	MOVE.B	#5,2(A2,D3.W)
	MOVE.B	(A3)+,D5
	LSR.B	#4,D5
	BEQ.S	S3M_VOL_DOWN2
	AND.W	#$F,D5
	LSL.W	#8,D5
	MOVE.W	D5,3(A2,D3.W)
	RTS
S3M_VOL_DOWN2
	MOVE.B	-1(A3),D5
	AND.W	#$F,D5	
	MOVE.W	D5,3(A2,D3.W)
	RTS
	
S3M_SAMPLE_OFFSET
	MOVE.B	#9,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_RETRIG_VOL_SLID
	MOVE.B	(A3)+,D5
	RTS
	
S3M_TREMOLO
	MOVE.B	#7,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	(A3)+,4(A2,D3.W)
	RTS
	
S3M_E_COMMAND
	MOVE.B	(A3)+,D5
	MOVE.B	D5,D6
	AND.B	#$F,D6
	LSL.B	#4,D5
	CMP.B	#1,D5
	BNE.S	.E2
	MOVE.B	#$13,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.E2	CMP.B	#2,D5
	BNE.S	.E3	
	RTS
.E3	CMP.B	#3,D5
	BNE.S	.E4
	MOVE.B	#$14,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.E4	CMP.B	#4,D5
	BNE.S	.E8
	MOVE.B	#$17,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.E8	CMP.B	#8,D5
	BNE.S	.EB
	MOVE.B	#$18,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.EB	CMP.B	#$B,D5
	BNE.S	.EC
	MOVE.B	#$16,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.EC	CMP.B	#$C,D5
	BNE.S	.ED
	MOVE.B	#$1C,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.ED	CMP.B	#$D,D5
	BNE.S	.EE
	MOVE.B	#$1D,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.EE	CMP.B	#$E,D5
	BNE.S	.EF
	MOVE.B	#$1E,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
.EF	MOVE.B	#$1F,2(A2,D3.W)
	MOVE.B	#0,3(A2,D3.W)
	MOVE.B	D6,4(A2,D3.W)
	RTS
	
S3M_SET_TEMPO
	MOVE.B	#$F,2(A2,D3.W)
	MOVE.B	(A3)+,3(A2,D3.W)
	MOVE.B	#0,4(A2,D3.W)
	RTS
	BRA	S3M_SET_SPEED
	
S3M_RTS
	MOVE.B	(A3)+,D5
	RTS
***************************************************************************
ROW		DC.W	0
J		DC.W	0
***************************************************************************	
l_mod:	MOVE.L	ENDADDR,A0
	CMP.W	#'if',(A0)
	BNE	NOT_MOD_669
*--------------------------------------------------------------------------
	LEA	PILEVOIE,A0
	MOVEQ	#31,D0
.QQ	MOVE.L	(A0)+,A1
	MOVE.B	#0,KIND_VOICE(A1)
	DBF	D0,.QQ
*--------------------------------------------------------------------------
	MOVE.L	long,d0
	BCLR	#0,D0
	MOVE.L	$42E.W,A1
	MOVE.L	ENDADDR,A0
	MOVE.L	a1,a2
	ADD.l	d0,a0
	SUB.L	d0,a2
.reco16	MOVE.L	-(a0),-(a1)
	MOVE.L	-(a0),-(a1)
	subq.l	#8,d0
	bpl.s	.reco16
	MOVE.L	A2,A6
*--------------------------------------------------------------------------
	LEA	BUFMOD,A1
	LEA	$1F1(A2),A0
	MOVEQ	#0,D0
	MOVE.B	$6E(A2),D0
	MULU	#$19,D0
	SUBQ.W	#1,D0
.SS	MOVE.B	(A0)+,(A1)+
	DBF	D0,.SS
*--------------------------------------------------------------------------
	MOVE.B	#9,digvoices
	MOVE.B	#8,NBVF
	MOVE.B	#1,maxmus
	MOVE.B	#0,curmus
	MOVE.L	DEBMUS,A4
	MOVE.L	A4,ADDDEB_MUS(A4)
	ADD.L	#TOTAL_MUS,ADDDEB_MUS(A4)
	MOVEQ	#0,D0
	MOVE.B	$6F(A6),D0
	MOVE.W	D0,LEN_MUS(A4)
	ADDQ.B	#1,D0
	MOVE.W	D0,maxpos
	MOVE.W	#0,curpos
	MOVE.W	D0,curlen
	MOVE.B	$70(A1),D0
	MOVE.W	D0,RESTART_MUS(A4)
	MOVE.W	D0,curlop
	MOVE.B	#6,I_SPEED_MUS(A4)
	MOVEQ	#$50,D0
	MOVE.B	D0,I_TEMPO_MUS(A4)
	BSR	SET_T2
	MOVE.W	#$2020,I_MASTERVOL_MUS(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+32(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+36(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+40(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+44(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+48(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+52(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+56(A4)
	MOVE.L	#$FF0000FF,I_VOL_MUS+60(A4)
	
	ADD.W	#TOTAL_MUS,A4
	MOVE.L	A4,DEBSEQ
	MOVE.L	A4,ADDCURSEQ
	
*--------------------------------------------------------------------------
	LEA	$71(A6),A2
	MOVE.L	DEBSEQ,A3
	MOVEQ	#127,D0
	MOVEQ	#0,D1
.RECO24	MOVE.B	(A2)+,D1
	CMP.B	#$FF,D1
	BEQ.S	.CONT3
	MOVE.W	D1,(A3)+
	DBF	D0,.RECO24
.CONT3	
	MOVE.L	A3,DEBPATT
	MOVEQ	#0,D0
	MOVE.B	$6F(A6),D0
	*SUBQ.B	#1,D0
	MOVE.W	D0,maxpatt
	MOVE.L	D0,D1
	MULU	#32*2+2,D0
	ADD.L	D0,A3
	MOVE.L	A3,DEBTABTRACK
	MULU	#9,D1
	MOVE.W	D1,maxtrack
	MULU	#4,D1
	ADD.L	D1,A3
	MOVE.L	A3,DEBTRACK

	BSR	REINIT_TAB_TRACK
	MOVEM.L	RIEN,D1-D3
	MOVE.L	DEBPATT,A1
	MOVEQ	#1,D0
	MOVE.W	maxpatt,D1
	SUBQ.W	#1,D1
	MOVE.B	digvoices,D2
	MOVEQ	#32,D4
	SUB.W	D2,D4
	
.RR	MOVE.W	#64,(A1)+
	
.ZZ	MOVE.W	D0,(A1)+
	ADDQ.W	#1,D0
	ADDQ.W	#1,D3
	CMP.W	D2,D3
	BNE.S	.ZZ
	MOVEQ	#0,D3
.EE	MOVE.W	#0,(A1)+
	ADDQ.W	#1,D3
	CMP.W	D4,D3
	BNE.S	.EE
	MOVEQ	#0,D3
	DBF	D1,.RR

	MOVE.L	DEBTRACK,A2
	LEA	TABLE_669_EFFECT,A3
	LEA	$f1(A6),A4
	MOVEQ	#63,D7
	MOVE.W	#64,(A2)+
.DD	MOVE.L	#0,(A2)+
	MOVE.W	#0,(A2)+
	DBF	D7,.DD

	MOVE.W	maxpatt,D0
	SUBQ.W	#1,D0
	
.RECO19	MOVE.L	A0,A5
	MOVEQ	#7,D4
	
.RECO22	MOVE.L	#63,D5
	MOVE.W	#64,(A2)+

.RECO21	MOVE.B	(A5)+,D1
	MOVE.B	D1,D2
	CMP.B	#$FF,D1			* NO NOTE   NO VOLUME
	BNE.S	.GF3
	MOVE.W	#0,(A2)
	MOVE.B	#0,5(A2)
	MOVE.B	(A5)+,D3
	BRA.S	.FF
	
.GF3	CMP.B	#$FE,D1			* NO NOTE   BUT VOLUME
	BNE.S	.GF5
	MOVE.W	#0,(A2)
	MOVE.B	(A5)+,D3
	BRA.S	.FE
	
	MOVEQ	#-1,D2
.GF5	LSR.B	#2,D1
	CMP.B	#0,D1
	BEQ.S	.dd
	ADD.B	#25,D1
.dd	MOVE.B	D1,(A2)			* NOTE
	AND.B	#3,D2
	LSL.B	#4,D2

	MOVE.B	(A5)+,D1
	MOVE.B	D1,D3
	LSR.B	#4,D1
	ADD.B	D2,D1
	CMP.B	#63,D1
	BNE.S	.GF4
	MOVEQ.B	#-1,D1
.GF4	ADDQ.B	#1,D1
	MOVE.B	D1,1(A2)		* INSTRU
.FE	AND.B	#$F,D3
	LSL.B	#2,D3
	
	CMP.B	#0,D3			* SET VOLUME A ZERO
	BNE.S	.LL
	MOVE.B	#$C,2(A2)
	MOVE.W	#0,3(A2)
	BRA.S	.FF
	
.LL	CMP.B	#$3C,D3
	BNE.S	.HH
	MOVE.B	#-$10,D3
.HH	ADD.B	#$10,D3
	MOVE.B	D3,5(A2)		* VOLUME


.FF	MOVEQ	#0,D1
	MOVE.B	(A5)+,D1
	CMP.B	#$FF,D1
	BNE.S	.GG
	MOVE.W	#0,2(A2)
	MOVE.B	#0,4(A2)
	BRA.S	.JJ
.GG	MOVE.B	D1,D2
	LSR.B	#4,D1
	CMP.B	#$F,D1
	BNE.S	.GF1
	MOVEQ	#6,D1			* = NO COM
.GF1	MOVE.B	(A3,D1.W),2(A2)		* COMMAND
	AND.B	#$F,D2
	CMP.B	#$F,D2
	BNE.S	.GF2
	MOVEQ	#0,D2
.GF2	MOVE.B	#0,3(A2)
	MOVE.B	D2,4(A2)		* PARAMETRE
	
.JJ	ADDQ.W	#6,A2
	ADD.W	#3*7,A5
	DBF	D5,.RECO21	* Boucle la 1ere piste
	
	ADDQ.W	#3,A0
	MOVE.L	A0,A5
	DBF	D4,.RECO22	* Boucle les 7 autres pistes
	
	MOVEQ	#62,D7			* 1 VOIE LIBRE POUR LE TEMPO ET 
	MOVE.W	#64,(A2)+		* ET LE BREAK
	
	MOVE.W	#0,(A2)+
	MOVE.W	#$0F00,(A2)+		* TEMPO
	MOVE.B	(A4)+,(A2)+
	MOVE.B	#0,(A2)+
	
.KK	MOVE.L	#0,(A2)+
	MOVE.W	#0,(A2)+
	DBF	D7,.KK
	
	ADD.W	#3*8*63,A0
	MOVE.L	A0,A5
	DBF	D0,.RECO19	* Boucle les patternes
	MOVE.L	A2,DEBSPL
*--------------------------------------------------------------------------
	MOVEQ	#0,D0
	MOVEQ	#0,D7
	MOVE.L	A2,D5
	MOVE.B	$6E(A6),D0
	SUBQ.B	#1,D0
	LEA	SAMPLE,A1
	LEA	BUFMOD,A2
	MOVE.L	A0,A3
	MOVE.L	DEBSPL,D5
SPL_669
	MOVE.L	(A2),(A1)		* NAME SAMPLE
	MOVE.L	4(A2),4(A1)
	MOVE.L	8(A2),8(A1)
	MOVE.B	12(A2),12(A1)
	MOVE.B	#0,13(A1)
	MOVE.L	#0,14(A1)
	MOVE.L	#0,18(A1)
	MOVE.L	#0,22(A1)
	MOVE.L	#0,26(A1)
	MOVE.L	#0,30(A1)
	MOVE.W	#0,32(A1)

	MOVE.B	16(A2),D1
	LSL.L	#8,D1
	MOVE.B	15(A2),D1
	LSL.L	#8,D1
	MOVE.B	14(A2),D1
	LSL.L	#8,D1
	MOVE.B	13(A2),D1		* D1 = SAMPLE LENGHT
	CMP.W	#0,D1
	BEQ	FIN_669

	MOVE.B	20(A2),D2
	LSL.L	#8,D2
	MOVE.B	19(A2),D2
	LSL.L	#8,D2
	MOVE.B	18(A2),D2
	LSL.L	#8,D2
	MOVE.B	17(A2),D2		* D2 = LOOP_DEB
	
	MOVE.B	24(A2),D3
	LSL.L	#8,D3
	MOVE.B	23(A2),D3
	LSL.L	#8,D3
	MOVE.B	22(A2),D3
	LSL.L	#8,D3
	MOVE.B	21(A2),D3		* D3 = LOOP END

	MOVE.L	D3,D4			* D4 = REAL LOOP END
	CMP.L	#2,D4
	BGT.S	.WW
	MOVE.L	D1,D4
	MOVE.L	#0,D3
	
.WW	CMP.L	D1,D2
	BLE.S	.SS
	MOVEQ	#0,D2
.SS	CMP.L	D1,D3
	BLE.S	.DD
	MOVEQ	#0,D3
.DD	CMP.L	D1,D4
	BLE.S	.FF
	MOVE.L	D1,D4
	
.FF	MOVE.L	D7,DEB_MGT(A1)	
	MOVE.L	D7,FIN_MGT(A1)	
	MOVE.L	D7,LOOP_DEB_MGT(A1)
	MOVE.L	D7,LOOP_FIN_MGT(A1)
	ADD.L	D5,DEB_MGT(A1)
	ADD.L	D5,FIN_MGT(A1)
	ADD.L	D5,LOOP_DEB_MGT(A1)
	ADD.L	D5,LOOP_FIN_MGT(A1)
	
	ADD.L	D4,FIN_MGT(A1)
	MOVE.L  D4,LEN_MGT(A1)
	ADD.L	D2,LOOP_DEB_MGT(A1)
	ADD.L	D4,LOOP_FIN_MGT(A1)
	
	CMP.L	#$0,D3			*D2
	BNE.S	.NOLOP2
	MOVE.L	DEB_MGT(A1),LOOP_DEB_MGT(A1)
	MOVE.L	FIN_MGT(A1),LOOP_FIN_MGT(A1)
	
.NOLOP2	MOVE.L	FIN_MGT(A1),D4
	SUB.L	LOOP_FIN_MGT(A1),D4
	MOVE.L	D4,LEN_FIN_MGT(A1)
	
	MOVE.L	DEB_MGT(A1),A4
	MOVE.L	D1,D4
	MOVE.L	A3,A5
	MOVE.L	D4,-(A7)
	
.UU	CMP.L	$42E.W,A5
	BGE.S	.UV
	MOVE.B	(A5)+,D6
	ADD.B	#$80,D6
	MOVE.B	D6,(A4)+
	SUBQ.L	#1,D4
	BNE.S	.UU
	
.UV	MOVE.L	(A7)+,D4
	ADD.L	D2,LOOP_DEB_MGT(A1)
	MOVE.W	#FINSAMPLE,LEN_BUF_MGT(A1)
	
	CMP.L	#0,D2
	BNE.S	.LLOOPP
	
	BCLR.B	#2,BIT1_MGT+1(A1)
	BSR	FIRST_ZEROFINSPL
	BRA.S	.MLML
	
.LLOOPP	BSET.B	#2,BIT1_MGT+1(A1)
	BSR	FIRST_BCLFINSPL
	
.MLML	MOVE.B	#0,F_TUNE_MGT(A1)
	MOVE.W	#$400,VOL_MGT(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	MOVE.B	#0,COMMAND_MGT(A1)
	MOVE.W	#0,PARAM_MGT(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.W	#8363,BASE_MGT(A1)
	ADD.L	D4,lensamples
	ADD.L	#FINSAMPLE,D4
	ADD.L	D4,D7
	
FIN_669	ADD.L	D1,A3
	LEA	$19(A2),A2
	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,SPL_669
	
	MOVE.L	A4,ENDADDR
	ADD.L	#FINSAMPLE,ENDADDR
	
*--------------------------------------------------------------------------
	BSR	AFF_EMPTY_PATT
	MOVEQ	#8,D1
	MOVEQ	#22,D2
	
	LEA	PILEVOIE,A1
	LEA	VOICE_TAB1,A2
.ZZ	MOVE.L	(A1)+,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#1,(A2)+
	DBF	D1,.ZZ
	
.EE	MOVE.L	(A1)+,A0
	MOVE.B	#0,KIND_VOICE(A0)
	MOVE.B	#0,(A2)+
	DBF	D2,.EE
	
	BSR	SET_ON
	BSR	SET_VS
	
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.L	ADDCURSEQ,A3
	MOVE.W	(A3),D3
	MOVE.W	D3,curpatt
	BSR	PATT_TRACK
	BSR	AFFSONG
	BSR	NB_VOICE_FRQ
	BSR	AFFPATTERN3
	RTS
TABLE_669_EFFECT	DC.B	1,2,3,$11,4,$F,0,0,0,0,0,0,0,0,0,0
***************************************************************************
OFF_134B:
	MOVE.W	#3,okp
	RTS
***************************************************************************
OFF_134:
	MOVE.B	#1,ASK_OFF
.WAIT1	CMP.B	#2,ASK_OFF
	BNE.S	.WAIT1
	BSR	SILENT
	MOVE.B	#0,ASK_OFF
	CMP.W	#3,okp
	BNE.S	.DD
	MOVE.W	#0,okp
.DD	RTS
ASK_OFF	DC.W	0	
***************************************************************************
NOT_MOD_669

	IFNE	DEMO
	
	BRA	NOT_MOD_MCS
	
	ELSEIF
	
	MOVE.L	S_ENTETE(A0),D0
	MOVE.B	#' ',D0
	CMP.L	#'MGT ',D0
	BNE	NOT_MOD_MCS
	CMP.L	#'½MCS',S_ENTETE+4(A0)
	BNE	NOT_MOD_MCS
	
	BSR	DEPLACE
	BSR	LOAD_ENTETE
	BSR	LOAD_MUS
	BSR	LOAD_SEQ
	BSR	LOAD_PATT
	BSR	LOAD_TRACK
	BSR	LOAD_SPLDATA
	BSR	LOAD_SPL
	BSR	REINIT_MTM
	RTS
	
	ENDC
*--------------------------------------------------------------------------	
DEPLACE:
	MOVE.L	long,D0
	BCLR	#0,D0
	MOVE.L	$42E.W,A1
	SUB.L	#50,A1
	MOVE.L	A1,A2
	MOVE.L	ENDADDR,A0
	ADD.L	D0,A0
	SUB.L	D0,A2
.reco14	MOVE.L	-(A0),-(A1)
	MOVE.L	-(A0),-(A1)
	SUBQ.L	#8,D0
	BPL.S	.reco14
	MOVE.L	A2,A0
	RTS
*--------------------------------------------------------------------------
LOAD_ENTETE
	MOVE.B	S_NBVOICE+1(A0),digvoices
	MOVE.B	S_NBMUS+1(A0),maxmus
	MOVE.W	S_NBSEQ(A0),maxpos
	MOVE.W	S_NBPATT(A0),maxpatt
	MOVE.W	S_NBTRK(A0),maxtrack
	MOVE.B	S_NBSPL+1(A0),totalsample
	
	MOVEQ	#0,D0
	MOVE.B	digvoices,D0
	CMP.B	#8,D0
	BLE.S	.HH
	MOVE.B	#8,D0
.HH	MOVE.B	D0,NBVF
	
	MOVEQ	#0,D0
	MOVE.W	S_NBMUS(A0),D0
	MULU	#TOTAL_MUS,D0
	MOVE.L	DEBMUS,A1
	ADD.L	D0,A1
	MOVE.L	A1,DEBSEQ
	MOVE.L	A1,ADDCURSEQ
	
	MOVEQ	#0,D0
	MOVE.W	S_NBSEQ(A0),D0
	LSL.L	#1,D0
	ADD.L	D0,A1
	MOVE.L	A1,DEBPATT
	
	MOVEQ	#0,D0
	MOVE.W	S_NBPATT(A0),D0
	MULU	#66,D0
	ADD.L	D0,A1
	MOVE.L	A1,DEBTABTRACK
	
	MOVEQ	#0,D0
	MOVE.W	S_NBTRK(A0),D0
	LSL.W	#2,D0
	ADD.L	D0,A1
	MOVE.L	A1,DEBTRACK
	ADD.L	S_LEN_DEPACKED_TRACKS(A0),A1
	MOVE.L	A1,DEBSPL
	
	ADD.L	S_LENSPL(A0),A1
	MOVE.L	A1,ENDADDR
	RTS
*--------------------------------------------------------------------------
LOAD_MUS
	MOVEQ	#0,D0	
	MOVEQ	#0,D1
	MOVE.B	maxmus,D0
	MOVE.L	DEBMUS,A1
	MOVE.L	A0,A2
	ADD.L	S_DEBMUS(A0),A2
	
.EE	MOVE.L	#I_VOL_MUS,D2
	SUB.L	#NAME_MUS,D2
.AA	MOVE.B	(A2)+,(A1)+
	SUBQ.W	#1,D2
	BNE.S	.AA

	MOVE.L	A1,A3
	MOVEQ	#15,D1
.GG	MOVE.L	#$FF0000FF,(A3)+
	DBF	D1,.GG
	
	MOVEQ	#0,D1
	MOVE.B	digvoices,D1
.BB	MOVE.W	(A2)+,(A1)+
	SUBQ.W	#1,D1
	BNE.S	.BB
	
*	MOVEQ	#32,D1
*	SUB.B	digvoices,D1
*	LEA	(A1,D1.W*2),A1
*	
*	MOVEQ	#31,D1
*.DD	MOVE.B	(A2)+,(A1)+
*	DBF	D1,.DD
	
	SUBQ.W	#1,D0
	BNE.S	.EE
	
	MOVE.B	maxmus,D0
	MOVE.L	DEBMUS,A1
	MOVE.L	DEBSEQ,D1
.FF	MOVE.L	D1,ADDDEB_MUS(A1)
	MOVEQ	#0,D2
	MOVE.W	LEN_MUS(A1),D2
	ADD.L	D2,D2
	ADD.L	D2,D1
	ADD.W	#TOTAL_MUS,A1
	SUBQ.B	#1,D0
	BNE.S	.FF
	
	MOVE.L	DEBMUS,A1
	MOVE.W	LEN_MUS(A1),curlen
	MOVEQ	#0,D0
	MOVE.B	I_SPEED_MUS(A1),D0
	MOVE.W	D0,SPEED
	MOVE.B	I_TEMPO_MUS(A1),D0
	BSR	SET_T2

	RTS
*--------------------------------------------------------------------------
LOAD_SEQ
	MOVEQ	#0,D0
	MOVE.W	S_NBSEQ(A0),D0
	MOVE.L	DEBSEQ,A1
	MOVE.L	A0,A2
	ADD.L	S_DEBSEQ(A0),A2
.AA	MOVE.W	(A2)+,(A1)+
	SUBQ.W	#1,D0
	BNE.S	.AA
	RTS
*--------------------------------------------------------------------------
LOAD_PATT
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#32,D2
	MOVE.W	S_NBPATT(A0),D0
	MOVE.W	S_NBVOICE(A0),D1
	SUB.W	D1,D2
	MOVE.L	A0,A1
	ADD.L	S_DEBPATT(A0),A1
	MOVE.L	DEBPATT,A2
	
.CC	MOVE.W	(A1)+,(A2)+
	MOVE.L	D1,D3
.AA	MOVE.W	(A1)+,(A2)+
	SUBQ.W	#1,D3
	BNE.S	.AA
	MOVE.L	D2,D3
.BB	MOVE.W	#0,(A2)+
	SUBQ.W	#1,D3
	BNE.S	.BB
	SUBQ.L	#1,D0
	BNE.S	.CC
	
	RTS
*--------------------------------------------------------------------------
LOAD_TRACK
	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVE.W	S_NBTRK(A0),D0
	MOVE.L	D0,D7
	MOVE.L	A0,A1
	ADD.L	S_DEBTABTRACK(A0),A1
	LEA	(A1,D0.W*4),A1
	MOVE.L	DEBTRACK,A2
	
.CC	MOVE.W	(A1)+,D1
	MOVE.W	D1,(A2)+
	*SUBQ.W	#1,D1
	MOVE.L	#0,(A2)
	MOVE.W	#0,4(A2)
	
.BB	MOVE.B	(A1)+,D2
	BTST	#2,D2
	BEQ.S	.Z1
	MOVE.B	(A1)+,(A2)
.Z1	BTST	#3,D2
	BEQ.S	.Z2
	MOVE.B	(A1)+,1(A2)
.Z2	BTST	#4,D2
	BEQ.S	.Z3
	MOVE.B	(A1)+,5(A2)
.Z3	BTST	#5,D2
	BEQ.S	.Z4
	MOVE.B	(A1)+,2(A2)
.Z4	BTST	#6,D2
	BEQ.S	.Z5
	MOVE.B	(A1)+,3(A2)
.Z5	BTST	#7,D2
	BEQ.S	.Z6	
	MOVE.B	(A1)+,4(A2)
.Z6	AND.W	#3,D2
.FF	ADDQ.W	#6,A2
	MOVE.L	#0,(A2)
	MOVE.W	#0,4(A2)
	SUBQ.W	#1,D1
	BEQ.S	.EE
	DBF	D2,.FF
	BRA.S	.BB
	
.EE	SUBQ.W	#1,D0
	BNE.S	.CC
	
	MOVE.L	DEBTABTRACK,A1
	MOVE.L	DEBTRACK,A2
.DD	MOVE.L	A2,(A1)+
	MOVEQ	#0,D6
	MOVE.W	(A2),D6
	MULU	#6,D6
	ADDQ.L	#2,D6
	ADD.L	D6,A2
	SUBQ.W	#1,D7
	BNE.S	.DD
	RTS
*--------------------------------------------------------------------------
LOAD_SPLDATA
	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVEQ	#0,D6
	MOVE.W	S_NBSPL(A0),D0
	MOVE.L	D0,D7
	MOVE.L	A0,A1
	ADD.L	S_DEBSPLDATA(A0),A1
	LEA	SAMPLE,A2
	MOVE.L	#255*LEN_SAMPLE_MGT-1,D1
.AA	MOVE.B	D2,(A2)+
	DBF	D1,.AA
	
	LEA	SAMPLE,A2
.XX	MOVE.L	#LEN_SAMPLE_MGT-4,D3
.BB	MOVE.B	(A1)+,(A2)+
	SUBQ.L	#1,D3
	BNE.S	.BB
	MOVE.L	#0,(A2)+
	SUBQ.L	#1,D0
	BNE.S	.XX
	
	LEA	SAMPLE,A2
	MOVE.L	S_DEBSPL(A0),D1
	MOVE.L	DEBSPL,D2
.CC	CMP.L	#0,LEN_MGT(A2)
	BEQ.S	.ZS	
	SUB.L	D1,DEB_MGT(A2)
	SUB.L	D1,LOOP_DEB_MGT(A2)
	ADD.L	D2,DEB_MGT(A2)
	ADD.L	D2,LOOP_DEB_MGT(A2)
	MOVE.L	LOOP_DEB_MGT(A2),D5
	ADD.L	D5,LOOP_FIN_MGT(A2) 	      *CONVERTI LONGUEUR EN ADRESSE
	MOVE.W	LEN_BUF_MGT(A2),D6
	
	MOVE.L	LOOP_FIN_MGT(A2),FIN_MGT(A2)  *RETROUVE L'ADD FIN_SPL
	ADD.L	D6,FIN_MGT(A2)
	MOVE.L	LEN_FIN_MGT(A2),D5
	ADD.L	D5,FIN_MGT(A2)
	
	ADD.L	D6,D2
.ZS	ADD.W	#LEN_SAMPLE_MGT,A2
	SUBQ.W	#1,D7
	BNE.S	.CC
	
	RTS
*--------------------------------------------------------------------------
LOAD_SPL
	MOVEQ	#0,D6
	MOVEQ	#0,D7
	MOVE.W	S_NBSPL(A0),D6
	MOVE.L	A0,A4
	ADD.L	S_DEBSPL(A0),A4
	MOVE.L	DEBSPL,A2
	LEA	SAMPLE,A1
	
.AA	MOVE.L	LEN_MGT(A1),D0
	BEQ.S	.NO
.BB	MOVE.B	(A4)+,(A2)+
	SUBQ.L	#1,D0
	BNE.S	.BB
	
	BTST.B	#2,BIT1_MGT+1(A1)
	BNE.S	.CC
	BSR	FIRST_ZEROFINSPL
	MOVE.W	LEN_BUF_MGT(A1),D7
	ADD.W	D7,A2
	ADD.L	D7,FIN_MGT(A1)
	BRA.S	.NO
	
.CC	BSR	FIRST_BCLFINSPL
	MOVE.W	LEN_BUF_MGT(A1),D7
	ADD.W	D7,A2
	ADD.L	D7,FIN_MGT(A1)
	
.NO	ADD.W	#LEN_SAMPLE_MGT,A1
	SUBQ.W	#1,D6
	BNE.S	.AA
	MOVE.L	A2,D6
	BCLR	#0,D6
	MOVE.L	D6,ENDADDR
	RTS
***************************************************************************	
SETT:	BSR	SILENT
	BSR.S	ADVICE
	RTS
	
STYL	MULU	#2,D0
	LEA	VTABLE(PC),A0
	ADD.W	D0,A0
	MOVE.L	A0,A3
	MOVE.L	where,a2
	MOVEQ	#2,D1
	MOVE.W	compt2,D2
	BSR	PRINT
	MOVE.L	A2,where
	ADDQ.L	#2,where
	MOVE.W	D2,compt2
	BSR	PRINT
	MOVE.L	A2,where
	SUBQ.L	#2,where
	MOVE.W	D2,compt2
	BSR	PRINT
	MOVE.L	A2,where
	SUBQ.L	#4,where
	MOVE.W	D2,compt2
	BSR	PRINT
	RTS
	
ADVICE	LEA	MUSIQUE,A0
	MOVEQ	#0,D0
	MOVE.B	D0,curmus
	MOVE.W	D0,curpos
	MOVE.W	(A0),curlen
	MOVE.W	2(A0),curlop
	MOVE.L	ADDCURSEQ,A0
	MOVE.W	(A0),curpatt
	
	MOVE.W	curpatt,D0
	MOVE.L  #screen+640*328+448,where
	BSR.S	pouet
	MOVE.W	curpos,d0
	MOVE.L  #screen+640*320+448,where
	BSR.S	pouet
	MOVE.B	curmus,d0
	MOVE.L  #screen+640*312+448,where
	BSR.S	pouet
	MOVE.W	curlen,d0
	MOVE.L  #screen+640*336+448,where
	BSR.S	pouet
	MOVE.W	curlop,d0
	MOVE.L  #screen+640*344+448,where
	BSR.S	pouet
	RTS
pouet	MOVE.W	#0,compt2
	BRA.S	SS
pouet2	MOVE.W	#1,compt2
SS	LEA	char3,A0
	BSR	CONVERT_WORD_TO_HEXA
	MOVEQ	#4,d1
	BSR	PRINT
	RTS
***************************************************************************	
NOT_MOD_MCS				* ALORS C'EST UN MODULE OKTALISER
	MOVE.L	ENDADDR,A1
	CMP.L	#'OKTA',(A1)
	BNE	NOT_OKT_MOD
	
	MOVE.L	long,D0
	BCLR	#0,D0
	MOVE.L	$42E.W,A0
	MOVE.L	a0,a2
	SUB.L	d0,a2
	ADD.L	D0,A1
.DEPL	MOVE.L	-(A1),-(A0)
	MOVE.L	-(A1),-(A0)
	SUBQ.L	#8,D0
	BPL.S	.DEPL
	MOVE.L	a2,a0
	MOVE.L	A0,A6
	BSR	ZEROVOICE
	
	MOVE.L	A6,A0
	ADD.W	#32,A0
	LEA	SAMPLE,A1
	MOVEQ	#35,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
.NEXT2	CMP.W	#0,22(A0)
	BEQ.S	.NXT
	MOVEQ	#0,D1
	MOVE.L	(A0),(A1)
	MOVE.L	4(A0),4(A1)
	MOVE.L	8(A0),8(A1)
	MOVE.L	12(A0),12(A1)
	MOVE.L	16(A0),16(A1)
	
	BCLR.B	#1,BIT1_MGT+1(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.W	#8363,BASE_MGT(A1)
	
	MOVE.W	22(A0),D1
	BCLR	#0,D1
	MOVE.L	D2,DEB_MGT(A1)		* DEB
	MOVE.L	D1,LEN_MGT(A1)		* LEN
	MOVE.L	D2,FIN_MGT(A1)
	ADD.L	D1,FIN_MGT(A1)		* END
	MOVE.L	22(A1),LOOP_DEB_MGT(A1)		* LOOP DEB
	MOVEQ	#0,D6
	MOVE.B	29(A0),D6
	LSL.W	#4,D6
	MOVE.W	D6,VOL_MGT(A1)		* VOLUME
	ADD.L	D1,D2
	ADD.L	#FINSAMPLE,D2
.NXT	LEA	32(A0),A0
	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,.NEXT2
	*MOVE.L	D2,lenspl
	
	MOVE.L	A6,A0
	ADD.L	#32+36*32,A0
	MOVE.W	#0,TICK
	MOVE.W	8(A0),SPEED
	MOVE.B	29(A0),MUSIQUE			* LEN  ZIC
	MOVE.B	#0,MUSIQUE+1			* LOOP ZIC
	MOVE.L	DEBSEQ,A1
	LEA	38(A0),A0			* SEQ PATT
	MOVEQ	#127,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
.DROM	MOVE.B	(A0),D1
	MOVE.B	(A0)+,(A1)+
	CMP.B	D2,D1
	BLE.S	.DREOM
	MOVE.B	D1,D2
.DREOM	DBF	D0,.DROM
	MOVE.B	D2,maxpatt
	MOVEQ	#0,D6
	MOVE.B	cvoies,D6
	MULU	D6,D2
	MULU	#64,D2
	MOVE.L	DEBPATT,A1
	ADD.L	D2,A1
	MOVE.L	A1,DEBSPL
	
	MOVE.L	A1,D1
	MOVEQ	#35,D0
	LEA	SAMPLE,A2
.SXC3	CMP.L	#0,LEN_MGT(A2)
	BEQ.S	.SXC4
	ADD.L	D1,DEB_MGT(A2)
	ADD.L	D1,FIN_MGT(A2)
	ADD.L	D1,LOOP_DEB_MGT(A2)
	ADD.L	D1,LOOP_FIN_MGT(A2)
.SXC4	ADD.W	#LEN_SAMPLE_MGT,A2
	DBF	D0,.SXC3
	
	MOVE.L	A6,A0
.CW2	CMP.L	#'PBOD',(A0)+
	BNE.S	.CW2
	MOVE.L	(A0)+,D1
	MOVE.W	(A0)+,D1
	MOVE.L	DEBPATT,a1
	MOVEQ	#0,d0
	MOVEQ	#0,d1
	MOVEQ	#0,d5
	LEA	TABLE_EFF_OKT,A2
	MOVE.B	#8-1,d0			* nb de voies utilisees
	MOVE.B	maxpatt,d1
	MOVE.L	#(32-8)*6,d2		* nb de voies restantes
	MOVE.L	d0,d3
	MOVEQ	#63,d4
	
.ecuiss	MOVE.L	a1,a4

	rept	32
	MOVE.L	d5,(a4)+
	MOVE.W	d5,(a4)+
	endr
	
.eortei	MOVEQ	#0,d5
	MOVEQ	#0,d6
	MOVE.B	(a0)+,(a1)+		* note
	BEQ.S	.RR
	ADD.B	#12,-1(A1)
.RR	MOVE.B	(a0)+,(a1)+		* instrument
	MOVEQ	#0,D5
	MOVE.B	(A0)+,D5		* commande
	MOVE.B	(A2,D5.W),(A1)+
	MOVE.B	#0,(A1)+
	MOVE.B	(A0)+,(A1)+		* parametre
	MOVE.B	#0,(A1)+
	dbf	d0,.eortei
	ADD.W	d2,a1
	MOVE.L	d3,d0
	dbf	d4,.ecuiss
	ADD.W	#10,a0
	MOVEQ	#63,d4
	dbf	d1,.ecuiss
	
.CW1	CMP.L	#'SBOD',(A6)+
	BNE.S	.CW1
	MOVE.L	(A6)+,D1
	
	MOVE.L	DEBSPL,A1
	LEA	SAMPLE,A2
	MOVEQ	#35,D0
.SXC	MOVE.L	26(A2),D2
	CMP.L	#0,D2
	BEQ.S	.NOLPS
.SXC2	MOVE.B	(A6)+,(A1)+
	SUBQ.L	#1,D2
	BNE.S	.SXC2
	MOVE.L	#FINSAMPLE-1,D2
.SXX	MOVE.B	#0,(A1)+
	DBF	D2,.SXX
	LEA	8(A6),A6
.NOLPS	LEA	LEN_SAMPLE_MGT(A2),A2
	DBF	D0,.SXC
	

REINIT8:
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVE.B	#8,digvoices
	MOVE.B	#8,NBVF
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.L	DEBSEQ,A3
	MOVE.L	DEBPATT,A2
	MOVE.B	(A3),D0
	MOVE.B	D0,curpatt
	MOVE.B	cvoies,D1
	MULU	D1,D0
	MULU	#64,D0
	ADD.L	D0,A2
	MOVE.L	A2,ADDCURPATT
	
	LEA	VOICE0,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE1,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE2,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE3,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE4,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE5,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE6,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	LEA	VOICE7,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#$80,31(A0)
	MOVE.B	#0,VOICE8+KIND_VOICE
	MOVE.B	#0,VOICE9+KIND_VOICE
	MOVE.B	#0,VOICE10+KIND_VOICE
	MOVE.B	#0,VOICE11+KIND_VOICE
	MOVE.B	#0,VOICE12+KIND_VOICE
	MOVE.B	#0,VOICE13+KIND_VOICE
	MOVE.B	#0,VOICE14+KIND_VOICE
	MOVE.B	#0,VOICE15+KIND_VOICE
	MOVE.B	#0,VOICE16+KIND_VOICE
	MOVE.B	#0,VOICE17+KIND_VOICE
	MOVE.B	#0,VOICE18+KIND_VOICE
	MOVE.B	#0,VOICE19+KIND_VOICE
	MOVE.B	#0,VOICE20+KIND_VOICE
	MOVE.B	#0,VOICE21+KIND_VOICE
	MOVE.B	#0,VOICE22+KIND_VOICE
	MOVE.B	#0,VOICE23+KIND_VOICE
	MOVE.B	#0,VOICE24+KIND_VOICE
	MOVE.B	#0,VOICE25+KIND_VOICE
	MOVE.B	#0,VOICE26+KIND_VOICE
	MOVE.B	#0,VOICE27+KIND_VOICE
	MOVE.B	#0,VOICE28+KIND_VOICE
	MOVE.B	#0,VOICE29+KIND_VOICE
	MOVE.B	#0,VOICE30+KIND_VOICE
	MOVE.B	#0,VOICE31+KIND_VOICE
	BSR	SET_ON
	
	MOVE.L	#$01010101,VOICE_TAB1
	MOVE.L	#$01010101,VOICE_TAB1+4
	MOVE.L	#$00000000,VOICE_TAB1+8
	MOVE.L	#$00000000,VOICE_TAB1+12
	MOVE.L	#$00000000,VOICE_TAB1+16
	MOVE.L	#$00000000,VOICE_TAB1+20
	MOVE.L	#$00000000,VOICE_TAB1+24
	MOVE.L	#$00000000,VOICE_TAB1+28
	BSR	SET_VS
	
	BSR	REINIT_PAN
	BSR	REINIT_TEMPO
	BSR	NB_VOICE_FRQ
	BSR	AFFPATTERN3
	RTS
	
TABLE_EFF_OKT		DC.B	0,0,0,0,0,0
			DC.B	0,0,0,0,0,0
			DC.B	0,0,0,0,0,0
			DC.B	0,0,0,0,0,0
			DC.B	0,$B,0,0,$F,0
			DC.B	0,0,0,0,0,0
***************************************************************************
NOT_OKT_MOD				* MADISON MODULE ?
	CMP.L	#'M.8.',(A1)
	BNE	NOT_MAD_MOD
	
	BSR	DEPLACE_MOD

	MOVE.L	#2048,D7
	MOVE.B	#8,digvoices
	MOVE.B	#8,NBVF
	ADDQ.W	#4,A6
	ADDQ.W	#4,A0
	BSR	DINS31			*INIT_MOD
	ADD.W	#$7E,A_MOD
	
	BSR	DATAPATT_MOD
	
	MOVE.L	DEBSPL,D5
	LEA	SAMPLE,A1
	LEA	BUFMOD+24,A2	
	ADD.L	#2048,FIRST_SPL
	BSR	DATASAMPLE_MOD		* DEP8	* DEPLACE SAMPLE
	BSR	REINIT_MOD
	RTS
***************************************************************************
NOT_MAD_MOD
	CMP.L	#'8CHN',$438(A1)	* 8 VOIES FAST TRACKER ?
	BEQ	CHN8_MOD
	CMP.L	#'FA08',$438(A1)
	BEQ	CHN8_MOD
	CMP.L	#'CD81',$438(A1)
	BEQ	CHN8_MOD
	BRA	NOT_8CHN_MOD
	
CHN8_MOD
	BSR	DEPLACE_MOD
	
	MOVE.L	#2048,D7
	MOVE.B	#8,digvoices
	MOVE.B	#8,NBVF
	BSR	DINS31			*INIT_MOD
	BSR	DATAPATT_MOD
	BSR	DATASAMPLE_MOD
	BSR	REINIT_MOD
	RTS
***************************************************************************
NOT_8CHN_MOD
	MOVE.L	(A1),D0
	MOVE.B	#' ',D0
	CMP.L	#'MTM ',D0
	BNE	NOT_MTM_MOD

	BSR	DEPLACE_MOD
	BSR	INIT_MTM
	BSR	DATAPATT_MTM
	BSR	DATASAMPLE_MTM
	BSR	REINIT_MTM
	RTS
	
PATTERN_ORDER_DATA	DC.L	0
TRACK_DATA		DC.L	0
TRACK_SEQUENCING_DATA	DC.L	0
EXTRA_COMMENT_FIELD	DC.L	0
RAW_SAMPLE_DATA		DC.L	0
*--------------------------------------------------------------------------
REINIT_MTM:
	BSR	AFF_EMPTY_PATT
	
	MOVEQ	#0,D0
	MOVE.B	digvoices,D0
	MOVE.L	D0,D1
	MOVE.L	D0,D2
	SUBQ	#1,D1
	SUB.W	#33,D2
	NOT.W	D2
	
	LEA	PILEVOIE,A1
	LEA	VOICE_TAB1,A2
.ZZ	MOVE.L	(A1)+,A0
	MOVE.B	#1,KIND_VOICE(A0)
	MOVE.B	#8,BITS(A0)
	MOVE.B	#1,(A2)+
	DBF	D1,.ZZ
	
.EE	MOVE.L	(A1)+,A0
	MOVE.B	#0,KIND_VOICE(A0)
	MOVE.B	#0,(A2)+
	DBF	D2,.EE
	BSR	SET_ON
	BSR	SET_VS

	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVEQ	#0,D3
	MOVE.L	ADDCURSEQ,A3
	MOVE.W	(A3),D3
	MOVE.W	D3,curpatt
	BSR	PATT_TRACK
	
	BSR	AFFSONG
	BSR	NB_VOICE_FRQ
	BSR	AFFPATTERN3
	RTS
*--------------------------------------------------------------------------
DATAPATT_MTM
	BSR	REINIT_TAB_TRACK
	MOVE.L	TRACK_SEQUENCING_DATA,A1
	MOVE.L	DEBPATT,A3
	MOVEQ	#0,D0
	MOVE.B	26(A0),D0		*  # OF PATTERNS
	
BCL2_MTM
	MOVEQ	#32-1,D7
	MOVE.W	#64,(A3)+
BCL1_MTM
	MOVEQ	#0,D1
	MOVE.B	1(A1),D1
	LSL.W	#8,D1
	MOVE.B	(A1),D1
	MOVE.W	D1,(A3)+
	ADDQ.W	#2,A1
	DBF	D7,BCL1_MTM
	DBF	D0,BCL2_MTM
	
	MOVE.L	TRACK_DATA,A2
	MOVE.L	DEBTRACK,A5
	MOVE.L	DEBTRACK,A6
	LEA	2+64*6(A6),A6		* 1ere PISTE VIDE
	
	MOVE.B	25(A0),D0
	LSL.W	#8,D0
	MOVE.B	24(A0),D0		* D0 = # OF TRACKS

	MOVE.L	D0,D1
	MULU.L	#(2+64*6)/4,D1
	MOVEQ	#0,D2
	MOVE.W	#64,(A5)+
.MM	MOVE.L	D2,(A5)+
	SUBQ.L	#1,D1
	BNE.S	.MM
	
.BCL3_MTM
	MOVEQ	#64-1,D1		* D1 = # OF ROWS
	MOVE.W	#64,(A6)+	
.BCL_MTM
	MOVEQ	#0,D3
	MOVEQ	#0,D4
	MOVE.L	#0,(A6)
	MOVE.W	#0,4(A6)
	MOVE.B	(A2),D3
	BEQ.S	.AA
	LSR.B	#2,D3			* NOTE
	ADD.B	#24,D3
.AA	MOVE.B	D3,(A6)
	MOVE.B	(A2)+,D3
	MOVE.B	(A2),D4
	AND.B	#3,D3
	LSL.B	#4,D3
	LSR.B	#4,D4
	OR.B	D4,D3			* INSTRUMENT
	MOVE.B	D3,1(A6)
	MOVE.B	(A2)+,D3
	AND.W	#$F,D3			* COMMANDE
	
	JSR	([MTM_EFFECT,D3.W*4])
	
	ADDQ.W	#6,A6
	DBF	D1,.BCL_MTM
	DBF	D0,.BCL3_MTM

	RTS
	
MTM_EFFECT
	DC.L	ARP_MTM,PORT_UP_MTM,PORT_DOWN_MTM,TONE_PORT_MTM
	DC.L	VIBRATO_MTM,TONE_SLIDE_MTM,VIB_SLIDE_MTM,TREMOLO_MTM
	DC.L	FINE_PAN_MTM,SPL_OFFSET_MTM,VOL_SLIDE_MTM,POS_JUMP_MTM
	DC.L	SET_VOL_MTM,PATT_BREAK_MTM,XTRA_EFFECT_MTM,SET_SPEED_MTM

SSD	MOVE.B	D3,2(A6)		* comm
	MOVE.B	(A2)+,4(A6)
	RTS
	
ARP_MTM
	BRA.S	SSD
	
PORT_UP_MTM
	BRA.S	SSD
	
PORT_DOWN_MTM
	BRA.S	SSD
	
TONE_PORT_MTM
	BRA.S	SSD
	
VIBRATO_MTM	
	BRA.S	SSD
	
TONE_SLIDE_MTM
	MOVE.B	D3,2(A6)
	MOVE.B	(A2)+,D3
	MOVE.W	D3,D6
	LSR.B	#4,D3
	BEQ.S	.SL_DOWN
	LSL.W	#8,D3
	MOVE.W	D3,3(A6)
	RTS
.SL_DOWN
	AND.W	#$F,D6	
	MOVE.W	D6,3(A6)
	RTS
	
VIB_SLIDE_MTM
	BRA.S	TONE_SLIDE_MTM
	
TREMOLO_MTM	
	BRA.S	SSD
	
FINE_PAN_MTM	
	BRA.S	SSD
	
SPL_OFFSET_MTM	
	BRA.S	SSD

VOL_SLIDE_MTM
	BRA.S	TONE_SLIDE_MTM

POS_JUMP_MTM
	BRA.S	SSD

SET_VOL_MTM
	CMP.B	#0,(A2)
	BEQ.S	SSD
	MOVE.B	#0,2(A6)
	MOVE.B	(A2)+,D3
	AND.W	#$FF,D3
	CMP.B	#$40,D3
	BGT.S .VHIGH
	ADD.B	#$10,D3
	MOVE.B	D3,5(A6)
	RTS
.VHIGH	MOVE.B	#$50,5(A6)
	
PATT_BREAK_MTM
	MOVE.B	D3,2(A6)
	MOVE.B	(A2)+,D7
	MOVE.B	D7,D3
	LSR.B	#4,D3
	MULU	#10,D3
	AND.W	#$F,D7
	ADD.B	D3,D7
	MOVE.B	D7,4(A6)
	RTS

XTRA_EFFECT_MTM	
	MOVE.B	(A2)+,D3
	MOVE.B	D3,D6
	LSR.B	#4,D3
	ADD.B	#$10,D3
	AND.B	#$F,D6
	MOVE.B	D3,2(A6)
	MOVE.B	#0,3(A6)
	MOVE.B	D6,4(A6)
	MOVE.B	#0,5(A6)
	RTS
	
SET_SPEED_MTM
	MOVE.B	#$F,2(A6)
	MOVE.B	(A2)+,D3
	CMP.W	#$20,D3
	BGT.S	.SPD2
	MOVE.B	D3,4(A6)
	RTS
.SPD2	MOVE.B	D3,3(A6)	
	RTS
*--------------------------------------------------------------------------
INIT_MTM
	MOVEQ	#0,D0
	MOVE.B	33(A0),D0
	MOVE.B	D0,digvoices
	CMP.B	#8,D0
	BLE.S	.HH
	MOVE.B	#8,D0
.HH	MOVE.B	D0,NBVF

	MOVE.B	#1,maxmus
	MOVE.B	#0,curmus
	MOVE.L	DEBMUS,A1
	MOVE.L	A1,ADDDEB_MUS(A1)
	ADD.L	#TOTAL_MUS,ADDDEB_MUS(A1)
	MOVE.B	27(A0),D0
	MOVE.W	D0,LEN_MUS(A1)
	ADDQ.W	#1,D0
	MOVE.W	D0,maxpos		* = maxlen
	MOVE.W	#0,curpos
	MOVE.W	D0,curlen
	MOVE.W	#0,RESTART_MUS(A1)
	MOVE.W	#0,curlop
	MOVE.B	#6,I_SPEED_MUS(A1)
	MOVE.B	#$7D,I_TEMPO_MUS(A1)
	MOVE.W	#$2020,I_MASTERVOL_MUS(A1)
	LEA	I_VOL_MUS(A1),A6
	
	LEA	4(A0),A3
	LEA	NAME_MUS(A1),A2
	MOVEQ	#19,D1
.COP2	MOVE.B	(A3)+,(A2)+
	DBF	D1,.COP2
	MOVEQ	#11,D1
.COP3	MOVE.B	#0,(A2)+
	DBF	D1,.COP3
	
	ADD.W	#TOTAL_MUS,A1
	MOVE.L	A1,DEBSEQ
	MOVE.L	A1,ADDCURSEQ
	
	LEA	(A1,D0.W*2),A1
	MOVE.L	A1,DEBPATT
	
	MOVE.B	26(A0),D0
	ADDQ.W	#1,D0
	MOVE.W	D0,maxpatt
	MULU	#32*2+2,D0
	ADD.L	D0,A1
	MOVE.L	A1,DEBTABTRACK
	
	MOVEQ	#0,D0
	MOVE.B	25(A0),D0
	LSL.W	#8,D0
	MOVE.B	24(A0),D0
	ADDQ.W	#1,D0
	MOVE.W	D0,maxtrack
	LEA	(A1,D0.L*4),A1
	MOVE.L	A1,DEBTRACK
	
	MOVE.L	A1,A2
	MOVE.W	#64,(A2)+
	MOVEQ	#63,D1
.WW	MOVE.L	#0,(A2)+
	MOVE.W	#0,(A2)+
	DBF	D1,.WW
	
	MULU.L	#6*64+2,D0
	ADD.L	D0,A1
	MOVE.L	A1,DEBSPL
	
	LEA	34(A0),A1
	LEA	PILEVOIE,A2
	LEA	TAB_PAN,A3
	MOVEQ	#32-1,D0
	MOVEQ	#0,D1
.FF	MOVE.L	(A2)+,A4
	MOVE.B	(A1)+,D1
	MOVE.W	(A3,D1.W*2),LEFT_VOL(A4)
	MOVE.W	LEFT_VOL(A4),(A6)+
	DBF	D0,.FF
	
	LEA	66(A0),A1
	MOVEQ	#0,D0
	MOVE.B	30(A0),D0
	MULU	#37,D0
	ADD.L	D0,A1
	MOVE.L	A1,PATTERN_ORDER_DATA
	ADD.L	#128,A1
	MOVE.L	A1,TRACK_DATA
	
	MOVEQ	#0,D0
	MOVE.B	25(A0),D0
	LSL.W	#8,D0
	MOVE.B	24(A0),D0
	MULU.L	#192,D0
	ADD.L	D0,A1
	MOVE.L	A1,TRACK_SEQUENCING_DATA
	MOVEQ	#0,D0
	MOVE.B	26(A0),D0
	ADDQ.W	#1,D0
	MULU	#32*2,D0
	ADD.L	D0,A1
	MOVE.L	A1,EXTRA_COMMENT_FIELD
	
	MOVEQ	#0,D0
	MOVE.B	29(A0),D0
	LSL.W	#8,D0
	MOVE.B	28(A0),D0
	ADD.L	D0,A1
	MOVE.L	A1,RAW_SAMPLE_DATA

	MOVE.L	PATTERN_ORDER_DATA,A1
	MOVE.L	DEBSEQ,A2
	MOVEQ	#$7F,D0
	MOVEQ	#0,D1
.LL	MOVE.B	(A1)+,D1
	MOVE.W	D1,(A2)+
	DBF	D0,.LL
	
	LEA	BUFMOD,A1
	LEA	66(A0),A2
	MOVEQ	#0,D0
	MOVE.B	30(A0),D0
	SUBQ.W	#1,D0
	MULU	#37,D0
.SS	MOVE.B	(A2)+,(A1)+
	DBF	D0,.SS
	
	BSR	REINIT_TEMPO
	RTS
*--------------------------------------------------------------------------
DATASAMPLE_MTM:
	MOVE.B	#0,totalsample
	MOVEQ	#0,D0
	MOVEQ	#0,D7
	MOVE.B	30(A0),D0
	SUBQ.W	#1,D0
	LEA	SAMPLE,A1
	LEA	BUFMOD,A2
	MOVE.L	RAW_SAMPLE_DATA,A3
	MOVE.L	DEBSPL,D5
	
SPL_MTM	MOVE.L	(A2),(A1)
	MOVE.L	4(A2),4(A1)
	MOVE.L	8(A2),8(A1)
	MOVE.L	12(A2),12(A1)
	MOVE.L	16(A2),16(A1)
	MOVE.W	20(A2),20(A1)
	MOVE.L	#0,22(A1)
	MOVE.L	#0,26(A1)
	MOVE.W	#0,30(A1)

	MOVE.B	25(A2),D1
	LSL.L	#8,D1
	MOVE.B	24(A2),D1
	LSL.L	#8,D1
	MOVE.B	23(A2),D1
	LSL.L	#8,D1
	MOVE.B	22(A2),D1		* D1 = SAMPLE LENGTH
	CMP.B	#0,D1
	BEQ	.FINT
	ADDQ.B	#1,totalsample
	
	MOVE.B	29(A2),D2
	LSL.L	#8,D2
	MOVE.B	28(A2),D2
	LSL.L	#8,D2
	MOVE.B	27(A2),D2
	LSL.L	#8,D2
	MOVE.B	26(A2),D2		* D2 = LOOP DEB
	
	MOVE.B	33(A2),D3
	LSL.L	#8,D3
	MOVE.B	32(A2),D3
	LSL.L	#8,D3
	MOVE.B	31(A2),D3
	LSL.L	#8,D3
	MOVE.B	30(A2),D3		* D3 = LOOP END
	
	MOVE.L	D3,D4			* D4 = REAL LOOP END
	CMP.L	#2,D4
	BGT.S	.WW
	MOVE.L	D1,D4
	MOVE.L	#0,D3
	
.WW	CMP.L	D1,D2
	BLE.S	.SS
	MOVEQ	#0,D2
.SS	CMP.L	D1,D3
	BLE.S	.DD
	MOVEQ	#0,D3
.DD	CMP.L	D1,D4
	BLE.S	.FF
	MOVE.L	D1,D4
	
.FF	MOVE.L	D7,DEB_MGT(A1)	
	MOVE.L	D7,FIN_MGT(A1)	
	MOVE.L	D7,LOOP_DEB_MGT(A1)
	MOVE.L	D7,LOOP_FIN_MGT(A1)

	ADD.L	D5,DEB_MGT(A1)
	ADD.L	D5,FIN_MGT(A1)
	ADD.L	D5,LOOP_DEB_MGT(A1)
	ADD.L	D5,LOOP_FIN_MGT(A1)
	
	ADD.L	D1,FIN_MGT(A1)
	MOVE.L  D1,LEN_MGT(A1)
	
	ADD.L	D2,LOOP_DEB_MGT(A1)
	ADD.L	D4,LOOP_FIN_MGT(A1)
	
	CMP.L	#0,D3			*D2
	BNE.S	.NOLOP2
	MOVE.L	DEB_MGT(A1),LOOP_DEB_MGT(A1)
	MOVE.L	FIN_MGT(A1),LOOP_FIN_MGT(A1)
	
.NOLOP2	MOVE.L	FIN_MGT(A1),D4
	SUB.L	LOOP_FIN_MGT(A1),D4
	MOVE.L	D4,LEN_FIN_MGT(A1)	
	
	MOVE.L	DEB_MGT(A1),A4
	MOVE.L	D1,D4
	
.UU	MOVE.B	(A3)+,D6
	ADD.B	#$80,D6
	MOVE.B	D6,(A4)+
	SUBQ.L	#1,D4
	BNE.S	.UU
	
	MOVE.W	#FINSAMPLE,LEN_BUF_MGT(A1)

	CMP.L	#0,D3			*D2
	BNE.S	.LLOOPP
	
	BCLR.B	#2,BIT1_MGT+1(A1)
	BSR	ZEROFINSPL
	BRA.S	.MLML
	
.LLOOPP	BSET.B	#2,BIT1_MGT+1(A1)
	BSR	BCLFINSPL
	
.MLML	ADD.L	#FINSAMPLE,D1
	ADD.L	#FINSAMPLE,FIN_MGT(A1)
	ADD.L	D1,lensamples
	ADD.L	D1,D7
	
	MOVE.B	34(A2),F_TUNE_MGT(A1)
	MOVEQ	#0,D6
	MOVE.B	35(A2),D6
	LSL.W	#4,D6
	MOVE.W	D6,VOL_MGT(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	MOVE.W	#8363,BASE_MGT(A1)
	MOVE.B	#0,COMMAND_MGT(A1)
	MOVE.W	#0,PARAM_MGT(A1)
	BTST.B	#0,36(A2)
	BEQ.S	.MTM_8
	
	BSET.B	#0,BIT1_MGT+1(A1)
	BRA.S	.FINT
	
.MTM_8	BCLR.B	#0,BIT1_MGT+1(A1)
	
.FINT	LEA	37(A2),A2
	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,SPL_MTM
	
	MOVE.L	A4,ENDADDR
	ADD.L	#FINSAMPLE,ENDADDR
	
	RTS
***************************************************************************
NOT_MTM_MOD
	CMP.L	#'6CHN',$438(A0)
	BNE	NOT_6CHN_MOD
	
	BSR	DEPLACE_MOD
	MOVE.L	#1536,D7
	MOVE.B	#6,digvoices
	MOVE.B	#6,NBVF
	BSR	DINS31				* INIT_MOD
	BSR	DATAPATT_MOD
	BSR	DATASAMPLE_MOD
	BSR	REINIT_MOD
	RTS
***************************************************************************
NOT_6CHN_MOD				* ALORS C'EST UN MODULE STANDARD
	BSR	DEPLACE_MOD

	MOVE.B	#4,digvoices	
	MOVE.B	#4,NBVF
	MOVE.L	#1024,D7
	BSR	INIT_MOD
	BSR	DATAPATT_MOD
	BSR	DATASAMPLE_MOD
	BSR	REINIT_MOD
	RTS
*--------------------------------------------------------------------------
REINIT_MOD
	BSR	REINIT_PAN
	BSR	REINIT_TEMPO
	BRA	REINIT_MTM
*--------------------------------------------------------------------------
DEPLACE_MOD:
	MOVE.L	ENDADDR,A1
	MOVE.L	#8000,D0
	LEA	BUFMOD,A0
.DEPL2	MOVE.B	(A1)+,(A0)+
	DBF	D0,.DEPL2
	
	MOVE.L	ENDADDR,A1
	MOVE.L	long,D0
	BCLR	#0,D0
	MOVE.L	$42E.W,A0
	SUB.L	#50,A0
	MOVE.L	A0,A2
	SUB.L	D0,A2
	ADD.L	D0,A1
.DEPL3	MOVE.L	-(A1),-(A0)
	MOVE.L	-(A1),-(A0)
	SUBQ.L	#8,D0
	BPL.S	.DEPL3
	MOVE.L	A2,A0
	MOVE.L	A2,A6
	BSR	ZEROVOICE
	RTS
*--------------------------------------------------------------------------
INIT_MOD:
	CMP.L	#'M.K.',$438(A0)
	BEQ.S	DINS31
	CMP.L	#'FLT4',$438(A0)
	BEQ.S	DINS31
	MOVE.W	#15,MAX_INS
	MOVE.W	#$1D8,W_MOD
	MOVE.W	#$258,A_MOD
	BRA.S	DINS16
DINS31	MOVE.W	#31,MAX_INS
	MOVE.W	#$3B8,W_MOD
	MOVE.W	#$43C,A_MOD
DINS16	MOVE.W	#1,IN_MOD
	ADD.W	W_MOD,A0
	MOVE.B	#1,maxmus
	MOVE.B	#0,curmus
	MOVEQ	#0,D0
	MOVE.L	DEBMUS,A1
	MOVE.B	-2(A0),D0			* LEN  ZIC
	MOVE.W	D0,LEN_MUS(A1)

	MOVE.W	D0,curlen
	MOVE.W	D0,maxpos
	MOVE.W	#0,curlop
	MOVE.W	#0,curpos
	MOVE.L	A1,ADDDEB_MUS(A1)
	ADD.L	#TOTAL_MUS,ADDDEB_MUS(A1)
	MOVE.W	#0,RESTART_MUS(A1)
	MOVE.B	#6,I_SPEED_MUS(A1)
	MOVE.W	#6,SPEED
	MOVE.L	#$7D,D0
	MOVE.B	D0,I_TEMPO_MUS(A1)
	BSR	SET_T2
	MOVE.W	#$2020,I_MASTERVOL_MUS(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+32(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+36(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+40(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+44(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+48(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+52(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+56(A1)
	MOVE.L	#$FF0000FF,I_VOL_MUS+60(A1)
	
	MOVE.L	A6,A2
	LEA	NAME_MUS(A1),A3
	MOVEQ	#19,D1
.COP	MOVE.B	(A2)+,(A3)+
	DBF	D1,.COP
	MOVEQ	#11,D1
.COP1	MOVE.B	#0,(A3)+
	DBF	D1,.COP1
	
	ADD.W	#TOTAL_MUS,A1
	MOVE.L	A1,DEBSEQ
	MOVE.L	A1,ADDCURSEQ
	LEA	(A1,D0.W*2),A1
	MOVE.L	A1,DEBPATT
	
	MOVE.L	DEBSEQ,A2
	MOVEM.L	RIEN,D0-D2
	MOVE.W	#$80-1,D0			* ON S'OCCUPE DE LA SEQUENCE
.DRCOM	MOVE.B	(A0)+,D1
	MOVE.W	D1,(A2)+
	CMP.W	D2,D1
	BLE.S	.DRECOM
	MOVE.B	D1,D2
.DRECOM	DBF	D0,.DRCOM
	ADDQ.W	#1,D2
	MOVE.W	D2,maxpatt
	MOVE.L	D2,D3
	MULU	#32*2+2,D3
	ADD.L	D3,A1
	MOVE.L	A1,DEBTABTRACK
	
	MOVE.L	D2,D3
	MOVEQ	#0,D0
	MOVE.B	digvoices,D0
	MULU	D0,D3
	ADDQ.W	#1,D3
	MOVE.W	D3,maxtrack
	LEA	(A1,D3.L*4),A1
	MOVE.L	A1,DEBTRACK
	
	MOVE.L	A1,A2
	MOVE.W	#64,(A2)+
	MOVEQ	#63,D0
.WW	MOVE.L	#0,(A2)+
	MOVE.W	#0,(A2)+
	DBF	D0,.WW
	
	MULU	#6*64+2,D3
	ADD.L	D3,A1
	MOVE.L	A1,DEBSPL
	MOVE.L	A1,ENDADDR
	
	MOVE.L	ADDCURSEQ,A2
	MOVEQ	#0,D3
	MOVE.B	(A2),D3
	MULU	#6*64+2,D3
	MOVE.L	DEBPATT,A2
	ADD.L	D3,A2
	MOVE.L	A2,ADDCURPATT
	
	MOVEQ	#0,D0
	MULU	D7,D2			
	MOVE.W	A_MOD,D0
	ADD.L	D2,D0
	MOVE.L	D0,FIRST_SPL
	
	RTS
*--------------------------------------------------------------------------
DATASAMPLE_MOD:
	LEA	SAMPLE,A1
	LEA	BUFMOD+20,A2
	MOVE.L	DEBSPL,D5

DEP8	MOVE.L	A6,A3
	ADD.L	FIRST_SPL,A3
	MOVE.B	#0,totalsample
	MOVEQ	#0,D0
	MOVEQ	#0,D7
	MOVE.W	MAX_INS,D0
	SUBQ.W	#1,D0
	
SPL_MOD	MOVE.L	(A2),(A1)
	MOVE.L	4(A2),4(A1)
	MOVE.L	8(A2),8(A1)
	MOVE.L	12(A2),12(A1)
	MOVE.L	16(A2),16(A1)
	MOVE.W	20(A2),20(A1)
	MOVE.W	#0,22(A1)
	MOVE.L	#0,24(A1)
	MOVE.L	#0,28(A1)
	
	MOVEQ	#0,D1
	MOVE.W	22(A2),D1		* D1=SPL LEN
	ADD.L	D1,D1
	BEQ	.FINT
	ADDQ.B	#1,totalsample
	
	MOVEQ	#0,D2
	MOVE.W	26(A2),D2		* D2=LOOP DEB
	ADD.L	D2,D2
	
	MOVEQ	#0,D3
	MOVE.W	28(A2),D3		* D3=LOOP LEN
	ADD.L	D3,D3
	
	MOVE.L	D2,D4
	ADD.L	D3,D4			* D4=LOOP END
	
	CMP.L	D3,D1
	BNE.S	.ZZ
	SUB.L	D2,D3
	BRA.S	.OK
	
.ZZ	CMP.L	D4,D1
	BGE.S	.OK
	MOVE.L	D1,D4
	
.OK	MOVE.L	D7,DEB_MGT(A1)
	MOVE.L	D7,FIN_MGT(A1)
	MOVE.L	D7,LOOP_DEB_MGT(A1)
	MOVE.L	D7,LOOP_FIN_MGT(A1)
	
	ADD.L	D5,DEB_MGT(A1)
	ADD.L	D5,FIN_MGT(A1)
	ADD.L	D5,LOOP_DEB_MGT(A1)
	ADD.L	D5,LOOP_FIN_MGT(A1)
	
	ADD.L	D1,FIN_MGT(A1)
	MOVE.L	D1,LEN_MGT(A1)
	
	ADD.L	D2,LOOP_DEB_MGT(A1)
	ADD.L	D4,LOOP_FIN_MGT(A1)
	
	CMP.L	#4,D3
	BGT.S	.NOLOP1
	MOVE.L	DEB_MGT(A1),LOOP_DEB_MGT(A1)
	MOVE.L	FIN_MGT(A1),LOOP_FIN_MGT(A1)

.NOLOP1	MOVE.L	FIN_MGT(A1),D4
	SUB.L	LOOP_FIN_MGT(A1),D4
	MOVE.L	D4,LEN_FIN_MGT(A1)
	
	MOVE.L	DEB_MGT(A1),A4
	MOVE.L	D1,D4
.UU	*CMP.L	$42E.W,A4
	*BGE.S	.UV
	MOVE.B	(A3)+,(A4)+
	SUBQ.L	#1,D4
	BNE.S	.UU
	
	*MOVE.W	#FINSAMPLE_MOD,LEN_BUF_MGT(A1)
	
.UV	CMP.L	#4,D3
	BLE.S	.NO_LOOP
		
	BSET.B	#2,BIT1_MGT+1(A1)
	BSR	FIRST_BCLFINSPL
	BRA.S	.RR
	
.NO_LOOP
	BCLR.B	#2,BIT1_MGT+1(A1)
	BSR	FIRST_ZEROFINSPL
	
.RR	ADD.L	#FINSAMPLE_MOD,D1
	ADD.L	#FINSAMPLE_MOD,FIN_MGT(A1)
	ADD.L	D1,lensamples
	ADD.L	D1,D7
	
.FINT	MOVE.W	#FINSAMPLE_MOD,LEN_BUF_MGT(A1)
	BCLR.B	#1,BIT1_MGT+1(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.W	#8363,BASE_MGT(A1)
	MOVE.B	#52,NOTE_MGT(A1)
	MOVE.B	#0,COMMAND_MGT(A1)
	MOVE.W	#0,PARAM_MGT(A1)
	MOVE.B	24(A2),F_TUNE_MGT(A1)
	MOVEQ	#0,D6
	MOVE.B	25(A2),D6
	LSL.W	#4,D6
	MOVE.W	D6,VOL_MGT(A1)
	
	LEA	30(A2),A2
	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,SPL_MOD
	
	MOVE.L	A4,ENDADDR
	ADD.L	#FINSAMPLE_MOD,ENDADDR
	RTS
*--------------------------------------------------------------------------
OFFSET1	DC.W	0
*--------------------------------------------------------------------------
DATAPATT_MOD:				* ON S'OCCUPE DES PATTERN
	BSR	REINIT_TAB_TRACK
	MOVEM.L	RIEN,D1-D3
	MOVE.L	DEBPATT,A1
	MOVEQ	#1,D0
	MOVE.W	maxpatt,D1
	SUBQ.W	#1,D1
	MOVE.B	digvoices,D2
	MOVEQ	#32,D4
	SUB.W	D2,D4
	
.RR	MOVE.W	#64,(A1)+
	
.ZZ	MOVE.W	D0,(A1)+
	ADDQ.W	#1,D0
	ADDQ.W	#1,D3
	CMP.W	D2,D3
	BNE.S	.ZZ
	MOVEQ	#0,D3
.EE	MOVE.W	#0,(A1)+
	ADDQ.W	#1,D3
	CMP.W	D4,D3
	BNE.S	.EE
	MOVEQ	#0,D3
	DBF	D1,.RR
	
	MOVE.L	A6,A0
	ADD.W	A_MOD,A0
	MOVE.L	A0,A3
	MOVE.L	A0,A4
	MOVE.L	DEBTRACK,A1
	LEA	6*64+2(A1),A1
	MOVEQ	#0,D1
	MOVE.W	maxpatt,D1
	SUBQ.W	#1,D1
	MOVE.W	D2,D5
	LSL.W	#2,D5
	MOVE.W	D5,OFFSET1
	
.dcuisse
	MOVEQ	#0,D2
	MOVE.B	digvoices,D2
	SUBQ	#1,D2
.ddoigt	
	MOVEQ	#63,D0	
	MOVE.W	#64,(A1)+
.dorteil
	MOVE.B	(A0),D5			* note poids fort
	AND.B	#$f,D5
	LSL.W	#8,D5
	MOVE.B	1(A0),D5		* note poids faible
	LEA	DIGINOTE1,A2
	MOVEQ	#0,D6
	MOVEQ	#95,D7
.fgb	ADDQ.B	#1,D6
	CMP.W	(A2)+,D5
	BEQ.S	.fga
	DBF	D7,.fgb
	MOVEQ	#0,D6
.fga	MOVE.B	D6,(A1)
	
	MOVE.B	(A0),D5
	AND.B	#$f0,D5
	MOVE.B	2(A0),D6		* instrument + commande
	MOVE.B	D6,D7
	AND.B	#$F0,D6
	AND.W	#$0F,D7
	LSR.W	#4,D6
	ADD.B	D5,D6
	MOVE.B	D6,1(A1)		* instru
	MOVE.B	#0,3(A1)
	MOVE.B	#0,4(A1)
	MOVE.B	#0,5(A1)

	JSR	([MOD_EFFECT,D7.W*4])
	
.ui	ADDQ.W	#6,A1
	ADD.W	OFFSET1,A0
	DBF	D0,.dorteil

	ADDQ.W	#4,A3
	MOVE.L	A3,A0
	DBF	D2,.ddoigt
	
	MOVEQ	#0,D0
	MOVE.B	digvoices,D0
	MULU	#64*4,D0
	ADD.L	D0,A4
	MOVE.L	A4,A0
	MOVE.L	A4,A3
	DBF	D1,.dcuisse
	RTS

MOD_EFFECT
	DC.L	ARP_MOD,PORT_UP_MOD,PORT_DOWN_MOD,TONE_PORT_MOD
	DC.L	VIBRATO_MOD,TONE_SLIDE_MOD,VIB_SLIDE_MOD,TREMOLO_MOD
	DC.L	FINE_PAN_MOD,SPL_OFFSET_MOD,VOL_SLIDE_MOD,POS_JUMP_MOD
	DC.L	SET_VOL_MOD,PATT_BREAK_MOD,XTRA_EFFECT_MOD,SET_SPEED_MOD

SSS	MOVE.B	D7,2(A1)		* comm
	MOVE.B	3(A0),4(A1)
	RTS
	
ARP_MOD
	BRA.S	SSS
	
PORT_UP_MOD
	BRA.S	SSS
	
PORT_DOWN_MOD
	BRA.S	SSS
	
TONE_PORT_MOD
	BRA.S	SSS
	
VIBRATO_MOD	
	BRA.S	SSS
	
TONE_SLIDE_MOD
	MOVE.B	D7,2(A1)
	MOVE.B	3(A0),D7
	MOVE.W	D7,D6
	LSR.B	#4,D7
	BEQ.S	.SL_DOWN
	LSL.W	#8,D7
	MOVE.W	D7,3(A1)
	RTS
.SL_DOWN
	AND.W	#$F,D6	
	MOVE.W	D6,3(A1)
	RTS
	
VIB_SLIDE_MOD
	BRA.S	TONE_SLIDE_MOD
	
TREMOLO_MOD	
	BRA.S	SSS
	
FINE_PAN_MOD	
	BRA.S	SSS
	
SPL_OFFSET_MOD	
	BRA.S	SSS

VOL_SLIDE_MOD
	BRA.S	TONE_SLIDE_MOD

POS_JUMP_MOD
	BRA.S	SSS

SET_VOL_MOD
	CMP.B	#0,3(A0)
	BEQ.S	SSS
	MOVE.B	#0,2(A1)
	MOVE.B	3(A0),D7
	AND.W	#$FF,D7
	CMP.B	#$40,D7
	BGT.S .VHIGH
	ADD.B	#$10,D7
	MOVE.B	D7,5(A1)
	RTS
.VHIGH	MOVE.B	#$50,5(A1)
	
PATT_BREAK_MOD
	MOVE.B	D7,2(A1)
	MOVE.B	3(A0),D7
	MOVE.B	D7,D6
	LSR.B	#4,D6
	MULU	#10,D6
	AND.W	#$F,D7
	ADD.B	D6,D7
	MOVE.B	D7,4(A1)
	RTS
	

XTRA_EFFECT_MOD	
	MOVE.B	3(A0),D6
	MOVE.B	D6,D7
	LSR.B	#4,D6
	ADD.B	#$10,D6
	AND.B	#$F,D7
	MOVE.B	D6,2(A1)
	MOVE.B	#0,3(A1)
	MOVE.B	D7,4(A1)
	MOVE.B	#0,5(A1)
	RTS
	
SET_SPEED_MOD
	MOVE.B	D7,2(A1)
	MOVEQ	#0,D7
	MOVE.B	3(A0),D7
	CMP.W	#$20,D7
	BGT.S	.SPD2
	MOVE.B	D7,4(A1)
	RTS
.SPD2	MOVE.B	D7,3(A1)
	RTS
*--------------------------------------------------------------------------
DEPLACE_SAMPLE
.sspl	MOVE.L	DEBSPL,A0
	LEA	SAMPLE,A1
mDEP8	ADD.L	FIRST_SPL,A6
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	MOVE.W	MAX_INS,D0
	SUBQ	#1,D0
.TROU	MOVE.L	LEN_MGT(A1),D1
	BEQ.S	.NO_LEN
.PAU	MOVE.B	(A6)+,(A0)+
	SUBQ.L	#1,D1
	BNE.S	.PAU
	BTST.B	#2,BIT1_MGT+1(A1)
	BEQ.S	.PALOP
	BSR	FIRST_BCLFINSPL
	BRA.S	.LOP
.PALOP	BSR	FIRST_ZEROFINSPL
.LOP	ADD.W	LEN_BUF_MGT(A1),A0
.NO_LEN	LEA	LEN_SAMPLE_MGT(A1),A1
	DBF	D0,.TROU
	
	RTS
*--------------------------------------------------------------------------
AFF_EMPTY_PATT
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	MOVEQ	#31,D0
	LEA	PILEVOIE,A1
	LEA	VOICE_TAB1,A2
.SS	MOVE.L	(A1)+,A3
	MOVE.L	DEBTRACK,ADDCURTRACK(A3)
	ADDQ.L	#2,ADDCURTRACK(A3)
	MOVE.W	#64,LENCURTRACK(A3)
	MOVE.W	#0,NBCURTRACK(A3)
	MOVE.B	#1,(A2)+
	DBF	D0,.SS
	BSR	SET_ON
	BSR	SET_VS
	BSR	AFFPATTERN3
	RTS
***************************************************************************
REINIT_TAB_TRACK
	MOVE.L	DEBTABTRACK,A1
	MOVE.L	DEBTRACK,A2
	MOVEQ	#0,D0
	MOVE.W	maxtrack,D0
	SUBQ.W	#1,D0
	
.JJ	MOVE.L	A2,(A1)+
	MOVE.W	#64,(A2)
	LEA	64*6+2(A2),A2
	DBF	D0,.JJ
	RTS
***************************************************************************
NB_VOICE_FRQ
	MOVEQ	#0,D0
	MOVE.B	NBVF,D0
	LSR.B	#1,D0
	MOVE.L	#$7FFFFF/64,D1
	DIVU.L	D0,D1
	LSR.L	#1,D1
	*MOVE.L	D1,MASTER_VOLUME_LEFT
	*MOVE.L	D1,MASTER_VOLUME_RIGHT
	BSR	AFF_VOL_GEN
	RTS
NBVF			DC.W	$0202
MASTER_VOL_LEFT		DC.B	32
MASTER_VOL_RIGHT	DC.B	32
***************************************************************************
AFF_VOL_GEN
	MOVEQ	#0,D0
	MOVE.B	NBVF,D0
	
	LEA	VVOL,A0
	DIVU.W	#10,D0
	ADD.B	#'0',D0
	MOVE.B	D0,1(A0)
	SWAP	D0
	ADD.B	#'0',D0
	MOVE.B	D0,2(A0)
	
	MOVE.L	#screen+640*72+432,where
	MOVE.W	#0,compt2
	MOVEQ	#3,D1
	BSR	PRINT
	RTS
VVOL	DC.B	'-00',0	
***************************************************************************
SET_VS:
	LEA	VOICE_TAB,A0
	LEA	VOICE_TAB1,A1
	LEA	V_TAB_SCR,A2
	LEA	ccompt2,A4
	MOVEQ	#4,D0
	
.ILI	MOVE.B	(A0)+,D1
	MOVE.B	(A1)+,D2
	MOVE.L	(A2)+,A3
	MOVE.W	(A4)+,D4
	CMP.B	D1,D2
	BEQ.S	.FIN
	
	MOVE.B	D2,-1(A0)
	BTST	#0,D4
	BNE.S	.SV1
	MOVEQ	#7,D3
.LOPO	NOT.W	(A3)
	LEA	640(A3),A3
	DBF	D3,.LOPO
	BRA	.FIN
.SV1	MOVEQ	#7,D3
.LOP2	NOT.B	1(A3)
	NOT.B	16(A3)
	LEA	640(A3),A3
	DBF	D3,.LOP2
.FIN	DBF	D0,.ILI
	RTS
***************************************************************************
ZEROVOICE
	MOVEM.L	D0/A5-A6,-(A7)
	LEA	PILEVOIE,A6
	MOVEQ	#32-1,D0
.ZZ	MOVE.L	(A6)+,A5
	BSR	CLEAR2
	DBF	D0,.ZZ
	MOVEM.L	(A7)+,D0/A5-A6
	RTS

CLEAR2
	MOVE.W	#0,FREQUENCY(A5)
	MOVE.L	#0,SPL_POINTER(A5)
	MOVE.L	#0,LOOP_BEGIN(A5)
	MOVE.L	#0,LOOP_END(A5)
	MOVE.L	#0,WAVE_START(A5)
	MOVE.L	#0,SPL_BEGIN(A5)
	MOVE.B	#0,VOL1(A5)
	MOVE.W	#$400,PATT_VOL(A5)
	MOVE.B	#8,BITS(A5)
	RTS
***************************************************************************
CANAL_MOD	DC.W	0	* # CANAL DU FICHIER
MAX_INS	DC.W	0		* NB MAX D'INSTRUMENTS
IN_MOD	DC.W	0		* SI = 1 ALORS ON EST DANS UN MODULE
A_MOD	DC.W	0		* POINTEUR DANS MOD (ADD_PARTITION)
P_MOD	DC.W	0		* POINTEUR FILESELECT
W_MOD	DC.W	0		* POINTEUR DANS MOD (ADD_SEQUENCE)
FIRST_SPL	DC.L	0	* ADRESSE PREMIER SPL DANS MOD (RELATIF)

	IFNE	DEMO

SAVE_MODULE
SAVE_SAMPLE
	RTS

	ELSEIF
	
s_spl	MOVEQ	#0,D0
	MOVE.B	sampledata,D0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a0
	ADD.l	d0,a0
	MOVE.L	a0,a1
	MOVE.L	a0,a2
	BSR	SPLTOSPE
	MOVE.L	22(a2),a1
	MOVE.L	26(a2),d1
	LEA	AFFICHAGE,a0
	BSR	SAVE
	MOVE.L	a2,a1
	BSR	SPLTOSPE
	RTS
	
SAVE_SAMPLE:	
s_spe	MOVEQ	#0,d0
	MOVE.B	sampledata,d0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a0
	ADD.l	d0,a0
	MOVE.L	a0,hihi
	MOVE.L	DEB_MGT(a0),a1		*
	SUB.L	#44,a1			*
	MOVE.L	a1,haha			*Recopie de l'adresse du sample -40
	LEA	buffer,a2		*dans un buffer
	MOVE.W	#10,d0			*
.recop1	MOVE.L	(a1)+,(a2)+		*
	dbf	d0,.recop1		*

	MOVE.L	haha,a1			*
	MOVE.L	#'SPE!',(a1)+		*
	MOVE.W	#9,d0			*Recopie des donnes sur le sample
.recop2	MOVE.L	(a0)+,(a1)+		*40 octets avant le sample
	dbf	d0,.recop2		*
	MOVE.L	hihi,a0
	MOVE.L	haha,a1
	ADDQ.W	#4,a1
	MOVE.L	DEB_MGT(a0),d0		*Servira pour le relogeage
	SUB.L	d0,DEB_MGT(a1)		*lors d'un prochain load
	SUB.L	d0,FIN_MGT(a1)		*de ce sample
	SUB.L	d0,LOOP_DEB_MGT(a1)	*A la limite on peut mettre 0 (sauf a celui la)
	SUB.L	d0,LOOP_FIN_MGT(a1)
	MOVE.L	LEN_MGT(a1),d1
	ADD.l	#44,d1
	MOVE.L	haha,a1
	LEA	AFFICHAGE,a0
	BSR	SAVE
	LEA	buffer,a0		*
	MOVE.L	haha,a1			*Replace les donnees du buffer
	MOVE.W	#10,d0			*a 40 octets du sample
.recop3	MOVE.L	(a0)+,(a1)+		*sauvgarde
	dbf	d0,.recop3		*
	RTS
hihi	dc.l	0
haha	dc.l	0
buffer	ds.b	44


s_bnk	LEA	SAMPLE,a0		* deloge data
	MOVE.L	#s1,d0
	MOVE.L  #255,d1

.s_bnk1	CMP.L	#0,26(a0)
	beq.s	.s_bnk2
	SUB.L	d0,22(a0)
	SUB.L	d0,30(a0)
	SUB.L	d0,36(a0)
	MOVE.L	a0,d3			* Adresse dernier SAMPLE
.s_bnk2	ADD.l	#LEN_SAMPLE_MGT,a0
	dbf	d1,.s_bnk1
	MOVE.L	#SAMPLE,d4
	SUB.L	d4,d3			* Len SAMPLE
	ADD.l	#LEN_SAMPLE_MGT,d3

	clr.W 	-(sp)			* Sauve data SAMPLE
 	pea	AFFICHAGE
 	MOVE.W #$3c,-(sp)
 	trap 	#1
 	ADDQ.l 	#8,sp
 	MOVE.W d0,d2

	LEA	SAMPLE-22,a0
	MOVE.L	#'BNK!',(a0)+
	MOVE.B	totalsample,(a0)+
	MOVE.B	#0,(a0)+
	MOVE.L	d3,(a0)+		* Len DATA SAMPLE
	MOVE.L	#0,(a0)+		* Len DATA YAMAHA
	MOVE.L	lensamples,(a0)+
	MOVE.L	#0,(a0)+

	ADD.l	#22,d3
 	pea	SAMPLE-22
 	MOVE.L d3,-(sp)
 	MOVE.W d2,-(sp)
 	MOVE.W #$40,-(sp)
 	trap 	#1
 	ADD.l 	#12,sp

	LEA	SAMPLE,a0		* reloge data
	MOVE.L	#s1,d0
	MOVEQ	#0,d1
	MOVE.L	#255,d3
.s_bnk3	CMP.L	#0,26(a0)
	beq.s	.s_bnk4
	ADD.l	d0,22(a0)
	ADD.l	d0,30(a0)
	ADD.l	d0,36(a0)
.s_bnk4	ADD.l	#LEN_SAMPLE_MGT,a0
	dbf	d3,.s_bnk3

	MOVE.L	lensamples,d1
 	pea	s1			* sauve sample
 	MOVE.L d1,-(sp)
 	MOVE.W d2,-(sp)
 	MOVE.W #$40,-(sp)
 	trap 	#1
 	ADD.l 	#12,sp

 	MOVE.W d2,-(sp)			* ferme fichier
 	MOVE.W #$3e,-(sp)
 	trap 	#1
 	ADDQ.l #4,sp
	*BSR	SAVENAME
	RTS

s_ptn
	MOVEQ	#0,d0
	MOVEQ	#0,d1
	MOVE.B	curpatt,d0
	MOVE.L	ADDCURPATT,a1
	MOVE.B	cvoies,d1
	MULU	d1,d0
	MULU	#64,d0			
	MULU	#64,d1			* longueur d'une ptn
	;ADD.l	d0,a1
	MOVE.L	-(a1),-(a7)
	MOVE.W	-(a1),-(a7)
	MOVE.L	#'PTN!',(a1)
	*MOVE.B	yamvoices,4(a1)	
	MOVE.B	digvoices,5(a1)	
	LEA	AFFICHAGE,a0
	BSR	SAVE
	MOVE.W	(a7)+,(a1)+
	MOVE.L	(a7)+,(a1)+
	RTS
*--------------------------------------------------------------------------
SAVE_MODULE:
s_mod	MOVEQ	#0,D0
	LEA	BUF_SAVE,A6
	MOVE.L	#'MGT ',S_ENTETE(A6)
	MOVE.B	#$10,S_ENTETE+3(A6)
	MOVE.L	#'½MCS',S_ENTETE+4(A6)
	MOVE.B	digvoices,D0
	MOVE.W	D0,S_NBVOICE(A6)
	MOVE.B	maxmus,D0
	MOVE.W	D0,S_NBMUS(A6)
	
	MOVE.L	DEBPATT,D0
	SUB.L	DEBSEQ,D0
	LSR.L	#1,D0
	MOVE.W	D0,S_NBSEQ(A6)
	
	MOVE.W	maxpatt,S_NBPATT(A6)
	MOVE.W	maxtrack,S_NBTRK(A6)

	LEA	SAMPLE,A0
	ADD.L	#254*LEN_SAMPLE_MGT,A0
	MOVEQ	#0,D0
	CMP.B	#0,totalsample
	BEQ.S	.sm7
	MOVE.L	#255,D0
.sm2	CMP.L	#0,LEN_MGT(A0)
	BNE.S	.sm7
	SUB.W	#LEN_SAMPLE_MGT,A0
	SUBQ.L	#1,D0
	BNE.S	.sm2
.sm7	MOVE.W	D0,S_NBSPL(A6)

	LEA	SAMPLE,A0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
.SSM1	CMP.L	#0,LEN_MGT(A0)
	BEQ.S	.SSM
	MOVE.W	LEN_BUF_MGT(A0),D1
	ADD.L	D1,D2
.SSM	ADD.W	#LEN_SAMPLE_MGT,A0
	SUBQ.L	#1,D0
	BNE.S	.SSM1
	MOVE.L	D2,S_LEN_BUF_SPL(A6)

	MOVE.L	#LEN_S,S_DEBMUS(A6)
	MOVE.L	#LEN_S,S_DEBSEQ(A6)
	MOVE.L	#LEN_S,S_DEBPATT(A6)
	MOVE.L	#LEN_S,S_DEBTABTRACK(A6)
	MOVE.L	#LEN_S,S_DEBSPLDATA(A6)
	MOVE.L	#LEN_S,S_DEBSPL(A6)

	LEA	AFFICHAGE,A1
	BSR	FCREATE
	LEA	BUF_SAVE,A1
	MOVE.L	#LEN_S,D1
	BSR	FWRITE
	
	BSR	SAVE_MUS
	BSR	SAVE_SEQ
	BSR	SAVE_PATT
	BSR	SAVE_TRACK
	BSR	SAVE_SPLDATA
	BSR	SAVE_SPL

	MOVEQ	#0,D1
	BSR	FSEEK
	LEA	BUF_SAVE,A1
	MOVE.L	#LEN_S,D1
	BSR	FWRITE
	
	BSR	FCLOSE
	RTS
*--------------------------------------------------------------------------
SAVE_MUS
	MOVE.L	DEBMUS,A1
	MOVEQ	#0,D1
	MOVE.W	S_NBMUS(A6),D1

	MOVE.L	#I_VOL_MUS,D3
	SUB.L	#NAME_MUS,D3
	MOVEQ	#0,D4
	MOVE.W	S_NBVOICE(A6),D4
	ADD.W	D4,D4
	ADD.L	D3,D4
	MULU	D4,D1
	
	MOVE.L	A1,A2
	MOVE.L	ENDADDR,A3
	MOVE.W	S_NBMUS(A6),D2
	
.EE	MOVE.L	A2,A5
	MOVE.L	#I_VOL_MUS,D3
	SUB.L	#NAME_MUS,D3		* D3 = NB D'OCTET AVANT I_VOL
.AA	MOVE.B	(A5)+,(A3)+
	SUBQ.B	#1,D3
	BNE.S	.AA
	
	LEA	VOICE_TAB,A4
	MOVEQ	#31,D3
.CC	MOVE.W	(A5)+,D5
	MOVE.B	(A4)+,D6
	BEQ.S	.BB	
	MOVE.W	D5,(A3)+
.BB	DBF	D3,.CC
	
	ADD.W	#TOTAL_MUS,A2
	SUBQ.B	#1,D2
	BNE.S	.EE

	MOVE.L	A3,D1
	SUB.L	ENDADDR,D1
	
	ADD.L	D1,S_DEBSEQ(A6)
	ADD.L	D1,S_DEBPATT(A6)
	ADD.L	D1,S_DEBTABTRACK(A6)
	ADD.L	D1,S_DEBSPLDATA(A6)
	ADD.L	D1,S_DEBSPL(A6)

	MOVE.L	S_DEBSEQ(A6),D0
	MOVEQ	#0,D3
	MOVE.W	S_NBMUS(A6),D3
	MOVE.L	ENDADDR,A3
	MOVE.L	ADDDEB_MUS(A3),D4
.FF	SUB.L	D4,ADDDEB_MUS(A3)
	ADD.L	D0,ADDDEB_MUS(A3)
	MOVEQ	#0,D5
	MOVE.W	LEN_MUS(A3),D5
	ADD.L	D5,D5
	ADD.L	D5,D0
	ADD.L	D4,A3
	SUBQ.B	#1,D3
	BNE.S	.FF
	
	MOVE.L	ENDADDR,A1
	BSR	FWRITE
	RTS
*--------------------------------------------------------------------------
SAVE_SEQ
	MOVEQ	#0,D0
	MOVE.W	S_NBSEQ(A6),D0
	LSL.L	#1,D0
	MOVE.L	D0,D1
	MOVE.L	DEBSEQ,A1
	BSR	FWRITE
	ADD.L	D1,S_DEBPATT(A6)
	ADD.L	D1,S_DEBTABTRACK(A6)
	ADD.L	D1,S_DEBSPLDATA(A6)
	ADD.L	D1,S_DEBSPL(A6)
	RTS
*--------------------------------------------------------------------------
SAVE_PATT
	MOVEQ	#0,D0
	MOVE.W	S_NBPATT(A6),D0
	
	MOVE.L	ENDADDR,A3
	MOVE.L	DEBPATT,A1
	
.AA	MOVE.L	A1,A5
	MOVE.W	(A5)+,(A3)+
	
	LEA	PILEVOIE,A4
	MOVEQ	#31,D3
.CC	MOVE.W	(A5)+,D5
	MOVE.L	(A4)+,A2
	BTST.B	#0,KIND_VOICE(A2)
	BEQ.S	.BB	
	MOVE.W	D5,(A3)+
.BB	DBF	D3,.CC

	ADD.W	#66,A1
	SUBQ.W	#1,D0
	BNE.S	.AA
	
	MOVE.L	ENDADDR,A1
	MOVE.L	A3,D1
	SUB.L	A1,D1
	BSR	FWRITE
	ADD.L	D1,S_DEBTABTRACK(A6)
	ADD.L	D1,S_DEBSPLDATA(A6)
	ADD.L	D1,S_DEBSPL(A6)
	RTS
*--------------------------------------------------------------------------
SAVE_TRACK
	MOVEQ	#0,D0
	MOVEQ	#0,D4
	MOVE.W	S_NBTRK(A6),D0
	MOVE.L	D0,D1
	MOVE.L	D0,D2
	LSL.L	#2,D2
	MOVE.L	DEBTABTRACK,A0
	MOVE.L	ENDADDR,A1
.SS	MOVE.L	S_DEBTABTRACK(A6),(A1)
	ADD.L	D2,(A1)+
	SUBQ.W	#1,D1
	BNE.S	.SS
	MOVE.L	A1,A5
	MOVE.L	ENDADDR,A1
	ADDQ.W	#4,A1
	MOVE.L	D0,D1
	MOVE.L	A5,DEBUT_ADR
	
.FF	MOVE.L	(A0)+,A2
	MOVE.W	(A2)+,D4		* # OF ROWS
	MOVE.W	D4,(A5)+
	
.DD	MOVEQ	#0,D2
	MOVEQ	#0,D3
	LEA	1(A5),A4
	MOVE.B	(A2),D2			* NOTE
	BEQ.S	.S1
	BSET	#2,D3
	MOVE.B	D2,(A4)+
	
.S1	MOVE.B	1(A2),D2		* INSTR
	BEQ.S	.S2
	BSET	#3,D3
	MOVE.B	D2,(A4)+
	
.S2	MOVE.B	5(A2),D2		* VOL
	BEQ.S	.S3
	BSET	#4,D3
	MOVE.B	D2,(A4)+
	
.S3	MOVE.B	2(A2),D2		* COMM
	BEQ.S	.S4
	BSET	#5,D3
	MOVE.B	D2,(A4)+
	
.S4	MOVE.B	3(A2),D2		* PARAM1
	BEQ.S	.S5
	BSET	#6,D3
	MOVE.B	D2,(A4)+
	
.S5	MOVE.B	4(A2),D2		* PARAM2
	BEQ.S	.S6
	BSET	#7,D3
	MOVE.B	D2,(A4)+
	
.S6	MOVEQ	#0,D6
	MOVEQ	#2,D7
	
.HH	ADDQ.W	#6,A2
	SUBQ.L	#1,D4
	BEQ.S	.GG
	MOVE.L	(A2),D5
	ADD.W	4(A2),D5
	CMP.L	#0,D5
	BNE.S	.EE
	ADDQ.B	#1,D6
	DBF	D7,.HH
	ADDQ.W	#6,A2
	SUBQ.L	#1,D4
	BEQ.S	.GG
	
.EE	OR.B	D6,D3
	MOVE.B	D3,(A5)			* BYTE (BIT PACK)
	MOVE.L	A4,A5
	BRA.S	.DD
	
.GG	OR.B	D6,D3
	MOVE.B	D3,(A5)
	MOVE.L	A4,A5
	MOVE.L	A5,D3
	SUB.L	DEBUT_ADR,D3
	CMP.W	#1,D0
	BEQ.S	.II
	ADD.L	D3,(A1)+

.II	SUBQ.W	#1,D0
	BNE	.FF
	
	MOVE.L	ENDADDR,A1
	MOVE.L	A5,D1
	SUB.L	A1,D1
	BTST	#0,D1
	BEQ.S	.OK
	ADDQ.L	#1,D1
.OK	BSR	FWRITE
	
	ADD.L	D1,S_DEBSPLDATA(A6)
	ADD.L	D1,S_DEBSPL(A6)
	
	MOVE.L	DEBSPL,D1
	SUB.L	DEBTRACK,D1
	MOVE.L	D1,S_LEN_DEPACKED_TRACKS(A6)
	
	RTS
	
DEBUT_ADR	DC.L	0
*--------------------------------------------------------------------------
SAVE_SPLDATA
	LEA	SAMPLE,A1
	MOVEQ	#0,D1
	MOVEQ	#0,D7
	MOVE.W	S_NBSPL(A6),D1
	MOVE.L	D1,D2
	
	MOVE.L	A1,A0
	MOVE.L	ENDADDR,A2
	MOVE.L	D1,D0
	
.XX	MOVE.L	#LEN_SAMPLE_MGT-4,D3
.WW	MOVE.B	(A0)+,(A2)+
	SUBQ.L	#1,D3
	BNE.S	.WW
	ADDQ.W	#4,A0
	SUBQ.L	#1,D0
	BNE.S	.XX

	*MOVE.L	A2,D1
	*SUB.L	ENDADDR,D1
	MULU	#LEN_SAMPLE_MGT-4,D1
	ADD.L	D1,S_DEBSPL(A6)
	MOVE.L	ENDADDR,A2
	MOVE.L	DEBSPL,D3
	MOVE.L	S_DEBSPL(A6),D4
	
	
.GH	CMP.L	#0,LEN_MGT(A2)
	BEQ.S	.FG
	
	MOVE.L	LOOP_FIN_MGT(A2),D7
	SUB.L	LOOP_DEB_MGT(A2),D7
	
	MOVE.L	DEB_MGT(A2),D3
	
	SUB.L	D3,DEB_MGT(A2)
	SUB.L	D3,LOOP_DEB_MGT(A2)
	ADD.L	D4,DEB_MGT(A2)
	ADD.L	D4,LOOP_DEB_MGT(A2)
	
	MOVE.L	D7,LOOP_FIN_MGT(A2)	*SAMPLE_LOOP_LENGHT
					*BUF_LEN_MGT = SAMPLE_BUFFER_LENGHT
					*LEN_FIN_MGT = SAMPLE_END_LENGHT
	ADD.L	LEN_MGT(A2),D4
.FG	ADD.W	#LEN_SAMPLE_MGT-4,A2
	SUBQ.L	#1,D2
	BNE.S	.GH
	
	MOVE.L	ENDADDR,A1
	BSR	FWRITE
	RTS
*--------------------------------------------------------------------------
SAVE_SPL
	MOVEQ	#0,D2
	MOVEQ	#0,D3
	MOVE.W	S_NBSPL(A6),D2
	LEA	SAMPLE,A2
	
.AA	MOVE.L	LEN_MGT(A2),D1
	BEQ.S	.NO
	
	MOVE.L	DEB_MGT(A2),A1			* SAMPLE + LOOP
	MOVE.L	LOOP_FIN_MGT(A2),D1
	SUB.L	A1,D1
	ADD.L	D1,D3
	BSR	FWRITE
	
	MOVE.L	LOOP_FIN_MGT(A2),A1		* L'APRES LOOP
	ADD.W	LEN_BUF_MGT(A2),A1		* S'IL Y A
	MOVE.L	LEN_FIN_MGT(A2),D1
	ADD.L	D1,D3
	BSR	FWRITE
	
.NO	ADD.W	#LEN_SAMPLE_MGT,A2
	SUBQ.W	#1,D2
	BNE.S	.AA
	
	MOVE.L	D3,S_LENSPL(A6)
	RTS
*--------------------------------------------------------------------------
s_avr
s_sam
s_s3m
s_mad
save_patt
	RTS
	ENDC
***************************************************************************
INITMEG:	
	MOVEM.L	D0-D3/A0-A3,-(A7)
	LEA	SAMPLE,a1
	MOVE.L	#254,d0
.mega1	MOVE.L	#0,(a1)
	MOVE.L	#0,4(a1)
	MOVE.L	#0,8(a1)
	MOVE.L	#0,12(a1)
	MOVE.L	#0,16(a1)
	MOVE.B	#0,F_TUNE_MGT(a1)
	BCLR.B	#2,BIT1_MGT+1(A1)
	BCLR.B	#1,BIT1_MGT+1(A1)
	BCLR.B	#0,BIT1_MGT+1(A1)
	MOVE.L	#0,DEB_MGT(a1)
	MOVE.L	#0,LEN_MGT(a1)
	MOVE.L	#0,FIN_MGT(a1)
	MOVE.W	#$400,VOL_MGT(a1)
	MOVE.L	#0,LOOP_DEB_MGT(a1)
	MOVE.L	#0,LOOP_FIN_MGT(a1)
	MOVE.W	#0,LEN_BUF_MGT(A1)
	MOVE.L	#0,LEN_FIN_MGT(A1)
	LEA	LEN_SAMPLE_MGT(a1),a1
	dbf	d0,.mega1

	MOVEM.L	RIEN,D0-D2
	MOVE.L	DEBMUS,A0
	MOVE.L	DEBPATT,A2
	MOVE.L	DEBTABTRACK,A4

	MOVE.B	maxmus,D0		* CLEAN SEQUENCE & MUSIC
	SUBQ.W	#1,D0
.CC	MOVE.L	ADDDEB_MUS(A0),A1
	MOVE.W	LEN_MUS(A0),D1
	SUBQ.W	#1,D1
.WW	MOVE.W	#0,(A1)+
	DBF	D1,.WW
	MOVE.W	#0,RESTART_MUS(A0)
	MOVE.B	#6,I_SPEED_MUS(A0)
	MOVE.W	#6,SPEED
	MOVEM.L	D0/A2,-(A7)
	MOVE.L	#$7D,D0
	MOVE.B	D0,I_TEMPO_MUS(A0)
	BSR	SET_T2
	MOVEM.L	(A7)+,D0/A2
	MOVE.W	#$2020,I_MASTERVOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+32(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+36(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+30(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+44(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+48(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+52(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+56(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+60(A0)
	MOVEQ	#31,D3
.KL	MOVE.B	#0,(NAME_MUS)(A0,D3.W)
	DBF	D3,.KL
	ADD.W	#TOTAL_MUS,A0
	DBF	D0,.CC

	MOVE.W	maxpatt,D1		* CLEAN PATT
	SUBQ.W	#1,D1
.XX	MOVEQ	#32-1,D0
	ADDQ.W	#2,A2
.VV	MOVE.W	D2,(A2)+
	DBF	D0,.VV
	DBF	D1,.XX

	MOVE.W	maxtrack,D1		* CLEAN TRACK
	SUBQ	#1,D1
.JJ	MOVE.L	(A4)+,A3
	MOVE.W	(A3)+,D0
	SUBQ.W	#1,D0
.BB	MOVE.L	D2,(A3)+
	MOVE.W	D2,(A3)+
	DBF	D0,.BB
	DBF	D1,.JJ

	MOVE.W	#0,TICK
	MOVE.W	#6,SPEED
	MOVEM.L	(A7)+,D0-D3/A0-A3
	RTS
***************************************************************************
*	A1 = ADD FILENAME
FCREATE	CLR.W	-(A7)
 	MOVE.L	A1,-(A7)
 	MOVE.W	#$3C,-(A7)
 	TRAP	#1
 	ADDQ.L 	#8,A7
 	MOVE.W	D0,HANDLE
	RTS
***************************************************************************
*	A1 = ADD FILENAME
FOPEN	CLR.W	-(A7)
 	MOVE.L	A1,-(A7)
 	MOVE.W	#$3D,-(A7)
 	TRAP	#1
 	ADDQ.L 	#8,A7
 	MOVE.W	D0,HANDLE
	RTS
HANDLE	DC.W	0
***************************************************************************
*	D1 = QUEL OCTET CHERCHER A PARTIR DU DEBUT
FSEEK	MOVE.W	#0,-(A7)
 	MOVE.W	HANDLE,-(A7)
 	MOVE.L	D1,-(A7)
 	MOVE.W	#$42,-(A7)
 	TRAP 	#1
 	ADD.L 	#10,A7
	RTS
***************************************************************************
*	A1 = ADD DATA
*	D1 = LEN DATA
FWRITE	MOVE.L	A1,-(A7)
 	MOVE.L	D1,-(A7)
 	MOVE.W	HANDLE,-(A7)
 	MOVE.W	#$40,-(A7)
 	TRAP 	#1
 	ADD.L 	#12,A7
	RTS
***************************************************************************
FCLOSE	MOVE.W	HANDLE,-(A7)
 	MOVE.W	#$3E,-(A7)
 	TRAP 	#1
 	ADDQ.L	#4,A7
	RTS
***************************************************************************
*	A1 = DATA SAMPLE
FIRST_ZEROFINSPL
	MOVEM.L	D0/A0-A2,-(A7)
	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.W	LEN_BUF_MGT(A1),D0
	MOVE.L	A0,A2
	ADD.L	D0,A0
	MOVE.L	LEN_FIN_MGT(A1),D0
	BEQ.S	.BB
.AJOU	MOVE.B	(A2)+,(A0)+
	SUBQ.L	#1,D0
	BNE.S	.AJOU
	
.BB	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.W	LEN_BUF_MGT(A1),D0
	SUBQ.W	#1,D0
.AJOU3	MOVE.B	#0,(A0)+
	DBF	D0,.AJOU3	
	MOVEM.L	(A7)+,D0/A0-A2
	RTS
***************************************************************************
*	A1 = DATA SAMPLE
ZEROFINSPL
	MOVEM.L	D0/A0,-(A7)
	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.W	LEN_BUF_MGT(A1),D0
	SUBQ.W	#1,D0
.AJOU3	MOVE.B	#0,(A0)+
	DBF	D0,.AJOU3	
	MOVEM.L	(A7)+,D0/A0
	RTS
***************************************************************************
*	A1 = DATA SAMPLE
FIRST_BCLFINSPL
	MOVEM.L	D0/A0-A2,-(A7)
	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.L	A0,A2
	ADD.W	LEN_BUF_MGT(A1),A0
	MOVE.L	LEN_FIN_MGT(A1),D0
	BEQ.S	.AA
.AJOU2	MOVE.B	(A2)+,(A0)+
	SUBQ.L	#1,D0
	BNE.S	.AJOU2
	
.AA	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.L	LOOP_DEB_MGT(A1),A2
	MOVE.W	LEN_BUF_MGT(A1),D0
	SUBQ.W	#1,D0
.AJOU3	MOVE.B	(A2)+,(A0)+
	DBF	D0,.AJOU3
	MOVEM.L	(A7)+,D0/A0-A2
	RTS
***************************************************************************
*	A1 = DATA SAMPLE
BCLFINSPL
	MOVEM.L	D0/A0-A2,-(A7)
	MOVE.L	LOOP_FIN_MGT(A1),A0
	MOVE.L	LOOP_DEB_MGT(A1),A2
	MOVE.W	LEN_BUF_MGT(A1),D0
	SUBQ.W	#1,D0
.ajou2	MOVE.B	(A2)+,(A0)+
	DBF	D0,.ajou2
	MOVEM.L	(A7)+,D0/A0-A2
	RTS
***************************************************************************
FRE:	MOVE.L	$42E.W,D0			*FRE(0)
	MOVE.L	ENDADDR,D1
	SUB.L	D1,D0
	MOVE.L	D0,freemem
	LEA	freem,A0
	BSR	CONVERT_HEXA_DECIASCII
	MOVE.L	#screen+640*72+560+1,where
	MOVE.W	#1,compt2
	LEA	freem,A0
	MOVEQ	#8,D1
	BSR	PRINT
	RTS
*************************************************************************
*	Recherche d'une place libre pour un sample
*	Retour : A1 = Adresse libre dans SAMPLE
*	       here = Numero de l'emplacement libre
SEARCHFREESPL
	MOVE.B	#0,sampledata
	LEA	SAMPLE,a1
.next	CMP.L	#0,LEN_MGT(a1)
	beq.s	.good
	ADD.l	#LEN_SAMPLE_MGT,a1
	ADDQ.b	#1,sampledata
	bra.s	.next
.good	MOVE.B	sampledata,curentnb2
	RTS
here	dc.b	0
	even
	
**************************************************************************
*	Saver
*	A0 = Adresse ou se trouve le nom du fichier
*	A1 = Adresse de debut
*	D1 = Longueur
SAVE 	clr.W 	-(sp)
 	MOVE.L	a0,-(a7)
 	MOVE.W #$3c,-(sp)
 	trap 	#1
 	ADDQ.l 	#8,sp

 	MOVE.W d0,d2
 	MOVE.L a1,-(sp)
 	MOVE.L d1,-(sp)
 	MOVE.W d2,-(sp)
 	MOVE.W #$40,-(sp)
 	trap 	#1
 	ADD.l 	#12,sp

	MOVE.W d2,-(sp)
 	MOVE.W #$3e,-(sp)
 	trap 	#1
 	ADDQ.l #4,sp
	RTS
***********************************************************************
*	Loader
*	A0 = Adresse ou se trouve le nom du fichier
*  ENDADDR = Adresse ou charger le fichier
LOAD:
	CMP.B	#'A',DRV
	BEQ.S	.NOT_TIME
	CMP.B	#'B',DRV
	BEQ.S	.NOT_TIME
	MOVE.B	playsong,D0
	ADD.B	playpat,D0
	CMP.B	#0,D0
	BEQ.S	.NOT_TIME
	BRA	.TIME	
.NOT_TIME
	
	BSR	OFF_134
	MOVE.W	#1,POL
	
.TIME	MOVE.W	#2,-(SP)		
	MOVE.L 	A0,-(SP)
	MOVE.W	#$3D,-(SP)		
	TRAP	#1		
	ADDQ.L	#8,SP		
	MOVE.W	D0,D7		
	TST.W	D0		
	BMI.S	PASFICHIER
	MOVE.L	ENDADDR,-(a7)
	PEA	$EFFFFF		
	MOVE.W	D0,-(SP)	
	MOVE.W	#$3F,-(SP)	
	TRAP	#1		
	ADDA.L	#$C,SP
	MOVE.L	d0,long
	MOVE.W	D7,-(SP)	
	MOVE.W	#$3E,-(SP)	
	TRAP	#1		
	ADDQ.L	#4,SP
	MOVE.L	long,d0
	MOVE.L	ENDADDR,a0
	BSR	DEC_23R
	MOVE.L	ENDADDR,a0
	BSR	DEC_AT35
	MOVE.L	d0,long
	MOVE.L	#0,$FFFF9800.W
	BRA.S	PAS1
PASFICHIER	
	MOVE.W	#1,erreur
PAS1	CMP.W	#1,POL
	BEQ.S	.PAS2
	RTS
.PAS2	
	*MOVE.L	#MY_134,$134.W
	MOVE.W	#0,POL
	RTS
	
RTE_134	RTE	


DEC_23R		INCBIN	D:\BOSS\DATA\DEC_23R.BIN
DEC_AT35	INCBIN	D:\BOSS\DATA\DEC_AT35.BIN
POL		DC.W	0
********************************************************************
*	d0 = # of sample in memory
SEARCHSAMPLE
	MOVEQ	#0,d0
	MOVE.B	sampledata,d0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a0
	ADD.l	d0,a0
;	CMP.L	#0,LEN_MGT(a0)
;	beq.s	nosample	
	MOVE.L	a0,current
	RTS
;nosample
;	MOVE.L	#0,current
;	RTS
***************************************************************************

pile		dc.l	0	*Sauvegarde de la pile
pile1		dc.l	0	*Adresse de la pile superviseur
touche		dc.W	0	*Numero de la derniere touche pressee
curentnb	dc.b	1	*Numero du sample actuel
	even
current         dc.l    0       *Adresse des donnees sur le sample actuel
ENDADDR         dc.l    s1      *Start adress of free memory
freemem		dc.l	0	*Free memory
fin		dc.W	0	*Quit prg
long		dc.l 	0	*Longueur d'un fichier charge
waiting         dc.W	0       *Wait VBL
lastkey     	dc.b	23	*evite la repetition des touches
sampledata	dc.b	0	*Numero du sample affiche sur l'ecran
erreur		dc.W	0	*Code d'erreur : 1 - File not found
				*		 2 - Too much sample in memory
				*                3 - Not enough memory
				*		 4 - Incorrect filename
				*		 5 - Esc pressed

okp		dc.W	0	*Code		 : 1 - Fileselect en cours
				*		   2 - Input en cours
				*		   3 - Traitement du fichier charge
				*		   4 - Erase sample
				*		   5 - Erase pattern
				*		   6 - Convert SPE - SPL
				*		   7 - Scroll Fileselect
				*		   8 - Tri des fichiers
				*		   9 - Loading
				*		  10 - Saving
				*		  11 - Printing pattern
				*		  12 - Efface contour pattern
				*		  13 - Print pattern while playing
				*		  14 - Up pattern
				*		  15 - Down pattern
				*		  16 - Divise par 2
				*		  17 - Divise par 3
				*		  18 - Divise par 4

totalsample	dc.b	0	*Nombre total de sample in memory
curentnb2	dc.b	1
curentmask	dc.b	3	*Mask actuel
voies		dc.b	32 	*Nb de voies activees
cvoies		dc.b	32*6	*voies * octets dans 1 lignes pattern
digvoices	dc.b	2	*Nb de voies digitales
curvoie		dc.b	0	*Voie courante    (0 -> 31)
curmus		dc.b	0	*Musique courante (0 -> 255)
curpos		dc.w	0	*Position courante(0 -> 65535)
curpatt		dc.w	0	*Pattern courante (0 -> 65535)
curlen		dc.w	0	*Longueur de la zic courante (0 -> 65535)
curlop		dc.w    0       *Loop de la zic courante     (0 -> 65535)
curspl		dc.b	0	*Sample courant   (0 -> 255)
maxmus		dc.b	0	*Nb de zic maximum
maxpos		dc.w	0	*                            (0 -> 65535)
maxpatt		dc.w	0	*Pattern maximum - 1
maxtrack	dc.w	0	*Piste maximum - 1
	even
DEBMUS		DC.L	MUSIQUE	
DEBSEQ		DC.L	SEQUENCE	
DEBPATT		DC.L	PATTERNS	*Adresse debut pattern
DEBTABTRACK	DC.L	TABTRACK	*Adresse debut table pointant sur les pistes	
DEBTRACK	DC.L	TRACK		*Adresse debut des pistes	
DEBSPL		DC.L	s1	 	*Adresse debut spl
ADDCURSEQ	DC.L	SEQUENCE	*Adresse sequence courante
ADDCURPATT	DC.L	PATTERNS 	*Adresse pattern courante
ADDCURSPL	DC.L	0		*Adresse sample courant dans SAMPLE
lensamples	DC.L	0		*Longueur de tous les samples
LENCURPATT	DC.W	0

		even
***************************************************************************
SPLTSPE
	MOVEM.L	D0-A0/A1,-(A7)
	MOVE.L	heretoconvert,a1
	BSR.S	SPLTOSPE
	MOVEM.L	(A7)+,D0-A0/A1
	MOVE.W	#0,okp
	RTS
**************************************************************************
*	SPL to SPE convertor
*	A1 = Adress of data sample	* en entree
*	A0 = Adress of the sample	* interne
*	D0 = Lenght of the sample	* interne
SPLTOSPE
	MOVE.L	DEB_MGT(a1),a0
	MOVE.L  LEN_MGT(a1),d0
	MOVE.B	#$80,d1
.again	ADD.b	d1,(a0)+
	subq.l	#1,d0
	BNE.S	.again
oout	RTS
***************************************************************************
*	Erase a sample
ERASE	MOVE.B	#0,KEY
	MOVEM.L	a0-a3/d0-d4,-(a7)
	BSR	OFF_134
	MOVEQ	#0,d0
	MOVEQ	#0,d1
	MOVEQ	#0,d7
	MOVE.B	sampledata,d0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a0
	ADD.L	d0,a0
	MOVE.L	DEB_MGT(a0),a3		*Debut de l'ancien sample   = A3
	MOVE.L	LEN_MGT(a0),d3		*Longeur de l'ancien sample = D3
	CMP.L	#0,d3			*Veut-il effacer un sample qui n'est pas en memoire
	BEQ	.nospl
	MOVEQ	#0,D4
	MOVE.W	LEN_BUF_MGT(A1),D4
	ADD.L	D4,D3
	ADD.L	LEN_FIN_MGT(A1),D3
	MOVE.B	totalsample,d1
	CMP.B	#1,d1			*1 seul sample en memoire
	BEQ.S	.pasdesuite
	CMP.B	#0,d1			*Aucun sample en memoire
	BEQ	.nospl
	MOVE.L	#255,d1
	MOVEQ	#0,d4
	;subq.W	#1,d1	
	LEA	SAMPLE,a1
.rep2	CMP.L	#0,DEB_MGT(a1)		*Y a-t-il un sample ?
	BEQ.S	.oncontinu
	MOVE.L	DEB_MGT(a1),a2
	CMP.L	a3,a2			*Est-il avant celui qu'on efface ?
	BLS.S	.oncontinu
	SUB.L	D3,DEB_MGT(a1)		*Calcul la nouvelle START ADRESS
	SUB.L	D3,FIN_MGT(a1)		*idem pour END ADRESS
	SUB.L	D3,LOOP_DEB_MGT(a1)	*idem pour LOOP ADRESS
	SUB.L	D3,LOOP_FIN_MGT(a1)
	ADD.L	LEN_MGT(a1),D4		*On calcul la longeur total des spl suivants
	MOVE.W	LEN_BUF_MGT,D7
	ADD.L	D7,D4
	ADD.L	LEN_FIN_MGT(A1),D4
.oncontinu
	ADD.L	#LEN_SAMPLE_MGT,a1
	DBF	d1,.rep2
	CMP.L	#0,d4			* C'etait le dernier sample ?
	BEQ.S	.pasdesuite
	MOVE.L	a3,a2
	ADD.L	d3,a2
.rep3	MOVE.B	(a2)+,(a3)+		*Et on recopie tout le reste la ou
	SUBQ.L	#1,d4			*l'ancien sample etait
	BNE.S	.rep3
.pasdesuite
	SUB.L	d3,ENDADDR
	SUB.L	d3,lensamples
	MOVE.L	a0,a1
	MOVE.W	#LEN_SAMPLE_MGT-1,d1
.rep5	MOVE.B	#0,(a0)+		*on efface ses donnees
	DBF	D1,.rep5
.rep4	MOVE.B	#0,(a3)+		*on efface le sample
	SUBQ.B	#1,d3
	BNE.S	.rep4
	SUBQ.B	#1,totalsample
	BSR	FRE
.nospl	MOVEM.L	(A7)+,A0-A3/D0-D4
	RTS
***************************************************************************
SHIFT_RIGHT_D
	MOVE.B	#1,SHIFT_RIGHT
	MOVE.B	#0,KEY
	RTE
***************************************************************************
SHIFT_RIGHT_U
	MOVE.B	#0,SHIFT_RIGHT
	MOVE.B	#0,KEY
	BSR	RECORD	
	RTE
***************************************************************************
SHIFT_LEFT_D
	MOVE.B	#1,SHIFT_LEFT
	MOVE.B	#0,KEY
	RTE
***************************************************************************
SHIFT_LEFT_U
	MOVE.B	#0,SHIFT_LEFT
	MOVE.B	#0,KEY
	RTE
***************************************************************************
CAPS_LOCK_D
	MOVE.B	#1,CAPS_LOCK
	MOVE.B	#0,KEY
	RTE
***************************************************************************
CAPS_LOCK_U
	MOVE.B	#0,CAPS_LOCK
	MOVE.B	#0,KEY
	BSR	PLAYSONG
	RTE
***************************************************************************
ALTERNATE_U
	MOVE.B	#0,ALTERN
	MOVE.B	#0,KEY
	RTE
***************************************************************************
ALTERNATE_D
	MOVE.B	#1,ALTERN
	MOVE.B	#0,KEY
	RTE
***************************************************************************
CONTROLE_U
	MOVE.B	#0,CONTRO
	MOVE.B	#0,KEY
	RTE
***************************************************************************
CONTROLE_D
	MOVE.B	#1,CONTRO
	MOVE.B	#0,KEY
	RTE
***************************************************************************
*	Keyboard rout
*	touche = # of the sample, or space bar
KEYB	
	MOVEQ	#0,D0
	MOVE.B	KEY,D0
	BEQ	.KEYB5
	
	CMP.B	lastkey,D0
	BEQ.S	.KEYB1
	MOVE.B	D0,lastkey
	MOVE.W	D0,touche
	MOVE.B	#0,WAIT3
	MOVE.B	#0,WAIT2
	RTS
.KEYB1	CMP.B	#1,WAIT2
	BEQ.S	.KEYB4
	ADDQ.B	#1,WAIT3
	CMP.B	#15,WAIT3
	BEQ.S	.KEYB2
	MOVE.W	#-1,touche
	RTS
.KEYB2	MOVE.B	#1,WAIT2
	MOVE.B	#0,WAIT3
	MOVE.W	D0,touche
	RTS
.KEYB4	ADDQ.B	#1,WAIT3
	CMP.B	#3,WAIT3
	BNE.S	.KEYB5
	MOVE.B	#0,WAIT3
	MOVE.W	D0,touche
	RTS
.KEYB5	MOVE.W	#-1,touche
	RTS
***************************************************************************
CAPS_LOCK	DC.B	0
SHIFT_RIGHT	DC.B	0
SHIFT_LEFT	DC.B	0
ALTERN		DC.B	0
CONTRO		DC.B	0
WAIT2		DC.B	0
WAIT3		DC.B	0
DRUM		DC.B	1	* SI = 0 ALORS ON EST EN MODE DRUM
	EVEN			* SI = 1 ALORS ON EST EN MODE FRQ
				* Ne pas oublier de nettoyer touche
*	touche = note or space bar
**************************************************************************
INPUT			*	Le retour
	MOVE.B	#0,KEY
	CMP.W	#0,okp
	BNE.S	.cokp
	MOVEQ	#0,d0
	MOVE.B	sampledata,d0
	MULU	#LEN_SAMPLE_MGT,d0
	LEA	SAMPLE,a0
	ADD.l	d0,a0
	MOVE.L	a0,string
	MOVE.L	#screen+32000+113*160+46,where2
	MOVE.W	#0,compt
	MOVE.B	#20,maxlet
	MOVE.W	#2,okp
.cokp	RTS
string	DC.L	0
where2	DC.L	0
maxlet	dc.b	0
	even

INPT2	MOVE.B	#0,lastouche
	BSR.S	INPT
	MOVE.B	#0,touche
	MOVE.W	#0,okp
	RTS
	
INPT:	MOVEM.L	D0-D1/A0-A2,-(A7)
	MOVE.L	string,a0
	MOVE.L	a0,a1
	MOVEQ	#0,D1
	MOVEQ	#0,D4
	MOVE.B	maxlet,d1
.onyva	MOVE.B	#'',D4
	MOVE.L	where2,where
	
	BSR	AFFICHE
	
.onyva2	BSR	INPUT2
	cmp.b	#$d,d0			* Si c'est RETURN ou ENTER
	beq.s	.fini1			* on va a la fin
	cmp.b	#$7f,d0			* Si c'est DEL
	beq	.del
	cmp.b	#8,d0			* ou BACKSPACE
	beq	.del			* on va en 'del'
	cmp.b	#$fd,d0			* Si c'est 'ESC'
	beq	.echap			* on annule tout
	cmp.b	#0,d0
	beq.s	.onyva2
	MOVE.B	D0,(A0)
	MOVE.B	D0,D4
	MOVE.L	where2,where
	
	BSR	AFFICHE
	
	subq.b	#1,d1			* Nb caracteres +1
	cmp.b  #0,d1
	BNE.S	.go
	MOVEQ	#1,d1	
	bra.s	.onyva
.go	ADDQ.L	#1,a0
	ADDQ.W	#1,compt
	CMP.W	#2,compt
	beq.s	.com2
	ADDQ.L	#1,where2
	bra.s	.com1
.com2	ADD.L	#15,where2
	MOVE.W	#0,compt
.com1	bra	.onyva
.fini1	MOVE.B #'',D4
	MOVE.L	where2,where

	BSR	AFFICHE
	MOVEM.L	(a7)+,d0-d1/a0-a2
	RTS
	
.del	cmp.b	#20,D1
	bge	.onyva
	
	ADDQ.B	#1,D1
	MOVE.B	#0,D4
	MOVE.L	where2,where
	
	BSR 	AFFICHE
	
	SUBQ.W	#1,A0
	MOVE.B	#0,(A0)
	ADDQ.W	#1,compt
	CMP.W	#2,compt
	beq.s	.co1
	sub.l	#15,where2
	bra.s	.co2
.co1	subq.l	#1,where2
	MOVE.W	#0,compt
.co2	bra	.onyva
.echap	MOVE.W	#5,erreur
	MOVEm.l	(a7)+,d0-d1/a0-a2
	RTS

compt	dc.W	0
************************************************************************
*	Simule la fonction   #A  du  trap #1
*	Retour : D0 = Caractere
INPUT2	MOVEm.l	d1/a1,-(a7)
	MOVEQ	#0,d0
	MOVEQ	#0,d1
	MOVE.B	KEY,d1
.gti	MOVE.B	KEY,d0
	cmp.b	d0,d1
	beq.s	.gti
.ici	LEA	SCANCODE,a1
.deja	MOVE.B	KEY,d0
	cmp.b	#0,d0
	BNE.S	.deja2
	MOVE.B	d0,lastouche
	bra.s	.deja
.deja2	cmp.b	lastouche,d0
	beq.s	.deja
	MOVE.B	d0,lastouche
.cont2	cmp.b	#-1,(a1)
	beq.s	.findescodes
	cmp.b	(a1)+,d0
	beq.s	.ca
	ADDQ.l	#1,a1
	bra.s	.cont2
.ca	MOVE.B	(a1),d0
	MOVEm.l	(a7)+,d1/a1
	RTS
.findescodes
	MOVEQ	#0,d0
	MOVEm.l	(a7)+,d1/a1
	RTS

compt2		dc.W	0
lastouche	dc.b	0
	even
**************************************************************************
AFFICHE:		* D4 = Numero du caractere
	MOVE.L	where,A4
	MOVE.L	ADDFONT,A5
	
	cmp.b	#'',D4
	beq.S	.cursor
	cmp.b	#0,D4
	beq.S	.blank
	cmp.b	#' ',D4
	beq.S	.blank
	ADD.W	D4,A5
	
	MOVE.B	(A5),(A4)
	MOVE.B	$100(A5),640(A4)
	MOVE.B	$200(A5),640*2(A4)
	MOVE.B	$300(A5),640*3(A4)
	MOVE.B	$400(A5),640*4(A4)
	MOVE.B	$500(A5),640*5(A4)
	MOVE.B	$600(A5),640*6(A4)
	MOVE.B	$700(A5),640*7(A4)
	RTS
	
.blank	MOVEQ	#0,D4
	MOVE.B	D4,(A4)
	MOVE.B	D4,640(A4)
	MOVE.B	D4,640*2(A4)
	MOVE.B	D4,640*3(A4)
	MOVE.B	D4,640*4(A4)
	MOVE.B	D4,640*5(A4)
	MOVE.B	D4,640*6(A4)
	MOVE.B	D4,640*7(A4)
	RTS
	
.cursor not.b	(A4)
	not.b	640(A4)
	not.b	640*2(A4)
	not.b	640*3(A4)
	not.b	640*4(A4)
	not.b	640*5(A4)
	not.b	640*6(A4)
	not.b	640*7(A4)
	RTS

where	DC.L	0		* Adresse ou afficher le caractere
**********************************************************************
CLRKEYB
	MOVE.W #$b,-(a7)		*
	trap #1		        	*
	ADDQ.l	#2,a7			*
	tst.W	d0			*
	beq.s	.gogo			* C'est pour vider le tampon	
	MOVE.W	#7,-(a7)		* du clavier
	trap #1			        *
	ADDQ.l	#2,a7			*
	bra.s	CLRKEYB		        *
.gogo	RTS
**************************************************************************
* Simule la fonction PRINT
* A0=Adresse ou se trouve le text
* A1=Adresse ou afficher sur l'ecran
* D1=Longueur du TXT

PRINT:	MOVEM.L	A0/A4-A5/D4,-(A7)
	MOVEQ	#0,D4
.again2	ADDQ.W	#1,compt2
	CMP.W	#2,compt2
	BEQ.S	.cco1
	ADDQ.L	#1,where
	BRA.S	.cco2
.cco1	ADD.L	#15,where
	MOVE.W	#0,compt2
.cco2	MOVE.B	(A0)+,D4
	BSR	AFFICHE
	SUBQ.W	#1,D1
	BNE.S	.again2
	MOVEM.L (A7)+,A0/A4-A5/D4
	RTS
***************************************************************************
UPCURSOR7
	CMP.B	#1,record
	BEQ	VOL_OK
	CMP.B	#1,playpat
	BEQ	VOL_OK
	CMP.B	#1,playsong
	BEQ	VOL_OK
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	ADDQ.W	#7,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.W	D1,D0
	BLE.S	.GOOD
	SUB.W	LENCURPATT,D0
.GOOD	MOVE.B	D0,inpatt
	MULU	#6,D0
	MOVE.W	D0,inpatt2
	BSR	OPTI
	BSR	AFFPATTERN
	BSR	OPTI
	RTS
UPCURSOR
	CMP.B	#1,record
	BEQ.S	.rr
	CMP.B	#1,playpat
	BEQ.S	.rr
	CMP.B	#1,playsong
	BEQ.S	.rr
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.B	D1,D0
	BGE.S	.rr2
	BSR	OPTI
	BSR	AFFPATTERN		*PATTUP
	BSR	OPTI
	ADDQ.B	#1,inpatt
	ADDQ.W	#6,inpatt2
.rr	RTS
.rr2	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
	BSR	OPTI
	BSR	AFFPATTERN
	BSR	OPTI
	RTS
***************************************************************************
DOWNCURSOR7
	CMP.B	#1,record
	BEQ	VOL_OK
	CMP.B	#1,playpat
	BEQ	VOL_OK
	CMP.B	#1,playsong
	BEQ	VOL_OK
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	SUBQ.W	#7,D0
	BPL.S	.GOOD1
	ADD.W	LENCURPATT,D0
.GOOD1	MOVE.B	D0,inpatt
	MULU	#6,D0
	MOVE.W	D0,inpatt2
	BSR	OPTI
	BSR	AFFPATTERN
	BSR	OPTI
	RTS
DOWNCURSOR
	CMP.B	#1,record
	BEQ.S	.rr3
	CMP.B	#1,playpat
	BEQ.S	.rr3
	CMP.B	#1,playsong
	BEQ.S	.rr3
	CMP.B	#0,inpatt
	BEQ.S	.rr4
	SUBQ.B	#1,inpatt
	SUBQ.W	#6,inpatt2
	BSR	OPTI
	BSR	AFFPATTERN		*PATTDOWN
	BSR	OPTI
.rr3	RTS
.rr4	MOVEQ	#0,D0
	MOVE.W	LENCURPATT,D0
	SUBQ.W	#1,D0
	MOVE.B	D0,inpatt
	MULU	#6,D0
	MOVE.W	D0,inpatt2
	BSR	OPTI
	BSR	AFFPATTERN
	BSR	OPTI
	RTS
***************************************************************************
CHECKNOTE
	MOVEM.L	D0-D1/A1,-(A7)
	LEA	DIGICORRES,A1
	TST.B	D0
	BEQ.S	.FL
	SUBQ.W	#1,D0
	MOVE.W	D0,D1
	ADD.W	D0,D0
	ADD.W	D1,D0
	ADD.W	D0,A1
	MOVE.B	(A1),(A2)
	MOVE.B	1(A1),1(A2)
	MOVE.B	2(A1),2(A2)
	BRA.S	.FINLOOP
.FL	MOVE.B	#'-',(A2)
	MOVE.B	#'-',1(A2)
	MOVE.B	#'-',2(A2)
.FINLOOP	
	MOVEM.L	(A7)+,D0-D1/A1
	RTS
**********************************************************************
AFFPARTIPATT
	MOVEM.L	D0-D2/A0-A2,-(A7)
	CMP.L	#-1,a0
	beq	.empty
	MOVEQ	#0,d0
	MOVEQ	#0,d1
	LEA	pattt,a2
	MOVE.B	(a0),d0
	BSR.S	CHECKNOTE
	
	LEA	hexa,A1
	
	MOVE.B	1(A0),D0
	MOVE.W	D0,D1
	AND.B	#$F,D0
	MOVE.B  (A1,D0.W),4(A2)
	LSR.B	#4,D1
	MOVE.B	(A1,D1.W),3(A2)
	CMP.B	#'0',3(A2)
	BNE.S	.Q1
	MOVE.B	#' ',3(A2)
	CMP.B	#'0',4(A2)
	BNE.S	.Q1
	MOVE.B	#' ',4(A2)
	
.Q1	MOVEQ	#7,D1
	MOVEQ	#0,D0
	MOVE.L	2(A0),D2
.WW	MOVE.B	D2,D0
	AND.B	#$F,D0
	MOVE.B	(A1,D0.W),5(A2,D1.W)
	LSR.L	#4,D2
	DBF	D1,.WW
	
	MOVEQ	#13,D1
	LEA	pattt,A0
	BSR	PRINT
	LEA	cp,A0
	LEA	pattt,A1
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.B	(A0)+,(A1)+
	MOVEM.L	(A7)+,D0-D2/A0-A2
	RTS
.empty	LEA	vvide,A0
	MOVEQ	#13,D1
	BSR	PRINT
	MOVEM.L	(A7)+,D0-D2/A0-A2
	RTS
pattt	dc.b '---0000000000',0
cp	dc.b '---0000000000',0
vvide	dc.b '             '
	even	
***************************************************************************
AFFNUMTRACK	DC.L	screen2-640*9+65,screen2-640*9+192,screen2-640*9+305,screen2-640*9+432,screen2-640*9+545
AFFNBTRACK	DC.L	screen2+65,screen2+192,screen2+305,screen2+432,screen2+545
AFFNBCOMPT	DC.W	1,0,1,0,1
***************************************************************************
AFFPATTERN:
	MOVE.W	#11,okp
	RTS
	
AFFPATTERN2
	BSR	AFFPATTERN3
	CMP.W	#11,okp
	BNE.S	.OUT
	MOVE.W	#0,okp
.OUT	RTS

AFFPATTERN3
	MOVEQ	#0,D0
	MOVEQ	#4,D3			* Nb de voies a afficher -1
	MOVEQ	#0,D7

.AA	BSR	AFF_ONE_TRACK
	ADDQ.B	#1,D7
	DBF	D3,.AA


	MOVEQ	#0,D0
	MOVEQ	#0,D3
	MOVE.B	inpatt,D0
	SUBQ.W	#7,D0
	MOVE.L	#screen+640*382-11+15,where
	
.thro	MOVE.W	#0,compt2
	CMP.W	#0,D0
	BLT.S	.negatif
	CMP.W	LENCURPATT,D0
	BGE.S	.negatif
	
	LEA	cs,A0
	LEA	hexa,a1
	MOVE.L	D0,D4
	MOVE.L	D0,D7
	AND.W	#$F,D7
	MOVE.B  (A1,D7.W),1(A0)
	LSR.B	#4,D4
	MOVE.B	(A1,D4.W),(A0)
	BRA.S	.positif
	
.negatif
	LEA	cv,A0
.positif
	MOVEQ	#2,d1
	BSR	PRINT
	ADD.L	#640*7+624,where
	ADDQ.W	#1,D0
	ADDQ.B	#1,D3
	CMP.W	#15,D3
	BEQ.S	.nif
	BRA.S	.thro
.nif	RTS
	
patt:	DC.L	VOICE,VOICE+113,VOICE+240,VOICE+353,VOICE+480
ccompt2	DC.W	0,1,0,1,0

bo		DC.W	0
cv		DC.B    '  '
cs		DC.B    '00'
***************************************************************************
AFFDATA
	MOVEM.L	D0-D2/A0-A2,-(A7)
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	LEA	pat,A2
	MOVE.B	#'-',(A2)
	MOVE.B	#'-',1(A2)
	MOVE.B	#'-',2(A2)
	MOVE.B	(A3),D0
	BSR	CHECKNOTE
	
	LEA	hexa,a1
	MOVE.B	1(a3),d0
	MOVE.W	d0,d1
	AND.B	#$f,d0
	MOVE.B  (a1,d0.W),4(a2)
	LSR.B	#4,d1
	MOVE.B	(a1,d1.W),3(a2)
	CMP.B	#'0',3(A2)
	BNE.S	.Q1
	MOVE.B	#' ',3(A2)
	CMP.B	#'0',4(A2)
	BNE.S	.Q1
	MOVE.B	#' ',4(A2)
	
.Q1	MOVEQ	#7,D1
	MOVEQ	#0,D0
	MOVE.L	2(A3),D2
.WW	MOVE.B	D2,D0
	AND.B	#$F,D0
	MOVE.B	(A1,D0.W),5(A2,D1.W)
	LSR.L	#4,D2
	DBF	D1,.WW

	MOVEQ	#0,D1
	MOVE.W	wherevoice,d0
	DIVU	#6,D0
	LEA	wb,A0
	MOVE.B	(A0,D0.W),D1
	MOVE.W	D1,compt2
	LEA	wa,A0
	MOVE.L	(A0,D0.W*4),where
	LEA	pat,A0
	MOVEQ	#13,D1
	BSR	PRINT
	MOVEM.L	(A7)+,D0-D2/A0-A2
	RTS
	
hexa	dc.b 	'0123456789ABCDEF'
pat	dc.b 	'---0000000000'
	even	
	
	
wa	dc.l	CUR,CUR+113,CUR+240,CUR+353,CUR+480
	dc.l	CUR+640*80,CUR+640*80+113,CUR+640*80+240,CUR+640*80+353,CUR+640*80+480
	dc.l	CUR+640*160,CUR+640*160+113,CUR+640*160+240,CUR+640*160+353,CUR+640*160+480
	dc.l	CUR+640*240,CUR+640*240+113,CUR+640*240+240,CUR+640*240+353,CUR+640*240+480
	dc.l	CUR+640*320,CUR+640*320+113,CUR+640*320+240,CUR+640*320+353,CUR+640*320+480
	dc.l	CUR+640*400,CUR+640*400+113,CUR+640*400+240,CUR+640*400+353,CUR+640*400+480
	dc.l	CUR+640*480,CUR+640*480+480

wb	dc.b	0,1,0,1,0
	dc.b	0,1,0,1,0
	dc.b	0,1,0,1,0
	dc.b	0,1,0,1,0
	dc.b	0,1,0,1,0
	dc.b	0,1,0,1,0
	dc.b	0,0

	even
zerotou	dc.W	0
***************************************************************************
CHECKPATT:
	CMP.B	#0,edit			* si = 1 alors edit
	BEQ	.paricilasortie
	
.on_edit	
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	
	MOVE.B	curvoie,D1
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D1.W),D1
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D1.W*4),A0
	MOVE.L	ADDCURTRACK(A0),A0
	CMP.L	DEBTRACK,A0
	BEQ	.paricilasortie
	MOVE.W	inpatt2,D1
	ADD.W	D1,A0
	
	CMP.W	#1,zerotou
	BNE.S	.gou
	
	MOVE.L	D0,(A0)
	MOVE.W	D0,4(A0)
	MOVE.B	D0,recnote
	MOVE.B	D0,recinst
	BRA	.BOU
	
.gou	CMP.B	#1,DRUM
	BEQ	.GUO

	MOVE.B	recinst,D0
	MOVE.B	D0,D1
	SUBQ.B	#1,D0
	MULU	#LEN_SAMPLE_MGT,D0
	LEA	SAMPLE,A1
	ADD.L	D0,A1
	CMP.L	#0,LEN_MGT(A1)
	BEQ	.paricilasortie
	
	MOVE.B	NOTE_MGT(A1),(A0)
	MOVE.B	D1,1(A0)
	MOVE.B	COMMAND_MGT(A1),2(A0)
	MOVE.W	PARAM_MGT(A1),3(A0)
	MOVE.B	#0,5(A0)
	BRA	.BOU

.GUO	MOVEQ	#0,D1
	LEA	datawhat,A1
	MOVE.B	whatvoice,D1
	MOVE.L	(A1,D1.W*4),A1
	JSR	(A1)
	
	MOVE.B	#0,recnote
	MOVE.B	#0,recinst
	MOVE.B	#0,reccom
	MOVE.B	#0,receff
	MOVE.B	#0,recvol
	
.BOU	MOVE.L	A0,A3
	BSR	AFFDATA
	
	CMP.B	#0,playpat		* si on est en mode
	BNE.S	.rdd			* play pattern  alors
	
	BSR	JOUEVOIE
	
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.W	D1,D0
	BGE.S	.paricilasortie2
	
	MOVEQ	#0,D2
	MOVE.B	EDITSKIP,D2
	ADD.W	D2,D0
	CMP.W	D1,D0
	BLT.S	.AA
	MOVE.B	D1,D0
	NOP
.AA	MOVE.B	D0,inpatt
	MULU	#6,D0
	MOVE.W	D0,inpatt2
	
.rdd	BSR	AFFPATTERN		*PATTUP
	RTS
.paricilasortie2
	BSR.L	INVERT_EDIT
	MOVE.B	#0,edit
.paricilasortie
	RTS
	
edit	dc.b	0			* Etat de l'editeur
inpatt:	dc.b	0			* Compteur dans la patt
inpatt2	dc.w	0
***************************************************************************
PLAYPATT
	cmp.b	#1,playpat
	beq.s	.rt5
					* BSR	EFFPAT
	MOVE.B	#-1,inpatt
	MOVE.W	#-6,inpatt2
	BSR	AFFPATTERN
	BRA.S	.RT11
	
.rt5	CMP.B	#-1,inpatt
	BNE.S	.RT17
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
.RT17	BSR	AFFPATTERN

.RT11	BCHG	#0,playpat
	MOVE.W	#0,TICK
	BSR.L	INVERT_PLAYPATT
	
	CMP.B	#1,playsong
	BNE.S	RT14
	
	MOVE.B	#0,playsong
	BSR.L	INVERT_PLAYSONG
	
RT14	CMP.B	#1,record
	BNE.S	.rt9
	
	MOVE.B	#0,record
	BSR.L	INVERT_RECORD
	
.rt9	CMP.B	#1,edit
	BNE.S	.rt10
	
	MOVE.B	#0,edit
	BSR.L	INVERT_EDIT
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata
.rt10	RTS

playpat		dc.b	0		* Si = 1  alors mode PLAY PATT
playsong	dc.b	0		* Si = 1  alors mode PLAY SONG
***************************************************************************
PLAYSONG:
	CMP.B	#1,playsong
	BEQ.S	.RT12
					* BSR	EFFPAT
	MOVE.B	#-1,inpatt
	MOVE.W	#-6,inpatt2
	BSR	AFFPATTERN
	MOVE.B	#1,playsong
	MOVE.W	#0,TICK
	BSR.L	INVERT_PLAYSONG
	CMP.B	#1,playpat
	BNE.S	.RT15
	MOVE.B	#0,playpat
	BSR.L	INVERT_PLAYPATT
.RT15	BRA	RT14
	
.RT12	CMP.B	#-1,inpatt
	BNE.S	.RT16
	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
.RT16	BSR	OFF_134B
	RTS
***************************************************************************
VBLPAT  ADDQ.W	#1,TICK
	MOVE.W	TICK,D0
	CMP.W	SPEED,D0
	BLO	.sor
	MOVE.W	#0,TICK
	
	ADDQ.B	#1,inpatt
	ADDQ.W	#6,inpatt2
	
	CMP.B	#1,playsong
	BNE.S	.ssre
	BSR	SONG1
	
.ssre	BSR	JOUEVOIE

	CMP.B	#0,inpatt
	BEQ.S	.ssre2
	BSR	AFFPATTERN		*PATTUP			* PATTUP3
	
.ssre2	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.W	D1,D0
	BGT.S	.ros
	
	CMP.B	#1,playpat
	BNE.S	.ros
	MOVE.B	#0,playpat
	BSR.L	INVERT_PLAYPATT
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata
	MOVE.W	#0,TICK
	
.ros	CMP.B	#0,BREAK
	BEQ.S	.SRO
	
	CMP.B	#1,BREAK		* PATT_BREAK
	BEQ.S	.PB
					* SINON POS_JUMP
	MOVE.B	#0,BREAK
	MOVEQ	#0,D0
	MOVE.W	BREAKPOS,D0
	MOVE.W	#0,BREAKPOS
	SUBQ.W	#1,D0
	MOVE.B	#-1,inpatt
	MOVE.W	#-6,inpatt2
	BSR	sng3
	RTS

.PB	MOVE.B	#0,BREAK
	MOVEQ	#0,D0
	MOVE.W	BREAKPOS,D0
	MOVE.W	#0,BREAKPOS
	SUBQ.W	#1,D0
	MOVE.B	D0,inpatt
	MULS	#6,D0
	MOVE.W	D0,inpatt2
	BSR	sng2
.SRO	RTS

.sor	BSR	EFFECT
	BRA.S	.ros
scurvoie	DC.B	0
BREAK		DC.B	0
BREAKPOS	DC.W	0
***************************************************************************
JOUEVOIE:
	LEA	VOICE0,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE1,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE2,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE3,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE4,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE5,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE6,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE7,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE8,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE9,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE10,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE11,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE12,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE13,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE14,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE15,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE16,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE17,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE18,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE19,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE20,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE21,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE22,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE23,A1
	BSR	TREAT_ONE_VOICE
	LEA	VOICE24,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE25,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE26,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE27,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE28,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE29,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE30,A1
	BSR.S	TREAT_ONE_VOICE
	LEA	VOICE31,A1
	BSR.S	TREAT_ONE_VOICE

	TST.B	PATTDELTIME
	BEQ.S	.NO_PATT_DELAY
	SUBQ.B	#1,PATTDELTIME
	BNE.S	.NO_PATT_DELAY
	SUBQ.B	#1,inpatt
	SUBQ.W	#6,inpatt2
	
.NO_PATT_DELAY
	RTS
***************************************************************************
TREAT_ONE_VOICE
	MOVEM.L	RIEN,D0-D3
	MOVE.L	ADDCURTRACK(A1),A0
	
	CMP.L	DEBPATT,A0
	BEQ.S	.FF
	
	MOVE.B	inpatt,D0
	CMP.W	LENCURTRACK(A1),D0
	BGE.S	.GG
	
	MOVE.W	inpatt2,D3
	LEA	(A0,D3.W),A0
	BRA.S	.FF
	
.GG	MOVE.L	DEBTRACK,A0
	
.FF	CMP.B	#$15,2(A0)
	BEQ.S	DOSETFINETUNE
	CMP.B	#3,2(A0)
	BEQ.S	CHECK_TONE1
	CMP.B	#5,2(A0)
	BEQ.S	CHECK_TONE
	BRA.S	SET_INSTR
DOSETFINETUNE
	BSR	SET_FINE_TUNE
	BRA.S	SET_INSTR
	
CHECK_TONE1
	MOVE.W	VOL1(A1),PATT_VOL(A1)
CHECK_TONE
	MOVE.B	2(A0),PATT_COMM(A1)
	MOVE.W	3(A0),PATT_PARAM(A1)
	BSR	SET_PORTAMENTO_TONE
	RTS
	
SET_INSTR
	MOVE.B	1(A0),D0			* 2 OCTET INSTRUMENT
	BEQ.S	SET_PERIODE
	MOVE.B	D0,PATT_INSTR(A1)
	BSR	INSTR
	
SET_PERIODE
	MOVE.B	(A0),D1				* 1 OCTET NOTE
	BNE.S	GFD
	TST.B	1(A0)				* 2 OCTET INSTRUMENT
	BEQ.S	SET_VOL
	MOVE.W	PATT_NOTE1(A1),FREQUENCY(A1)
	MOVE.B	PATT_NOTE2(A1),D1
GFD	LEA	TABLE_DIGINOTE,A2
	MOVEQ	#0,D0
	MOVE.B	FINE_TUNE(A1),D0		* FINE TUNE
	MOVE.L	(A2,D0.W*4),A2
	MOVE.B	D1,PATT_NOTE2(A1)
	SUBQ.W	#1,D1
	MOVE.W	(A2,D1.L*2),D0
	MOVE.W	D0,FREQUENCY(A1)
	MOVE.W	D0,PATT_NOTE1(A1)
	
DFG	*MOVE.B	2(A0),D0
	*CMP.B	#$1D,D0 			; Notedelay
	*BEQ.S	SET_VOL

	BTST	#2,WAVE_CONTROL(A1)
	BNE.S	VIBNOC
	CLR.B	VIB_POS(A1)
VIBNOC	BTST	#6,WAVE_CONTROL(A1)
	BNE.S	TRENOC
	CLR.B	TREM_POS(A1)
TRENOC	TST.B	1(A0)
	BNE.S	SET_VOL
	MOVEQ	#0,D0
	MOVE.B	PATT_INSTR(A1),D0
	BSR	INSTR2

SET_VOL	MOVEQ	#0,D0
	MOVE.B	5(A0),D0			* 6 OCTET VOLUME
	BEQ.S	TREAT_EFFECT
	CMP.W	#$50,D0
	BGT	TREAT_VOLUME
	CMP.B	#$10,D0
	BLT.S	TREAT_EFFECT
	SUB.B	#$10,D0
	LSL.W	#4,D0
	MOVE.W	D0,PATT_VOL(A1)
	MOVE.W	D0,VOL1(A1)
	
TREAT_EFFECT
	MOVEQ	#0,D0
	MOVE.B	2(A0),D0			* EFFECT NUMBER
	CMP.W	#35,D0
	BGE.S	NO_EFFECT
	MOVE.B	D0,PATT_COMM(A1)
	MOVE.W	3(A0),PATT_PARAM(A1)
	CMP.B	#0,edit
	BNE.S	.EDIT
	JSR	([TABLE_EFFECT,D0.W*4])
	RTS
.EDIT	JSR	([TABLE_EFFECT3,D0.W*4])
NO_EFFECT
	RTS
	NOP
***************************************************************************
TREAT_VOLUME
	BSR	TREAT_VOLUME1
	BRA	TREAT_EFFECT
	
TREAT_VOLUME1
	MOVE.B	D0,D1
	AND.W	#$00F0,D0
	LSR.W	#4,D0
	AND.W	#$000F,D1
	MOVE.B	D0,VOL_COMM(A1)
	MOVE.B	D1,VOL_PARAM(A1)
	JSR	([TABLE_VOL_EFFECT,D0.W*4])
	RTS
*--------------------------------------------------------------------------	
VOL_SLIDE_DOWN
	MOVEQ	#0,D0
	MOVE.B	VOL_PARAM(A1),D0
	BRA	VDO
*--------------------------------------------------------------------------	
VOL_SLIDE_UP
	MOVEQ	#0,D0
	MOVE.B	VOL_PARAM(A1),D0
	BRA	VUP
*--------------------------------------------------------------------------	
FVOL_SLIDE_DOWN
	MOVEQ	#0,D0
	MOVE.B	VOL_PARAM(A1),D0
	BRA	VDO
*--------------------------------------------------------------------------	
FVOL_SLIDE_UP
	MOVEQ	#0,D0
	MOVE.B	VOL_PARAM(A1),D0
	BRA	VUP
***************************************************************************
INSTR	LEA	SAMPLE,A3
	SUBQ.B	#1,D0
	MULU	#LEN_SAMPLE_MGT,D0
	ADD.L	D0,A3
	
	CMP.B	#0,(A0)
	BNE.S	.DS
	CMP.B	#$A,2(A0)
	BNE.S	.DS
	BRA	.SD
	
.DS	MOVE.L	DEB_MGT(A3),SPL_POINTER(A1)		* ADD DEBUT
	MOVE.L	DEB_MGT(A3),SPL_BEGIN(A1)		* DANS ADD DEBUT SPL
	MOVE.B	F_TUNE_MGT(A3),FINE_TUNE(A1)		* FINE TUNE
	MOVE.W	VOL_MGT(A3),PATT_VOL(A1)		* VOLUME
	MOVE.W	VOL_MGT(A3),VOL1(A1)
	MOVE.L	LOOP_DEB_MGT(A3),LOOP_BEGIN(A1)		* ADD LOOP DEBUT
	MOVE.L	LOOP_DEB_MGT(A3),LOOP_BEGIN(A1)		* DANS WAVE START
	MOVE.L	LOOP_FIN_MGT(A3),LOOP_END(A1)		* FIN LOOP = FIN DU SAMPLE
	MOVE.B	BIT1_MGT+1(A3),BITS(A1)
	MOVE.W	BASE_MGT(A3),BASE_SPL(A1)
	RTS
.SD	MOVE.W	VOL_MGT(A3),PATT_VOL(A1)
	MOVE.W	VOL_MGT(A3),VOL1(A1)
	RTS
***************************************************************************
INSTR2	LEA	SAMPLE,A3
	SUBQ.B	#1,D0
	MULU	#LEN_SAMPLE_MGT,D0
	ADD.L	D0,A3
	
	MOVE.L	DEB_MGT(A3),SPL_POINTER(A1)		* ADD DEBUT
	MOVE.L	DEB_MGT(A3),SPL_BEGIN(A1)		* DANS ADD DEBUT SPL
	MOVE.B	F_TUNE_MGT(A3),FINE_TUNE(A1)		* FINE TUNE
	MOVE.L	LOOP_DEB_MGT(A3),LOOP_BEGIN(A1)		* ADD LOOP DEBUT
	MOVE.L	LOOP_DEB_MGT(A3),LOOP_BEGIN(A1)		* DANS WAVE START
	MOVE.L	LOOP_FIN_MGT(A3),LOOP_END(A1)		* FIN LOOP = FIN DU SAMPLE
	MOVE.B	BIT1_MGT+1(A3),BITS(A1)			* NB DE BIT (8 OU 16)
	MOVE.W	BASE_MGT(A3),BASE_SPL(A1)
	RTS
***************************************************************************
	RSRESET				* VOIE IN REPLAY ROUT
FREQUENCY	RS.W	1		* PERIODE OF REPLAY
SPL_POINTER	RS.L	1
LOOP_BEGIN	RS.L	1
LOOP_END	RS.L	1
WAVE_START	RS.L	1
SPL_BEGIN	RS.L	1
VOL1		RS.W	1
BIT_LOOP	RS.B	1		* LOOP OR NOT
KIND_VOICE	RS.B	1
BUSY		RS.B	1
VOIE_BRUIT	RS.B	1		* ??

PATT_NOTE1	RS.W	1		* (PERIODE)
PATT_NOTE2	RS.B	1		* (LITTERAL)
PATT_INSTR	RS.B	1		*
PATT_COMM	RS.B	1		* LIGNE DANS LA PATT
PATT_VIDE	RS.B	1
PATT_PARAM	RS.W	1		*
PATT_VOL	RS.W	1		*

VOL2		RS.B	1
BITS		RS.B	1		* SAMPLE 8/16 BITS
VIB_COMM	RS.B	1
VIB_POS		RS.B	1
SPL_OFFSET	RS.B	1		* .W
TREM_COMM	RS.B	1
TREM_POS	RS.B	1
WAVE_CONTROL	RS.B	1

VOL_COMM	RS.B	1		* VOLUME COMMAND
VOL_PARAM	RS.B	1		* VOLUME PARAMATER

GLISS_FUNK	RS.B	1
FUNK_OFFSET	RS.B	1
WAVE_ST		RS.B	1
FINE_TUNE	RS.B	1
TONE_PORT_DIR	RS.B	1
WANTED_PERIOD	RS.W	1
TONE_PORT_SPD	RS.W	1
NOTE		RS.W	1		* LITTERAL	*.B NORMALEMENT

LEFT_VOL	RS.B	1
RIGHT_VOL	RS.B	1
BASE_SPL	RS.W	1
ADDCURTRACK	RS.L	1
LENCURTRACK	RS.W	1
NBCURTRACK	RS.W	1

VOICE_SIZE	RS.L	1
***************************************************************************
ARPEGGIO
	TST.B	PATT_COMM(A1)
	BNE	NO_EFFECT

	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.W	TICK,D0
	MOVE.W	PATT_PARAM(A1),D1
	BEQ	NO_EFFECT
	
	TST.B	PATT_PARAM(A1)
	BEQ.S	.NO_XTEND
	ADD.W	#Arpeggio_Table2-Arpeggio_Table,D0
	
.NO_XTEND
	MOVE.B	Arpeggio_Table(PC,D0.W),D0
	BEQ.S	.ARP_NOP

	SUBQ.W	#4,D0	
	LSR.W	D0,D1
	AND.W	#$F,D1
	
	ADD.B	PATT_NOTE2(A1),D1
	SUBQ.W	#1,D1
	MOVEQ	#0,D0
	MOVE.B	FINE_TUNE(A1),D0
	LEA	TABLE_DIGINOTE,A2
	MOVE.L	(A2,D0.W*4),A2
	MOVE.W	(A2,D1.W*2),FREQUENCY(A1)
	RTS
	
.ARP_NOP
	MOVE.W	PATT_NOTE1(A1),FREQUENCY(A1)
	RTS
	
Arpeggio_Table
	DC.B	0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4
	DC.B	8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0
	DC.B	4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8
	DC.B	0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4,8,0,4
	
Arpeggio_Table2
	DC.B	0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4
	DC.B	8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12
	DC.B	16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0
	DC.B	4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8,12,16,0,4,8

***************************************************************************
PORTAMENTO_UP
	TST.W	FREQUENCY(A1)
	BEQ	VOL_OK
	MOVEQ	#0,D0
	MOVE.W	PATT_PARAM(A1),D0
	SUB.W	D0,FREQUENCY(A1)
	SUB.W	D0,PATT_NOTE1(A1)
	MOVE.W	FREQUENCY(A1),D0
	CMP.W	#$20,D0
	BPL	ZERO2
	MOVE.W	#$20,FREQUENCY(A1)
	MOVE.W	#$20,PATT_NOTE1(A1)
ZERO1	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
ZERO2	RTS
***************************************************************************
PORTAMENTO_DOWN
	TST.W	FREQUENCY(A1)
	BEQ	VOL_OK
	MOVEQ	#0,D0
	MOVE.W	PATT_PARAM(A1),D0
	ADD.W	D0,FREQUENCY(A1)
	ADD.W	D0,PATT_NOTE1(A1)
	MOVE.W	FREQUENCY(A1),D0
	CMP.W	#6848,D0
	BMI	ZERO2
	MOVE.W	#6848,FREQUENCY(A1)
	MOVE.W	#6848,PATT_NOTE1(A1)
	BRA.S	ZERO1
***************************************************************************
SET_PORTAMENTO_TONE
	MOVE.B	(A0),D2
	BEQ	VOL_OK
	MOVEQ	#0,D0
	SUBQ.B	#1,D2
	MOVE.B	FINE_TUNE(A1),D0
	LEA	TABLE_DIGINOTE,A2
	MOVE.L	(A2,D0.W*4),A2
	MOVE.W	(A2,D2.W*2),D2

	MOVE.W	D2,WANTED_PERIOD(A1)
	MOVE.W	PATT_NOTE1(A1),D0
	MOVE.B	#0,TONE_PORT_DIR(A1)
	CMP.W	D0,D2
	BEQ.S	.CLEARTONEPORTA
	BGE	VOL_OK
	MOVE.B	#1,TONE_PORT_DIR(A1)
	RTS
.CLEARTONEPORTA
	MOVE.W	#0,WANTED_PERIOD(A1)
	RTS
**********************************************************************
PORTAMENTO_TONE
	TST.W	FREQUENCY(A1)
	BEQ	VOL_OK
	MOVE.W	PATT_PARAM(A1),D0
	BEQ.S	TONEPORTNOCHANGE
	MOVE.W	D0,TONE_PORT_SPD(A1)
	MOVE.W	#0,PATT_PARAM(A1)
TONEPORTNOCHANGE
	TST.W	WANTED_PERIOD(A1)
	BEQ	VOL_OK
	MOVE.W	TONE_PORT_SPD(A1),D0
	TST.B	TONE_PORT_DIR(A1)
	BNE.S	.TONEPORTAUP
.TONEPORTADOWN
	ADD.W	D0,FREQUENCY(A1)
	ADD.W	D0,PATT_NOTE1(A1)
	MOVE.W	WANTED_PERIOD(A1),D0
	CMP.W	FREQUENCY(A1),D0
	BGT.S	.TONEPORTASETPER
	MOVE.W	WANTED_PERIOD(A1),FREQUENCY(A1)
	MOVE.W	#0,WANTED_PERIOD(A1)
	BRA.S	.TONEPORTASETPER

.TONEPORTAUP
	SUB.W	D0,FREQUENCY(A1)
	SUB.W	D0,PATT_NOTE1(A1)
	MOVE.W	WANTED_PERIOD(A1),D0
	CMP.W	FREQUENCY(A1),D0
	BLT.S	.TONEPORTASETPER
	MOVE.W	WANTED_PERIOD(A1),FREQUENCY(A1)
	MOVE.W	#0,WANTED_PERIOD(A1)

.TONEPORTASETPER
	MOVE.W	FREQUENCY(A1),D2
	MOVE.B	GLISS_FUNK(A1),D0
	AND.B	#$0F,D0
	BEQ.S	.GLISSKIP
	MOVEQ	#0,D0
	MOVE.B	FINE_TUNE(A1),D0
	LEA	TABLE_DIGINOTE,A2
	MOVE.L	(A2,D0.W*4),A2
	MOVEQ	#0,D0
.GLISSLOOP
	CMP.W	(A2,D0.W),D2
	BHS.S	.GLISSFOUND
	ADDQ.W	#2,D0
	CMP.W	#96*2,D0
	BLO.S	.GLISSLOOP
	MOVE.L	#95*2,D0
.GLISSFOUND
	MOVE.W	(A2,D0.W),D2
.GLISSKIP
	MOVE.W	D2,FREQUENCY(A1) 			; Set period
	MOVE.W	D2,PATT_NOTE1(A1)
	RTS
***************************************************************************
VIBRATO	
	MOVE.B	PATT_PARAM+1(A1),D0
	BEQ.S	VIBRATO2
	MOVE.B	VIB_COMM(A1),D2
	AND.B	#$0F,D0
	BEQ.S	.VIBSKIP
	AND.B	#$F0,D2
	OR.B	D0,D2
.VIBSKIP
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$F0,D0
	BEQ.S	.VIBSKIP2
	AND.B	#$0F,D2
	OR.B	D0,D2
.VIBSKIP2
	MOVE.B	D2,VIB_COMM(A1)
VIBRATO2
	MOVE.B	VIB_POS(A1),D0
	LEA	SINUS,A5
	LSR.W	#2,D0
	AND.W	#$001F,D0
	MOVEQ	#0,D2
	MOVE.B	WAVE_CONTROL(A1),D2
	AND.B	#$03,D2
	BEQ.S	.VIB_SINE
	LSL.B	#3,D0
	CMP.B	#1,D2
	BEQ.S	.VIB_RAMPDOWN
	MOVE.B	#255,D2
	BRA.S	.VIB_SET
.VIB_RAMPDOWN
	TST.B	VIB_POS(A1)
	BPL.S	.VIB_RAMPDOWN2
	MOVE.B	#255,D2
	SUB.B	D0,D2
	BRA.S	.VIB_SET
.VIB_RAMPDOWN2
	MOVE.B	D0,D2
	BRA.S	.VIB_SET
.VIB_SINE
	MOVE.B	0(A5,D0.W),D2
.VIB_SET
	MOVE.B	VIB_COMM(A1),D0
	AND.W	#15,D0
	MULU	D0,D2
	LSR.W	#7,D2
	MOVE.W	PATT_NOTE1(A1),D0			* PERIODE
	TST.B	VIB_POS(A1)
	BMI.S	.VIBRATONEG
	ADD.W	D2,D0
	BRA.S	.VIBRATO3
.VIBRATONEG
	SUB.W	D2,D0
.VIBRATO3
	MOVE.W	D0,FREQUENCY(A1)				* PERIODE
	MOVE.B	VIB_COMM(A1),D0
	LSR.W	#2,D0
	AND.W	#$003C,D0
	ADD.B	D0,VIB_POS(A1)
	RTS
**********************************************************************
PORT_SLID
	BSR	TONEPORTNOCHANGE
	BRA	VOLUME_SLIDE
	
**********************************************************************
VIB_SLID
	BSR.S	VIBRATO2
	BRA	VOLUME_SLIDE
**********************************************************************
TREMOLO
	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVE.B	PATT_PARAM+1(A1),D0
	BEQ.S	.TREMOLO2
	MOVE.B	TREM_COMM(A1),D2
	AND.B	#$0F,D0
	BEQ.S	.TRESKIP
	AND.B	#$F0,D2
	OR.B	D0,D2
.TRESKIP
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$F0,D0
	BEQ.S	.TRESKIP2
	AND.B	#$0F,D2
	OR.B	D0,D2
.TRESKIP2
	MOVE.B	D2,TREM_COMM(A1)
.TREMOLO2
	MOVE.B	TREM_POS(A1),D0
	LEA	SINUS,A5
	LSR.W	#2,D0
	AND.W	#$001F,D0
	MOVEQ	#0,D2
	MOVE.B	WAVE_CONTROL(A1),D2
	*LSR.B	#4,D2	????
	AND.B	#$03,D2
	BEQ.S	.TRE_SINE
	LSL.B	#3,D0
	CMP.B	#1,D2
	BEQ.S	.TRE_RAMPDOWN
	MOVE.B	#255,D2
	BRA.S	.TRE_SET
.TRE_RAMPDOWN
	TST.B	VIB_POS(A1)
	BPL.S	.TRE_RAMPDOWN2
	MOVE.B	#255,D2
	SUB.B	D0,D2
	BRA.S	.TRE_SET
.TRE_RAMPDOWN2
	MOVE.B	D0,D2
	BRA.S	.TRE_SET
.TRE_SINE
	MOVE.B	0(A5,D0.W),D2
.TRE_SET
	MOVE.B	TREM_COMM(A1),D0
	AND.W	#15,D0
	MULU	D0,D2
	LSR.W	#2,D2		* #6 ????
	MOVEQ	#0,D0
	MOVE.B	PATT_VOL(A1),D0		* VOLUME
	TST.B	TREM_POS(A1)
	BMI.S	.TREMOLONEG
	ADD.W	D2,D0
	BRA.S	.TREMOLO3
.TREMOLONEG
	SUB.W	D2,D0
.TREMOLO3
	BPL.S	.TREMOLOSKIP
	MOVEQ	#0,D0
.TREMOLOSKIP
	CMP.W	#$40,D0
	BLS.S	.TREMOLOK
	MOVE.W	#$40,D0
.TREMOLOK
	MOVE.W	D0,22(A1)		*??
	MOVE.B	TREM_COMM(A1),D0
	LSR.W	#2,D0
	AND.W	#$3C,D0
	ADD.B	D0,TREM_POS(A1)
	RTS
**********************************************************************
SAMPLEOFFSET
	TST.L	SPL_POINTER(A1)
	BEQ	VOL_OK
	
	MOVEQ	#0,D0
	MOVE.W	PATT_PARAM(A1),D0
	BEQ.S	.NONEW
	MOVE.W	#0,PATT_PARAM(A1)
	MOVE.B	#0,PATT_COMM(A1)
	
	MOVE.W	D0,SPL_OFFSET(A1)
.NONEW	MOVE.W	SPL_OFFSET(A1),D0
	LSL.L	#8,D0
	ADD.L	D0,SPL_POINTER(A1)
	MOVE.L	SPL_POINTER(A1),D0
	MOVE.L	LOOP_END(A1),D1
	CMP.L	D0,D1
	BLT.S	.NOOK
	RTS
.NOOK	MOVE.L	SPL_BEGIN(A1),SPL_POINTER(A1)
	RTS
**********************************************************************
VOLUME_SLIDE
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM(A1),D0
	BEQ.S	VOL_DOWN
VUP	LSL.W	#4,D0
	ADD.W	D0,PATT_VOL(A1)
	CMP.W	#$400,PATT_VOL(A1)
	BMI.S	VOL_OK
	MOVE.W	#$400,PATT_VOL(A1)
	RTS
VOL_DOWN
	MOVE.B	PATT_PARAM+1(A1),D0
VDO	LSL.W	#4,D0
	SUB.W	D0,PATT_VOL(A1)
	BPL.S	VOL_OK
	MOVE.W	#0,PATT_VOL(A1)
	RTS
	
***************************************************************************
POS_JUMP
	MOVE.B	#2,BREAK
	MOVE.W	PATT_PARAM(A1),BREAKPOS
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
SET_VOLUME
	MOVE.W	PATT_PARAM(A1),PATT_VOL(A1)
	MOVE.W	PATT_PARAM(A1),VOL1(A1)
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	CMP.W	#$400,PATT_VOL(A1)
	BMI.S	VOL_OK
	MOVE.W	#$400,PATT_VOL(A1)
	MOVE.W	#$400,VOL1(A1)
VOL_OK	RTS
***************************************************************************
PATT_BREAK
	MOVE.B	#1,BREAK
	MOVE.W	PATT_PARAM(A1),D0
	
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.B	D1,D0
	BLE.S	.JPP
	MOVEQ	#0,D0
	
.JPP	MOVE.B	D0,BREAKPOS
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
SET_SPEED:
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	BEQ.S	SET_TEMPO
	CMP.W	#$1F,D0
	BGT	SET_TEMPO
	MOVE.W	#0,TICK
	MOVE.W	D0,SPEED
	TST.W	SPEED
	BNE.S	SET_TEMPO
	MOVE.W	#1,SPEED

SET_TEMPO:
	MOVE.B	PATT_PARAM(A1),D0
SET_T2	CMP.B	#0,D0
	BEQ.S	.ZZ
	CMP.B	#$FF,D0
	BEQ.S	.ZZ
	MOVE.B	D0,TEMPO
	SUB.B	#32,D0
.JK	LEA	Simplet_Tempo_Table,A2
	MOVE.W	 (A2,D0.W*4),Sample_Lenght
	MOVE.B	2(A2,D0.W*4),Timer_Control
	MOVE.B	3(A2,D0.W*4),Timer_Data
.ZZ	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
SPEED:			DC.W	0
TICK:			DC.W	0
TEMPO			DC.B	0
LOWMASK:		DC.B	0
***************************************************************************
FINE_PORT_UP
	TST.W	TICK
	BNE	VOL_OK
	MOVE.B	#$0F,LOWMASK
PORTAUP MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	LOWMASK,D0
	MOVE.B	#$FF,LOWMASK
	SUB.W	D0,FREQUENCY(A1)
	MOVE.W	FREQUENCY(A1),D0
	CMP.W	#$20,D0
	BPL	VOL_OK
	MOVE.W	#$20,FREQUENCY(A1)
	RTS
**********************************************************************
FINE_PORT_DOWN
	TST.W	TICK
	BNE	VOL_OK
	MOVE.B	#$0F,LOWMASK
PORTADOWN
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	LOWMASK,D0
	MOVE.B	#$FF,LOWMASK
	ADD.W	D0,FREQUENCY(A1)
	MOVE.W	FREQUENCY(A1),D0
	AND.W	#$0FFF,D0
	CMP.W	#6848,D0
	BMI	VOL_OK
	MOVE.W	#6848,FREQUENCY(A1)
	RTS
**********************************************************************
SET_GLISSANDO_CONTROL
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$F0,GLISS_FUNK(A1)
	OR.B	D0,GLISS_FUNK(A1)
	RTS
**********************************************************************
SET_VIBRATO_CONTROL
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$F0,WAVE_CONTROL(A1)
	OR.B	D0,WAVE_CONTROL(A1)
	RTS
***************************************************************************
SET_FINE_TUNE
	MOVE.B	PATT_PARAM+1(A1),FINE_TUNE(A1)
	RTS
***************************************************************************
JUMP_LOOP
	TST.B	TICK
	BNE	VOL_OK
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$0F,D0
	BEQ.S	.SETLOOP
 	TST.B	LOOP_COUNT
	BEQ.S	.JUMPCNT
	SUBQ.B	#1,LOOP_COUNT
	BEQ	VOL_OK
.JMPLOOP
	MOVEQ	#0,D0
	MOVE.B	PATT_LOOP_POS,D0
	MOVE.B	D0,inpatt
	MULU	#6,D0
	MOVE.W	D0,inpatt2
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
.JUMPCNT
	MOVE.B	D0,LOOP_COUNT
	BRA.S	.JMPLOOP
.SETLOOP
	MOVE.B	inpatt,PATT_LOOP_POS
	RTS
PATT_LOOP_POS	DC.B	0
LOOP_COUNT	DC.B	0
***************************************************************************
SET_TREMOLO_CONTROL
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$0F,D0
	LSL.B	#4,D0
	AND.B	#$0F,WAVE_CONTROL(A1)
	OR.B	D0,WAVE_CONTROL(A1)
	RTS
***************************************************************************
SET_PAN
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$0F,D0
	LEA	TAB_PAN,A2
	MOVE.W	(A2,D0.W*2),LEFT_VOL(A1)
	RTS
TAB_PAN	
	dc.w	$ff00
	dc.w	$f010,$e020,$d030,$c040,$b050,$a060,$9070
	dc.w	$8080
	dc.w	$7090,$60a0,$50b0,$40c0,$30d0,$20e0,$00ff
***************************************************************************
FINE_PAN
	MOVE.B	PATT_PARAM+1(A1),D0
	MOVE.B	#-1,D1
	SUB.B	D0,D1
	MOVE.B	D1,LEFT_VOL(A1)
	MOVE.B	D0,RIGHT_VOL(A1)
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
RETRIG_NOTE
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	BEQ	VOL_OK
	MOVEQ	#0,D1
	MOVE.W	TICK,D1
	BNE.S	.RTNSKP
	TST.W	PATT_NOTE1(A1)
	BNE	VOL_OK
.RTNSKP	DIVU	D0,D1
	SWAP	D1
	TST.W	D1
	BNE	VOL_OK
	MOVE.W	PATT_NOTE1(A1),FREQUENCY(A1)
	MOVE.L	SPL_BEGIN(A1),SPL_POINTER(A1)			* ADD DEBUT SPL
	RTS
***************************************************************************
VOLUME_FINE_UP
	TST.W	TICK
	BNE	VOL_OK
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$F,D0
	BRA	VUP
**********************************************************************
VOLUME_FINE_DOWN
	TST.W	TICK
	BNE	VOL_OK
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	AND.B	#$0F,D0
	BRA	VDO
**********************************************************************
NOTE_CUTE
	MOVEQ	#0,D0
	MOVE.W	PATT_PARAM(A1),D0
	CMP.W	TICK,D0
	BNE	VOL_OK
	MOVE.W	#0,PATT_VOL(A1)
	RTS
**********************************************************************
NOTE_DELAY
	MOVEQ	#0,D0
	MOVE.L	D0,2(A1)
	MOVE.W	PATT_PARAM(A1),D0
	CMP.W	TICK,D0
	BNE	VOL_OK
	MOVE.L	SPL_BEGIN(A1),SPL_POINTER(A1)
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
PATTERN_DELAY
	TST.W	TICK
	BNE	VOL_OK
	MOVEQ	#0,D0
	MOVE.B	PATT_PARAM+1(A1),D0
	ADDQ.B	#1,D0
	MOVE.B	D0,PATTDELTIME
	RTS
PATTDELTIME	DC.B	0
***************************************************************************
SET_STEREO
	MOVE.W	PATT_PARAM(A1),LEFT_VOL(A1)
	MOVE.B	#0,PATT_COMM(A1)
	MOVE.W	#0,PATT_PARAM(A1)
	RTS
***************************************************************************
TABLE_EFFECT	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,SET_PORTAMENTO_TONE
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		DC.L	FINE_PAN,SAMPLEOFFSET,NO_EFFECT,POS_JUMP
		DC.L	SET_VOLUME,PATT_BREAK,NO_EFFECT,SET_SPEED
		DC.L	NO_EFFECT,FINE_PORT_UP,FINE_PORT_DOWN,SET_GLISSANDO_CONTROL
		DC.L	SET_VIBRATO_CONTROL,SET_FINE_TUNE,JUMP_LOOP,SET_TREMOLO_CONTROL
		DC.L	SET_PAN,RETRIG_NOTE,VOLUME_FINE_UP,VOLUME_FINE_DOWN
		DC.L	NOTE_CUTE,NOTE_DELAY,PATTERN_DELAY,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,SET_STEREO,NO_EFFECT
		
TABLE_EFFECT2	DC.L	ARPEGGIO,PORTAMENTO_UP,PORTAMENTO_DOWN,PORTAMENTO_TONE
		DC.L	VIBRATO,PORT_SLID,VIB_SLID,TREMOLO
		DC.L	NO_EFFECT,NO_EFFECT,VOLUME_SLIDE,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		DC.L	NO_EFFECT,RETRIG_NOTE,NO_EFFECT,NO_EFFECT
		DC.L	NOTE_CUTE,NOTE_DELAY,NO_EFFECT,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		
TABLE_EFFECT3	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,SET_PORTAMENTO_TONE
		DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
		DC.L	FINE_PAN,SAMPLEOFFSET,NO_EFFECT,NO_EFFECT
		DC.L	SET_VOLUME,NO_EFFECT,NO_EFFECT,SET_SPEED
		DC.L	NO_EFFECT,FINE_PORT_UP,FINE_PORT_DOWN,SET_GLISSANDO_CONTROL
		DC.L	SET_VIBRATO_CONTROL,SET_FINE_TUNE,NO_EFFECT,SET_TREMOLO_CONTROL
		DC.L	SET_PAN,RETRIG_NOTE,VOLUME_FINE_UP,VOLUME_FINE_DOWN
		DC.L	NOTE_CUTE,NOTE_DELAY,NO_EFFECT,NO_EFFECT
		DC.L	NO_EFFECT,NO_EFFECT,SET_STEREO,NO_EFFECT
		
TABLE_VOL_EFFECT
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
	DC.L	FVOL_SLIDE_DOWN,FVOL_SLIDE_UP,NO_EFFECT,NO_EFFECT
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
TABLE_VOL_EFFECT2
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
	DC.L	NO_EFFECT,NO_EFFECT,VOL_SLIDE_DOWN,VOL_SLIDE_UP
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT
	DC.L	NO_EFFECT,NO_EFFECT,NO_EFFECT,NO_EFFECT		
		
SINUS		DC.B	$00,$18,$31,$4A,$61,$78,$8B,$A1
		DC.B	$B4,$C5,$D4,$E0,$EB,$F4,$FA,$FD
		DC.B	$FA,$F4,$EB,$E0,$D4,$C5,$B4,$A1
		DC.B	$8B,$78,$61,$4A,$31,$18
		
Simplet_Tempo_Table
		INCBIN	DATA\TEMPODSP.TAB
***************************************************************************
* 0  - ARPEGGIO
* 1  - PORTAMENTO UP
* 2  - PORTAMENTO DOWN
* 3  - PORTAMENTO TONE
* 4  - VIBRATO
* 5  - PORTAMENTO TONE + VOLUME SLIDE
* 6  - VIBRATO + VOLUME SLIDE
* 7  - TREMOLO
* 8  - FINE PAN
* 9  - SAMPLE OFFSET
* A  - VOLUME SLIDE
* B  - POSITION JUMP
* C  - SET VOLUME
* D  - PATTERN BREAK
* E  - 
* F  - SET SPEED
* 10 -
* 11 - FINE PORTAMENTO UP
* 12 - FINE PORTAMENTO DOWN
* 13 - SET GLISSANDO CONTROL
* 14 - SET VIBRATO CONTROL
* 15 - SET FINE TUNE
* 16 - JUMP LOOP
* 17 - SET TREMOLO CONTROL
* 18 - PAN
* 19 - RETRIG NOTE
* 1A - VOLUME FINE UP
* 1B - VOLUME FINE DOWN
* 1C - NOTE CUT
* 1D - NOTE DELAY
* 1E - PATTERN DELAY
* 1F - FUNK IT
* 20 -
* 21 -
* 22 - SET STEREO
**********************************************************************
*	1xx   Fxx
*	2xx   Bxx
*	3xx   Dxx
*	4xy   Axy
*	4Fy   1By
*	4xF   1Ax
*	5xx   2xx
*	5Fx   12x
*	5Ex             * extra slide down
*	6xx   1xx
*	6Fx   11x
*	6Ex             * extra slide up
*	7xx   3xx
*	8xy   4xy
*	9xy             * Tremor
*	Axy   0xy
*	Bxy   6xy
*	Cxy   5xy
*	Dxy   9xy
*	Exy   19x       * Retrig + Volume slide
*	Fxy   7xy
	
**********************************************************************
EFFECT	LEA	VOICE0,A1
	BSR	OUT_PAT
	LEA	VOICE1,A1
	BSR	OUT_PAT
	LEA	VOICE2,A1
	BSR	OUT_PAT
	LEA	VOICE3,A1
	BSR	OUT_PAT
	LEA	VOICE4,A1
	BSR	OUT_PAT
	LEA	VOICE5,A1
	BSR	OUT_PAT
	LEA	VOICE6,A1
	BSR	OUT_PAT
	LEA	VOICE7,A1
	BSR	OUT_PAT
	LEA	VOICE8,A1
	BSR	OUT_PAT
	LEA	VOICE9,A1
	BSR	OUT_PAT
	LEA	VOICE10,A1
	BSR	OUT_PAT
	LEA	VOICE11,A1
	BSR	OUT_PAT
	LEA	VOICE12,A1
	BSR	OUT_PAT
	LEA	VOICE13,A1
	BSR	OUT_PAT
	LEA	VOICE14,A1
	BSR	OUT_PAT
	LEA	VOICE15,A1
	BSR	OUT_PAT
	LEA	VOICE16,A1
	BSR	OUT_PAT
	LEA	VOICE17,A1
	BSR	OUT_PAT
	LEA	VOICE18,A1
	BSR	OUT_PAT
	LEA	VOICE19,A1
	BSR	OUT_PAT
	LEA	VOICE20,A1
	BSR.S	OUT_PAT
	LEA	VOICE21,A1
	BSR.S	OUT_PAT
	LEA	VOICE22,A1
	BSR.S	OUT_PAT
	LEA	VOICE23,A1
	BSR.S	OUT_PAT
	LEA	VOICE24,A1
	BSR.S	OUT_PAT
	LEA	VOICE25,A1
	BSR.S	OUT_PAT
	LEA	VOICE26,A1
	BSR.S	OUT_PAT
	LEA	VOICE27,A1
	BSR.S	OUT_PAT
	LEA	VOICE28,A1
	BSR.S	OUT_PAT
	LEA	VOICE29,A1
	BSR.S	OUT_PAT
	LEA	VOICE30,A1
	BSR.S	OUT_PAT
	LEA	VOICE31,A1
	BSR.S	OUT_PAT
	RTS

OUT_PAT	MOVEQ	#0,D0
	MOVE.B	PATT_COMM(A1),D0
	CMP.W	#35,D0
	BGE.S	.OK_RTS
	JSR	([TABLE_EFFECT2,D0.W*4])

	MOVEQ	#0,D0
	MOVE.B	VOL_COMM(A1),D0
	JSR	([TABLE_VOL_EFFECT2,D0.W*4])
.OK_RTS	RTS
***************************************************************************
SONG1	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	CMP.W	D1,D0
	BGE.S	sng1
	RTS
sng1	MOVE.B	#0,inpatt
	MOVE.W	#0,inpatt2
sng2	MOVEM.L	RIEN,D0-D3
	MOVE.W	curpos,D0
sng3	MOVE.W	curlen,D1
	SUBQ.W	#1,D1
	CMP.W	D0,D1
	BEQ	finsong
	ADDQ.W	#1,D0
LLOP	MOVE.W	D0,curpos
	MOVE.W	D0,D3
	MOVE.L  #screen+640*320+448,where
	BSR	pouet

	MOVEQ	#0,D0
	MOVEQ	#0,D3
	MOVE.W	curpos,D0
	MOVE.L	ADDCURSEQ,A0
	MOVE.W	(A0,D0.W*2),D3
	CMP.W	#-1,D3
	BEQ.S	sng1
	MOVE.W	D3,curpatt

	MOVE.W	D3,D0
	MOVE.L  #screen+640*328+448,where
	BSR	pouet

	BSR	PATT_TRACK
	BSR	AFFPATTERN
	RTS
finsong 
	MOVE.W	curlop,d0
	BRA	LLOP
***************************************************************************
*	D3 = No PATT DESIRE
PATT_TRACK:
	MOVE.L	DEBPATT,A0
	MULU	#32*2+2,D3
	LEA	(A0,D3.L),A0
	
	MOVE.L	A0,ADDCURPATT
	MOVE.W	(A0)+,LENCURPATT
	LEA	PILEVOIE,A1
	MOVE.L	DEBTRACK,A2
	MOVE.L	DEBTABTRACK,A5
	MOVEQ	#31,D0
	
.MM	MOVE.L	(A1)+,A3
	MOVEQ	#0,D1
	MOVE.W	(A0)+,D1
	MOVE.W	D1,NBCURTRACK(A3)
	MOVE.L	(A5,D1.L*4),A4
	MOVE.W	(A4)+,LENCURTRACK(A3)
	MOVE.L	A4,ADDCURTRACK(A3)
	DBF	D0,.MM
	RTS
***************************************************************************
VBLRECORD					*ICI INPATT A REVOIR
	CMP.W	#1,sync
	BEQ	.ross
.rio	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#0,D2
	
	MOVE.B	curvoie,D1
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D1.W),D1
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D1.W*4),A0
	MOVE.L	ADDCURTRACK(A0),A0
	CMP.L	DEBTRACK,A0
	BEQ	.iop
	MOVE.W	inpatt2,D1
	ADD.W	D1,A0
	
	CMP.W	#1,zerotou
	BNE.S	.ter
	
	MOVE.L	D0,(A0)
	MOVE.W	D0,4(A0)
	MOVE.B	D0,recinst
	BRA.S	.zer

.ter	CMP.B	#1,DRUM
	BEQ	.GUO

	MOVE.B	recinst,D0
	MOVE.B	D0,D1
	SUBQ.B	#1,D0
	MULU	#LEN_SAMPLE_MGT,D0
	LEA	SAMPLE,A1
	ADD.L	D0,A1
	CMP.L	#0,LEN_MGT(A1)
	BEQ	.zer
	
	MOVE.B	NOTE_MGT(A1),(A0)
	MOVE.B	D1,1(A0)
	MOVE.B	COMMAND_MGT(A1),2(A0)
	MOVE.W	PARAM_MGT(A1),3(A0)
	MOVE.B	#0,5(A0)
	BRA	.zer


.GUO	MOVEQ	#0,d1
	LEA	datawhat,a1
	MOVE.B	whatvoice,d1
	MOVE.L	(a1,d1.W*4),a1
	JSR	(a1)
	
.zer	ADDQ.W	#1,TICK
	MOVE.W	TICK,D0
	CMP.W	SPEED,D0
	BLO	.ssor
	MOVE.W	#0,TICK
	
	MOVE.B	#0,recnote
	MOVE.B	#0,recinst
	MOVE.B	#0,reccom
	MOVE.B	#0,receff
	MOVE.B	#0,recvol
	
	MOVE.L	A0,A3
	BSR	AFFDATA
	BSR	JOUEVOIE
	
	MOVEQ	#0,D0
	MOVE.B	inpatt,D0
	MOVE.W	LENCURPATT,D1
	SUBQ.W	#1,D1
	CMP.W	D1,D0
	BGE.S	.sre
	
	ADDQ.B	#1,inpatt
	ADDQ.W	#6,inpatt2
	BSR	AFFPATTERN			*PATTUP
	bra.s	.ssor
.sre	MOVE.B	#0,record
	BSR.L	INVERT_RECORD
	MOVE.B	dernier,curentnb2
	MOVE.B	dernier,sampledata
.ssor	RTS
.ross	cmp.b	#0,KEY
	beq.s	.iop
	MOVE.W	#0,sync
	bra	.rio
.iop	RTS
sync	dc.W	0
datawhat	dc.l	w0,w1,w2,w3,w4,w5,w6,w7,w8,w9,w10
**********************************************************************
* whatvoice = 0  (Note)
w0	cmp.b	#-1,recinst
	beq.s	w11
	MOVE.B	recnote,(a0)
	MOVE.B	recinst,1(a0)
w11	RTS
* whatvoice = 1  (Instrument - haut)
w1	cmp.b	#-1,recinst
	beq.s	w11
	MOVE.B	recinst,d0
	AND.B	#$f,d0
	lsl.b	#4,d0
	AND.B	#$f,1(a0)
	or.b	d0,1(a0)
	RTS
* whatvoice = 2  (Instrument - bas )
w2	cmp.b	#-1,recinst
	beq.s	w11
	MOVE.B	recinst,d0
	AND.B	#$f,d0
	AND.B	#$f0,1(a0)
	or.b	d0,1(a0)
	RTS
* whatvoice = 3  (Commande - haut)
w3	cmp.b	#-1,reccom
	beq.s	w11
	MOVE.B	reccom,d0
	AND.B	#$f,d0
	lsl.b	#4,d0
	AND.B	#$f,2(a0)
	or.b	d0,2(a0)
	RTS
* whatvoice = 4  (Commande - bas)
w4	cmp.b	#-1,reccom
	beq.s	w11
	MOVE.B	reccom,d0
	AND.B	#$f,d0
	AND.B	#$f0,2(a0)
	or.b	d0,2(a0)
	RTS
* whatvoice = 5  (Donnees1 - haut)
w5	cmp.b	#-1,receff
	beq	w11
	MOVE.B	receff,d0
	AND.B	#$f,d0
	lsl.b	#4,d0
	AND.B	#$f,3(a0)
	or.b	d0,3(a0)
	RTS
* whatvoice = 6  (Donnees1 - bas )
w6	cmp.b	#-1,receff
	beq	w11
	MOVE.B	receff,d0
	AND.B	#$f,d0
	AND.B	#$f0,3(a0)
	or.b	d0,3(a0)
	RTS
* whatvoice = 7  (Donnees2 - haut)
w7	cmp.b	#-1,receff
	beq	w11
	MOVE.B	receff,d0
	AND.B	#$f,d0
	lsl.b	#4,d0
	AND.B	#$f,4(a0)
	or.b	d0,4(a0)
	RTS
* whatvoice = 8  (Donnees2 - bas )
w8	cmp.b	#-1,receff
	beq	w11
	MOVE.B	receff,d0
	AND.B	#$f,d0
	AND.B	#$f0,4(a0)
	or.b	d0,4(a0)
	RTS
* whatvoice = 9  (Volume - haut)
w9	cmp.b	#-1,recvol
	beq	w11
	MOVE.B	recvol,d0
	AND.B	#$f,d0
	lsl.b	#4,d0
	AND.B	#$f,5(a0)
	or.b	d0,5(a0)
	RTS
* whatvoice = 10  (Volume - bas )
w10	cmp.b	#-1,recvol
	beq	w11
	MOVE.B	recvol,d0
	AND.B	#$f,d0
	AND.B	#$f0,5(a0)
	or.b	d0,5(a0)
	RTS
***************************************************************************
LEFTCURSOR13
	MOVEQ	#11,D2
	BRA.S	LEFTCURSOR1
LEFTCURSOR
	MOVEQ	#1,D2
LEFTCURSOR1
	MOVEQ	#0,D0
	BSR	OPTI
	SUB.W	D2,curspos
	CMP.W	#0,curspos
	BMI.S	.leftout
	BSR	OPTI
	RTS
.leftout	
	ADD.W	#55,curspos
	BSR	OPTI
	RTS
	
RIGHTCURSOR13
	MOVEQ	#11,D2
	BRA.S	RIGHTCURSOR1
RIGHTCURSOR
	MOVEQ	#1,D2
RIGHTCURSOR1
	MOVEQ	#0,D0
	BSR	OPTI
	ADD.W	D2,curspos	
	CMP.W	#54,curspos
	BGT.S	.rightout
	BSR	OPTI
	RTS
.rightout
	SUB.W	#55,curspos
	BSR	OPTI
	RTS
	
dataposcur
	dc.l	CUR+1,CUR+32,CUR+33,CUR+48,CUR+49,CUR+64,CUR+65,CUR+80,CUR+81,CUR+96,CUR+97
	dc.l	CUR+128,CUR+145,CUR+160,CUR+161,CUR+176,CUR+177,CUR+192,CUR+193,CUR+208,CUR+209,CUR+224
	dc.l	CUR+241,CUR+272,CUR+273,CUR+288,CUR+289,CUR+304,CUR+305,CUR+320,CUR+321,CUR+336,CUR+337
	dc.l	CUR+368,CUR+385,CUR+400,CUR+401,CUR+416,CUR+417,CUR+432,CUR+433,CUR+448,CUR+449,CUR+464
	dc.l	CUR+481,CUR+512,CUR+513,CUR+528,CUR+529,CUR+544,CUR+545,CUR+560,CUR+561,CUR+576,CUR+577
	
curspos	DC.W	0
whatvoice			* Qu'est-ce dans la voie ?
	DC.B	0		* 0  = Note
	EVEN			* 1  = Instrument (hexa - haut)
				* 2  = Instrument (hexa - bas)
				* 3  = Commande   (hexa - haut)
				* 4  = Commande   (hexa - bas)
				* 5  = Donnees1 sur Commande (hexa - haut)
				* 6  = Donnees1 sur Commande (hexa - haut)
				* 7  = Donnees2 sur Commande (hexa - haut)
				* 8  = Donnees2 sur Commande (hexa - bas)
				* 9  = Volume     (hexa - haut)
				* 10 = Volume     (hexa - bas)
postyle	
M	SET	0
	REPT	32
	DC.B	M,0,M,1,M,2,M,3,M,4,M,5,M,6,M,7,M,8,M,9,M,10
M	SET	M+6	
	ENDR
	
	EVEN
wherevoice
	DC.W	0			* Position de la voie dans la pattern
***************************************************************************
CURSOR
m	set 0
	rept	7
	not.b	m(a0)
	*not.b	m-2(a0)
	not.b	m-4(a0)
m	set m+640
	endr
	RTS
	
OPTI:	MOVEQ	#0,D0
	MOVEQ	#0,D1
	LEA	dataposcur,A0
	LEA	postyle,A1
	MOVE.W	curspos,D0
	LEA	(A1,D0.W*2),A1
	MOVE.B	(A1)+,D1
	MOVE.W	D1,wherevoice
	DIVU	#6,D1
	MOVE.B	D1,curvoie
	MOVE.B	(A1)+,whatvoice
	MOVE.L	(A0,D0.W*4),A0
	SUBQ.W	#2,A0
	BSR	CURSOR
	NOP
	RTS
alors	dc.b	0
	even
***************************************************************************
*	A0 = ou mettre le resultat de la conversion
*	D0 = nombre a convertir
*	     Le nombre est a 7 chiffres Hexa
*			     8 chiffres Deci  
CONVERT_HEXA_DECIASCII:
	MOVEM.L	D0-D1/A0-A1,-(A7)
	MOVEQ	#0,D1
	MOVE.L	A0,A1
	DIVU	#10000,d0
	MOVE.L	d0,d1		
	SWAP	d0		
	MOVE.W	#0,d0
	SWAP	d0
	
	DIVU	#1000,D0
	ADD.W	#'0',D0
	MOVE.B	D0,(A0)+
	MOVE.W	#0,D0
	SWAP	D0
	DIVU	#100,d0
	ADD.W	#'0',d0
	MOVE.B	D0,(A0)+
	MOVE.W	#0,d0
	SWAP	D0
	DIVU	#10,d0
	ADD.W	#'0',d0
	MOVE.B	d0,(a0)+
	SWAP	d0
	ADD.W	#'0',d0
	MOVE.B	d0,(a0)+
	MOVE.W	#0,d1
	SWAP	d1
	DIVU	#1000,d1
	ADD.W	#'0',d1
	MOVE.B	d1,(a0)+
	MOVE.W	#0,d1
	SWAP	d1
	DIVU	#100,d1
	ADD.W	#'0',d1
	MOVE.B	d1,(a0)+
	MOVE.W	#0,d1
	SWAP	d1
	DIVU	#10,d1
	ADD.W	#'0',d1
	MOVE.B	D1,(A0)+
	SWAP	D1	
	ADD.W	#'0',D1
	MOVE.B	D1,(A0)+
	MOVE.W	#8,D1
.still	CMP.B	#'0',(A1)
	BNE.S	.sortie
	MOVE.B	#' ',(A1)+
	SUBQ	#1,D1
	CMP.B	#0,D1
	BNE.S	.still
.sortie	MOVEM.L	(A7)+,D0-D1/A0-A1
	RTS
**********************************************************************	
*	Affiche les donnees sur le sample
SUM:    MOVEM.L	D0-D1/A0-A1,-(A7)

	MOVE.L	A0,A1
	
	BSR	AFF_NAME_SPL
	BSR	AFF_VOLUME_SPL
	BSR	AFF_LOOP_DEB_SPL
	BSR	AFF_LOOP_FIN_SPL
	BSR	AFF_BUFFER
	BSR	AFF_LOOP_ON_OFF
	BSR	AFF_LEN_SPL
	BSR	AFF_NB_SPL
	BSR	AFF_MONO_SPL
	BSR	AFF_FRQ_SPL
	BSR	AFF_COM_SPL
	BSR	AFF_PARAM_SPL
	BSR	AFF_BITS_SPL
	BSR	AFF_BASE_SPL
	BSR	AFF_F_TUNE_SPL
	
	MOVEM.L	(A7)+,D0-D1/A0-A1
	RTS

AFF_F_TUNE_SPL
	MOVEQ	#0,D0
	MOVE.B	F_TUNE_MGT(A1),D0
	LEA	TAB_FT,A2
	LEA	(A2,D0.W*2),A0
	MOVE.L	#screen+640*336+81,where
	MOVE.W	#1,compt2
	MOVEQ	#2,D1
	BSR	PRINT
	RTS
TAB_FT	DC.W	' 0',' 1',' 2',' 3',' 4',' 5',' 6',' 7'
	DC.W	'-8','-7','-6','-5','-4','-3','-2','-1'
	
AFF_PARAM_SPL					*ICI
	MOVEQ	#0,D0
	MOVE.W	PARAM_MGT(A1),D2
	LEA	hexa,a2
	LEA	lengt,a0
	MOVE.B	D2,D0
	MOVE.W	D0,D1
	AND.B	#$F,D0
	MOVE.B	(A2,D0.W),3(A0)
	LSR.B	#4,D1
	MOVE.B	(A2,D1.W),2(A0)
	LSR.W	#8,D2
	MOVE.B	D2,D0
	MOVE.W	D0,D1
	AND.B	#$F,D0
	MOVE.B	(A2,D0.W),1(A0)
	LSR.B	#4,D1
	MOVE.B	(A2,D1.W),(A0)
	MOVE.L	#screen+640*304+65,where
	MOVE.W	#1,compt2
	MOVEQ	#4,D1
	BSR	PRINT
	RTS
	
AFF_COM_SPL
	MOVEQ	#0,D0
	MOVE.B	COMMAND_MGT(A1),D0
	BSR	CONV_2
	MOVE.L	#screen+640*297+112,where
	MOVE.W	#0,compt2
	MOVEQ	#2,D1
	BSR	PRINT
	RTS
	
		
AFF_BITS_SPL
	MOVEQ	#0,D0
	BTST.B	#0,BIT1_MGT+1(A1)
	BEQ.S	.S8
	MOVEQ	#16,D0
	BRA.S	.DD
.S8	MOVEQ	#8,D0
.DD	MOVE.L	#screen+640*312+81,where
	BSR	BITS2
	RTS
	
AFF_BASE_SPL	
	MOVEQ	#0,D0
	MOVE.W	BASE_MGT(A1),D0
	LEA	lengt,A0
	BSR	CONVERT_HEXA_DECIASCII
	MOVE.L	#screen+640*320+49+15,where
	MOVE.W	#0,compt2
	LEA	lengt+3,A0		
	MOVEQ	#5,D1
	BSR	PRINT
	RTS
	
BITS2	LEA	nume,A0
	DIVU	#10,D0
	BEQ	.B1
	ADD.B	#'0',D0
	MOVE.B	D0,(A0)
	BRA.S	.B2
	
.B1	MOVE.B	#' ',(A0)
.B2	SWAP	D0
	ADD.B	#'0',D0
	MOVE.B	D0,1(A0)
	MOVE.W	#1,compt2
	MOVEQ	#2,D1
	BSR	PRINT
	RTS
	
AFF_FRQ_SPL
	MOVEQ	#0,D0
	MOVE.B	NOTE_MGT(A1),D0
	LEA	pattt,A2
	BSR	CHECKNOTE
	MOVE.L	#screen+640*297+32,where
	MOVE.W	#0,compt2
	LEA	pattt,A0
	MOVEQ	#3,D1
	BSR	PRINT
	RTS

AFF_LEN_SPL
	MOVE.L	LEN_MGT(a1),D0
	LEA	lengt,A0			* LEN
	BSR	CONVERT_HEXA_DECIASCII
	MOVE.L	#screen+640*233+49,where
	MOVE.W	#1,compt2
	LEA	lengt+1,A0		
	MOVEQ	#7,D1
	BSR	PRINT
	RTS


AFF_LOOP_DEB_SPL
	MOVE.L	LOOP_DEB_MGT(A1),D0
	BEQ.S	.nn2
	SUB.L	DEB_MGT(A1),D0
	LEA	lengt,A0
	BSR	CONVERT_HEXA_DECIASCII
	MOVE.L	LOOP_DEB_MGT(a1),d0
	SUB.L	DEB_MGT(a1),d0
	CMP.L	#0,d0
	BNE.S	.nn1
	MOVE.B	#'0',lengt+7
	BRA	.nn1
.nn2	MOVE.L	#'    ',lengt
	MOVE.L	#'    ',lengt+4
.nn1	MOVE.L	#screen+640*257+49,where
	MOVE.W	#1,compt2
	LEA	lengt+1,A0		
	MOVEQ	#7,D1
	BSR	PRINT
	RTS

AFF_LOOP_FIN_SPL
	MOVE.L	LOOP_FIN_MGT(A1),D0
	BEQ.S	.nn2
	SUB.L	DEB_MGT(A1),D0
	LEA	lengt,A0
	BSR	CONVERT_HEXA_DECIASCII
	MOVE.L	LOOP_FIN_MGT(a1),d0
	SUB.L	DEB_MGT(a1),d0
	CMP.L	#0,d0
	BNE.S	.nn1
	MOVE.B	#'0',lengt+7
	BRA	.nn1
.nn2	MOVE.L	#'    ',lengt
	MOVE.L	#'    ',lengt+4
.nn1	MOVE.L	#screen+640*265+49,where
	MOVE.W	#1,compt2
	LEA	lengt+1,A0		
	MOVEQ	#7,D1
	BSR	PRINT
	RTS
	
AFF_BUFFER
	MOVEQ	#0,D0
	MOVE.W	LEN_BUF_MGT(A1),D0
	BEQ.S	.nn2
	LEA	lengt,A0
	BSR	CONVERT_HEXA_DECIASCII
	MOVEQ	#0,D0
	MOVE.W	LEN_BUF_MGT(A1),D0
	CMP.L	#0,d0
	BNE.S	.nn1
	MOVE.B	#'0',lengt+7
	BRA	.nn1
.nn2	MOVE.L	#'    ',lengt
	MOVE.L	#'    ',lengt+4
.nn1	MOVE.L	#screen+640*273+49,where
	MOVE.W	#1,compt2
	LEA	lengt+1,A0		
	MOVEQ	#7,D1
	BSR	PRINT
	RTS
	
AFF_LOOP_ON_OFF
	BTST.B	#2,BIT1_MGT+1(A1)
	BEQ.S	.NOLOOP
	LEA	L_ON,A0
	BRA.S	.AFF
.NOLOOP	LEA	L_OFF,A0
.AFF	MOVE.L #screen+640*280+1,where
	MOVE.W	#1,compt2
	MOVEQ	#3,D1
	BSR	PRINT
	RTS
L_ON	DC.B	' ON'
L_OFF	DC.B	'OFF'


AFF_VOLUME_SPL	
	MOVEQ	#0,D0
	MOVE.W	VOL_MGT(A1),D0
	BSR	CONV_3
	MOVE.L 	#screen+640*241+49,where
	MOVE.W	#1,compt2
	MOVEQ	#3,d1
	BSR	PRINT
	RTS
	
CONV_2
	LEA	hexa,a2
	LEA	nume,a0
	MOVE.W	d0,d1
	AND.B	#$f,d0
	MOVE.B	(a2,d0.W),1(a0)
	LSR.B	#4,d1
	MOVE.B	(a2,d1.W),d1
	cmp.b	#'0',d1
	BNE.S	.sum2
	MOVE.B	#' ',d1
.sum2	MOVE.B	d1,(a0)
	RTS

CONV_3
	LEA	hexa,A2
	LEA	nume,A0
	MOVE.W	D0,D1
	AND.W	#$F,D1
	MOVE.B	(A2,D1.W),2(A0)
	MOVE.W	D0,D1
	LSR.W	#4,D1
	AND.W	#$F,D1
	MOVE.B	(A2,D1.W),D1
	MOVE.B	D1,1(A0)
	LSR.W	#8,D0
	AND.W	#$F,D0
	MOVE.B	(A2,D0.W),(A0)
	CMP.B	#'0',(A0)
	BEQ.S	.SUM2
	RTS
.SUM2	MOVE.B	#' ',(A0)
	CMP.B	#'0',1(A0)
	BEQ.S	.SUM3
	RTS
.SUM3	MOVE.B	#' ',(A0)	
	RTS

AFF_NAME_SPL
	MOVE.L	A1,A0				* NAME
	MOVE.W	#28,D1
	MOVE.L	#screen+640*345,where
	MOVE.W	#0,compt2
	BSR	PRINT
	RTS

AFF_NB_SPL
	MOVEQ	#0,D0
	MOVE.B	sampledata,d0
	ADDQ.b	#1,d0
	BSR	CONV_2
	MOVE.L #screen+640*224+49,where
	MOVE.W	#1,compt2
	MOVEQ	#2,d1
	BSR	PRINT
	RTS
	
AFF_MONO_SPL
	BTST.B	#1,BIT1_MGT+1(A1)
	BEQ.S	.MMONO
	LEA	STEREO,A0
	BRA.S	.SSTEREO
.MMONO	LEA	MONO,A0
.SSTEREO	MOVE.L #screen+640*328,where
	MOVE.W	#0,compt2
	MOVEQ	#6,D1
	BSR	PRINT
	RTS
STEREO		DC.B 'STEREO'
MONO		DC.B 'MONO  '
nume		dc.b ' 0'
lengt		dc.b '        '
freem		dc.b '        '
	even
***************************************************************************
FRQ_PREPA
	MOVE.L	ADDCURSPL,A1
	CMP.L	#0,LEN_MGT(A1)
	BEQ.S	.nno
	MOVEQ	#0,D1
	MOVE.B	curvoie,D1
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D1.W),D1
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D1.W*4),A0
	
	MOVEQ	#0,D0
	MOVE.B	recnote,D0
	BEQ.S	.jjj
	SUBQ.W	#1,D0
	LEA	TABLE_DIGINOTE,A3
	MOVE.B	F_TUNE_MGT(A1),D1
	MOVE.L	(A3,D1.W*4),A4
	MOVE.W	(A4,D0.W*2),FREQUENCY(A0)
	BRA.S	.kkk
.jjj	MOVE.W	#0,FREQUENCY(A0)
.kkk	MOVE.L	DEB_MGT(A1),SPL_POINTER(A0)
	MOVE.L	LOOP_DEB_MGT(A1),LOOP_BEGIN(A0)
	MOVE.L	LOOP_FIN_MGT(A1),LOOP_END(A0)
	MOVE.B	BIT1_MGT+1(A1),BITS(A0)
	MOVE.B	F_TUNE_MGT(A1),FINE_TUNE(A0)
	MOVE.W	VOL_MGT(A1),PATT_VOL(A0)
	MOVE.W	VOL_MGT(A1),VOL1(A0)
	MOVE.W	BASE_MGT(A1),BASE_SPL(A0)
.nno	RTS
***************************************************************************
DRUM_PREPA
	MOVEQ	#0,D0	
	MOVEQ	#0,D1
	MOVE.B	curentnb2,D0
	MULU	#LEN_SAMPLE_MGT,D0
	LEA	SAMPLE,A1
	ADD.L	D0,A1
	
	CMP.L	#0,LEN_MGT(A1)
	BEQ.S	.nno
	
	MOVE.B	curvoie,D1
	LEA	NUMERO_VOICE_TAB,A0
	MOVE.B	(A0,D1.W),D1
	LEA	PILEVOIE,A0
	MOVE.L	(A0,D1.W*4),A0
	
	MOVEQ	#0,D0
	MOVE.B	NOTE_MGT(A1),D0
	BEQ.S	.LLL
	
	SUBQ.W	#1,D0
	LEA	TABLE_DIGINOTE,A3
	MOVE.B	F_TUNE_MGT(A1),D1
	MOVE.L	(A3,D1.W*4),A4
	MOVE.W	(A4,D0.W*2),FREQUENCY(A0)
	BRA.S	.MMM
	
.LLL	MOVE.W	#0,FREQUENCY(A0)

.MMM	MOVE.L	DEB_MGT(A1),SPL_POINTER(A0)
	MOVE.L	LOOP_DEB_MGT(A1),LOOP_BEGIN(A0)
	MOVE.L	LOOP_FIN_MGT(A1),LOOP_END(A0)
	MOVE.B	BIT1_MGT+1(A1),BITS(A0)
	MOVE.B	F_TUNE_MGT(A1),FINE_TUNE(A0)
	MOVE.W	VOL_MGT(A1),PATT_VOL(A0)
	MOVE.W	VOL_MGT(A1),VOL1(A0)
	MOVE.W	BASE_MGT(A1),BASE_SPL(A0)
.nno	RTS
***************************************************************************
SndTrack_Timer_Cmpt	DC.W	%0001000100010001
AA	RTE
***************************************************************************
MY_134:	
	ror.w	SndTrack_Timer_Cmpt
	bcc.s	AA
	bsr.s	SndTrack_IT
	move.b	Timer_Data,$fffffa1f.w
	move.b	Timer_Control,$fffffa19.w
	move.w	Sample_Lenght,Code_Sample_Lenght

SndTrack_Timer_Ret
	CMP.L	#0,COLOR
	BEQ.S	.BB
	MOVE.L	#0,$FFFF9800.W
.BB	RTE

SndTrack_IT
	TST.B	DSP_IN_USE
	BEQ.S	IT_OK
	MOVE.W	#$2300,SR
	RTS
	
IT_OK	
	CMP.L	#0,COLOR
	BEQ.S	.AA
	MOVE.L	COLOR,$FFFF9800.W

.AA	MOVEM.L	D0-A6,-(A7)
	
	ST	DSP_IN_USE			* Signale au DSP qu'on veut causer  la routine Soundtracker
	MOVE.B	#$80+$26/2,$FFFFA201.W		* Host User 0, vecteur $26
	
	LEA	$FFFFA204.W,A3
	
	MOVEQ	#0,D0
	MOVE.W	Code_Sample_Lenght,D0
	MOVE.L	D0,(A3)
	
	BTST.B	#1,$FFFFA202.W
	BEQ.S	*-6
	
	LEA	PILEVOIE,A5
	MOVE.L	(A5)+,A6
	MOVE.L	A5,VOICE_POINTER
 	
	BSR	PLAY_VOICE_0
	
	MOVE.L	#MY_3FC,$3FC.W
	MOVE.B	#$FF,$FFFFA203.W
	BSET.B	#0,$FFFFA200.W
 	MOVEM.L	(A7)+,D0-A6
 	RTS
	
VOICE_POINTER	DC.L	0
DSP_IN_USE	DC.W	0			* DC.B
***************************************************************************
MY_3FC:	
	CMP.L	#0,COLOR
	BEQ.S	.CC
	MOVE.L	COLOR,$FFFF9800.W
	
.CC	MOVEM.L	D0-A6,-(A7)
	LEA	$FFFFA204.W,A3
	MOVE.L	(A3),D0
	BCLR.B	#0,$FFFFA200.W
	MOVE.W	#$2300,SR
	
.NEXT_V	MOVE.L	VOICE_POINTER,A5
	MOVE.L	(A5)+,A6
	CMP.L	#0,A6
	BEQ.S	NO_MORE_VOICE
	MOVE.L	A5,VOICE_POINTER
	
	BSR	PLAY_VOICE
	BMI.S	.NEXT_V
	
	MOVE.L	#MY_3FC,$3FC.W
	MOVE.B	#$FF,$FFFFA203.W
	BSET.B	#0,$FFFFA200.W
 	MOVEM.L	(A7)+,D0-A6
	BRA	SndTrack_Timer_Ret
***************************************************************************
NO_MORE_VOICE
	MOVE.L	#0,(A3)
	SF	DSP_IN_USE
	BSR.L	OLD_134
 	MOVEM.L	(A7)+,D0-A6
	BRA	SndTrack_Timer_Ret
***************************************************************************
PLAY_VOICE_0
	BTST.B	#0,KIND_VOICE(A6)			* VOIE ACTIVE ?
	BEQ.S	NIET_ACTIVE_0
	
	TST.W	LEFT_VOL(A6)				* PANORAMIQUE NUL ?
	BEQ.S	NIET_VOICE_0
	
	MOVE.L	SPL_POINTER(A6),A0
	TST.L	SPL_POINTER(A6)				* VOIE VIDE
	BEQ.S	NIET_VOICE_0

	MOVEQ	#0,D3	
	MOVE.W	PATT_VOL(A6),D3			* .W VOLUME NUL ?
	BNE.S	CHOIX_0
NIET_VOICE_0
	CMP.W	#0,FREQUENCY(A6)
	BNE.S	.AA
	MOVE.W	#1712,FREQUENCY(A6)
.AA	CMP.L	#0,A0
	BNE.S	CHOIX_0
	LEA	RIEN+1,A0
	BRA.S	CHOIX_0
NIET_ACTIVE_0
	MOVE.W	#1712,FREQUENCY(A6)
	MOVE.L	#0,SPL_POINTER(A6)
	LEA	RIEN+1,A0
	BRA.S	CHOIX_0
***************************************************************************
PLAY_VOICE
	BTST.B	#0,KIND_VOICE(A6)		* VOIE ACTIVE ?
	BEQ.S	NIET_VOICE
	
	TST.W	LEFT_VOL(A6)			* PANORAMIQUE NUL ?
	BEQ.S	NIET_VOICE
	
	MOVE.L	SPL_POINTER(A6),A0		* VOIE VIDE ?
	TST.L	SPL_POINTER(A6)
	BEQ.S	NIET_VOICE
	
	MOVEQ	#0,D3	
	MOVE.W	PATT_VOL(A6),D3			* .W VOLUME NUL ?
	BNE.S	CHOIX
	
NIET_VOICE
	MOVEQ	#-1,D0				* La voie est saute
	RTS
***************************************************************************
CHOIX:	MOVE.L	#1,(A3)			* DEMANDE UNE NOUVELLE VOIE AU DSP
CHOIX_0	moveq	#0,d0
	moveq	#0,d4
	moveq	#0,d5
	moveq	#0,d6
	move.b	NBVF,d4			* DIGVOICES
	lsr.w	#1,d4
	move.b	MASTER_VOL_LEFT,d5
	move.b	MASTER_VOL_RIGHT,d6

	move.b	LEFT_VOL(a6),d0
	mulu.w	d3,d0
	divu.l	d4,d0
	mulu.l	d5,d0
	move.l	d0,(a3)			* Volume Gauche

	moveq	#0,d0
	move.b	RIGHT_VOL(a6),d0
	mulu.w	d3,d0
	divu.l	d4,d0
	mulu.l	d5,d0
	move.l	d0,(a3)			* Volume Droit

	move.l	#$800000/8*428/49169,d0
	moveq	#0,d2
	move.w	BASE_SPL(a6),d2
	mulu.l	d2,d1:d0
	move.w	FREQUENCY(a6),d2
	divu.l	d2,d1:d0
	move.l	d0,(a3)			* NOTE

	BTST.B	#0,$FFFFA202.W
	BEQ.S	*-6
	MOVE.L	(A3),D0			* RECOIT LA LONGUEUR A RENVOYER
	
	
.QQ	MOVE.L	D0,D3			* SAUVEGARDE
	MOVE.L	A0,A1			*

	EXT.L	D0
	DIVU.W	#6,D0			; Envoi par paquet de 3
	ADDQ.W	#1,D0			; un de plus car on tombe
	EXT.L	D0			; par forcment pile
	MOVE.L	D0,(A3)			; Nombre de paquets

	SUBQ.W	#1,D0			; pour le dbra
	SUBQ.W	#1,A0			; Cale les samples

	MOVE.W	#$2300,SR
Send_Samples
	MOVE.L	(A0),(A3)
	MOVE.L	3(A0),(A3)
	ADDQ.W	#6,A0
	DBRA	D0,Send_Samples
	
.TERR	TST.L	SPL_POINTER(A6)
	BEQ.S	.RRETT

	MOVE.L	A1,A0
	ADD.L	D3,A0
	
	MOVE.L	A0,SPL_POINTER(A6)	* POSITION COURANTE DANS LE SAMPLE
	MOVE.L	A0,D0
	MOVE.L	LOOP_END(A6),D1		* FIN DU SAMPLE
	CMP.L	D0,D1
	BGE.S	.PARES
	BRA.S	.CALCRESTE
.RRETT	MOVEQ	#0,D0
	RTS

.CALCRESTE
	BTST.B	#2,BITS(A6)
	BNE.S	.UNLOOP
	MOVE.W	#0,FREQUENCY(A6)
	MOVE.L	#0,SPL_POINTER(A6)
.PARES	MOVEQ	#0,D0
	RTS

.UNLOOP	MOVE.L	SPL_POINTER(A6),D0
	MOVE.L	LOOP_END(A6),D1
	SUB.L	D1,D0
	MOVE.L	LOOP_BEGIN(A6),SPL_POINTER(A6)
	ADD.L	D0,SPL_POINTER(A6)
.YET	MOVE.L	SPL_POINTER(A6),D1
	MOVE.L	LOOP_END(A6),D2
	CMP.L	D2,D1
	BGE.S	.RECAL
	MOVEQ	#0,D0
	RTS
.RECAL	
	SUB.L	LOOP_BEGIN(A6),D1
	SUB.L	LOOP_BEGIN(A6),D2
	SUB.L	D2,D1
	MOVE.L	LOOP_BEGIN(A6),SPL_POINTER(A6)
	ADD.L	D1,SPL_POINTER(A6)
	BRA.S	.YET
*************************************************************************
*	DATA MOUSE

X1	dc.W	3
X2	dc.W	3
Y1	dc.W	74
Y2	dc.L	74
km	dc.B	0
km2	dc.B	0
***************************************************************************
RESTITU
	LEA	FOND,A0
	MOVE.L	(A0)+,A1		* ADDR
	MOVEQ	#14,D0
.REST	
	MOVE.W	(A0)+,14(A1)
	
	MOVE.W	(A0)+,30(A1)
	ADD.W	#640,A1
	DBF	D0,.REST
	RTS
***************************************************************************
FOND2
	MOVEQ	#0,D1
	LEA	FOND,A0
	MOVE.W	X1,D0
	MOVE.W	D0,X2
	MOVE.W	Y1,D1
	AND.L	#$3F0,D0
	MULU.L	#640,D1
	MOVE.L	D1,Y2
	MOVE.L	#screen,A1
	ADD.L	D0,A1
	ADD.L	D1,A1
	MOVE.L	A1,(A0)+
	MOVEQ	#14,D0
.SAUVE	
	MOVE.W	14(A1),(A0)+
	
	MOVE.W	30(A1),(A0)+
	ADD.W	#640,A1
	DBF	D0,.SAUVE
	RTS
***************************************************************************
AFFMOUSE
	MOVE.L	Y2,D0
	MOVE.W	X2,D1
	MOVE.W	D1,D7
	AND.L	#$3F0,D1
	ADD.L	D1,D0
	AND.L	#15,D7
	LEA	mousemask,A3
	MOVE.L	#screen,A1
	ADD.L	D0,A1
	MOVEQ	#14,D6
AFF1	MOVEQ	#0,D4
	MOVE.L	(A3)+,D4
	ROR.L	D7,D4
	AND.W	D4,14(A1)
	NOT.W	D4
	OR.W	D4,14(A1)
	SWAP	D4
	AND.W	D4,30(A1)
	NOT.W	D4
	OR.W	D4,30(A1)
	ADD.W	#640,A1
	DBRA	D6,AFF1
	RTS
******************************************************************************
TESTBORDS
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.W	Y1,D0
	MOVE.W	SCREENY,D1
	CMP.W	D1,D0
	BGT.S	.SCRIN1
	MOVE.W	D0,SCREENY
	BRA.S	.SCRIN2
.SCRIN1	ADD.W	OFFSET,D1
	CMP.W	D1,D0
	BLT.S	.SCRIN2
	SUB.W	OFFSET,D0
	MOVE.W	D0,SCREENY
.SCRIN2	RTS
SCREENY	DC.W	0
OFFSET	DC.W	290-15
**************************************************************************
MOUSEIT	CMP.B	#$F7,$FFFFFC02.W
	BNE.S	.TSTKEY
	MOVE.L	#.IT2,$118.W
	RTE
.TSTKEY	MOVE.B	$FFFFFC02.W,KEY
	CMP.B	#$2A,KEY
	BEQ	SHIFT_LEFT_D
	CMP.B	#$2A+128,KEY
	BEQ	SHIFT_LEFT_U
	CMP.B	#$36,KEY
	BEQ	SHIFT_RIGHT_D
	CMP.B	#$36+128,KEY
	BEQ	SHIFT_RIGHT_U
	CMP.B	#$3A,KEY
	BEQ	CAPS_LOCK_D
	CMP.B	#$3A+128,KEY
	BEQ	CAPS_LOCK_U
	CMP.B	#$38,KEY
	BEQ	ALTERNATE_D
	CMP.B	#$38+128,KEY
	BEQ	ALTERNATE_U
	CMP.B	#$1D,KEY
	BEQ	CONTROLE_D
	CMP.B	#$1D+128,KEY
	BEQ	CONTROLE_U
	RTE
	
.IT2	MOVE.W	D0,-(A7)
	MOVE.B	$FFFFFC02.W,D0
	AND.B	#$F,D0
	BNE.S	.BB
.UU	MOVE.L	#.IT3,$118.W
	MOVE.W	(A7)+,D0
	RTE
.BB	MOVE.B	D0,km
	BRA.S	.UU
.IT3	MOVE.B	$FFFFFC02.W,X1
	MOVE.L	#.IT4,$118.W
	RTE
.IT4	MOVE.B	$FFFFFC02.W,X1+1
	MOVE.L	#.IT5,$118.W
	RTE
.IT5	MOVE.B	$FFFFFC02.W,Y1
	MOVE.L	#.IT6,$118.W
	RTE
.IT6	MOVE.B	$FFFFFC02.W,Y1+1
	MOVE.L	#MOUSEIT,$118.W
	RTE

KEY	DC.B	0
	EVEN
***************************************************************************
FILESELECT
	MOVE.W	#1,okp
	RTS
FILESEL:
	MOVEQ	#0,D0
	MOVE.B	DRV,D0
	SUB.B	#'A',D0
	CMP.B	#2,D0
	BGE.S	.HJ2
	
	MOVE.W	D0,-(A7)
	MOVE.W	#7,-(A7)
	TRAP	#13			* GET BPB
	ADDQ.W	#4,A7
	
.HJ2	LEA	DIR_FILES,A0
	MOVE.L	#(400*20)/4-1,D0
	MOVEQ	#0,D1
.NET	MOVE.L	D1,(A0)+
	DBF	D0,.NET
	
	MOVE.L	#ZERO,CURRENTREP
	MOVE.L	#ZERO,ADD_REP
	MOVE.L	#DIR_REP,ADD_REP+4
	MOVE.L	#DIR_FILES,ADD_FIL
	MOVE.L	#DIR_FILES,ADD_FIL+4
	MOVE.L	#DIR_FILES,ADD_DEB_THIS_REP
	MOVE.B	#0,NBREP
	MOVE.B	#0,NUMREP
	
	LEA	DIR_FILES,A2

	PEA	DTA_BUFFER
	MOVE.W	#$1A,-(SP)
	TRAP	#1
	ADDQ.L	#6,SP

REPRISE	MOVE.W	#$19,-(SP)
	PEA	PATH
	MOVE.W	#$4E,-(SP)
	TRAP	#1
	ADDA.L	#8,A7
.TINU	BSR	STOCKAGE
	MOVE.W	#$4F,-(SP)
	TRAP	#1
	ADDQ.L	#2,SP
	
	TST.W	D0				* D'AUTRES FICHIERS ?
	BEQ.S	.TINU				* OUI
	
	MOVE.W	#0,NB_PAGE_DEB
	MOVE.W	#0,NB_PAGE_FIN
	MOVE.L	#DIR_FILES,TOP_IN_LIST
	BSR	COUNT_MASKED_FILE
	BSR	SORT
	BSR	AFF_FS
	MOVE.W	#0,okp
	RTS
	
*--------------------------------------------------------------------------
STOCKAGE
	CMP.B	#$10,DTA_BUFFER+21		*TEST ATTRIBUT
	BEQ.S	REPERT

	LEA	maskmod+2,A5			*TEST SI EXTENSION CONNU
	LEA	DTA_BUFFER+30,A1
	MOVEQ	#8,D0
PAS_PT	CMP.B	#'.',(A1)+
	BEQ.S	POINT
	DBF	D0,PAS_PT
	BRA.S	LA				*SI PAS EXTENSION ON DEGAGE

POINT:	MOVE.L	A1,A3
	MOVE.L	A5,A4
	CMP.B	(A3)+,(A4)+			*TEST SI = AU MASQUE
	BNE.S	.SUIVAN
	CMP.B	(A3)+,(A4)+
	BNE.S	.SUIVAN
	CMP.B	(A3)+,(A4)+
	BNE.S	.SUIVAN
	BRA.S	C_UN_BON
	
.SUIVAN	ADDQ.W	#6,A5
	CMP.B	#-1,(A5)
	BEQ.S	LA
	BRA.S	POINT
	
C_UN_BON
	MOVE.B	#$20,(A2)+
	MOVE.B	#$20,(A2)+
	LEA	DTA_BUFFER+30,A1		*NOM FICHIER
	MOVE.L	(A1)+,(A2)+
	MOVE.L	(A1)+,(A2)+
	MOVE.L	(A1)+,(A2)+
	LEA	DTA_BUFFER+26,A1		*TAILLE FICHIER
	MOVE.L	(A1)+,(A2)+
LA	LEA	DTA_BUFFER+30,A1
	MOVEQ	#$D,D0
.L0003:	CLR.B	(A1)+	
	DBF	D0,.L0003
	RTS


REPERT	LEA	DTA_BUFFER+30,A3
	CMP.B	#'.',(A3)
	BEQ.S	LA
	
	LEA	18(A2),A3
	LEA	(A2),A4
	LEA	18(A2),A2
	MOVE.L	ADD_DEB_THIS_REP,A5
	
.COPY	MOVE.L	-(A4),-(A3)		* DECALE D'1 ENTREE VERS LE BAS
	CMP.L	A5,A3			* POUR INSERER LE FOLDER EN HAUT
	BGT.S	.COPY
	
	LEA	DTA_BUFFER+30,A0
	MOVE.L	ADD_DEB_THIS_REP,A1
	LEA	ADD_REP,A3
	MOVE.B	#'*',(A1)+
	MOVE.B	#'0',(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	#0,(A1)+
	
	BRA	LA


DTA_BUFFER	DS.B	44
DEFAULT		DC.L	0,0,0,0,0
POINTFIL	DC.L	0		*POINTEUR TABLE ADD_FIL
PATH		DC.B	'A:\*.*'
		DS.B	64
AFFICHAGE	DC.B	'D:\spac-klf.mtm'
		DS.B	64+12		*CHEMIN+NOMFICH
MASQUE		DC.B	'*.MOD',0
FILE_LOADED	DC.B    '*.MOD',0
NUMREP		DC.B	0
NBREP		DC.B	0
CURRENTREP	DC.L	0
ADD_DEB_THIS_REP DC.L   0
ZERO		DC.W	0
	EVEN
***************************************************************************
COUNT_MASKED_FILE
	LEA	DIR_FILES+2,A2
	MOVE.W	#0,D3
	
.XW	MOVE.L	A2,A0
	CMP.B	#0,-1(A0)
	BEQ	.LEAVE
	CMP.B	#'*',-2(A0)
	BEQ	.COUNT

.WX	CMP.B	#'.',(A0)+
	BNE.S	.WX
	MOVE.L	MASKPOINTER,A3
	
.AA	MOVE.L	A0,A4
	MOVE.L	A3,A1	
	CMP.B	(A4)+,(A1)+
	BNE.S	.NEIN
	CMP.B	(A4)+,(A1)+
	BNE.S	.NEIN
	CMP.B	(A4)+,(A1)+
	BNE.S	.NEIN
.COUNT	ADDQ.W	#1,D3
.BB	LEA	18(A2),A2
	BRA	.XW
	
.NEIN	ADDQ.W	#6,A3
	CMP.B	#-2,-3(A3)
	BNE.S	.AA
	BRA.S	.BB
	
.LEAVE	MOVE.W	D3,NNB2
	SUB.W	#19,D3
	BGE.S	.OK
	MOVEQ	#0,D3
.OK	MOVE.W	D3,BOTTOM	
	RTS
***************************************************************************
AFF_FS:
	LEA	FILES,A0
	MOVEQ	#22,D0
.CLEAN3	MOVE.B	#0,(A0)+
	DBF	D0,.CLEAN3
	LEA	FILES_TO_SORT,A1
	MOVE.L	#screen+640*27+144,where
	MOVEQ	#18,D2
	CMP.W	#1,IN_MOD
	BEQ.S	AFF_FILE_MOD
.NB1	MOVE.L	where,A2
	MOVEQ	#0,D0
	LEA	FILES,A0
	MOVE.B	(A1)+,D0
	MOVE.B	D0,D6
	BCLR	#0,D0
	MOVE.B	D0,(A0)+
	ADDQ.L	#1,A0
	ADDQ.L	#1,A1
	MOVE.L	(A1)+,(A0)+
	MOVE.L	(A1)+,(A0)+
	MOVE.L	(A1)+,(A0)+
	MOVE.L	(A1)+,D0
	BSR	CONVERT_HEXA_DECIASCII
	ADDQ.L	#8,A0
	LEA	FILES,A0
	MOVE.W	#0,compt2
	MOVEQ	#22,D1
	BSR	PRINT
	BTST	#0,D6
	BEQ.S	.PAS_INVERT
	BSR	INVERT3
.PAS_INVERT
	ADD.L	#640*8+464,where
	DBF	D2,.NB1
	RTS
	
*--------------------------------------------------------------------------
AFF_FILE_MOD
	LEA	BUFMOD+20,A0
	MOVEQ	#0,D0
	MOVE.W	P_MOD,D0
	MULU	#30,D0
	ADD.L	D0,A0
.PSSOU	MOVE.W	#0,compt2
	MOVEQ	#22,D1
	MOVE.L	where,A2
	BSR	PRINT
	CMP.B	#1,24(A0)
	BNE.S	.SPOU
	BSR	INVERT3
.SPOU	ADD.L	#640*8+464,where
	LEA	30(A0),A0
	DBF	D2,.PSSOU
	RTS
	
FILES		DS.B	23
DEJA_REP	DC.W	0
*************************************************************************
SORT:	LEA	FILES_TO_SORT,A4
	MOVEQ	#(22*19)/4-1,D0
	MOVEQ	#0,D1
.CLEAN2	MOVE.L	D1,(A4)+
	DBF	D0,.CLEAN2
	
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVEQ	#12,D2
	LEA	FILES_TO_SORT,A4
	MOVE.L	TOP_IN_LIST,A2
	MOVE.W	#-1,NB
	MOVE.W	#0,DEJA_REP
.HERE_NEXT
	BSR.S	VERIFY
	CMP.L	#-1,D2			* Y A PLUS DE FICHIER = MASQUE ?
	BEQ.S	.ENDTHE			* SI OUI => THE END
	
	MOVEQ	#12,D2
	LEA	18(A2),A2
	
	CMP.W	#18,NB
	BNE.S	.HERE_NEXT
.ENDTHE	MOVE.W	#0,DEJA_REP
	MOVE.L	A2,BOTTOM_IN_LIST
	RTS
*--------------------------------------------------------------------------
MASKPOINTER	DC.L	maskmod+2
VERIFY	MOVE.L	A2,A3
	CMP.B	#'*',(A3)
	BEQ.S	.C_EST_UN_REP
	
	CMP.B	#0,(A3)
	BEQ	.NDTHE
	
	MOVE.W	#1,DEJA_REP
	ADDQ.L	#2,A3
.PAS	CMP.B	#".",(A3)+
	BNE.S	.PAS
	MOVE.L	MASKPOINTER,A0
.REPARTI
	MOVE.L	A3,A5	
	MOVE.L	A0,A6	
	CMP.B	(A5)+,(A6)+		*TEST SI = AU MASQUE
	BNE.S	.PAS_BON
	CMP.B	(A5)+,(A6)+
	BNE.S	.PAS_BON
	CMP.B	(A5)+,(A6)+
	BNE.S	.PAS_BON
	
	ADDQ.W	#1,NB
	ADDQ.W	#1,NB_PAGE_FIN
	
	MOVEQ	#0,D3
	MOVE.W	NB,D3
	LEA	PILEADD,A5
	LEA	(A5,D3.W*4),A5
	MOVE.L	A2,(A5)
	MOVE.L	A2,A3
	MOVE.L	(A3)+,(A4)+		*C'EST = ALORS ON RECOPIE
	MOVE.L	(A3)+,(A4)+	
	MOVE.L	(A3)+,(A4)+	
	MOVE.L	(A3)+,(A4)+
	MOVE.W	(A3)+,(A4)+
	SUBQ.L	#1,D2
	RTS
	
.PAS_BON
	ADDQ.W	#6,A0
	CMP.B	#-2,-3(A0)
	BEQ.S	.WIZZ
	BRA.S	.REPARTI
	
.C_EST_UN_REP
	*CMP.W	#1,DEJA_REP
	*BEQ.S	WIZZ
	MOVE.L	(A3)+,(A4)+
	MOVE.L	(A3)+,(A4)+
	MOVE.L	(A3)+,(A4)+
	MOVE.W	(A3)+,(A4)+
	MOVE.L	#0,(A4)+
	ADDQ.W	#1,NB
	ADDQ.W	#1,NB_PAGE_FIN
	
	MOVEQ	#0,D3
	MOVE.W	NB,D3
	LEA	PILEADD,A5
	LEA	(A5,D3.W*4),A5
	MOVE.L	A2,(A5)
.WIZZ	RTS

.NDTHE	MOVEQ	#-1,D2
	RTS
	


TOP_IN_LIST	DC.L	0
BOTTOM_IN_LIST	DC.L	0

NB		DC.W	0		* # OF FILE IN WINDOW < 19
NNB2		DC.W	0		* # OF MASKED FILE IN LIST < 400
BOTTOM		DC.W	0
FILES_TO_SORT	DS.B	22*19
PILEADD 	DS.L	20
NB_PAGE_DEB	DC.W	0		* # (IN LIST) OF FIRST FILE PRINTED
NB_PAGE_FIN	DC.W	0		* # (IN LIST) OF LAST  FILE PRINTED
QUE_FAIRE	DC.W	0		* + = ON DESCEND DANS LE FILESELECT
					* - = ON MONTE
*************************************************************************
SCROLL_FILESELECT
	LEA	AFFICHAGE,A0
	MOVEQ	#1,D1
	MOVE.L	#screen+119*640+64+1,where
	MOVE.W	#1,compt2
	BSR	PRINT
	
	CMP.W	#1,IN_MOD
	BEQ	SCROLL_MOD
	
	LEA	MASQUE+1,A0
	MOVEQ	#0,D0
	MOVEQ	#0,D2
	MOVE.W	NNB2,D1
	MOVE.W	QUE_FAIRE,D0
	BGE	ADDITION
	
.SOUSTR	MOVE.W	NB_PAGE_DEB,D2
	*CMP.W	#0,D2			* SI ON EST DEJA TOUT EN HAUT
	BEQ	RIEN_FAIRE		* ON NE FAIT RIEN
	
	ADD.W	D2,D0			* SINON
	BGE.S	NO_PRBM
	MOVE.W	#0,D0
	
NO_PRBM	LEA	DIR_FILES+2,A2
	MOVE.W	D0,NB_PAGE_DEB
	MOVE.W	D0,D2
	BEQ	.OK
	
.HERE	CMP.B	#'*',-2(A2)
	BEQ.S	.PLUS_1
	
	MOVEQ	#12,D0
	MOVE.L	A2,A3
.EREH	CMP.B	#".",(A3)+
	BNE.S	.EREH
	MOVE.L	MASKPOINTER,A4
	
.AA	MOVE.L	A4,A0
	MOVE.L	A3,A5
	CMP.B	(A5)+,(A0)+		*TEST SI = AU MASQUE
	BNE.S	.PAS_BON2
	CMP.B	(A5)+,(A0)+
	BNE.S	.PAS_BON2
	CMP.B	(A5)+,(A0)+
	BNE.S	.PAS_BON2
	BRA.S	.PLUS_1

.PAS_BON2
	ADDQ.W	#6,A4
	CMP.B	#-2,-3(A4)
	BNE.S	.AA
	
	SUBQ.W	#1,D0
	BNE.S	.EREH
	LEA	18(A2),A2		* SI NON
	BRA	.HERE
	
.PLUS_1	LEA	18(A2),A2
	SUBQ.W	#1,D2			* SI OUI
	BNE.S	.HERE	
	
.OK	MOVE.L	A2,TOP_IN_LIST
	SUBQ.L	#2,TOP_IN_LIST
	MOVE.W	NB_PAGE_DEB,NB_PAGE_FIN
	BSR	SORT

RIEN_FAIRE
	RTS
*--------------------------------------------------------------------------
ADDITION:
	MOVE.W	NB_PAGE_DEB,D2
	CMP.W	BOTTOM,D2
	BEQ	RIEN_FAIRE
	
	ADD.W	D2,D0
	CMP.W	BOTTOM,D0
	BLE	NO_PRBM
	
	MOVE.W	BOTTOM,D0
	BRA	NO_PRBM
*--------------------------------------------------------------------------
SCROLL_MOD
	CMP.W	#19,MAX_INS
	BLE.S	.RETOUR_
	MOVEQ	#0,D0
	MOVE.W	QUE_FAIRE,D0
	CMP.W	#0,D0
	BMI.S	.NNEG

	ADD.W	D0,P_MOD	*POSITIF
	MOVE.W	P_MOD,D0
	MOVE.W	MAX_INS,D1
	SUB.W	#20,D1
	CMP.W	D0,D1
	BGT.S	.RETOUR_
	MOVE.W	MAX_INS,P_MOD
	SUB.W	#20,P_MOD
	BRA.S	.RETOUR_

.NNEG	ADD.W	D0,P_MOD
	MOVE.W	P_MOD,D0
	CMP.W	#0,D0
	BGE.S	.RETOUR_
	MOVE.W	#0,P_MOD
.RETOUR_ RTS
*************************************************************************
TEST_FILE:
	LEA	AFFICHAGE,A0
	MOVEQ	#1,D1
	MOVE.L	#screen+119*640+64+1,where
	MOVE.W	#1,compt2
	BSR	PRINT
	CMP.W	#1,IN_MOD
	BEQ	VOL_OK
	MOVEQ	#0,D0
	MOVE.W	Y1,D0
	SUB.L	#27,D0
	DIVU	#9,D0
	LEA	FILES_TO_SORT,A0
	LEA	PILEADD,A1
	LEA	screen+144,A2
	SWAP	D0
	MOVE.W	#0,D0
	SWAP	D0
	MOVE.L	D0,D1
	MOVE.L	D0,D2
	MULU	#18,D1
	ADD.L	D1,A0
	CMP.B	#'*',(A0)
	BEQ	OH_UN_REP
	CMP.B	#0,2(A0)
	BEQ	VOL_OK
	CMP.W	#1,EH_NON
	BEQ.S	.YA_PRBM
.NICHT_PRBM
	MOVEQ	#0,D3
	MOVE.B	(A0),D3
	BCHG	#0,D3
	MOVE.B	D3,(A0)
	MOVE.L	(A1,D0.L*4),A1
	MOVE.L	A1,ADD_MOD
	MOVE.B	(A1),D3
	BCHG	#0,D3
	MOVE.B	D3,(A1)
	MULU	#9,D2
	ADD.L	#27,D2
	MULU	#640,D2
	ADD.L	D2,A2
	BSR	INVERT3
	RTS

.YA_PRBM
	BTST.B	#0,(A0)
	BNE.S	.NICHT_PRBM
	
.WQA	LEA	FILES_TO_SORT,A3
	MOVEQ	#19,D4
	LEA	screen+640*27+144,A2

.WQS	BTST.B	#0,(A3)
	BEQ.S	.WQZ
	BSR	INVERT3
	BCLR.B	#0,(A3)
.WQZ	LEA	18(A3),A3
	ADD.L	#640*9,A2
	DBF	D4,.WQS

	MOVE.L	ADD_MOD,A3
	CMP.L	#0,A3
	BEQ.S	.AA
	BCLR.B	#0,(A3)
.AA	LEA	screen+144,A2
	BRA	.NICHT_PRBM

OH_UN_REP
	ADDQ.B	#1,POINREP
	LEA	PATH,A1
	
.NON	TST.B	(A1)+
	BNE.S	.NON
	
	LEA	-4(A1),A1
	MOVE.L	A1,A2
	LEA	2(A0),A0
	
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.L	(A0)+,(A1)+
	MOVE.B	(A0)+,(A1)+
	
.NON2	CMP.B	#0,(A2)+
	BNE.S	.NON2
	MOVE.L	#'\*.*',-1(A2)
	MOVE.B	#0,3(A2)
	MOVE.W	#1,okp
	RTS
	
TRI:	BSR	COUNT_MASKED_FILE
	BSR	SORT
	BSR	AFF_FS
	MOVE.W	#0,okp
	RTS

TEST_MOD
	MOVEQ	#0,D0
	MOVE.W	Y1,D0
	SUB.L	#27,D0
	DIVU	#9,D0
	LEA	BUFMOD+20,A0
	LEA	screen+144,A2
	SWAP	D0
	MOVE.W	#0,D0
	SWAP	D0
	MOVE.L	D0,D2
	ADD.W	P_MOD,D0
	MOVE.L	D0,D1
	MULU	#30,D1
	ADD.L	D1,A0
	BCHG.B	#0,24(A0)
	MULU	#9,D2
	ADD.L	#27,D2
	MULU	#640,D2
	ADD.L	D2,A2
	BSR.S	INVERT3
	RTS

INVERT3	MOVEQ	#6,D3
.INVERT1
	NOT.B	1(A2)
	NOT.W	16(A2)
	NOT.W	32(A2)
	NOT.W	48(A2)
	NOT.W	64(A2)
	NOT.W	80(A2)
	NOT.W	96(A2)
	NOT.W	112(A2)
	NOT.W	128(A2)
	NOT.W	144(A2)
	NOT.W	160(A2)
	NOT.B	176(A2)
	LEA	640(A2),A2
	DBF	D3,.INVERT1
	RTS

ADD_MOD	DC.L	0
EH_NON	DC.W	1
PILEREP	DS.B	15
POINREP	DC.B	0
	EVEN
***************************************************************************
EXIT_REP
	CMP.W	#1,IN_MOD
	BEQ.S	EXIT_MOD
	
	CMP.B	#0,POINREP
	BEQ.S	NO_EXIT
	
	SUBQ.B	#1,POINREP
	
	LEA	PATH+3,A0
.NON	TST.B	(A0)+
	BNE.S	.NON
	LEA	-5(A0),A0
	
.NON2	CMP.B	#'\',-(A0)
	BNE.S	.NON2
	MOVE.L	#'\*.*',(A0)+
	MOVE.L	#0,(A0)+
	
	MOVE.W	#1,okp
NO_EXIT	RTS

EXIT_MOD
	MOVE.W	#0,IN_MOD
	MOVE.W	#1,EH_NON
	MOVE.W	#8,okp
	RTS
***************************************************************************
ADD1FS	MOVE.W	#1,QUE_FAIRE
	BRA.S	SCROLL
ADD18FS MOVE.W	#18,QUE_FAIRE
	BRA.S	SCROLL
SUB1FS	MOVE.W	#-1,QUE_FAIRE
	BRA.S	SCROLL
SUB18FS MOVE.W	#-18,QUE_FAIRE
SCROLL	MOVE.W	#0,DEJA_REP
	MOVE.W	#7,okp
	RTS
SCROL
	BSR	SCROLL_FILESELECT
	BSR	AFF_FS
	MOVE.W	#0,okp
	RTS
***************************************************************************
REINIT_TEMPO
	MOVE.B	#125,TEMPO			; Tempo par dfaut
	MOVE.W	#6,SPEED			; Vitesse par dfaut
	MOVE.W	#0,TICK				; Vitesse par dfaut
	MOVE.B	#5,Timer_Control
	MOVE.B	#192,Timer_Data
	MOVE.W	#984,Code_Sample_Lenght	
	MOVE.W	#984,Sample_Lenght
	RTS
***************************************************************************
REINIT_PAN
	LEA	PILEVOIE,A0
	MOVEQ	#16-1,D0
.ZZ	MOVE.L	(A0)+,A1
	MOVE.B	#$FF,LEFT_VOL(A1)		* PAN VOIE GAUCHE
	MOVE.B	#$00,RIGHT_VOL(A1)
	MOVE.W	#8363,BASE_SPL(A1)		* BASE FRQ
	MOVE.L	(A0)+,A1
	MOVE.B	#$00,LEFT_VOL(A1)		* PAN VOIE DROITE
	MOVE.B	#$FF,RIGHT_VOL(A1)
	MOVE.W	#8363,BASE_SPL(A1)
	DBF	D0,.ZZ
	RTS
***************************************************************************
AFFSONG:
	MOVEQ	#0,D0
	MOVE.B	curmus,D0
	MOVE.L  #screen+640*312+448,where
	BSR	pouet
	MOVE.W	curpos,D0
	MOVE.L  #screen+640*320+448,where
	BSR	pouet
	MOVE.W	curpatt,D0
	MOVE.L  #screen+640*328+448,where
	BSR	pouet
	
	MOVE.W	curlen,D0
	MOVE.L  #screen+640*320+481,where
	BSR	pouet2
	
	MOVE.W	curlop,D0
	MOVE.L  #screen+640*344+448,where
	BSR	pouet
	MOVEQ	#0,D0
	MOVE.B	maxmus,D0
	MOVE.L  #screen+640*312+481,where
	BSR	pouet2
	MOVE.W	maxpatt,D0
	MOVE.L  #screen+640*328+481,where
	BSR	pouet2
	
	MOVE.W	maxtrack,D0
	MOVE.L  #screen+640*336+481,where
	BSR	pouet2
	RTS
***************************************************************************
BEGIN:
	MOVE.L	A7,A5
	MOVE.L	4(A5),A5
	MOVE.L	$C(A5),D0
	ADD.L	$14(A5),D0
	ADD.L	$1C(A5),D0
	ADD.L	#$100,D0
	MOVE.L	D0,-(A7)
	MOVE.L	A5,-(A7)
	MOVE.W	#0,-(A7)
	MOVE.W	#$4A,-(A7)
	TRAP	#1
	ADD.L	#12,A7
	
	LEA	SAMPLE,A0
	MOVEQ	#0,D0
	MOVE.L	#65000,D1
.COP	MOVE.L	D0,(A0)+
	DBF	D1,.COP	
	
	DC.W	$A000			* RECHERCHE ADD FONT SYS
	MOVE.L	-$1C4(A0),A0
	MOVE.L	$4C(A0),ADDFONT
	
	MOVE.W	#$19,-(A7)		* DGETDRIVE
	TRAP 	#1
	ADDQ.L	#2,A7
	ADD.W	#'A',D0
	MOVE.B	D0,PATH
	MOVE.B	D0,AFFICHAGE
	MOVE.B	D0,DRV

	MOVE.L	#pile2,-(a7)		*SUPERVISOR
	MOVE.W	#$20,-(a7)
	trap #1
	MOVE.L	D0,pile


Init_Sound
* Stoppe la lecture DMA au cas o...
		clr.b	$ffff8901.w

* DAC sur piste 0 (quartet fort)
		move.b	#$0f,$ffff8920.w

* Source DSP-Xmit sur Horloge Interne 25.175 MHz, DSP connect (Enable)
* Source DMA-Play sur Horloge Interne 25.175 MHz
		move.w	#%10010001,$ffff8930.w

* Destinations DAC, DMA-Record et External OutPut
* connectes  Source DSP-Xmit, Handshaking On
* Destination DSP-Rec connecte sur DMA-Play, DSP connect (Enable)
		move.w	#%0010001000010011,$ffff8932.w

* Frquence 49169 Hz
		move.b	#1,$ffff8935.w

* Programme DSP
	move.w	#113,-(sp)		; DSP_RequestUniqueAbility
	trap	#14			; XBios
	addq.l	#2,sp

	move.w	d0,-(sp)		; No Ability
	move.l	#(DSP_End-DSP_Code)/3,-(sp)		; Longueur en Mots DSP
	pea.l	DSP_Code		; Adresse du code binaire
	move.w	#109,-(sp)		; Dsp_ExecProg
	trap	#14			; XBios
	lea.l	12(sp),sp


Connect	move.l	#87654321,$ffffa204.w
	moveq.l	#0,d0

Conct_Get
	btst.b	#0,$ffffa202.w
	bne.s	DSP_Test
	addq.l	#1,d0
	cmp.l	#100000,d0
	beq.s	DSP_Error
	bra.s	Conct_Get

DSP_Test
	move.l	$ffffa204.w,d0
	cmp.l	#12345678,d0
	beq.s	DSP_Ok

DSP_Error
	moveq.l	#-1,d0
	
DSP_Ok	
	LEA	PILEVOIE,A0
	MOVEQ	#16-1,D0

	BSR	REINIT_PAN	
	BSR	REINIT_TEMPO
	
	PEA	MOUSEABS		*INIT MOUSE ABSOLUTE
	MOVE.W	#8,-(A7)
	MOVE.W	#25,-(A7)
	TRAP	#14
	ADDQ.L	#8,A7
	
	BSR	FRE
	
	LEA	PATH,A0
	MOVEQ	#1,D1
	MOVE.L	#screen+119*640+64+1,where
	MOVE.W	#1,compt2
	BSR	PRINT

	
	MOVE.W	#2,-(A7)
	TRAP	#14
	ADDQ.L 	#2,A7
	MOVE.L 	D0,ecran
	
	MOVE.W	#-1,-(A7)
	MOVE.W	#88,-(A7)
	TRAP	#14
	ADDQ.W 	#2,A7
	MOVE.W	D0,rezo

	MOVE.L	$42E.W,D0
	SUB.L	#153600,D0
	
	MOVE.W	#$2B,-(A7)	
	MOVE.W	#3,-(a7)
	MOVE.L	D0,-(a7)
	MOVE.L	D0,-(a7)
	MOVE.W	#5,-(a7)
	TRAP 	#14
	ADD.W	#14,a7
	
	DC.W	$A00A
	BCLR	#0,$484.W
	
	LEA	palet,A0
	LEA	$FFFF9800.W,A1
*	MOVE.L	#$0030005A,4*5(A0)
	MOVE.L	#255,D0
.O1	MOVE.L (A0)+,(A1)+
	DBF	D0,.O1
	
	LEA	$FFFF9800+100*4,A1
	MOVE.L	#255-100,D0
.O2	MOVE.L	#$FF000000,(A1)+
	DBF	D0,.O2

        LEA	PILEVOIE,A0
	MOVE.L	DEBTRACK,A1
	ADDQ.W	#2,A1
	MOVEQ	#32-1,D0
.LL	MOVE.L	(A0)+,A2
	MOVE.L	A1,ADDCURTRACK(A2)
	MOVE.W	#64,LENCURTRACK(A2)
	MOVE.W	#0,NBCURTRACK(A2)
	DBF	D0,.LL
	MOVE.W	#64,LENCURPATT
	
	LEA	NUMERO_VOICE_TAB,A0
        MOVE.L	#$00010203,(A0)
        MOVE.B	#$04,4(A0)
        
        LEA	VOICE_TAB,A0
        MOVE.L	#$01010101,(A0)
        MOVE.L	#$01010101,4(A0)
        MOVE.L	#$01010101,8(A0)
        MOVE.L	#$01010101,12(A0)
        MOVE.L	#$01010101,16(A0)
        MOVE.L	#$01010101,20(A0)
        MOVE.L	#$01010101,24(A0)
        MOVE.L	#$01010101,28(A0)
	BSR	AFFPATTERN3
	
        LEA	VOICE_TAB,A0
        MOVE.L	#$00000000,(A0)
        MOVE.L	#$00000000,4(A0)
        MOVE.L	#$00000000,8(A0)
        MOVE.L	#$00000000,12(A0)
        MOVE.L	#$00000000,16(A0)
        MOVE.L	#$00000000,20(A0)
        MOVE.L	#$00000000,24(A0)
        MOVE.L	#$00000000,28(A0)
        
	MOVEQ	#0,D0
	BSR.L	T_VS
	MOVEQ	#1,D0
	BSR.L	T_VS
	MOVEQ	#2,D0
	BSR.L	T_VS
	MOVEQ	#3,D0
	BSR.L	T_VS
	MOVEQ	#4,D0
	BSR.L	T_VS
	
	BSR.L	AFF_VOL_GEN
	BSR.L	AFF_DIGIPL
	BSR.L	AFF_PL

	MOVE.B	#0,curmus
	MOVE.W	#0,curpos
	MOVE.W	#0,curpatt
	MOVE.W	#128,curlen		* =MAXPOS =MAXSEQ
	MOVE.W	#0,curlop
	MOVE.B	#2,maxmus
	MOVE.W	#128,maxpatt
	MOVE.W	#32,maxtrack

	MOVE.L	DEBMUS,A0
	MOVE.L	DEBSEQ,A1
	MOVEQ	#0,D0
	MOVEQ	#0,D1
	MOVE.B	maxmus,D0
	SUBQ.W	#1,D0
	MOVE.W	curlen,D1
.BB	MOVE.L	A1,ADDDEB_MUS(A0)
	MOVE.W	D1,LEN_MUS(A0)
	MOVE.W	#0,RESTART_MUS(A0)
	MOVE.B	#6,I_SPEED_MUS(A0)
	MOVE.B	#$7D,I_SPEED_MUS(A0)
	MOVE.W	#$2020,I_MASTERVOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+4(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+8(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+12(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+16(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+20(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+24(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+28(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+32(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+36(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+40(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+44(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+48(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+52(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+56(A0)
	MOVE.L	#$FF0000FF,I_VOL_MUS+60(A0)
	
	MOVEQ	#31,D3
.KL	MOVE.B	#0,(NAME_MUS)(A0,D3.W)
	DBF	D3,.KL
	
	LEA	(A1,D1.W*2),A1
	ADD.W	#TOTAL_MUS,A0
	DBF	D0,.BB
	
	MOVE.L	DEBPATT,A0
	MOVE.W	maxpatt,D0
	SUBQ	#1,D0
.MM	MOVE.W	#64,(A0)
	LEA	32*2+2(A0),A0
	DBF	D0,.MM
	
	BSR	REINIT_TAB_TRACK
	BSR	INITMEG
	BSR	AFFSONG
	
	BCHG.B	#0,DRUM
	BSR.L	PIANO_DRUM
	
	BSR	OPTI
	
	MOVE.B	#1,VOICE0+KIND_VOICE
	MOVE.B	#8,VOICE0+BITS
	
	MOVE.B	#1,VOICE1+KIND_VOICE
	MOVE.B	#8,VOICE1+BITS
	BSR.L	SET_ON
	
	MOVE.L	#SAMPLE,ADDCURSPL
	
	LEA	screen+640*80+8,A0
	MOVEQ	#23,D0
.AA	NOT.W	(A0)
	NOT.W	16(A0)
	NOT.W	32(A0)
	NOT.W	48(A0)
	LEA	640(A0),A0
	DBF	D0,.AA

	MOVE.W	SR,-(A7)
	MOVE.W	#$2700,SR
	JSR	STORE
	CLR.B	$FFFFFA19.W
	MOVE.B	Timer_Data,$FFFFFA1F.W
	MOVE.B	Timer_Control,$FFFFFA19.W
	BCLR	#3,$FFFFFA17.W
	BSET	#5,$FFFFFA07.W
	BSET	#5,$FFFFFA13.W
	MOVE.L	#MY_70,$70.W
	MOVE.L	#MY_134,$134.W
	MOVE.L	#MOUSEIT,$118.W
	*MOVE.B	#$80+$2A/2,$FFFFA201.W	; Host User 2, vecteur $2a
	JSR	OVERSCAN
	MOVE.W	(A7)+,SR
	
	BSR	FOND2
	MOVE.W	#1,okp
	BSR	FILESEL
	JMP	niet
OVERSCAN
	MOVE.W	rezo,D0
	BTST	#4,D0
	BNE.S	VGA
	BTST	#5,D0
	BEQ.S	NTSC
	MOVE.W	#$F+14,$FFFF82A6.W
	MOVE.W	#$F+15,$FFFF82A8.W
	MOVE.W	#$271-18,$FFFF82A4.W
	MOVE.W	#$271-18,$FFFF82AA.W
	MOVE.W	#$26B,$FFFF82AC.W
	MOVE.W	#290-15,OFFSET				* 308
	RTS
VGA	MOVE.W	#$23,$FFFF82A6.W
	MOVE.W	#$23,$FFFF82A8.W
	MOVE.W	#$403,$FFFF82A4.W
	MOVE.W	#$403,$FFFF82AA.W
	MOVE.W	#$415,$FFFF82AC.W
	MOVE.W	#248-15,OFFSET
	RTS
NTSC	MOVE.W	#$3,$FFFF82A6.W
	MOVE.W	#$1,$FFFF82A8.W
	MOVE.W	#$1F1,$FFFF82A4.W
	MOVE.W	#$1FE,$FFFF82AA.W
	MOVE.W	#$1F2,$FFFF82AC.W
	MOVE.W	#248-15,OFFSET
	RTS
***************************************************************************
STORE	LEA	SAVE_REGISTER,A0
	MOVE.L	$70.W,(A0)+
	MOVE.L	$118.W,(A0)+
	MOVE.L	$134.W,(A0)+
	MOVE.L	$FFFFFA06.W,(A0)+
	MOVE.L	$FFFFFA12.W,(A0)+
	MOVE.L	$FFFFFA16.W,(A0)+
	MOVE.B	$FFFFFA1F.W,(A0)+
	MOVE.B	$FFFFFA25.W,(A0)+
	RTS
RESTORE LEA	SAVE_REGISTER,A0
	MOVE.W	#$2700,SR
	MOVE.L	(A0)+,$70.W
	MOVE.L	(A0)+,$118.W
	MOVE.L	(A0)+,$134.W
	MOVE.L	(A0)+,$FFFFFA06.W
	MOVE.L	(A0)+,$FFFFFA12.W
	MOVE.L	(A0)+,$FFFFFA16.W
	MOVE.B	(A0)+,$FFFFFA1F.W
	MOVE.B	(A0)+,$FFFFFA25.W
	MOVE.W	#$2300,SR
	RTS
***************************************************************************
SAVE_REGISTER	DCB.L	7
ADDFONT		DC.L	0
ARP_COUNTER	DC.B	0
		EVEN
***************************************************************************
*	Table of (Scancode) to (number of sample)
AZERTY
* Pave alphanumerique
	dc.b	$10,0,$11,1,$12,2,$13,3,$14,4,$15,5,$16,6,$17,7,$18,8
	dc.b	$19,9,$1a,10,$1b,11,$1e,12,$1f,13,$20,14,$21,15,$22,16
	dc.b	$23,17,$24,18,$25,19,$26,20,$27,21,$28,22,$2c,23,$2d,24
	dc.b	$2e,25,$2f,26,$30,27,$31,28,$32,29,$33,30,$34,31
	dc.b	$35,32
* Pave numerique
	dc.b	$63,33,$64,34,$65,35,$66,36,$67,37,$68,38,$69,39
	dc.b	$4a,40,$6a,41,$6b,42,$6c,43,$4e,44,$6d,45,$6e,46,$6f,47
	dc.b	$72,48,$70,49,$71,50
* Numero du pave alphanumerique
	dc.b	254,51,2,52,3,53,4,54,5,55,6,56,7,57,8,58,9,59,$a,60,$b,61,$c,62,$d,63
	dc.l	-1
***************************************************************************
FONCTION	
* Touches de fonctions  (inchangees)
	dc.b	$3b,8,$3c,9,$3d,10,$3e,11,$3f,12,$40,13,$41,14,$42,15,$43,16,$44,17
	dc.b	$48,6,$4b,4,$50,7,$4d,5 	* Fleches
	dc.b   	1,3				* TAB = ESC
	dc.b	$39,1				* Space bar
	dc.b	$62,2				* help
	dc.b	$52,18,$47,19			* insert,clr home
	dc.b	$61,20				* undo
	dc.b	$e,21				* backspace
	dc.l	-1

***************************************************************************
*	Table of (scancode) to (hexa -> Commande & Donnees)
DATA
	dc.b	$70,0,$6d,1,$6e,2,$6f,3,$6a,4,$6b,5
	dc.b	$6c,6,$67,7,$68,8,$69,9,$10,$A,$30,$B
	dc.b	$2E,$C,$20,$D,$12,$E,$21,$F
	dc.l	-1


***************************************************************************
*	Table of (scancode) to (number of note)
NOTE1
*	Octave 1
	dc.b	$2c,0,$1f,1,$2d,2,$20,3,$2e,4,$2f,5
	dc.b	$22,6,$30,7,$23,8,$31,9,$24,10,$32,11
*	octave 2
	dc.b	$33,12,$26,13,$34,14,$27,15,$35,16,$10,17
	dc.b	$3,18,$11,19,$4,20,$12,21,$5,22,$13,23
*	octave 3
	dc.b	$14,24,$7,25,$15,26,$8,27,$16,28,$17,29,$a,30,$18,31
	dc.b	$b,32,$19,33,$c,34,$1a,35
*	octave 4
	dc.b	$1b,36,$29,37
	dc.l	-1

***************************************************************************
*	Table of (number of note) to (note)
DIGINOTE1:
	INCBIN	D:\BOSS\DATA\PERIOD.TAB
	
TABLE_DIGINOTE	
	DC.L	DIGINOTE1+00*192,DIGINOTE1+01*192,DIGINOTE1+02*192,DIGINOTE1+03*192
	DC.L	DIGINOTE1+04*192,DIGINOTE1+05*192,DIGINOTE1+06*192,DIGINOTE1+07*192
	DC.L	DIGINOTE1+08*192,DIGINOTE1+09*192,DIGINOTE1+10*192,DIGINOTE1+11*192
	DC.L	DIGINOTE1+12*192,DIGINOTE1+13*192,DIGINOTE1+14*192,DIGINOTE1+15*192

**************************************************************************
DIGICORRES
	DC.B	'C-0','C#0','D-0','D#0','E-0'
	DC.B	'F-0','F#0','G-0','G#0','A-0','A#0','B-0'
	DC.B	'C-1','C#1','D-1','D#1','E-1'
	DC.B	'F-1','F#1','G-1','G#1','A-1','A#1','B-1'
	DC.B	'C-2','C#2','D-2','D#2','E-2'
	DC.B	'F-2','F#2','G-2','G#2','A-2','A#2','B-2'
	DC.B	'C-3','C#3','D-3','D#3','E-3'
	DC.B	'F-3','F#3','G-3','G#3','A-3','A#3','B-3'
	DC.B	'C-4','C#4','D-4','D#4','E-4'
	DC.B	'F-4','F#4','G-4','G#4','A-4','A#4','B-4'
	DC.B	'C-5','C#5','D-5','D#5','E-5','F-5'
	DC.B	'F-5','F#5','G-5','G#5','A-5','A#5','B-5'
	DC.B	'C-6','C#6','D-6','D#6','E-6','F-6'
	DC.B	'F-6','F#6','G-6','G#6','A-6','A#6','B-6'
	DC.B	'C-7','C#7','D-7','D#7','E-7','F-7'
	DC.B	'F-7','F#7','G-7','G#7','A-7','A#7','B-7'
	DC.B	-1,-1,-1
	EVEN

**************************************************************************
*	Table of scancode to AZERTY
SCANCODE
	DC.B	$10,'A',$11,'Z',$12,'E',$13,'R',$14,'T',$15,'Y',$16,'U',$17,'I',$18,'O',$19,'P',$1B,'*'
	DC.B    $1E,'Q',$1F,'S',$20,'D',$21,'F',$22,'G',$23,'H',$24,'J',$25,'K',$26,'L',$27,'M'
	DC.B	$2C,'W',$2D,'X',$2E,'C',$2F,'V',$30,'B',$31,'N',$32,'?'
	DC.B	$6D,'1',$6E,'2',$6F,'3',$6A,'4',$6B,'5',$6C,'6',$67,'7',$68,'8',$69,'9',$70,'0',$66,'*'
	DC.B	$1C,$D,$72,$D,$71,'.',$33,'.',$39,' ',$28,'\'
	DC.B	1,$FD,$53,$FC,$4B,$FB,$4D,$FA,$E,8,$53,8
	DC.B	-1,-1
**************************************************************************

txt	dc.b	" Mega Track",$d,$a
	dc.b    " By Axel F.",$d,$a
	DC.B	"A day he wasn't asleep",0

palet	INCBIN	D:\BOSS\DATA\MGT.PAL
	even
screen	INCBIN	D:\MGT.scr
screen2	equ	screen+640*372
*--------------------------------------------------------------------------		
DSP_Code		IncBin	'D:\BOSS\DATA\HOST_MGT.P56'
DSP_End
*--------------------------------------------------------------------------		
mousemask	incbin	D:\BOSS\data\mouse.msk
FOND		DCB.L	62

CUR		EQU screen+640*438+17+6+15
VOICE		EQU screen+640*382+17+6+15
VOICEU		EQU screen+640*382+17+6-1
VOICED		EQU screen+640*431+17+6-1

PILEVOIE	DC.L	VOICE0,VOICE1,VOICE2,VOICE3,VOICE4,VOICE5
		DC.L	VOICE6,VOICE7,VOICE8,VOICE9,VOICE10,VOICE11
		DC.L	VOICE12,VOICE13,VOICE14,VOICE15,VOICE16,VOICE17
		DC.L	VOICE18,VOICE19,VOICE20,VOICE21,VOICE22,VOICE23
		DC.L	VOICE24,VOICE25,VOICE26,VOICE27,VOICE28,VOICE29
		DC.L	VOICE30,VOICE31
		DC.L	0,0
		
ecran		dc.l	0
rezo		dc.W	0		
***************************************************************************	
	SECTION BSS
		ds.l	200
pile2		ds.l	200	

SAMPLE	DS.B	LEN_SAMPLE_MGT*256

BLK_TAB		DS.B	32
VOICE_TAB	DS.B	32
VOICE_TAB1	DS.B	32
NUMERO_VOICE_TAB	DS.B	6
VOICE0		DS.B	VOICE_SIZE
VOICE1		DS.B	VOICE_SIZE
VOICE2		DS.B	VOICE_SIZE
VOICE3		DS.B	VOICE_SIZE
VOICE4		DS.B	VOICE_SIZE
VOICE5		DS.B	VOICE_SIZE
VOICE6		DS.B	VOICE_SIZE
VOICE7		DS.B	VOICE_SIZE
VOICE8		DS.B	VOICE_SIZE
VOICE9		DS.B	VOICE_SIZE
VOICE10		DS.B	VOICE_SIZE
VOICE11		DS.B	VOICE_SIZE
VOICE12		DS.B	VOICE_SIZE
VOICE13		DS.B	VOICE_SIZE
VOICE14		DS.B	VOICE_SIZE
VOICE15		DS.B	VOICE_SIZE
VOICE16		DS.B	VOICE_SIZE
VOICE17		DS.B	VOICE_SIZE
VOICE18		DS.B	VOICE_SIZE
VOICE19		DS.B	VOICE_SIZE
VOICE20		DS.B	VOICE_SIZE
VOICE21		DS.B	VOICE_SIZE
VOICE22		DS.B	VOICE_SIZE
VOICE23		DS.B	VOICE_SIZE
VOICE24		DS.B	VOICE_SIZE
VOICE25		DS.B	VOICE_SIZE
VOICE26		DS.B	VOICE_SIZE
VOICE27		DS.B	VOICE_SIZE
VOICE28		DS.B	VOICE_SIZE
VOICE29		DS.B	VOICE_SIZE
VOICE30		DS.B	VOICE_SIZE
VOICE31		DS.B	VOICE_SIZE
***************************************************************************
EFFECT_BUFFER	DS.L	10
BLOCK_BUFFER	DS.B	6*256
UNDO_BUFFER	DS.B	6*256

BUF_SAVE	DS.B	LEN_S
RIEN		DS.L	1024
BUFMOD		DS.L	8000/4

ADD_FIL		DS.L	1500
ADD_REP		DS.L	60
DIR_FILES	DS.B	18*1500
DIR_REP		DS.B	64*60
***************************************************************************
MUSIQUE			   * 256 musiques possibles, reparties en sequences 
		RSRESET
NAME_MUS	RS.B	32
ADDDEB_MUS	RS.L	1
LEN_MUS		RS.W	1
RESTART_MUS	RS.W	1
I_SPEED_MUS	RS.B	1
I_TEMPO_MUS	RS.B	1
I_MASTERVOL_MUS RS.W	1
I_VOL_MUS	RS.W	32

TOTAL_MUS	RS.L	1

	DS.W	TOTAL_MUS*2
***************************************************************************
SEQUENCE
* 	La sequence correspond a la succession des patterns pour
*	former la musique.Ici une position pointe sur une sequence de piste
*	2 octets = le numero de la pattern (0 -> 65535)
	DS.W	128*2
***************************************************************************
PATTERNS		* 1 PATT = SEQUENCE DE 32 PISTES + LEN PATT
*		          1er MOT = LEN ROW OF THE PATT

	DS.W	32*128+128
***************************************************************************
TABTRACK
	DS.L	32	* 32 PISTES EN MEMOIRE
***************************************************************************
TRACK		        * 1 PISTE = 1 VOIE
*		          1er MOT = LEN PISTE

	DS.B	(2+64*6)+(2+64*6)*31		* LEN = 64 DE BASE
***************************************************************************
*	Sample
s1	

 


