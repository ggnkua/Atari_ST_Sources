; dsp_fix.s
;
; COPYRIGHT (c) 1998 by NoCrew Laboratories.
;
; Implements:
;
;     extern Int dsp_load_program(Byte *program, Int length);
;
; Where length is the number of DSP words (e.i. 3 byte tuples).
; A return value of 1 means that the loading was sucessful. 0
; means something went wrong.
;
; This module will always load the DSP program. It is compatible
; with the Dsp_ExecProg loader. However, as it reloads the DSP
; bootstrap code every time -- which the TOS version does not --
; this one does not freeze up.

	
; ------------------------------------------------------
		SECTION	TEXT
; ------------------------------------------------------

dsp_load_program:
		move.l	a0,.dsp_program
		move.l	d0,.dsp_length

		move	sr,d0				;Test for supervisor mode.
		btst	#13,d0
		bne.s	.dsp_load
	
		move.l	#.dsp_load,-(sp)
		move.w	#$26,-(sp)
		trap	#14
		addq.w	#6,sp

		move.l	.dsp_status,d0
		rts

.dsp_load:	bsr	.dsp_reset
		bsr	.dsp_go
		move.l	d0,.dsp_status
		rts

.dsp_reset:	move.b	#$e,$ffff8800.w			;Power down.
		move.b	$ffff8800.w,d0
		and.b	#$ef,d0
		move.b	d0,$ffff8802.w
		or.b	#$10,d0
		move.b	d0,$ffff8802.w
		
		;move.l	#dsp_down,d0
		;bsr.w	cconws

		move.w	#10000-1,d0			;Wait for DSP to power down.
.wait:		nop
		dbra	d0,.wait

		move.b	#$e,$ffff8800.w			;Power up.
		move.b	$ffff8800.w,d0
		and.b	#$ef,d0
		move.b	d0,$ffff8802.w
		
		;move.l	#dsp_up,d0
		;bsr.w	cconws
		rts

.dsp_go:	lea	.dsp_bootstrap_code,a0		;Load system startup code.
		move.w	#512-1,d0
.next:		btst.b	#1,$ffffa202.w
		beq.s	.next
		move.b	(a0)+,$ffffa205.w
		move.b	(a0)+,$ffffa206.w
		move.b	(a0)+,$ffffa207.w
		dbra	d0,.next
		
		;move.l	#dsp_boot,d0
		;bsr.w	cconws

		move.l	.dsp_program,a0			;Load DSP binary.
		move.l	.dsp_length,d0
		subq.w	#1,d0
		bmi.s	.no_way
.copy:		btst.b	#1,$ffffa202.w
		beq.s	.copy
		move.b	(a0)+,$ffffa205.w
		move.b	(a0)+,$ffffa206.w
		move.b	(a0)+,$ffffa207.w
		dbra	d0,.copy
		
		;move.l	#dsp_bin,d0
		;bsr.w	cconws

.go:		btst.b	#1,$ffffa202.w			;Launch DSP binary.
		beq.s	.go
		move.l	#3,$ffffa204.w
		
		;move.l	#dsp_exec,d0
		;bsr.w	cconws
	
		moveq	#1,d0
		rts
.no_way:	moveq	#0,d0
		rts


; ------------------------------------------------------
		SECTION	DATA
; ------------------------------------------------------

.dsp_bootstrap_code:
		dc.b	$0c,$00,$40,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$60,$f4,$00,$00,$00,$4f,$61,$f4
		dc.b	$00,$00,$7e,$a9,$06,$2e,$80,$00,$00,$47
		dc.b	$07,$d8,$84,$07,$59,$84,$08,$f4,$a8,$00
		dc.b	$00,$04,$08,$f4,$bf,$00,$0c,$00,$00,$fe
		dc.b	$b8,$0a,$f0,$80,$00,$7e,$a9,$08,$f4,$a0
		dc.b	$00,$00,$01,$08,$f4,$be,$00,$00,$00,$0a
		dc.b	$a9,$80,$00,$7e,$ad,$08,$4e,$2b,$44,$f4
		dc.b	$00,$00,$00,$03,$44,$f4,$45,$00,$00,$01
		dc.b	$0e,$a0,$00,$0a,$a9,$80,$00,$7e,$b5,$08
		dc.b	$50,$2b,$0a,$a9,$80,$00,$7e,$b8,$08,$46
		dc.b	$2b,$44,$f4,$45,$00,$00,$02,$0a,$f0,$aa
		dc.b	$00,$7e,$c9,$20,$00,$45,$0a,$f0,$aa,$00
		dc.b	$7e,$d0,$06,$c6,$00,$00,$7e,$c6,$0a,$a9
		dc.b	$80,$00,$7e,$c4,$08,$58,$6b,$0a,$f0,$80
		dc.b	$00,$7e,$ad,$06,$c6,$00,$00,$7e,$cd,$0a
		dc.b	$a9,$80,$00,$7e,$cb,$08,$58,$ab,$0a,$f0
		dc.b	$80,$00,$7e,$ad,$06,$c6,$00,$00,$7e,$d4
		dc.b	$0a,$a9,$80,$00,$7e,$d2,$08,$58,$eb,$0a
		dc.b	$f0,$80,$00,$7e,$ad,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		dc.b	$00,$00,$00,$00,$00,$00
		
;dsp_down:	dc.b	13,10,"DSP power down",13,10,0
;dsp_up:		dc.b	13,10,"DSP power up",13,10,0
;dsp_boot:	dc.b	13,10,"DSP bootstrap code loaded",13,10,0
;dsp_bin:	dc.b	13,10,"DSP binary loaded",13,10,0
;dsp_exec:	dc.b	13,10,"DSP binary launched",13,10,0

; ------------------------------------------------------
		SECTION	BSS
; ------------------------------------------------------

.dsp_program:	ds.l	1
.dsp_length:	ds.l	1
.dsp_status:	ds.l	1


; ------------------------------------------------------
		SECTION	TEXT
; ------------------------------------------------------