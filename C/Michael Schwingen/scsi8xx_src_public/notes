msg_bad:
	INT	SEND_REJECT
	MOVE	0x07, SCRATCHA	; REJECT Message
	MOVE MEMORY 1, SCRATCHA, msgout
	SET	ATN
;	JUMP	clrack

clrack:
	CLEAR	ACK
dispatch:
L01C8:
        MOVE 0x00000001,msgin, WHEN MSG_IN 
        JUMP msg_complete, IF 0x00
        JUMP msg_disconnect, IF 0x04
;        JUMP L500002E8, IF 0x02
;        JUMP L50000304, IF 0x03
        JUMP msg_extended, IF 0x01	; extended message
        JUMP clrack, IF 0x08		; NOP
        JUMP clrack, IF 0x07		; Reject
        JUMP msg_ign_residue, IF 0x23	; ignore Wide residue
	
	INT	UNKNOWN_MESSAGE


; MSG 00 = command complete
msg_complete:
        MOVE SCNTL2 & 0x7F TO SCNTL2
        CLEAR ACK ATN
        (WAIT) DISCONNECT

	(Ende)

; MSG 04 = Disconnect
msg_disconnect:
        MOVE SCNTL2 & 0x7F TO SCNTL2
        CLEAR ACK ATN
        (WAIT) DISCONNECT
	(...)

; MSG 02 = Save Pointers

; Msg 03 = Restore Pointers

msg_extended:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	1,msgin+1, WHEN MSG_IN
	JUMP	msg_ext_3, IF 0x03
	JUMP	msg_ext_bad, IF NOT 0x02
msg_ext_2:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	1,msgin+2, WHEN MSG_IN
	JUMP	msg_wdtr, IF 0x03	; WDTR
	JUMP	msg_bad

msg_ext_3:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	1,msgin+2, WHEN MSG_IN
	JUMP	msg_sdtr, ix 0x01
	JUMP	msg_bad

msg_wdtr:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	1,msgin+3, WHEN MSG_IN
	INT	GOT_WDTR

msg_sdtr:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	2,msgin+3, WHEN MSG_IN
	INT	GOT_SDTR

msg_ign_residue:
	CLEAR	ACK
	JUMP	dispatch, WHEN NOT MSG_IN
	MOVE	1,msgin+1, WHEN MSG_IN
	JUMP	clrack, IF 0x00
	INT	IGNORE_RESIDUE

	