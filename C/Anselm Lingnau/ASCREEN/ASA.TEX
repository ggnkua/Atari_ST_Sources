% ASCREEN-3.2-HANDBUCH --- Anhang A (GEM-Nachrichten)
% Copyright (C) 1992 by Anselm Lingnau
%
\chapter{\ASCREEN\ und GEM-Nachrichten} \label{a:gem-msg}

\section{GEM-Nachrichten}

Alle, die schon einmal ein GEM-Programm geschrieben haben,
kennen {\em Nachrichten\/} und die Warteschlange:
jedes GEM-Programm bekommt so zum Beispiel mitgeteilt,
welche MenÅpunkte gewÑhlt wurden
oder welche Fenster neu gezeichnet werden mÅssen.
Meist werden Nachrichten von den AES erzeugt,
dem Teil des Atari-""Betriebssystems,
das sich mit der graphischen BenutzungsoberflÑche befaût.

Auch \ASCREEN\ verarbeitet natÅrlich diverse GEM-""Nachrichten.
Dazu gehîren aber nicht nur die Åblichen Nachrichten
wie "`Fenster neuzeichnen"' oder "`MenÅpunkt ausgewÑhlt"',
sondern auch einige besondere nur fÅr \ASCREEN\ definierte Nachrichten.
Hiermit kînnen andere Programme \ASCREEN\ bitten,
eine \DVI-Datei einzulesen,
die gerade gezeigte \DVI-Datei nochmals zu lesen,
ein neues Fenster zu îffnen und einiges mehr.
In diesem Anhang erklÑre ich Ihnen diese Nachrichten
und zeige auch, wie Sie sie von einem Programm aus verschicken kînnen.

\section{Nachrichten fÅr \ASCREEN}

Betrachten wir zuerst die Nachrichten,
die fÅr \ASCREEN\ definiert sind.
Neben den Åblichen AES-""Nachrichten,
die Sie am besten in einem beliebigen GEM-Buch, etwa dem {\sl Profibuch},
nachschlagen und die hier nicht aufgefÅhrt werden,
gibt es einige spezielle \ASCREEN-""Nachrichten.

ZunÑchst der allgemeine Aufbau einer GEM-""Nachricht.
Nachrichten mÅssen mindestens 8~Wîrter, also 16~Bytes lang sein,
sonst wird die Annahme bzw.\ Zustellung verweigert.
Mit der Definition
\begin{typed}
WORD msg[8];
\end{typed}
gilt die Zuordnung
\begin{example}
{\tt msg[0]}\qquad Nachrichtentyp\\
{\tt msg[1]}\qquad Prozeûnummer des Absenders\\
{\tt msg[2]}\qquad "`öberlÑnge"' der Nachricht
\end{example}
Der Rest der Nachricht kann ein beliebiges Format haben.
Die "`öberlÑnge"' ist die Anzahl von Bytes,
die nicht mehr in die 16~Bytes der eigentlichen Nachricht gepaût haben
und daher mit einem expliziten Aufruf von \verb|appl_read()|
gelesen werden mÅssen.

Das erste Wort gibt den {\em Typ\/} der Nachricht an,
zum Beispiel \verb|MN_SELECTED| (0)
fÅr die AES-""Nachricht "`MenÅpunkt gewÑhlt"'.
Bei \ASCREEN-""Nachrichten hat das erste Wort
immer den Wert \verb|MSG_ASCREEN|, die Zahl 8196.
\begin{aha}
Hierbei handelt es sich um eine willkÅrliche Definition,
die Nummer 8196 ist hoffentlich noch frei\dots
\end{aha}
\ASCREEN\ unterscheidet die verschiedenen Arten von Nachrichten,
bei denen \verb|msg[0]| gleich \verb|MSG_ASCREEN| ist,
am Wert des vierten Worts (\verb|msg[3]|).
Hier gibt es die Werte
\begin{center}
\begin{tabular}{cl}
\tt MSG\_READ	& \DVI-Datei einlesen\\
\tt MSG\_REREAD	& \DVI-Datei wieder einlesen\\
\tt MSG\_NEWPAGE& Neue Seite formatieren\\
\tt MSG\_NEWWIN & Neues Fenster îffnen
\end{tabular}
\end{center}
Die numerischen Werte dieser Namen sollten Sie nicht allzusehr interessieren,
es sei denn, Sie benutzen abartige Programmiersprachen
wie Pascal oder Assembler.
Im Verzeichnis {\tt ALAUNCH} der \ASCREEN-""Distribution
finden Sie eine Datei {\tt ASCRMSGS.H},
die die entsprechenden Definitionen fÅr C enthÑlt.

Hier nun der Aufbau der einzelnen Nachrichten.
Die ersten drei Wîrter haben wir ja schon diskutiert;
ich spare es mir, sie hier immer wieder mit anzugeben.
\begin{description}
\item[MSG\_READ] \<Dateiname>\dots\\
	Mit dieser Nachricht fordern Sie \ASCREEN\ auf,
	eine neue \DVI-""Datei einzulesen.
	Die bisherige wird verworfen;
	ist der Name der bisherigen Datei gleich dem \<Dateiname>n,
	so entspricht die Nachricht der Nachricht {\tt MSG\_REREAD}.
	Diese Nachricht hat mit einiger Sicherheit öberlÑnge.
	Weiter unten kînnen Sie sehen, wie Sie sie korrekt verschicken:
	der Dateiname folgt unmittelbar
	auf die ersten vier Wîrter der Nachricht,
	und alles wird mit einem einzigen \verb|appl_write()|
	auf die Reise geschickt.
\item[MSG\_REREAD] (keine weiteren Parameter)\\
	Wenn \ASCREEN\ diese Nachricht empfÑngt,
	liest er die gerade im Speicher befindliche \DVI-Datei nochmals ein.
	Dies entspricht dem gleichnamigen MenÅpunkt.
\item[MSG\_NEWPAGE] \<Seitennummer>\\
	Diese Nachricht bittet \ASCREEN,
	die Seite mit der Nummer, die {\tt msg[4]} angibt,
	zu formatieren und in den Cachespeicher zu tun.
	Der praktische NÑhrwert dieser Nachricht auûerhalb von \ASCREEN\
	ist zweifelhaft.
	\ASCREEN\ verwendet die Nachricht jedoch intern,
	um das Vorausarbeiten zu koordinieren.
\item[MSG\_NEWWIN] \<Art> \<Seite> \<x> \<y> \<w> \<h>\\
	Hiermit kînnen Sie \ASCREEN\ veranlassen, ein neues Fenster zu îffnen.
	Die \<Art> des Fensters ist 1 fÅr ein normales Fenster,
	2 fÅr ein um den Faktor 2 verkleinertes Fenster,
	4 fÅr ein um den Faktor 3 verkleinertes Fenster,
	8 fÅr ein um den Faktor 2 verkleinertes
	und 16 fÅr ein um den Faktor 3 verkleinertes doppelseitiges Fenster.
	Das Fenster enthÑlt die Seite mit der Nummer \<Seite>,
	und als Grîûe wÅnschen Sie sich die Breite \<w> und Hîhe \<h>
	an der Position (\<x>, \<y>).
	Diese Nachricht hat eine öberlÑnge von 2~Bytes.
\end{description}
Interessant fÅr die Ñuûerliche Anwendung sind vor allem
die beiden erstgenannten Nachrichten.

\section{Das Programm {\tt ALaunch}}

Die \ASCREEN""-Distribution enthÑlt ein Programm
zur Demonstration der Nachrichtenschnittstelle.
{\tt ALaunch} ist fÅr Sie vielleicht interessant,
wenn Sie einen GEM-""Multitaskingzusatz wie {\sl MultiGEM\/} benutzen
--- es scheint, daû es Åberhaupt nur dann fÅr Sie sinnvoll ist!
{\tt ALaunch} wird mit dem Namen einer \DVI-Datei als Parameter aufgerufen.
Es prÅft, ob gerade ein \ASCREEN-Prozeû lÑuft.
Falls nein, wird ein neuer \ASCREEN\ mit der betreffenden Datei gestartet.
Falls doch,
so erhÑlt der laufende \ASCREEN\ eine {\tt MSG\_READ}-""Nachricht
mit dem angegebenen Dateinamen.
Sie kînnen also {\tt ALaunch} als Applikation
fÅr Dateien vom Typ {\tt DVI} anmelden
(oder, ein hinreichend intelligentes Desktop wie {\sl Gemini}
oder das neue von Atari vorausgesetzt,
ein {\tt ALaunch}-Icon auf dem Desktophintergrund ablegen)
und durch einfaches Anklicken (oder Abschleppen) von \DVI-""Dateien
\ASCREEN\ starten.
{\tt ALaunch} sorgt dann dafÅr,
daû Ihr Speicher nicht durch mehrfache \ASCREEN s aufgefressen wird.
\begin{attention}
Philosophische Personen kînnen sich die Frage stellen,
ob sie immer nur einen \ASCREEN\ haben wollen.
Wer lieber mehrere \DVI-""Dateien gleichzeitig auf dem Schirm hat,
sollte {\tt ALaunch} eben nur als Beispiel ansehen
und nicht wirklich installieren.
\end{attention}
Der Quellcode fÅr {\tt ALaunch} steht im entsprechenden Verzeichnis
der \ASCREEN-""Distribution zur Inspektion bereit.
Ich mîchte hier nicht den ganzen Code wiederholen,
sondern beschrÑnke mich auf die wesentlichen Teile.

Die Anwesenheit von \ASCREEN\ kînnen Sie mit der AES-""Funktion
\verb|appl_find()| wie im folgenden Ausschnitt ÅberprÅfen:
\begin{wtyped}
if ((id = appl_find("ASCREEN ")) < 0)
    /* Fehler */
else if (id <= app_count) /* geladenen ASCREEN weiterbenutzen */
    send_message(app_id, id, argv[1]);
else /* neuen ASCREEN starten */
    launch_ascreen(argv[1]);
\end{wtyped}
{\tt app\_count} ist dabei eine AbkÅrzung
fÅr das zweite Wort des {\tt global[]}-Felds von GEM,
das die Maximalzahl der gleichzeitig mîglichen Prozesse angibt.
Bei einem GEM ohne Multitaskingerweiterung ist dies immer~1
({\tt ALaunch} tut dann nichts Sinnvolles);
bei {\sl MultiGEM\/} kann der Wert eingestellt werden.
Beachten Sie auch,
daû das Argument von {\tt appl\_find()} genau acht Zeichen lang sein muû.

Und {\tt MSG\_READ} verschicken Sie an \ASCREEN\ ungefÑhr so:
\begin{wtyped}
void
send_message (const int from, const int to, const char *file)
{
    int  size;
    char msg[8 + MAX_CMDLINE];	/* MAX_CMDLINE ist z. B. 128 */
#define PUT_WORD(a, i, v) a[i] = (v) >> 8, a[i+1] = (v) & 0xff

    strcpy(msg + 8, file);
    size = 8 + (int)strlen(msg + 8) + 1;
    if (size < 16) size = 16;

    PUT_WORD(msg, 0, MSG_ASCREEN);
    PUT_WORD(msg, 2, from);
    PUT_WORD(msg, 4, size - 16);  /* die "Uberl"ange */
    PUT_WORD(msg, 6, MSG_READ);
    appl_write(to, size, msg);
}
\end{wtyped}

{\tt ALaunch} ist an einer Stelle von {\sl MultiGEM\/} abhÑngig:
es verwendet den Aufruf {\tt Mfork()},
um einen neuen \ASCREEN\ als unabhÑngigen Prozeû zu starten.
Leider weiû ich nicht,
inwieweit {\tt Mfork()} etwa von {\sl MultiTOS\/} oder {\sl Mag!X}
unterstÅtzt wird
und ob {\tt ALaunch} daher in diese Umgebungen portabel ist.
Erfahrungsberichte wÅrden mich natÅrlich brennend interessieren.
Damit Sie {\tt Mfork()} mit Turbo- oder Pure-C
und seiner Nichtstandard-""ParameterÅbergabe in Registern
benutzen kînnen,
brauchen Sie ein kleines Binding in Assembler,
siehe {\tt MFORK.S}.

\section{Die Zukunft}

Stefan Lindner, Lutz Birkhahn und Robert Kieûling
bereiten ein \TeX-""System vor,
das auf der Steuersprache {\tt tcl} von John Ousterhout beruhen wird.
Dies wird vermutlich diverse Interaktionen zwischen \TeX,
\TeX shell und Programmen wie Previewer und Druckertreiber zulassen.
Wenn darÅber mehr bekannt ist,
wird auch \ASCREEN\ na"-tÅr"-lich entsprechend ge"-Ñn"-dert werden.
Wir sind alle sehr gespannt.

\begin{chapterquote}
Die Botschaft hîr' ich wohl,
allein mir fehlt der Glaube;
Das Wunder ist des Glaubens liebstes Kind.
\author JOHANN WOLFGANG VON GOETHE, {\it Faust} (1808)
\end{chapterquote}
