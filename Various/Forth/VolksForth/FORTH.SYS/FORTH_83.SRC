\\   ###   Main Directory   ###                        21feb86we                                                                Quelltext                $0009                                  Target-Compiler          $00A0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *********************************************************************                                                      *********             May the volksFORTH be with you             *******              ==============================              *****                                                            ****     Anfragen, Kritik und Verbesserungsvorschl„ge an :      ****                                                            ****            Dietrich Weineck                                ****            Fleetrade 40                                    ****       2800 Bremen 1                                        *****           Tel. 0421 - 493090                             *******                                                        *********                                                     **********************************************************************                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ Atari 520 ST    Forth loadscreen                     20mar86we\ volksFORTH-83 was developed by K. Schleisiek, B. Pennemann    \ G. Rehfeld & D. Weineck                                       \ Atari ST - Version by D. Weineck                                                                                                                                                              Onlyforth                                                                                                                               0 dup displace !                                        Target definitions here!                                                                                                                                                                         1 $72 +thru                                                                                                                    cr .unresolved  ' .blk is .status                                                                                               \ Loadscreen for Standard System                       11feb86we                                                                : .blk    blk @ ?dup  IF  base push hex  ." Blk " . ?cr  THEN ;   ' .blk is .status                                             $40 load                      .( Assembler loaded)         cr   $10 load                   cr .( Strings loaded)           cr   $0D load                   cr .( Simple Files loaded)      cr   load" Long-Adressing"      cr .( Long-Adressing loaded)    cr   load" Savesystem"          cr .( Savesystem loaded)        cr   load" Line-A Graphics"     cr .( Line-A Graphics loaded)   cr   load" Editor-Window"       cr .( Editor-Window loaded)     cr   load" Editor"              cr .( Editor loaded)            cr   \ load" Multitasker"       cr .( Tasker und Clock loaded)  cr   load" Tools"               cr .( Tools loaded)             cr                                                        -->                                                                        \ Loadscreen for Standard System                       11feb86we                                                                load" Printer Interface"   cr .( Printer Interface loaded) cr   load" Relocating"          cr .( Relocating loaded)        cr   load" Allocating"          cr .( Allocating loaded)        cr    .( May the volksFORTH be with you ...) cr                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ recover noop                                         21feb86we                                                                Create recover   Assembler                                       .l A7 )+ W move  .w IP RP -) move   W IP lmove   Next end-code                                                                 Compiler Assembler also definitions                                                                                             H : ;c:   0 T recover mempage L#) jsr  end-code   ] H ;                                                                         Target                                                                                                                          Code noop  Next end-code                                                                                                                                                                                                                                                                                                        \ User Variables                                       21feb86we                                                                Constant origin   8 uallot drop  \ For multitasker              User s0                                                         User r0                                                         User dp                                                         User offset            0 offset !                               User base              $10 base !                               User output                                                     User input                                                      User errorhandler       \ pointer for abort" -code              User voc-link                                                   User udp                \ points to next free addr in User      User next-link          \ points to next Next                                                                                                                                                   \ end-trace                                            19mar86we                                                                Label fnext  IP )+ D7 move  D7 W lmove  W )+ D7 move  end-code                                                                  Code end-trace                                                     .l fnext mempage # A2 move                                      .w user' next-link UP D) D0 move                                BEGIN   D0 D7 move  0<>                                         WHILE   D7 A1 lmove   &10 # A1 suba   .l A2 A0 move                    .l A0 )+ A1 )+ move    .w A0 )+ A1 )+ move                       D7 A1 lmove   A1 ) D0 move                              REPEAT Next end-code                                                                                                                                                                                                                                                                                                         \ manipulate system pointers                           20mar86we                                                                Code sp@   ( -- addr )    SP SP -) move   Next end-code                                                                         Code sp!   ( addr -- )    SP )+ D7 move   $FFFE D7 andi                                   D7 SP lmove    Next end-code                                                                          Code up@   ( -- addr )    UP SP -) move   Next end-code                                                                         Code up!   ( addr -- )    SP )+ D7 move   $FFFE D7 andi                                   D7 UP lmove    Next end-code                                                                                                                                                                                                                                                                                                                                          \ manipulate returnstack                               20mar86we                                                                Code rp@   ( -- addr )    RP SP -) move   Next end-code                                                                         Code rp!   ( addr -- )    SP )+ D7 move   $FFFE D7 andi                                   D7 RP lmove    Next end-code                                                                          Code >r    ( 16b -- )     SP )+ RP -) move                                                Next end-code restrict                                                                                Code r>    ( -- 16b )     RP )+ SP -) move                                                Next end-code restrict                                                                                                                                                                                                                                                                                \ r@ rdrop  exit  unnest ?exit                         19mar86we                                                                Code r@    ( -- 16b )        RP ) SP -) move   Next end-code                                                                    Code rdrop                   2 RP addq   Next end-code restrict                                                                 Code exit                    RP )+ D7 move   D7 IP lmove                                     Next end-code                                                                                      Code unnest                  RP )+ D7 move   D7 IP lmove                                     Next end-code                                                                                      Code ?exit ( flag -- )       SP )+ tst   0<> IF   RP )+ D7 move                              D7 IP lmove  THEN   Next end-code                                                                  \\ : ?exit ( flag -- )       IF rdrop THEN ;                    \ execute  perform                                     19mar86we                                                                Code execute   ( cfa -- )                                          SP )+ D7 move   D7 W lmove   W )+ D7 move   D7 A0 lmove         A0 ) jmp    end-code                                                                                                         : perform   ( addr -- )      @ execute ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ c@   c! ctoggle                                      19mar86we                                                                Code c@   ( addr -- 8b )                                           SP ) D7 move   D7 A0 lmove   D0 clr                             .b A0 ) D0 move   .w D0 SP ) move    Next end-code                                                                           Code c!   ( 16b addr -- )                                          SP )+ D7 move   D7 A0 lmove                                     SP )+ D0 move   .b D0 A0 ) move    Next end-code                                                                             : ctoggle   ( 8b addr --)      under c@ xor swap c! ;                                                                                                                                                                                                                                                                                                                                           \ @ !                                                  19mar86we                                                                Code @   ( addr -- 16b )                                           SP )+ D7 move   D7 A0 lmove                                     .b 1 A0 D) SP -) move   A0 ) SP -) move                         Next  end-code                                                                                                               Code !   ( 16b addr -- )                                           SP )+ D7 move  D7 A0 lmove                                      .b SP )+ A0 )+ move   SP )+ A0 )+ move                          Next end-code                                                                                                                                                                                                                                                                                                                                                                                \ +! drop swap                                         20mar86we                                                                Code +!   ( n addr -- )                                            SP )+ D7 move   D7 A0 lmove   2 A0 addq   2 SP addq             4 # move>ccr   .b SP -) A0 -) addx   SP -) A0 -) addx           .w 2 SP addq   Next end-code                                                                                                                                                                 Code drop   ( 16b -- )         2 SP addq Next end-code                                                                          Code swap   ( 16b1 16b2 -- 16b2 16b1 )                             .l SP ) D0 move   D0 swap   D0 SP ) move    Next end-code                                                                                                                                                                                                                                                                    \ dup  ?dup                                            20mar86we                                                                Code dup    ( 16b -- 16b 16b )    SP ) SP -) move  Next end-code                                                                Code ?dup   ( 16b -- 16b 16b / false )                             SP ) tst   0<> IF   SP ) SP -) move   THEN      Next end-code                                                                                                                                                                                                \\                                                              : ?dup ( 16b -- 16b 16b / false) dup IF dup THEN ;                                                                                                                                                                                                                                                                                                                                              \ over rot nip under                                   20mar86we                                                                Code over   ( 16b1 16b2 - 16b1 16b3 16b1 )                         2 SP D) SP -) move   Next end-code                           Code rot    ( 16b1 16b2 16b3 - 16b2 16b3 16b1 )                    SP )+ D1 move   SP )+ D2 move   SP  ) D0 move                   D2 SP  ) move   D1 SP -) move   D0 SP -) move                   Next end-code                                                Code nip    ( 16b1 16b2 -- 16b2 )                                  SP )+ SP )  move    Next end-code                            Code under  ( 16b1 16b2 - 16b2 16b1 16b2 )                         .l SP ) D0 move   D0 swap   D0 SP ) move   .w D0 SP -) move     Next end-code                                                \\                                                              : nip ( 16b1 16b2 -- 16b2) swap drop ;                          : under ( 16b1 16b2 -- 16b2 16b1 16b2) swap over ;              \ -rot nip pick roll                                   19mar86we                                                                Code -rot   ( 16b1 16b2 16b3 -- 16b3 16b1 16b2 )                   SP )+ D2 move   SP )+ D0 move   SP  ) D1 move                   D2 SP  ) move   D1 SP -) move   D0 SP -) move                   Next end-code                                                Code pick   ( n -- 16b.n )                                         .l D0 clr   .w SP )+ D0 move   D0 D0 add                        0 D0 SP DI) SP -) move    Next end-code                      : roll   ( n -- )                                                  dup >r   pick   sp@ dup 2+   r> 1+  2*  cmove>  drop ;       : -roll   ( n -- )    dup >r   sp@ dup 2+                          dup 2+  swap  r@  2*  cmove   r> 1+ 2* +  ! ;                \\                                                              : pick    ( n -- 16b.n )     1+ 2* sp@ + @ ;                    : -rot    ( 16b1 16b2 16b3 -- 16b3 16b1 16b2 )   rot rot ;      \ double word stack manip.                             20mar86we                                                                Code 2swap    ( 32b1 32b2 -- 32b2 32b1 )                           .l SP )+ D0 move   SP ) D1 move   D0 SP ) move  D1 SP -) move   Next end-code                                                                                                                Code 2drop    ( 32b -- )        4 SP addq  Next end-code                                                                        Code 2dup     ( 32b -- 32b 32b )                                   .l SP ) SP -) move   Next end-code                                                                                                                                                           \\                                                              : 2swap ( 32b1 32b2 -- 32b2 32b1) rot >r rot r> ;               : 2drop ( 32b -- ) drop drop ;                                  : 2dup ( 32b -- 32b 32b) over over ;                            \ + and or xor not                                     19mar86we                                                                Code +     ( n1 n2 -- n3 )                                         SP )+ D0 move   D0 SP ) add    Next end-code                                                                                 Code or    ( 16b1 16b2 -- 16b3 )                                   SP )+ D0 move   D0 SP ) or     Next end-code                                                                                 Code and   ( 16b1 16b2 -- 16b3 )                                   SP )+ D0 move   D0 SP ) and    Next end-code                                                                                 Code xor   ( 16b1 16b2 -- 16b3 )                                   SP )+ D0 move   D0 SP ) eor    Next end-code                                                                                 Code not   ( 16b1 -- 16b2 )       SP ) not    Next end-code                                                                     \ -  negate                                            19mar86we                                                                Code -    ( n1 n2 -- n3 )                                          SP )+ D0 move   D0 SP ) sub   Next end-code                                                                                  Code negate ( n1 -- n2 )     SP ) neg   Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \ dnegate d+                                           20mar86we                                                                Code dnegate   ( d1 -- -d1 )     .l SP ) neg   Next end-code                                                                    Code d+        ( d1 d2 -- d3 )   .l SP )+ D0 move   D0 SP ) add                                   Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ 1+ 2+ 3+ 4+ 6+    1- 2- 4-                           24nov85we                                                                Code 1+     ( n1 -- n2 )      1 SP ) addq  Next end-code        Code 2+     ( n1 -- n2 )      2 SP ) addq  Next end-code        Code 3+     ( n1 -- n2 )      3 SP ) addq  Next end-code        Code 4+     ( n1 -- n2 )      4 SP ) addq  Next end-code        | Code 6+   ( n1 -- n2 )      6 SP ) addq  Next end-code        Code 1-     ( n1 -- n2 )      1 SP ) subq  Next end-code        Code 2-     ( n1 -- n2 )      2 SP ) subq  Next end-code        Code 4-     ( n1 -- n2 )      4 SP ) subq  Next end-code                                                                                                                                                                                                                                                                                                                                                                                                        \ number Constants                                     24nov85we                                                                Code 0    ( -- 0 )     0 # SP -) move  Next end-code            Code 1    ( -- 1 )     1 # SP -) move  Next end-code            Code 2    ( -- 2 )     2 # SP -) move  Next end-code            Code 3    ( -- 3 )     3 # SP -) move  Next end-code            Code 4    ( -- 4 )     4 # SP -) move  Next end-code            Code -1   ( -- -1 )   -1 # SP -) move  Next end-code                                                                            ' -1 Alias true              ' 0 Alias false                                                                                    : on   ( addr -- )   true  swap ! ;                             : off  ( addr -- )   false swap ! ;                                                                                                                                                                                                                             \ words for number literals                            19mar86we                                                                Code lit   ( -- 16b )    IP )+ SP -) move    Next end-code                                                                      : Literal  ( 16b -- )    compile lit   , ; immediate restrict                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \ comparision code words                               19mar86we                                                                Label yes   true # SP ) move Next    Label no   SP ) clr Next                                                                   Code 0<    ( n -- flag )     SP ) tst  yes bmi  no bra  end-code                                                                Code 0=    ( 16b -- flag )   SP ) tst  yes beq  no bra  end-code                                                                Code <     ( n1 n2 -- flag ) SP )+ D0 move   SP ) D0 cmp                                     yes bgt   no bra   end-code                                                                        Code u<    ( u1 u2 -- flag ) SP )+ D0 move   SP ) D0 cmp                                     yes bhi   no bra   end-code                                                                        : uwithin  ( u1 [low up[ -- flag )                                                           rot under u> -rot u> not and ;     \ comparision code words                               25mar86we                                                                Code >    ( n1 n2 -- flag )     SP )+ D0 move   SP ) D0 cmp                                     yes blt   no bra   end-code                                                                     Code 0>   ( n -- flag )         SP ) tst   yes bgt   no bra                                     end-code                                                                                        Code 0<>  ( n -- flag )         SP ) tst   yes bne   no bra                                     end-code                                                                                        Code u>   ( u1 u2 -- flag )     SP )+ D0 move   SP ) D1 move                                    D0 D1 cmp   yes bhi   no bra                                    end-code                        Code =    ( n1 n2 -- flag )     SP )+ D0 move   SP ) D0 cmp                                     yes beq   no bra   end-code     \ comparision words                                    20mar86we                                                                : d0=   ( d -- flag )        or  0= ;                           : d=    ( d1 d2 -- flag )    dnegate d+  d0= ;                  : d<    ( d1 d2 -- flag )    rot 2dup - IF    > nip nip                                                 ELSE  2drop u<  THEN ;                                                                                                                                  \\                                                              : 0<                        8000 and 0<> ;                      : >    ( n1 n2 -- flag )    swap < ;                            : 0>   ( n -- flag )        negate 0< ;                         : 0<>  ( n -- flag )        0= not ;                            : u>   ( u1 u2 -- flag )    swap u< ;                           : =    ( n1 n2 -- flag )    - 0= ;                                                                                              \ min max umax umin extend dabs abs                    19mar86we                                                                | : minimax  ( n1 n2 flag -- n3 )                                    rdrop   IF  swap  THEN   drop ;                                                                                            : min      ( n1 n2 -- n3 )      2dup  > minimax ;               : max      ( n1 n2 -- n3 )      2dup  < minimax ;               : umax     ( u1 u2 -- u3 )      2dup u< minimax ;               : umin     ( u1 u2 -- u3 )      2dup u> minimax ;               : extend   ( n -- d )           dup 0< ;                        : dabs     ( d -- ud )          extend IF dnegate THEN ;        : abs      ( n -- u)            extend IF  negate THEN ;                                                                                                                                                                                                                                                                        \ loop primitives                                      19mar86we                                                                | : dodo              rdrop r> 2+ dup >r rot >r swap >r >r ;                                                                    : (do  ( limit start -- )  over -  dodo ;           restrict    : (?do ( limit start -- )  over -  ?dup IF  dodo  THEN                                     r> dup  @ +  >r drop ;   restrict                                                                    : bounds ( start count -- limit start )     over + swap ;                                                                       Code endloop               6 RP addq   Next end-code   restrict                                                                                                                                                                                                 \\ dodo puts "index | limit | adr.of.DO" on return-stack                                                                        \ (loop (+loop                                         19mar86we                                                                Code (loop                                                         1 RP ) addq                                                      CC IF  4 RP D) D7 move   D7 IP lmove  THEN                     Next end-code   restrict                                                                                                     Code (+loop                                                        SP )+ D0 move   D0 D1 move   D0 RP ) add                        1 # D1 roxr   D0 D1 eor                                           0>=  IF 4 RP D) D7 move  D7 IP lmove  THEN                    Next end-code   restrict                                                                                                                                                                                                                                                                                                     \ loop indices                                         20mar86we                                                                Code I   ( -- n )                                                  RP ) D0 move      2 RP D) D0 add   D0 SP -) move                Next end-code                                                                                                                Code J   ( -- n )                                                  6 RP D) D0 move   8 RP D) D0 add   D0 SP -) move                Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ branch ?branch                                       19mar86we                                                                Code branch                                                     Label bran1   IP ) D0 move   IP D7 lmove                           D0 D7 add   D7 IP lmove   Next end-code                                                                                      Code ?branch   ( fl -- )   SP )+ tst   bran1 beq   2 IP addq                                 Next  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ resolve loops and branches                           19mar86we                                                                : >mark     ( -- addr )          here  0 , ;                    : >resolve  ( addr -- )          here  over - swap ! ;          : <mark     ( -- addr )          here ;                         : <resolve  ( addr -- )          here -  , ;                    : ?pairs    ( n1 n2 -- )         - abort" unstructured" ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ case?                                                19mar86we                                                                Code case? ( 16b1 16b2 -- 16b1 false / true )                      SP )+ D0 move   SP ) D0 cmp   yes beq   SP -) clr               Next   end-code                                                                                                                                                                              \\                                                              : case? ( 16b1 16b2 -- 16b1 false / true )                       over = dup  IF nip THEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                      \ Branching                                            24nov85we                                                                : IF             compile ?branch >mark 1 ; immediate restrict   : THEN           abs 1 ?pairs >resolve ;   immediate restrict   : ELSE           1 ?pairs compile branch >mark swap                              >resolve -1 ;             immediate restrict   : BEGIN          <mark 2 ;                 immediate restrict   : WHILE          2 ?pairs 2 compile ?branch >mark                                -2 2swap ;                immediate restrict   | : (reptil      <resolve                                                        BEGIN dup -2 = WHILE drop >resolve REPEAT ;    : REPEAT         2 ?pairs compile branch (reptil ;                                                         immediate restrict   : UNTIL          2 ?pairs compile ?branch (reptil ;                                                        immediate restrict                                                                   \ Loops                                                24nov85we                                                                : DO        compile  (do >mark 3 ;       immediate restrict     : ?DO       compile (?do >mark 3 ;       immediate restrict     : LOOP      3 ?pairs compile  (loop compile endloop >resolve ;                                           immediate restrict     : +LOOP     3 ?pairs compile (+loop compile endloop >resolve ;                                           immediate restrict     : LEAVE     endloop r> 2- dup @ + >r ;             restrict                                                                                                                                     \\ Returnstack: calladr | index limit | adr of DO                                                                                                                                                                                                                                                                               \ um*                                                  19mar86we                                                                Code um* ( u1 u2 -- ud )                                           SP )+ D0 move   SP )+ D0 mulu   .l D0 SP -) move                Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ m* * 2* 2/                                           19mar86we                                                                : m*  ( n1 n2 -- d )    dup 0<   dup >r   IF  negate  THEN                              swap dup   0< IF  negate r> not >r  THEN                        um*   r> IF  dnegate  THEN ;                                                                            : *  ( n1 n2 - prod )   um* drop ;                                                                                              Code 2*  ( n -- 2*n )   SP ) asl   Next end-code                Code 2/  ( n -- n/2 )   SP ) asr   Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                \ um/mod                                               20mar86we                                                                Code um/mod   ( d1 n1 -- rem quot )                                SP )+ D0 move   .l SP )+ D1 move   D0 D1 divu                   D1 swap   D1 SP -) move   Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ m/mod                                                20mar86we                                                                : m/mod ( d n -- mod quot )                                      dup >r   abs over   0< IF  under + swap  THEN   um/mod  r@ 0<       IF  negate  over IF  swap  r@ +  swap 1-  THEN  THEN        rdrop ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ /mod / mod */mod */ u/mod  ud/mod                    24nov85we                                                                : /mod   ( n1 n2 -- rem quot )      >r  extend  r>   m/mod ;    : /      ( n1 n2 --     quot )      /mod nip ;                  : mod    ( n1 n2 -- rem )           /mod drop ;                 : */mod  ( n1 n2 n3 -- rem quot )   >r  m*  r>   m/mod ;        : */     ( n1 n2 n3 -- quot )       */mod nip ;                 : u/mod  ( u1 u2 -- urem uquot )    0 swap   um/mod ;           : ud/mod ( ud1 u2 -- urem udquot )  >r  0 r@ um/mod  r> swap >r                                     um/mod   r> ;                                                                                                                                                                                                                                                                                                                                                                                                               \ cmove cmove>                                         19mar86we                                                                Code cmove    ( from to count -- )                                 SP )+ D0 move                                                   SP )+ D7 move   D7 A0 lmove   SP )+ D7 move   D7 A1 lmove       D0 tst   0<> IF   1 D0 subq                                       D0 DO   .b A1 )+ A0 )+ move   LOOP   THEN                     Next end-code                                                                                                                Code cmove>   ( from to count -- )                                 SP )+ D0 move                                                   SP )+ D7 move   D0 D7 add   D7 A0 lmove                         SP )+ D7 move   D0 D7 add   D7 A1 lmove                         D0 tst   0<> IF   1 D0 subq                                       D0 DO   .b A1 -) A0 -) move   LOOP   THEN                     Next end-code                                                \ move place count                                     19mar86we                                                                : move   ( from to quan -- )                                       >r   2dup u< IF  r> cmove>  exit  THEN   r> cmove ;                                                                          : place  ( addr len to --)                                         over >r  rot over 1+  r> move   c! ;                                                                                         Code count ( adr -- adr+1 len )                                    SP ) D7 move   D7 A0 lmove                                      D0 clr  .b A0 )+ D0 move   .w 1 SP ) addq   D0 SP -) move       Next  end-code                                                                                                                                                                               \\                                                              : count ( adr -- adr+1 len ) dup 1+ swap c@ ;                   \ fill erase                                           19mar86we                                                                Code fill   ( addr quan 8b -- )                                    SP )+ D0 move   SP )+ D1 move   SP )+ D7 move   D7 A0 lmove     D1 tst   0<> IF                                                   1 D1 subq   D1 DO  .b D0 A0 )+ move   LOOP   THEN             Next end-code                                                                                                                : erase   ( addr quan --)            0 fill ;                                                                                                                                                                                                                   \\                                                              : fill ( addr quan 8b -- )                                       swap ?dup IF  >r over c! dup 1+ r> 1- cmove exit  THEN          2drop ;                                                        \ here , c,                                            25mar86we                                                                Code here   ( -- addr )                                            user' dp UP D) SP -) move   Next end-code                                                                                    Code ,     ( 8b -- )     user' dp UP D) D7 move   D7 A0 lmove      .b SP )+ A0 )+ move   SP )+ A0 )+ move                          .w A0 user' dp UP D) move   Next end-code                                                                                    Code c,    ( 8b -- )      user' dp UP D) D7 move   D7 A0 lmove     SP )+ D0 move   .b D0 A0 )+ move                                .w A0 user' dp UP D) move   Next end-code                    \\                                                              : here   ( -- addr )             dp @ ;                         : ,      ( 16b -- )              here  !  2 allot ;             : c,     ( 8b -- )               here c!  1 allot ;             \ allot pad compile                                    25mar86we                                                                Code allot   ( n -- )                                              SP )+ D0 move   D0 user' dp UP D) add   Next end-code                                                                        : pad    ( -- addr )             here $42 + ;                                                                                   : compile                        r>  dup 2+  >r   @ , ; restrict                                                                                                                                                                                                                                                                \\                                                              : allot  ( n -- )                dp +! ;                                                                                                                                                        \ input strings                                        25mar86we                                                                Variable #tib     0 #tib !                                      Variable >tib     here >tib !  &80 allot                        Variable >in      0 >in !                                       Variable blk      0 blk !                                       Variable span     0 span !                                                                                                      : tib ( -- addr )        >tib @ ;                                                                                               : query           tib &80 expect  span @ #tib !                                   >in off  blk off ;                                                                                                                                                                                                                                                                                            \ scan skip /string                                    16nov85we                                                                : /string ( addr0 len0 +n - addr1 len1 )                           over umin  rot over +  -rot  - ;                                                                                                                                                                                                                                                                                             \\                                                              : scan ( addr0 len0 char -- addr1 len1 )    >r                     BEGIN   dup WHILE  over c@  r@ - WHILE  1-  swap  1+  swap      REPEAT   rdrop ;                                                                                                             : skip ( addr len del -- addr1 len1 )       >r                     BEGIN   dup WHILE  over c@  r@ = WHILE  1-  swap  1+  swap      REPEAT   rdrop ;                                             \ skip scan                                            19mar86we                                                                Label done     A0 SP -) move   D1 SP -) move   Next             Code skip   ( addr len del -- addr1 len1 )                         SP )+ D0 move   SP )+ D1 move   1 D1 addq                       SP )+ D7 move   D7 A0 lmove                                     BEGIN   1 D1 subq  0<>                                          WHILE   .b A0 ) D2 move   D2 D0 cmp   done bne   .w 1 A0 addq   REPEAT  done bra   Next end-code                                                                                             Code scan   ( addr len chr -- addr1 len1 )                         SP )+ D0 move   SP )+ D1 move   1 D1 addq                       SP )+ D7 move   D7 A0 lmove                                     BEGIN   1 D1 subq  0<>                                          WHILE   .b A0 ) D2 move   D2 D0 cmp   done beq   .w 1 A0 addq   REPEAT  done bra   Next end-code                             \ convert to upper case                                19mar86we                                                                Label umlaut                                                       Ascii „ c,   Ascii ” c,   Ascii  c,                            Ascii Ž c,   Ascii ™ c,   Ascii š c,                                                                                         Label (capital   ( D1 -> D1 )                                      D1 7 # btst   0= IF                                                              .b Ascii a D1 cmpi   >= IF   Ascii z D1 cmpi                       <= IF   bl D1 subi   THEN  THEN   rts                        THEN   umlaut mempage L#) A1 lea               2 D6 moveq   D6 DO  .b A1 ) D1 cmp                                          0= IF  .w 3 A1 addq   .b A1 ) D1 move  rts  THEN           .w 1 A1 addq   LOOP  rts   end-code                                                                                                                                                   \ capital capitalize                                   19mar86we                                                                Code capital ( char -- char' )                                     SP ) D1 move    (capital bsr   D1 SP ) move   Next end-code                                                                  Code capitalize ( string -- string )                               SP ) D7 move   D7 A0 lmove                                      D0 clr   .b A0 )+ D0 move                                       0<> IF   1 D0 subq   D0 DO                                                       A0 ) D1 move  (capital bsr   D1 A0 )+ move                               LOOP  THEN   Next end-code                                                                                                                                         \\                                                              : capitalize ( string -- string)                                 dup count bounds ?DO  I c@  capital  I c!  LOOP ;              \ (word                                                19mar86we                                                                Code (word ( char adr0 len0 -- addr )                            D1 clr   SP )+ D0 move   D0 D4 move                             SP )+ D7 move   D7 A0 lmove   SP ) D2 move                      >in mempage L#) D3 move   D3 A0 adda   D3 D0 sub                   <= IF  D4 >in mempage L#) move                                     ELSE  1 D0 addq  BEGIN  1 D0 subq 0<>                                       WHILE  .b A0 ) D2 cmp 0=                                        WHILE  .w 1 A0 addq   REPEAT   THEN                     .l A0 A1 move   1 D0 addq                                               BEGIN  .w 1 D0 subq 0<>                                         WHILE  .b A0 ) D2 cmp 0<>                                       WHILE  .w 1 A0 addq  1 D1 addq   REPEAT  THEN              D7 A0 suba   D1 tst  0<> IF  1 A0 addq  THEN             A0 >in mempage L#) move   THEN                           \ (word Part2                                          19mar86we                                                                   user' dp UP D) D7 move   D7 A0 lmove                            A0 SP ) move   .b D1 A0 )+ move   .w 1 D1 subq                    0>= IF  D1 DO  .b A1 )+ A0 )+ move   LOOP   THEN              bl # A0 ) move    Next end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ even source word parse name                          16nov85we                                                                : even     ( addr -- addr1 )      dup 1 and + ;                 : source   ( -- addr len )                                       blk @  ?dup IF  block b/blk   exit  THEN   tib #tib @ ;                                                                        : word     ( char -- addr )       source (word ;                : parse    ( char -- addr len )                                    >r   source   >in @  /string   over swap  r> scan >r            over -  dup r>  0<> -   >in +! ;                                                                                             : name     ( -- addr )             bl word capitalize exit ;    \\                                                              : word ( char -- addr)   >r  source over swap   >in @ /string    r@ skip   over swap   r> scan >r   rot over swap -  r>  0<> -   >in !  over -  here dup >r   place   bl r@ count + c!   r> ;   \ state Ascii ,"  ("  "                                25mar86we                                                                Variable state        0 state !                                                                                                 : Ascii  ( char -- n )                                             bl word  1+ c@  state @ IF  [compile] Literal  THEN ;                                                 immediate                                                                              : ,"       Ascii " parse  here over 1+  allot  place ;          : "lit     r> r>  under  count +  even  >r >r ;    restrict     : ("       "lit ;                                  restrict     : "        compile (" ,"  align ;        immediate restrict                                                                                                                                                                                                                                                                     \ ." ( .( \ \\ hex decimal                             25mar86we                                                                : (."      "lit count type ;                       restrict     : ."       compile (." ,"  align ;       immediate restrict     : (        ascii ) parse 2drop ;         immediate              : .(       ascii ) parse type ;          immediate              : \        >in @ c/l / 1+ c/l * >in ! ;  immediate              : \\       b/blk >in ! ;                 immediate              : \needs   name find nip IF  [compile] \  THEN ;                                                                                : hex      $10 base ! ;                                         : decimal  &10 base ! ;                                                                                                                                                                                                                                                                                                         \ number conversion: digit?                            19mar86we                                                                | Variable ptr       \ points into string                                                                                       Label   fail     SP ) clr  Next                                 Code digit?    ( char -- n true : false )                          user' base UP D) D0 move   SP ) D1 move                         .b Ascii 0 D1 subi   fail bmi    &10 D1 cmpi                      0>= IF   $11 D1 cmpi   fail bmi   7 D1 subq   THEN            D0 D1 cmp   fail bpl   .w D1 SP ) move   true # SP -) move      Next  end-code                                               \\                                                              : digit? ( char -- digit true/ false )                             Ascii 0 -  dup 9 u> IF  [ Ascii A Ascii 9 - 1- ] Literal -      dup   9 u> IF [ 2swap ( unstrukturiert) ] THEN                  base @   over u> ?dup  ?exit  THEN   drop false ;            \ number conversion:  accumulate  convert              19mar86we                                                                Code accumulate   ( +d0 addr digit -- +d1 addr )                   .l D0 clr   .w SP )+ D0 move                                    2 SP D) D1 move   4 SP D) D2 move   user' base UP D) D3 move    D3 D2 mulu   D3 D1 mulu   .l D1 swap   .w D1 clr                .l D2 D1 add   D0 D1 add   D1 2 SP D) move    Next end-code                                                                  : convert ( +d1 addr0 -- +d2 addr2 )                               1+  BEGIN   count  digit? WHILE   accumulate   REPEAT   1- ;                                                                                                                                 \\                                                              : accumulate ( +d0 adr digit - +d1 adr )                           swap >r swap  base @  um* drop rot  base @  um* d+ r> ;                                                                      \ number conversion: end? char previous                25mar86we                                                                | : end?   ( -- flag )                   ptr @ 0= ;             | : char       ( addr0 -- addr1 char )   count -1 ptr +! ;      | : previous   ( addr0 -- addr0 char )   1- count ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ number conversion: ?nonum punctuation?               25mar86we                                                                | : ?nonum    ( flag -- exit if true )                               IF  rdrop 2drop drop rdrop   false  THEN ;                                                                                 | : punctuation?   ( char -- flag )                                  Ascii , over =   swap   Ascii . =   or ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \ number conversion: fixbase?                          25mar86we                                                                | : fixbase?  ( char - char false / newbase true )                   Ascii & case? IF  &10 true exit  THEN                           Ascii $ case? IF  $10 true exit  THEN                           Ascii H case? IF  $10 true exit  THEN                           Ascii % case? IF    2 true exit  THEN     false ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ number conversion: ?num ?dpl                         25mar86we                                                                Variable dpl      -1 dpl !                                                                                                      | : ?num      ( flag -- exit if true )                               IF  rdrop drop   r> IF  dnegate  THEN                               rot drop   dpl @ 1+ ?dup ?exit   drop  true  THEN ;                                                                    | : ?dpl     dpl @   -1 = ?exit   1 dpl +! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ (number  number                                      25feb86we                                                                : number?   ( string - string false / n 0< / d 0> )                base push   dup count ptr !   dpl on                            0 >r ( +sign)   0.0 rot   end? ?nonum   char                    Ascii - case?  IF  rdrop   true >r   end? ?nonum   char  THEN   fixbase?       IF  base !            end? ?nonum   char  THEN   BEGIN   digit? 0= ?nonum                                          BEGIN   accumulate  ?dpl end? ?num  char  digit?  0=  UNTIL    previous   punctuation?  0= ?nonum  dpl off  end? ?num  char   REPEAT ;                                                                                                                     : number ( string -- d )                                           number? ?dup 0= abort" ?"   0< IF  extend  THEN ;                                                                                                                                            \ hide reveal immediate restrict                       24nov85we                                                                Variable last     0 last !                                      | : last?   ( -- false / acf true)    last @ ?dup ;             : hide                     last?  IF  2- @ current @ !  THEN ;  : reveal                   last?  IF  2-   current @ !  THEN ;  : Recursive                reveal ; immediate restrict                                                                          | : flag!    ( 8b --)                                              last?  IF  under c@ or over c!  THEN   drop  ;                                                                               : immediate     $40 flag! ;                                     : restrict      $80 flag! ;                                                                                                                                                                                                                                     \ clearstack hallot heap heap?                         19mar86we                                                                Code clearstack       user' s0 UP D) D7 move   $FFFE D7 andi       D7 SP lmove   Next end-code   \ clearstack muss Code bleiben                                                                 : hallot ( quan -- )                                               s0 @  over -  swap    sp@ 2+  dup rot                               dup 1 and   ?dup  IF  over  0< IF  negate  THEN +  THEN         \ 68k-align                                                 - dup s0 !  2 pick  over -  move  clearstack    s0 ! ;                                                                       : heap    ( -- addr )        s0 @ 6 + ;                         : heap?   ( addr -- flag )   heap up@ uwithin ;                 | : heapmove   ( from -- from )                                      dup  here over -  dup hallot                                    heap swap cmove   heap over - last +!  reveal ;            \ Does>  ;                                             19mar86we                                                                Label (dodoes>                                                     IP RP -) move   A7 )+ IP lmove   W SP -) move   Next end-code                                                                | : (;code          r> last @ name> ! ;                                                                                         : Does>                                                            compile (;code     $4EB9 , ( JSR-Code ) [ mempage ] Literal ,   compile (dodoes> ;   immediate restrict                                                                                      \ Does> compiles (;code and JSR (doedoes>                                                                                                                                                                                                                                                                                       \ ?head  | alignments                                  25mar86we                                                                Variable ?head     0 ?head !                                                                                                    : |                ?head @  ?exit  -1 ?head ! ;                                                                                                                                                 : align        here  1 and  allot ;                             : halign       heap  1 and  hallot ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ warning Create                                       25mar86we                                                                Variable warning    0 warning !                                 | : exists?         warning @ ?exit   last @   current @             (find nip IF  space last @ .name ." exists " ?cr  THEN ;                                                                   : Create                                                           align      here  blk @ ,  current @ @ ,                         name c@   dup 1 $20 uwithin  not abort" invalid name"           here last !    1+ allot   align                                 exists?   ?head @                                                IF  1 ?head +!   dup ,            \ Pointer to Code                 halign   heapmove $20 flag! dp !                            ELSE  drop  THEN   reveal 0 ,                                  ;Code  W SP -) move  Next end-code                                                                                           \ nfa?                                                 24nov85we                                                                : nfa?    ( thread cfa -- nfa / false)                             >r                                                              BEGIN @ dup 0= IF  rdrop exit  THEN                                   dup 2+ name> r@ = UNTIL                                   2+ rdrop ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \ >name name> >body .name                              19mar86we                                                                : >name   ( cfa -- nfa / false )        voc-link                   BEGIN   @ dup WHILE   2dup 4 - swap nfa?                                ?dup IF  -rot 2drop  exit  THEN   REPEAT   nip ;                                                                     | : (name>   ( nfa -- cfa )      count  $1F and  +  even ;                                                                      : name>   ( nfa -- cfa )                                           dup  (name> swap  c@ $20 and IF  @  THEN  ;                                                                                  : >body   ( cfa -- pfa )       2+ ;                                                                                             : .name   ( nfa -- )                                               ?dup IF  dup heap?  IF ." |" THEN                                        count $1F and type   ELSE   ." ???"  THEN  space ;  \ : ; Constant Variable                                25mar86we                                                                : Create:   Create  hide  current @ context ! ] 0  ;                                                                            : :    Create:                                                         ;Code  IP RP -) move   W IP lmove   Next end-code        \ W ist durch Next schon justiert                                                                                               : ;        0 ?pairs   compile unnest   [compile] [   reveal ;              immediate restrict                                                                                                   : Constant                                                         Create   ,   ;Code   W ) SP -) move   Next end-code                                                                                                                                                                                                          \ uallot User Alias                                    19mar86we                                                                : Variable         Create 2 allot ;                                                                                             : uallot   ( quan -- offset )                                      dup   udp @ +   $FF u> abort" Userarea full"                    udp @ swap udp +! ;                                                                                                          : User       Create   udp @ 1 and udp +!   2 uallot   c,           ;Code   D0 clr   .b W ) D0 move   .w UP D0 add                  D0 SP -) move   Next end-code                                                                                                : Alias ( cfa -- )                                                 Create   last @  dup c@ $20 and                                 IF  -2 allot  ELSE  $20 flag!  THEN   (name> ! ;                                                                             \ vp current context also toss                         19mar86we                                                                Create vp  $10 allot             Variable current                                                                               : context   ( -- addr )             vp dup @ + 2+ ;                                                                             | : thru.vocstack ( -- from to )    vp 2+ context ;             \ "Only Forth also Assembler" gives                             \ vp:  countword = 6 | Only | Forth | Assembler |                                                                               : also          vp @   &10 > error" Vocabulary stack full"                      context @  2 vp +!  context ! ;                                                                                 : toss          vp @ IF  -2 vp +!  THEN ;                                                                                                                                                       \ Vocabulary Forth Only Onlyforth                      24nov85we                                                                : Vocabulary                                                       Create    0 , 0 ,   here   voc-link @ ,   voc-link !            Does>   context ! ;                                          \  | Name | Code | Thread | Coldthread | Voc-link |                                                                             Vocabulary Forth                                                Vocabulary Only                                                 ] Does>  [ Onlypatch ]  0 vp !  context !  also ;  ' Only !                                                                     : Onlyforth        Only Forth also definitions ;                                                                                                                                                                                                                                                                                \ definitions order words                              24nov85we                                                                : definitions            context @ current ! ;                  | : .voc   ( adr -- )    @ 2-   >name .name ;                   : order                  thru.vocstack   DO   I .voc   -2 +LOOP                          2 spaces   current .voc ;                                                                              : words          context @                                         BEGIN   @ dup stop? 0= and                                      WHILE   ?cr dup 2+ .name space   REPEAT   drop ;                                                                                                                                                                                                                                                                                                                                                                                                             \ found -text                                          07dec85we                                                                | : found ( nfa -- cfa n )                                           dup c@ >r   (name> r@ $20 and  IF  @       THEN                                 -1 r@ $80 and  IF  1-      THEN                                    r> $40 and  IF  negate  THEN  ;         \\                                                              : -text ( adr1 u adr2 -- false:gleich/+1:str1>str2/-1:str1<str2) over bounds DO   drop 1+ dup 1- c@ I c@ - dup                                  IF dup abs / LEAVE THEN LOOP nip ;               \ Variable string         \ Variable strlen                    : (find    ( string thread -- str false/NFA true )               >r count $1F and  strlen ! string !                             BEGIN r> ?dup WHILE dup @ >r 2+ dup c@ $1F and strlen @ =         IF dup 1+ strlen @ string @ -text 0= ?dup IF rdrop exit THEN     THEN drop   REPEAT  string @ 1- false ;                     \ (find                                                19mar86we                                                                \ A0: thread  A1: string  A2: nfa in thread  D0: count                                                                          Code (find   ( str thr - str false/ NFA true )                     SP )+ D7 move   D7 A0 lmove   SP ) D7 move   D7 A1 lmove        .b A1 ) D0 move   .w $1F D0 andi   1 D0 addq   D7 D4 lmove      D4 0 # btst   0= IF                                          Label findloop   A0 ) D7 move   0= IF   SP -) clr   Next  THEN     D7 A0 lmove   2 D7 addq   D7 A2 lmove   A2 D3 move              D4 A1 lmove                                                     A1 )+ D1 move   $1FFF D1 andi   A2 )+ D2 move   $1FFF D2 andi   D1 D2 cmp   findloop bne                                        D2 clr    BEGIN   2 D2 addq   D2 D0 cmp >                                 WHILE   A1 )+ A2 )+ cmpm   findloop bne   REPEAT                                                                   \ (find part 2                                         19mar86we                                                                   ELSE                                                         Label findloop1   A0 ) D7 move    0= IF  SP -) clr   Next  THEN    D7 A0 lmove   2 D7 addq   D7 A2 lmove   A2 D3 lmove             D4 A1 lmove                                                     .b A1 )+ D1 move  $1F D1 andi   A2 )+ D2 move  $1F D2 andi      D1 D2 cmp  findloop1 bne                                        D2 clr  BEGIN   1 D2 addq   D2 D0 cmp >                                 WHILE   A1 )+ A2 )+ cmpm   findloop1 bne   REPEAT       THEN                                                            .w D3 SP ) move   true # SP -) move    Next end-code                                                                                                                                                                                                                                                                         \ find  ' [']                                          13jan85bp                                                                : find    ( string -- cfa n / string false )                       context dup @   over 2- @   = IF  2-  THEN                      BEGIN   under @ (find IF  nip found   exit  THEN                  over  vp 2+  u> WHILE  swap  2-  REPEAT   nip false ;                                                                      : '    ( -- cfa )      name find 0= abort" Haeh?" ;                                                                             : [compile]            ' , ;                 immediate restrict                                                                 : [']                  ' [compile] Literal ; immediate restrict                                                                 : nullstring?   ( string -- string false / true )                                      dup c@  0= dup IF  nip  THEN  ;                                                                          \ >interpret                                           19mar86we                                                                Label jump                                                         W ) D7 move   2 D7 addq   D7 IP lmove    Next end-code                                                                       Create >interpret   2 allot     jump ' >interpret !                                                                             \ make >interpret to special Defer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ interpret interactive                                19mar86we                                                                Defer notfound                                                  : no.extensions  ( string -- )   error" Haeh?" ; \ string not 0 ' no.extensions Is notfound                                                                                                     : interpret       >interpret ;                                                                                                  | : interpreter      ?stack name find ?dup                           IF  1 and  IF execute  >interpret THEN                            abort" compile only" THEN                                     nullstring? ?exit                                               number? 0= IF  notfound  THEN >interpret ;                                                                                 ' interpreter  >interpret !                                                                                                     \ compiling [ ]                                        22mar86we                                                                | : compiler         ?stack name find ?dup                           IF  0> IF  execute >interpret  THEN    , >interpret THEN        nullstring? ?exit                                               number? ?dup                                                    IF  0> IF  swap [compile] Literal  THEN  [compile] Literal      >interpret   THEN                                               notfound  >interpret ;                                                                                                     : [      ['] interpreter Is >interpret  state off ; immediate   : ]      ['] compiler    Is >interpret  state on ;                                                                                                                                                                                                                                                                              \  Defer Is                                            04dec85we                                                                | : crash           true Abort" crash" ;                                                                                        : Defer     Create   ['] crash ,                                   ;Code   W )+ D7 move   D7 W lmove   W )+ D7 move                        D7 A0 lmove   A0 ) jmp   end-code                                                                                    : (is      r> dup 2+ >r   @  ! ;                                                                                                | : def?  ( cfa -- )    @  ['] notfound @ over =                                     swap  ['] >interpret @    =   or                  not abort" not deferred" ;                                                                                               : Is   ( adr -- )     ' dup def? >body                             state @ IF  compile (is  ,  exit  THEN   ! ; immediate       \ ?stack                                               15dec85we                                                                | : stackfull ( -- )                                                 depth $20 > abort" tight stack"                                 reveal   last?                                                     IF  dup heap? IF  name>  ELSE 4 -  THEN  (forget  THEN       true abort" Dictionary full" ;                                                                                             Code ?stack      user' dp UP D) D0 move   SP D1 move             D0 D1 sub   $100 D1 cmpi  $6200 ( u<= )                                 IF  ;c: stackfull ;   Assembler  THEN                   user' s0 UP D) D0 move   SP D0 cmp  0>=                                 IF  Next  THEN   ;c: true abort" Stack empty" ;        \\                                                              : ?stack     sp@ here - $100 u< IF stackfull THEN                            sp@ s0 @ u> abort" Stack empty" ;                  \ .status push load                                    25mar86we                                                                Defer .status   ' noop Is .status                                                                                               | Create: pull         r> r> ! ;                                                                                                : push   ( addr -- )   r> swap dup >r  @ >r   pull >r >r ;                             restrict                                                                                                 : load   ( blk --)     ?dup 0= ?exit                                                   blk push   blk !   >in push   >in off                           .status   interpret ;                                                                                                                                                                                                                                                                                    \ +load thru +thru --> rdepth depth                    19mar86we                                                                : +load    ( offset -- )        blk @ + load ;                                                                                  : thru     ( from to -- )       1+ swap DO  I  load   LOOP ;                                                                    : +thru    ( off0 off1 -- )     1+ swap DO  I +load   LOOP ;                                                                    : -->                           1 blk +!  >in off  .status ;                                    immediate                                                                                       : rdepth   ( -- +n )            r0 @  rp@ 2+  -  2/ ;           : depth    ( -- +n )            sp@  s0 @  swap  -  2/ ;                                                                                                                                                                                                        \ quit (quit abort                                     13feb86we                                                                | : prompt    state @ IF ."  compiling"   exit  THEN   ."  ok" ;                                                                : (quit       BEGIN   .status  cr  query  interpret  prompt                   REPEAT ;                                                                                                          Defer 'quit       ' (quit Is 'quit                              : quit            r0 @ rp!   [compile] [   'quit ;                                                                              : standardi/o     [ output ] Literal output 4 cmove ;                                                                           Defer 'abort     ' noop Is 'abort                               : abort          clearstack   end-trace                                          'abort   standardi/o   quit ;                                                                                  \ (error abort" error"                                 29mar86we                                                                Variable scr    1 scr !       Variable r#    0 r# !                                                                             : (error ( string -- )                                             standardi/o   space here .name  count type space ?cr            blk @ ?dup IF  scr !   >in @ r# !   THEN   quit ;            ' (error errorhandler !                                                                                                         : (abort"     "lit swap IF  >r clearstack r>                                   errorhandler perform  exit  THEN  drop ; restrict                                                                | : (err"      "lit swap IF  errorhandler perform  exit  THEN                  drop ; restrict                                  : abort"       compile (abort"  ,"  align ;  immediate restrict : error"       compile (err"    ,"  align ;  immediate restrict \ -trailing                                            19mar86we                                                                Code -trailing   ( addr n1 -- addr n2 )                            SP )+ D0 move   0<> IF                                          SP  ) D7 move   D7 A0 lmove   D0 A0 adda                     Label -trail    .b A0 -) D1 move   $20 D1 cmpi   -trail D0 dbne    .w -1 D0 cmpi   0= IF   D0 clr   THEN                           THEN   D0 SP -) move    Next end-code                                                                                                                                                                                                                                                                                        \\                                                              : -trailing ( addr n1 -- addr n2)                                2dup bounds  ?DO  2dup + 1- c@ bl - IF  LEAVE  THEN  1-  LOOP ;                                                                \ space spaces                                         07dec85we                                                                $20 Constant bl                                                                                                                 : space                      bl emit ;                          : spaces   ( u -- )          0 ?DO  space  LOOP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ hold <# #> sign # #s                                 05dec85we                                                                | : hld   ( -- addr )           pad 2- ;                                                                                        : hold    ( char -- )           -1 hld +! hld @ c! ;                                                                            : <#                            hld hld ! ;                                                                                     : #>      ( 32b -- addr +n )    2drop hld @ hld over - ;                                                                        : sign    ( n -- )              0< IF  Ascii - hold  THEN ;                                                                     : #       ( +d1 -- +d2 )        base @ ud/mod  rot 9 over <      IF [ ascii A ascii 9 - 1- ] Literal +  THEN  Ascii 0 + hold ;                                                                  : #s      ( +d -- 0 0 )         BEGIN  # 2dup d0=  UNTIL ;      \ print numbers                                        24dec83ks                                                                : d.r      -rot under  dabs  <# #s rot sign #>                             rot over  max  over - spaces  type ;                                                                                 : .r       swap extend rot d.r ;                                                                                                : u.r      0 swap d.r ;                                                                                                         : d.       0 d.r space ;                                                                                                        : .        extend d. ;                                                                                                          : u.       0 d. ;                                                                                                                                                                               \ .s list c/l l/s                                      24nov85we                                                                : .s                                                             sp@  s0 @  over -  $20 umin bounds ?DO  I @ u.  2 +LOOP ;                                                                      $40 Constant c/l        \ Screen line length                    $10 Constant l/s        \ lines per screen                                                                                      : list ( blk -- )                                                  scr !   ." Scr " scr @ dup u.   ." Dr "  drv? .                 l/s 0 DO                                                          cr I 2 .r  space  scr @ block I c/l * + c/l -trailing type    LOOP cr ;                                                                                                                                                                                                                                                    \ multitasker primitives                               19mar86we                                                                Code pause   Next end-code                                                                                                      : lock ( addr -- )                                                 dup @  up@  = IF  drop  exit  THEN                              BEGIN   dup @ WHILE   pause   REPEAT  up@  swap  ! ;                                                                         : unlock   ( addr -- )        dup lock off ;                                                                                    Label wake    2 A7 addq   A7 )+ UP lmove                           2 UP subq   $4EF9 ( jmp ) # UP ) move                           6 UP D) D7 move    D7 SP lmove                                     SP )+ D7 move   D7 RP lmove                                     SP )+ D7 move   D7 IP lmove    Next end-code                                                                              \ buffer mechanism                                     19mar86we                                                                User file            0 file !     \ addr of file control block  Variable prev        0 prev !     \ Listhead                    | Variable buffers   0 buffers !  \ Semaphor                    $408 Constant b/buf               \ physikalische Gr”že                                                                         \\ Structur eines Buffers:                                        0 : link                                                        2 : file                                                        4 : blocknummer                                                 6 : statusflags                                                 8 : Data ... 1 Kb ...                                         Statusflag bits : 15   1 -> updated                             file :  -1 -> empty buffer,  0 -> no fcb, direct acces                  else addr of fcb  ( system dependent )                  \ search for blocks in memory                          19mar86we\ D0:blk   D1:file   A0:bufadr  A1:Vorgaenger                                                                                   Label thisbuffer?                                                  2 A0 D) D1 cmp   0= IF  4 A0 D) D0 cmp   THEN  rts           Code (core?  ( blk file -- adr\blk file )                          2 SP D) D0 move   SP ) D1 move   user' offset UP D) D0 add      prev mempage L#) D7 move   D7 A0 lmove                          thisbuffer? bsr  0= IF                                       Label blockfound    2 # SP adda   8 # A0 adda   A0 SP ) move       RP )+ D7 move   D7 IP lmove   Next  THEN                         BEGIN    A0 A1 lmove   A1 ) D7 move    0= IF   Next   THEN            D7 A0 lmove   thisbuffer? bsr   0= UNTIL                 A0 ) A1 ) move                                                  prev mempage L#) A0 ) move   A0 prev mempage L#) move           blockfound bra   end-code                                    \ (core?                                               17nov85we                                                                \\                                                              | : this? ( blk file bufadr -- flag )                                dup 4+ @  swap 2+ @  d= ;                                                                                                  | : (core? ( blk file -- dataaddr / blk file )                       BEGIN   over  offset @ +  over  prev @ this?                            IF  rdrop 2drop  prev @ 8 +  exit  THEN                   2dup >r   offset @ + >r   prev @                                BEGIN   dup @ ?dup 0= IF  rdrop rdrop drop exit  THEN             dup   r> r> 2dup >r >r   rot this?  0=                        WHILE nip REPEAT                                                dup @ rot !   prev @ over !   prev !   rdrop rdrop            REPEAT ;                                                                                                                   \ (diskerr                                             11jun85bp                                                                : (diskerr                                                         ." error ! r to retry "    key $FF and  capital                 Ascii R = not abort" aborted" ;                                                                                              Defer diskerr                                                   ' (diskerr Is diskerr                                                                                                           Defer r/w                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ backup emptybuf readblk                              19mar86we                                                                | : backup ( bufaddr -- )       dup 6+ @ 0<                          IF 2+ dup @ 1+           \ buffer empty if file = -1              IF  input push   output push   standardi/o                        BEGIN   dup 6+   over 2+ @   2 pick @  0 r/w                    WHILE   ." write " diskerr   REPEAT                           THEN   4+ dup  @ $7FFF and  over !  THEN  drop ;                                                                         | : emptybuf ( bufaddr -- )      2+ dup on   4+ off ;                                                                           | : readblk ( blk file addr -- blk file addr )                       dup emptybuf                                                    input push   output push   standardi/o   >r                     BEGIN   over  offset @ +   over   r@ 8 +  -rot  1 r/w           WHILE   ." read " diskerr   REPEAT  r> ;                   \ take mark updates? full? core?                              bp                                                                | : take ( -- bufaddr)    prev                                       BEGIN   dup @ WHILE   @ dup   2+ @   -1 = UNTIL                 buffers lock    dup backup ;                                                                                               | : mark ( blk file bufaddr -- blk file )                            2+ >r   2dup r@ !   offset @ +   r@ 2+ !  r> 4+ off             buffers unlock ;                                                                                                           | : updates? ( -- bufaddr / flag)                                    prev  BEGIN   @ dup WHILE   dup 6+ @ 0<  UNTIL ;                                                                           | : full? ( -- flag )  prev  BEGIN  @ dup @  0= UNTIL  6+ @ 0< ;                                                                : core? ( blk file -- addr /false )     (core? 2drop false ;    \ block & buffer manipulation                          19mar86we                                                                : (buffer ( blk file -- addr )                                     BEGIN   (core?  take  mark   REPEAT ;                                                                                        : (block ( blk file -- addr )                                      BEGIN   (core?  take  readblk  mark   REPEAT ;                                                                               | Code file@   ( -- addr )    user' file UP D) SP -) move                                     Next end-code                                                                                     : buffer ( blk -- addr )   file@ (buffer ;                                                                                      : block  ( blk -- addr )   file@ (block ;                                                                                                                                                       \ block & buffer manipulation                          11nov85we                                                                : update          $80 prev @ 6+ c! ;                                                                                            : save-buffers    buffers lock                                                    BEGIN  updates? ?dup WHILE  backup  REPEAT                      buffers unlock ;                                                                                              : empty-buffers   buffers lock  prev                                              BEGIN  @ ?dup WHILE  dup emptybuf  REPEAT                       buffers unlock ;                                                                                              : flush           save-buffers empty-buffers ;                                                                                                                                                                                                                  \ moving blocks                                        11nov85we                                                                | : (copy ( from to -- )                                             dup file@  core? IF   prev @ emptybuf   THEN                           full? IF  save-buffers  THEN                             offset @ +   swap  block 4-  !  update  ;                                                                                  | : blkmove ( from to quan --)    save-buffers  >r                   over r@ +   over u> >r   2dup u< r>   and                       IF    r@ r@ d+   r> 0 ?DO  -1 -2 d+  2dup (copy  LOOP           ELSE   r> 0 ?DO  2dup (copy  1 1 d+  LOOP                       THEN    save-buffers 2drop ;                                                                                               : copy ( from to --)                1 blkmove ;                 : convey ( [blk1 blk2] [to.blk --)                                 swap 1+  2 pick -  dup  0> not abort" No !!!"   blkmove ;    \ Allocating buffers                                   22mar86we                                                                $10000 Constant limit            Variable first                                                                                 : allotbuffer ( -- )                                               first @  r0 @  -  b/buf 2+  u< ?exit                            b/buf negate first +!  first @ dup emptybuf                     prev @ over !  prev ! ;                                                                                                      : freebuffer ( -- )                                                first @   limit b/buf - u<                                       IF  first @ backup   prev                                         BEGIN   dup @  first @ -  WHILE  @  REPEAT                    first @ @  swap !   b/buf first +!  THEN ;                                                                                  : all-buffers    BEGIN  first @ allotbuffer  first @ = UNTIL ;  \ endpoints of forget                               04j29mar86we                                                                | : |? ( nfa -- flag )   c@ $20 and ;                           | : forget? ( adr nfa -- flag )   \ code in heap or above adr ?      name>  under  1+ u<  swap  heap?  or ;                                                                                     | : endpoints ( addr -- addr symb )                                  heap  voc-link >r                                               BEGIN   r> @ ?dup       \ through all Vocabs                    WHILE  dup >r 4 - >r    \ link on returnstack                     BEGIN  r> @ >r over 1- dup r@ u<      \ until link or                        swap r@ 2+ name> u< and  \ code under adr          WHILE  r@ heap? [ 2dup ] UNTIL  \ search for name in heap       r@ 2+ |? IF  over r@ 2+ forget?                                        IF  r@ 2+ (name> 2+ umax  THEN  \ then update symb       THEN  REPEAT   rdrop   REPEAT ;                          \ remove, -words, -tasks                          bp/ks08jan86we                                                                | : remove ( dic sym thread - dic sym )                              BEGIN dup @ ?dup      \ unlink forg. words                      WHILE dup heap?                                                    IF  2 pick over u>  ELSE  3 pick over 1+ u<  THEN            IF  @ over ! ( unlink word)  ELSE  nip  THEN  REPEAT drop ;                                                                | : remove-words ( dic sym -- dic sym )                              voc-link BEGIN  @ ?dup                                                   WHILE  dup >r  4- remove  r> REPEAT ;                                                                             | : remove-tasks ( dic -- )       up@                                BEGIN  4+  dup @  up@ -  WHILE  2dup @ swap here uwithin               IF  dup @ 4+ @  over ! 4-                                       ELSE  @  THEN  REPEAT  2drop ;                      \ remove-vocs forget-words                             29apr85bp                                                                | : remove-vocs ( dic symb -- dic symb )                             voc-link remove       thru.vocstack                              DO  2dup I @  -rot uwithin                                         IF  [ ' Forth 2+ ] Literal  I !  THEN   -2 +LOOP             2dup  current @   -rot  uwithin                                 IF  [ ' Forth 2+ ] Literal  current !  THEN ;                                                                             | : remove-codes   ( dic symb -- dic symb )                          next-link remove  ;                                                                                                        | : forget-words ( dic symb -- )                                     over  remove-tasks  remove-vocs  remove-words  remove-codes     heap swap - hallot   dp !   0 last ! ;                                                                                     \ deleting words from dict.                            13jan83ks                                                                : clear        here  dup up@  forget-words  dp ! ;                                                                              : (forget ( adr -- )    dup heap? abort" is symbol"                                     endpoints  forget-words ;                                                                               : forget   ' dup  [ dp ] Literal @  u< abort" protected"                    >name  dup  heap?                                               IF  name>  ELSE  4-  THEN (forget ;                                                                                 : empty   [ dp ] Literal @ up@ forget-words                               [ udp ] Literal @  udp ! ;                                                                                                                                                                                                                            \ save bye stop? ?cr                                   19mar86we                                                                : save    here  up@ forget-words                                   voc-link @  BEGIN   dup 4- @   over 2-  !  @ ?dup 0= UNTIL      up@ origin $100 cmove ;                                                                                                      : bye       flush empty (bye ;                                                                                                  | : end?    key $FF and dup 3 =   \ Stoptaste                                     swap $1B = or   \ Escapetaste                                 IF true rdrop THEN ;                                                                                            : stop? ( -- flag )     key? IF end? end? THEN false ;                                                                          : ?cr                   col c/l u> IF cr THEN ;                                                                                 \ in/output structure                                  25mar86we                                                                | : Out:   Create dup c, 2+ Does> c@ output @ + perform ;                                                                       : Output:  Create:   Does> output ! ;                           0   Out: emit   Out: cr   Out: type   Out: del                      Out: page   Out: at   Out: at?    drop                                                                                      : row ( -- row )     at? drop ;                                 : col ( -- col )     at? nip ;                                                                                                  | : In:    Create dup c, 2+ Does> c@ input @ + perform ;                                                                        : Input:   Create:   Does> input ! ;                            0   In: key   In: key?   In: decode   In: expect  drop                                                                          \ Alias  only definitionen                             29jan85bp                                                                Only definitions Forth                                                                                                          : seal 0 ['] Only >body ! ;  \ kill all words in Only                                                                           ' Only        Alias Only                                        ' Forth       Alias Forth                                       ' words       Alias words                                       ' also        Alias also                                        ' definitions Alias definitions                                                                                                 Host Target                                                                                                                                                                                                                                                     \ 'cold 'restart                                       19mar86we                                                                | : init-vocabularys        voc-link @                               BEGIN   dup 2- @   over 4-  !    @ ?dup 0= UNTIL ;         | : init-buffers     0 prev !   limit first !   all-buffers ;                                                                   Defer 'cold    ' noop Is 'cold                                  | : (cold      origin up@ $100 cmove                                 init-vocabularys   init-buffers   'cold   page  wrap            Onlyforth   cr &27 spaces   logo count type cr   restart ;                                                                 Defer 'restart  ' noop Is 'restart                              | : (restart    ['] (quit Is 'quit   drvinit   'restart          [ errorhandler ] Literal @  errorhandler !                      ['] noop Is 'abort   abort ;                                                                                                   \ cold bootsystem restart                              19mar86we                                                                Label buserror    ;c: ." Bus Error !" restart ;                 Label adrerror    ;c: ." Adress Error !" restart ;              Label illegal     ;c: ." Illegal Instruction !" restart ;       Label div0        ;c: ." Division by 0 !" restart ;                                                                             Code cold      here >cold !                                        .l 0 mempage # D0 move     \ set 64k memory-page                .w s0 mempage L#) D0 move  .l 6 D0 addq  D0 A0 move             origin mempage # A1 move                                        $3F 0 # D1 move            \ long adressing                       D1 DO  A1 )+ A0 )+ move  LOOP                                 $A00A ,                    \ hide mouse                         ' (cold >body mempage # D7 move                                                                                              \ restart                                              19mar86we                                                                Label bootsystem     .l D7 D0 move     \ mempage                   .w s0 mempage L#) D0 move   .l 6 D0 addq D0 UP move             .w user' s0 UP D) D0 move   D0 SP lmove                            user' r0 UP D) D0 move   D0 RP lmove                         .l RP ) clr   D7 IP move                                        .w D0 move<sr   D0 $0D # btst  ( src<>dst)  0= IF               .l A7 -) clr  .w $20 # A7 -) move   1 trap   6 A7 addq   THEN   .w buserror # D7 move  .l D7   8 #) move                        .w adrerror # D7 move  .l D7 $0C #) move                        .w illegal  # D7 move  .l D7 $10 #) move                        .w div0     # D7 move  .l D7 $14 #) move                        .w wake     # D7 move  .l D7 $8C #) move                        Next end-code                                                                                                                \ System dependent load screen                         23feb86we                                                                Code restart      here >restart !                                  .l ' (restart >body mempage # D7 move                           bootsystem mempage L#) jmp    end-code                                                                                       2 $0C +thru        \ Atari 520 ST Interface                                                                                     Host    ' Transient 8 + @  Transient Forth Context @ 6 + !      \ Tlatest aus Transient wird Tlatest in Forth                                                                                   Target Forth also definitions                                   : forth-83 ;     \ last word in Dictionary                                                                                                                                                                                                                      \ System patchup                                       01jan86we                                                                Forth definitions                                                                                                               mempage Constant mempage                                                                                                        $AB00 s0 !               $AF00 r0 !                             s0 @ dup s0 2- !         6 + s0 4 - !                           here dp !                                                                                                                       Host  Tudp @         Target  udp !                              Host  Tvoc-link @    Target  voc-link !                         Host  Tnext-link @   Target  next-link !                        Host  move-threads                                                                                                                                                                              \ BIOS - Calls                                         19mar86we                                                                Code bconstat   ( dev -- fl )                                      SP )+ D0 move   D0 A7 -) move   1 # A7 -) move                  $0D trap   4 A7 addq   D0 SP -) move    Next end-code        Code bcostat    ( dev -- fl )                                      SP )+ D0 move   D0 A7 -) move   8 # A7 -) move                  $0D trap   4 A7 addq   D0 SP -) move    Next end-code                                                                        Code bconin     ( dev -- char )                                    SP )+ D0 move   D0 A7 -) move   2 # A7 -) move                  $0D trap   4 A7 addq   D0 D1 move   .l 8 # D0 lsr               .b D1 D0 move   .w D0 SP -) move   Next end-code             Code bconout    ( char dev -- )                                    SP )+ D0 move   SP )+ A7 -) move   D0 A7 -) move                3 # A7 -) move   $0D trap   6 A7 addq   Next end-code        \ STkey? getkey                                        07jan86we                                                                $08 Constant #bs         $0D Constant #cr                       $0A Constant #lf         $1B Constant #esc                                                                                      : con!     ( 8b -- )     2 bconout ;                            : curon              #esc con!  Ascii e con! ;                  : curoff             #esc con!  Ascii f con! ;                  : wrap               #esc con!  Ascii v con! ;                  : curleft            #esc con!  Ascii D con!   -1 out +!  ;     : currite            #esc con!  Ascii C con!    1 out +!  ;                                                                     : STkey?   ( -- fl )     2 bconstat ;                           : getkey   ( -- char )   STkey? IF  2 bconin  ELSE  0  THEN ;   : STkey    ( -- char )   curon                                     BEGIN  pause STkey?  UNTIL curoff getkey ;                   \ (ins (del                                            07jan86we                                                                | Variable maxchars                                                                                                             | : (del   ( addr pos1 -- addr pos2 )    2dup curleft                at? >r >r   2dup +  over span @ - negate under   type space       r> r> at                                                      >r + dup 1- r> cmove   -1 span +!   1-    ;                                                                                | : (ins   ( addr pos1 -- addr pos2 )    2dup                        +   over span @ - negate >r   dup   dup 1+ r@ cmove>            bl over c!   r> 1+   at? >r >r   type   r> r> at                1 span +! ;                                                                                                                                                                                                                                                \ decode                                               01jan86we                                                                : STdecode   ( addr pos1 key -- addr pos2 )                       $4D00 case?  IF dup  span @ <  IF  currite 1+  THEN  exit THEN  $4B00 case?  IF dup            IF  curleft 1-  THEN  exit THEN  $5200 case?  IF dup  span @ -  IF  (ins        THEN  exit THEN  $FF and   dup 0= IF  drop exit  THEN                              #bs case?  IF  dup    IF  (del  THEN  exit THEN                 $7F case?  IF  span @   2dup <  and                                        IF  currite 1+ (del  THEN  exit THEN                 #cr case?  IF span @  maxchars !                                              dup  at?  rot span @ -  - at  exit THEN         >r  2dup + r@ swap c!  r> emit                                  dup span @ = IF  1 span +!  THEN  1+ ;                                                                                                                                                        \ expect keyboard                                      25mar86we                                                                : STexpect   ( addr len -- )       maxchars !                      span off  0                                                        BEGIN   span @  maxchars @  u< WHILE   key decode   REPEAT   2drop space ;                                                                                                                                                                                Input:  keyboard    [ here input ! ]                                STkey STkey? STdecode STexpect ;                                                                                                                                                                                                                                                                                                                                                                                                                            \ emit cr del page at at? type                         07jan86we                                                                Variable out    0 out !         | &80 Constant c/row                                                                            : STemit   ( 8b -- )    5 bconout   1 out +!   pause ;          : STcr                  #cr con!   #lf con!                                             out @  c/row /  1+  c/row *  out ! ;    : STdel                 #bs con!  space  #bs con!   -2 out +! ; : STpage                #esc con!  Ascii E con!   out off ;     : STat  ( row col -- )  #esc con!  Ascii Y con!                                         over $20 + con!   dup $20 + con!                                swap  c/row * + out ! ;                 : STat? ( -- row col )  out @  c/row /mod  &24 min swap ;                                                                       \\                                                              : STtype ( addr len --) 0 ?DO count emit LOOP drop ;            \ Output                                               25mar86we                                                                Code STtype   ( addr len -- )                                      SP )+ D3 move   SP )+ D7 move   D3 tst  0<>                     IF   D3 out mempage L#) add   1 D3 subq                              D3 DO   D7 A0 lmove   .b A0 ) D1 move                               .w D1 A7 -) move   5 # A7 -) move   3 # A7 -) move              $0D trap   6 A7 addq   1 D7 addq  LOOP                 THEN  ;c:  pause ;                                                                                                           Output: display    [ here output ! ]                               STemit STcr STtype STdel STpage STat STat? ;                                                                                 | Code term     A7 -) clr  1 trap   end-code                    | :             (bye curoff term ;                                                                                              \ b/blk drive >drive drvinit                           11feb86we                                                                $400 Constant b/blk          $15F Constant blk/drv                                                                              | Variable (drv    0 (drv !                                                                                                     : drive   ( drv# -- )               blk/drv * offset ! ;        : >drive  ( block drv# -- block' )  blk/drv * + offset @ - ;    : drv?    ( block -- drv# )         offset @ + blk/drv / ;                                                                      : drvinit            noop ;                                                                                                     : a:                 0 drive ;                                  : b:                 1 drive ;                                                                                                                                                                  \ readsector writesector                               19mar86we                                                                Code rwabs   ( r/wf adr rec# -- flag )                             .l 0 mempage # D0 move   D0 D1 move   D0 D2 move                .w SP )+ D0 move   SP )+ D1 move   SP )+ D2 move   2 D2 addq    (drv mempage L#) A7 -) move      \ Drivenummer                                D0 A7 -) move      \ rec#                                      2 # A7 -) move      \ Anzahl Sektoren                         .l D1 A7 -) move      \ Adresse                                 .w D2 A7 -) move      \ r/wflag                                   4 # A7 -) move      \ Funktionsnummer               $0D trap   $0E # A7 adda   .w D0 SP -) move  \ Fehlerflag       Next end-code                                                                                                                                                                                                                                               \ STr/w                                                11feb86we                                                                : STr/w   ( adr blk file r/wf -- flag )                            swap abort" no file"                                            1 xor -rot   blk/drv /mod   dup (drv !                          3 u> IF   . ." beyond capacity"  nip  exit   THEN               9 + 2*  rwabs ;                                                                                                              ' STr/w Is r/w                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ index findex                                         05dec85we                                                                | : range  ( from to -- to+1 from )                                  blk/drv 1- umin   swap   blk/drv 1- umin                        2dup > IF  swap  THEN  1+ swap ;                                                                                           : index ( from to --)                                              range DO  cr  I 4 .r   I space block  c/l type                            stop? IF  LEAVE  THEN  LOOP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      