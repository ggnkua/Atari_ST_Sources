Seite 54 Tracer

Das Kapitel '7.2) Der Tracer' von Seite 54 ist durch folgendes zu 
ersetzen:

Angenommen, Sie wollen folgendes Wort auf Fehler untersuchen: 
(bitte tippen Sie ein, alle n”tigen Eingaben sind fett und alle 
Ausgaben des volksFORTH83 sind unterstrichen dargestellt.)

: -trailing  ( addr1 n1 -- addr1 n2 )  compiling
2dup bounds  ?DO  2dup + 1-  c@ bl =  compiling
IF  LEAVE  THEN  1-  LOOP ;  ok

Die Funktion dieses Wortes k”nnen Sie, wenn sie Ihnen unklar ist, 
dem Glossar entnehmen. Zum Testen des Wortes wird ein String 
ben”tigt. Sie definieren:

Create teststring ," Dies ist ein Test        "  ok

wobei Sie bitte absichtlich einige zus„tzliche Leerzeichen 
eingefgt haben. Sie geben nun ein :

teststring count .s 16 7E39  ok
-trailing .s 16 7E39  ok

und stellen zu Ihrem Erstaunen (oder auch nicht ?!) fest, da
-TRAILING kein einziges Leerzeichen abgeschnitten hat. (Sp„testens 
jetzt sollten Sie am Rechner sitzen und den Tracer laden, wenn er 
noch nicht im System vorhanden ist. Prfen Sie, ob es das Wort 
DEBUG im FORTH Vocabulary gibt, dann ist der Tracer vorhanden. Der 
Tracer geh”rt zu den sogenannten Tools. Die Quelltexte finden Sie 
auf Ihrer Diskette (Sehen Sie bitte im Directory-Screen nach)).

Mit dem Tracer k”nnen Sie Worte, die mit dem : definiert wurden, 
im Einzelschrittbetrieb testen. Um den Tracer zu benutzen, geben 
Sie folgendes ein:

debug <name1>  ok

Hierbei ist <name1> das zu tracende Wort. Zun„chst geschieht noch 
gar nichts.  DEBUG  hat nur den Tracer "scharf gemacht". Geben Sie 
nun eine Sequenz ein, die <name1> enth„lt, unterbricht der Tracer 
die Ausfhrung, wenn er auf <name1> st”t. Es erscheint folgendes 
Bild.

addr1 addr2 <name2>                (Werte)

Hierbei ist addr1 eine Adresse im Parameterfeld von <name1>, 
n„mlich die, in der addr2 steht. addr2 ist die Kompilations-
Adresse von <name2>. <name2> ist das Wort, das als n„chstes 
ausgefhrt werden soll. (Werte) sind die Werte, die gerade auf dem 
Stack liegen.

Bleiben wir bei unserem Beispiel, Sie geben ein:

debug -trailing  ok

Es geschieht zun„chst nichts.

Nun versuchen Sie es wieder mit der Sequenz

teststring count .s 16 7E39  ok
-trailing

und erhalten folgendes Bild:

7E04  536  2DUP                    16 7E39

16 7E39 ist der Stackinhalt, wie er von  TESTSTRING COUNT  
geliefert wurde, n„mlich Adresse und L„nge des Strings  
TESTSTRING .

Natrlich k”nnen die Zahlen bei Ihnen anders aussehen, je nachdem, 
wohin   TESTSTRING  und  -TRAILING  kompiliert wurde.  536 ist die 
Kompilations-Adresse  von  2DUP ,  7E04 die Position von  2DUP  in  
-TRAILING . (Auch diese Adressen k”nnnen sich ge„ndert haben!)

Drcken Sie jetzt so lange <Return>, bis  OK  ausgegeben wird. Es 
ergibt sich folgende Gesamtausgabe:

debug -trailing   teststring count .s 16 7E39  ok
-trailing
7E04  536  2DUP                    16 7E39 
7E06  954  BOUNDS                  16 7E39 16 7E39 
7E08  92C  (?DO                    7E39 7E4F 16 7E39 
7E0C  536  2DUP                    16 7E39 
7E0E  546  +                       16 7E39 16 7E39 
7E10  64C  1-                      7E4F 16 7E39 
7E12  34E  C@                      7E4E 16 7E39 
7E14 215C  BL                      20 16 7E39 
7E16  816  =                       20 20 16 7E39 
7E18  A0C  ?BRANCH                 FFFF 16 7E39 
7E1C  BE2  LEAVE                   16 7E39
7E24  2F4  UNNEST                  16 7E39    ok

Sehen wir uns die Ausgabe nun etwas genauer an. Bei den ersten 
beiden Zeilen w„chst der Wert ganz links immer um 2. Es ist der 
Inhalt des Instructionpointers (IP), der immer auf die n„chste 
auszufhrende Adresse zeigt. Der Inhalt dieser Adresse ist jeweils 
eine Kompilations-Adresse ( 536 bei 2DUP usw.). Jede Kompilations-
Adresse  ben”tigt zwei Bytes,  daher mu der IP immer um 2  erh”ht 
werden.

Immer? Nein, denn schon die n„chste Zeile zeigt eine Ausnahme. Das 
Wort (?DO erh”ht den IP um 4 ! Woher kommt eigentlich  (?DO , in 
der Definition von  -TRAILING  stand doch nur  ?DO  . (?DO ist ein 
von  ?DO  kompiliertes Wort, das zus„tzlich zur Kompilations-
Adresse noch einen 16-Bit-Wert ben”tigt, n„mlich fr den 
Sprungoffset hinter LOOP, wenn die Schleife beendet ist. Zwei 
„hnliche F„lle treten noch auf. Das  IF  aus dem Quelltext hat ein  
?BRANCH  kompiliert. Es wird gesprungen, wenn der oberste 
Stackwert FALSE ( = 0) ist. Auch ?BRANCH ben”tigt einen 
zus„tzlichen 16-Bit-Wert fr den Sprungoffset.

Nach  LEAVE  geht es hinter  LOOP  weiter, es wird UNNEST 
ausgefhrt, das vom  ;  in -TRAILING kompiliert wurde und das 
gleiche wie EXIT bewirkt und damit ist das Wort -TRAILING auch 
beendet. Das hier gelistete Wort UNNEST ist nicht zu verwechseln 
mit dem UNNEST des Tracers (siehe unten).

Wo liegt nun der Fehler in unserer Definition von  -TRAILING ? 
Bevor Sie weiterlesen, sollten Sie die Fehlerbeschreibung, den 
Tracelauf und Ihre Vorstellung von der korrekten Arbeitsweise des 
Wortes noch einmal unter die Lupe nehmen.

Der Stack ist vor und nach  -TRAILING  gleich geblieben, die L„nge 
des Strings also nicht ver„ndert worden. Offensichtlich wird die 
Schleife gleich beim ersten Mal verlassen, obwohl das letzte 
Zeichen des Textes ein Leerzeichen war. Die Schleife h„tte also 
eigentlich mit dem vorletzten Zeichen weiter machen mssen. Mit 
anderen Worten:

Die Abbruchbedingung in der Schleife ist falsch. Sie ist genau 
verkehrt herum gew„hlt. Ersetzt man  =  durch  = NOT  oder  - , so 
funktioniert das Wort korrekt. šberlegen Sie bitte, warum  -  
statt  = NOT  eingesetzt werden kann. (Tip: der  IF -Zweig wird 
nicht ausgefhrt, wenn der oberste Stackwert FALSE (also = 0) 
ist.)

Der volksFORTH83-Tracer gestattet es, jederzeit Befehle 
einzugeben, die vor dem Abarbeiten des n„chsten Trace-Kommandos 
ausgefhrt werden. Damit kann man z. B. Stack-Werte ver„ndern oder 
das Tracen abbrechen. ndern Sie probehalber beim n„chsten Trace-
Lauf von -TRAILING das TRUE-Flag (FFFF) auf dem Stack vor der 
Ausfhrung von ?BRANCH durch Eingabe von  NOT  auf 0 und verfolgen 
Sie den weiteren Trace-Lauf. Sie werden bemerken, da die LOOP ein 
zweites Mal durchlaufen wird.

Wollen Sie das Tracen und die weitere Ausfhrung des getraceten 
Wortes abbrechen, so geben Sie bitte RESTART ein. RESTART fhrt 
einen Warm-Start des FORTH-Systems aus und schaltet den Tracer ab.

Ntzlich ist auch die M”glichkeit, das Wort, das als n„chstes zur 
Ausfhrung ansteht, solange zu tracen, bis es ins aufrufende Wort 
zurckkehrt. Dafr ist das Wort NEST vorgesehen. Wollen Sie also 
wissen, was BOUNDS macht, so geben Sie bitte, wenn BOUNDS als 
n„chstes auszufhrendes Wort angezeigt wird, NEST ein und Sie 
erhalten dann:

7E04  536  2DUP                    16 7E39 
7E06  954  BOUNDS                  16 7E39 16 7E39  nest
  956  44C  OVER                   16 7E39 16 7E39  
  958  546  +                      7E39 16 7E39 16 7E39  
  95A  40A  SWAP                   7E4F 7E39 16 7E39  
  95C  2F4  UNNEST                 7E39 7E4F 16 7E39
7E08  92C  (?DO                    7E39 7E4F 16 7E39  
...

Beachten Sie bitte, da die Zeilen jetzt eingerckt dargestellt 
werden, bis der Tracer automatisch in das aufrufende Wort 
zurckkehrt. Der Gebrauch von NEST ist nur dadurch eingeschr„nkt, 
da sich einige Worte, die den Return-Stack manipulieren, mit NEST 
nicht tracen lassen, da der Tracer selbst Gebrauch vom Return-
Stack macht. Auf solche Worte mu man den Tracer mit DEBUG 
ansetzen.

Wollen Sie das Tracen eines Wortes beenden, ohne die Ausfhrung 
des Wortes abzubrechen, so benutzen Sie bitte UNNEST . (Ist der 
Tracer geladen, so kommen Sie an das tief im System steckende 
UNNEST, einem Synonym fr EXIT, das ausschlielich vom  ;  
kompiliert wird, nicht mehr heran und benutzen statt dessen das 
Tracer-UNNEST, das Sie eine Ebene im Trace-Lauf zurckbringt.)

Haben Sie den Fehler gefunden und wollen deshalb nicht mehr 
tracen, so mssen Sie nach dem Ende des Tracens END-TRACE oder 
jederzeit RESTART eingeben, ansonsten bleibt der Tracer "scharf", 
was zu merkwrdigen Erscheinungen fhren kann; auerdem verringert 
sich bei eingeschaltetem Tracer die Laufzeit des Systems.

Wenn man sich eingearbeitet hat, ist der Tracer ein wirklich 
verblffendes Werkzeug, mit dem man sehr viele Fehler schnell 
finden kann. Er ist gleichsam ein Mikroskop, mit dem man sehr tief 
ins Innere von Forth schauen kann.


